<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="随便记录一些东西">
<meta property="og:type" content="website">
<meta property="og:title" content="FishPlayer">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="FishPlayer">
<meta property="og:description" content="随便记录一些东西">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="2C2C2C2">
<meta property="article:tag" content="C#">
<meta property="article:tag" content=" Unity">
<meta property="article:tag" content=" C++">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>FishPlayer</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="FishPlayer" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">FishPlayer</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一个喜欢摸鱼的废物</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2024/02/16/20240216-primitivebehaviour/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="2C2C2C2">
      <meta itemprop="description" content="随便记录一些东西">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FishPlayer">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/16/20240216-primitivebehaviour/" class="post-title-link" itemprop="url">UGUI 一些自用UI表现件基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-02-16 13:26:35 / 修改时间：15:09:23" itemprop="dateCreated datePublished" datetime="2024-02-16T13:26:35+08:00">2024-02-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UGUI/" itemprop="url" rel="index"><span itemprop="name">UGUI</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Temp"><a href="#Temp" class="headerlink" title="Temp"></a>Temp</h1><p>自从开始加班以后就没什么干劲了。这段时间重头工作就是接用户SDK然后补以前落下的一些细节需求。</p>
<p>比较蚌埠住的是，这段时间发现了自己写的很多重复的UI组件代码。而且在这个时候已经不方便再整合替换了，整合替换可能会导致爆炸。</p>
<p>为了尽可能杜绝此类事情发生，决定先把用到的一些基础代码总结一下写在这里，方便下次直接过来抄而不是再手搓了。</p>
<h1 id="上代码"><a href="#上代码" class="headerlink" title="上代码"></a>上代码</h1><h2 id="PrimitiveBehaviour-基本结构"><a href="#PrimitiveBehaviour-基本结构" class="headerlink" title="PrimitiveBehaviour(基本结构)"></a>PrimitiveBehaviour(基本结构)</h2><p>首先定义表现件的最基本的结构。实质就是一个接收值的更新。<br>此外还多了一个标志，可用于调整该组件是否在第一次收到值得时候使用快进动画。<br>因为该功能在实际使用的时候，是根据美术的要求来决定的，所以我觉得不写在代码里而是开放出来供直接在prefab更改会更方便。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core.UI</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// where T : IComparable, IComparable&lt;T&gt;, IConvertible, IEquatable&lt;T&gt; 其实就是为了限制 T 必须是这些基础类型，但是感觉还是没必要这么写</span></span><br><span class="line">    public interface IBehaviourDispatcher&lt;T&gt; where T : IComparable, IComparable&lt;T&gt;, IConvertible, IEquatable&lt;T&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">DispatchValueChange</span>(<span class="params">T nextValue, <span class="keyword">bool</span> instant</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public abstract class PrimitiveBehaviour&lt;T&gt; : MonoBehaviour where T : IComparable, IComparable&lt;T&gt;, IConvertible, IEquatable&lt;T&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_instantApplyInitValue = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_hasInit = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> T m_currentValue;</span><br><span class="line">        <span class="keyword">private</span> T m_previousValue;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> T currentValue =&gt; m_currentValue;</span><br><span class="line">        <span class="keyword">public</span> T previousValue =&gt; m_previousValue;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> hasInited =&gt; m_hasInit;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 持有数据的一方主动调用该方法，以对表现进行更新</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="nextValue"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="instant"&gt;</span>instant changing value can also used to fast forward anim<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ChangeValue</span>(<span class="params">T nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_hasInit)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!instant &amp;&amp; IsValueEqual(currentValue, nextValue))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                m_previousValue = m_currentValue;</span><br><span class="line">                m_currentValue = nextValue;</span><br><span class="line">                NotifyValueChanged(nextValue, instant);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            instant = instant || m_instantApplyInitValue;</span><br><span class="line">            NotifyValueChanged(nextValue, instant);</span><br><span class="line">            m_previousValue = m_currentValue = nextValue;</span><br><span class="line">            m_hasInit = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">IsValueEqual</span>(<span class="params">T l, T r</span>)</span> =&gt; <span class="number">0</span> == l.CompareTo(r);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">NotifyValueChanged</span>(<span class="params">T nextValue, <span class="keyword">bool</span> instant</span>)</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="BoolBehaviour"><a href="#BoolBehaviour" class="headerlink" title="BoolBehaviour"></a>BoolBehaviour</h2><p>需要下发数据的一方需要持有一个 BoolBehaviourDispatcher 变量，并通过其把数据变更下发出去。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core.UI</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> BoolBehaviourDispatcher : IBehaviourDispatcher&lt;<span class="keyword">bool</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> BoolBehaviour[] m_behaviours;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DispatchValueChange</span>(<span class="params"><span class="keyword">bool</span> nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> count = m_behaviours.Length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                BoolBehaviour behaviour = m_behaviours[i];</span><br><span class="line">                <span class="keyword">if</span> (behaviour.gameObject.activeInHierarchy &amp;&amp; behaviour.enabled)</span><br><span class="line">                &#123;</span><br><span class="line">                    behaviour.ChangeValue(nextValue, instant);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"FindInChildren"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">FindInChildren</span>(<span class="params">GameObject source</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> behaviors = source.GetComponentsInChildren&lt;BoolBehaviour&gt;();</span><br><span class="line">            m_behaviours = behaviors;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public abstract class BoolBehaviour : PrimitiveBehaviour&lt;bool&gt; </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Editor preview"</span>), NonReorderable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> previewValue_editor = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> previrwInstant = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"SetValuePreview"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetValuePreview</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Application.isPlaying)</span><br><span class="line">            &#123;</span><br><span class="line">                NotifyValueChanged(previewValue_editor, previrwInstant);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            NotifyValueChanged(previewValue_editor, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="FloatBehaviour"><a href="#FloatBehaviour" class="headerlink" title="FloatBehaviour"></a>FloatBehaviour</h2><p>需要下发数据的一方需要持有一个 FloatBehaviourDispatcher 变量，并通过其把数据变更下发出去。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core.UI</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> FloatBehaviourDispatcher: IBehaviourDispatcher&lt;<span class="keyword">float</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> FloatBehaviour[] m_behaviours;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DispatchValueChange</span>(<span class="params"><span class="keyword">float</span> nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> count = m_behaviours.Length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> behaviour = m_behaviours[i];</span><br><span class="line">                <span class="keyword">if</span> (behaviour.gameObject.activeInHierarchy &amp;&amp; behaviour.enabled)</span><br><span class="line">                &#123;</span><br><span class="line">                    behaviour.ChangeValue(nextValue, instant);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"FindInChildren"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">FindInChildren</span>(<span class="params">GameObject source</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> behaviors = source.GetComponentsInChildren&lt;FloatBehaviour&gt;();</span><br><span class="line">            m_behaviours = behaviors;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public abstract class FloatBehaviour : PrimitiveBehaviour&lt;float&gt;</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Editor preview"</span>), NonReorderable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> previewValue_editor = <span class="number">1f</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> previrwInstant = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"SetValuePreview"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetValuePreview</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Application.isPlaying)</span><br><span class="line">            &#123;</span><br><span class="line">                NotifyValueChanged(previewValue_editor, previrwInstant);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            NotifyValueChanged(previewValue_editor, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="IntBehaviour"><a href="#IntBehaviour" class="headerlink" title="IntBehaviour"></a>IntBehaviour</h2><p>需要下发数据的一方需要持有一个 IntBehaviourDispatcher 变量，并通过其把数据变更下发出去。<br>IntBehaviour 我定义成一个抽象类。因为实际使用的时候(我暂时遇到的情况)，在UI表现上会需要有持有一个数值，数值相同不同时的表现，或是UI收到不同的数值再有不同的表现。<br>所以这边分做成了两个 Beheaviour 。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core.UI</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> IntBehaviourDispatcher : IBehaviourDispatcher&lt;<span class="keyword">int</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> IntBehaviour[] m_behaviours;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DispatchValueChange</span>(<span class="params"><span class="keyword">int</span> nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> count = m_behaviours.Length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> behaviour = m_behaviours[i];</span><br><span class="line">                <span class="keyword">if</span> (behaviour.gameObject.activeInHierarchy &amp;&amp; behaviour.enabled)</span><br><span class="line">                &#123;</span><br><span class="line">                    behaviour.ChangeValue(nextValue, instant);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"FindInChildren"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">FindInChildren</span>(<span class="params">GameObject source</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> behaviors = source.GetComponentsInChildren&lt;IntBehaviour&gt;();</span><br><span class="line">            m_behaviours = behaviors;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public abstract class IntBehaviour : PrimitiveBehaviour&lt;int&gt; </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Editor preview"</span>), NonReorderable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> previewValue_editor = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> previrwInstant = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"SetValuePreview"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetValuePreview</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Application.isPlaying)</span><br><span class="line">            &#123;</span><br><span class="line">                NotifyValueChanged(previewValue_editor, previrwInstant);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            NotifyValueChanged(previewValue_editor, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据收到的值不同 而作不同表现</span></span><br><span class="line">    public abstract class IntSwitchBehaviour&lt;T&gt; : PrimitiveBehaviour&lt;int&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Serializable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">struct</span> IntPack</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">int</span> intValue;</span><br><span class="line">            <span class="keyword">public</span> T targetValueDataPack;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Extra param"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_hasDefaultPack = <span class="literal">false</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> m_defaultPackIndex = <span class="number">0</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_unapplyPrevPack = <span class="literal">true</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> IntPack[] m_packArray;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">sealed</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">NotifyValueChanged</span>(<span class="params"><span class="keyword">int</span> nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> length = m_packArray.Length;</span><br><span class="line">            <span class="keyword">int</span> meetIndex = <span class="number">-1</span>;</span><br><span class="line">            IntPack pack;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                pack = m_packArray[i];</span><br><span class="line">                <span class="keyword">if</span> (pack.intValue == nextValue)</span><br><span class="line">                &#123;</span><br><span class="line">                    meetIndex = i;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (m_unapplyPrevPack)</span><br><span class="line">                &#123;</span><br><span class="line">                    UnApplyPack(pack.targetValueDataPack);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (meetIndex &gt; <span class="number">0</span>) <span class="comment">// has meet</span></span><br><span class="line">            &#123;</span><br><span class="line">                pack = m_packArray[meetIndex];</span><br><span class="line">                ApplyPack(pack.targetValueDataPack, instant);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// apply default one</span></span><br><span class="line">            pack = m_packArray[m_defaultPackIndex];</span><br><span class="line">            ApplyPack(pack.targetValueDataPack, instant);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">ApplyPack</span>(<span class="params">T pack, <span class="keyword">bool</span> instant</span>)</span>;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">UnApplyPack</span>(<span class="params">T pack</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 持有一个数值，判断传进来的值是否相等，再做表现</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">IntEqualBehaviour</span> : <span class="title">IntBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> m_targetValue;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_isPreviousValueEqual = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">sealed</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">NotifyValueChanged</span>(<span class="params"><span class="keyword">int</span> nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">bool</span> isEqual = IsValueEqual(nextValue, m_targetValue);</span><br><span class="line">            <span class="keyword">bool</span> hasChanged = isEqual != m_isPreviousValueEqual;</span><br><span class="line">            <span class="keyword">if</span> (hasInited)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (hasChanged)</span><br><span class="line">                &#123;</span><br><span class="line">                    NotifyValueEqual(isEqual, instant);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            NotifyValueEqual(isEqual, instant);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">NotifyValueEqual</span>(<span class="params"><span class="keyword">bool</span> equal, <span class="keyword">bool</span> instant</span>)</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h2><p>下面是一个 FloatBehaviour 和 BoolBehaviour 的例子。<br>只需要收到数值，FloatBehaviour 启动tween去修改 Image 的填充/ BoolBehaviour 去开关物体。其它还会用到的表现还有更改颜色，开关物体之类的，<br>当然实际使用的情况还得考虑 target 是否会无效，以及物体从来没开过，却调用 NotifyValueChanged 之类的细节问题的。</p>
<img src="/2024/02/16/20240216-primitivebehaviour/20240216-primitivebehaviour-pic001.png" class="" title="split">
<img src="/2024/02/16/20240216-primitivebehaviour/20240216-primitivebehaviour-pic002.png" class="" title="split">
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core.UI</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">RequireComponent(typeof(Image))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SlicesImageFill</span> : <span class="title">FloatBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Fields"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Image m_target;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_reverse = <span class="literal">false</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 m_range = <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">1f</span>);</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_doTweenFill = <span class="literal">false</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> TweenParameter m_tweenParameter;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Tween m_currentTween;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">NotifyValueChanged</span>(<span class="params"><span class="keyword">float</span> nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_currentTween?.Kill();</span><br><span class="line">            <span class="keyword">float</span> targetFill = CalculateFillValue(nextValue);</span><br><span class="line">            <span class="keyword">if</span> (instant || !m_doTweenFill)</span><br><span class="line">            &#123;</span><br><span class="line">                m_target.fillAmount = targetFill;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            m_currentTween = m_target.DOFillAmount(targetFill, m_tweenParameter.duration);</span><br><span class="line">            m_currentTween.ApplyParam(m_tweenParameter);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">float</span> <span class="title">CalculateFillValue</span>(<span class="params"><span class="keyword">float</span> rawValue</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> Mathf.Lerp(m_range.x, m_range.y, m_reverse ? <span class="number">1</span> - rawValue : rawValue);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDestroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_currentTween?.Kill();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_target = GetComponent&lt;Image&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BoolReactorObjectActive</span> : <span class="title">BoolBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Serializable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">struct</span> ObjectActivePack</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> GameObject target;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">bool</span> inverse;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Extra param"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> ObjectActivePack[] m_packs;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">NotifyValueChanged</span>(<span class="params"><span class="keyword">bool</span> <span class="keyword">value</span>, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, length = m_packs.Length; i &lt; length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                ObjectActivePack pack = m_packs[i];</span><br><span class="line">                pack.target.SetActive(pack.inverse ? !<span class="keyword">value</span> : <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/10/15/20231015-psd-complexlayer-export/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="2C2C2C2">
      <meta itemprop="description" content="随便记录一些东西">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FishPlayer">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/15/20231015-psd-complexlayer-export/" class="post-title-link" itemprop="url">UGUI PSD智能对象导图小记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-10-15 12:43:02 / 修改时间：14:15:00" itemprop="dateCreated datePublished" datetime="2023-10-15T12:43:02+08:00">2023-10-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UGUI/" itemprop="url" rel="index"><span itemprop="name">UGUI</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>当前的项目里因为UI缺乏UI美术人，没有人力导图拼图，所以使用了<a href="https://github.com/zouhunter/unity-psd-ugui" target="_blank" rel="noopener">PSD2UGUI</a>插件。这个插件又依赖一个分析PSD的解析库<a href="https://github.com/NtreevSoft/psd-parser/tree/master" target="_blank" rel="noopener">psd-parser</a>。<br>这俩东西都已经有点老旧了，美术那边遇到了一个问题，他们做的智能对象图层不能正确导出。</p>
<img src="/2023/10/15/20231015-psd-complexlayer-export/20231015-psd-complexlayer-export-pic001.png" class="" title="split">
<p>直接用文字有点难描述，大概是这样的。他们做的智能对象大小就和图里这个黑底一样大，但实际有图案部分就像红框里的那样，不会占满整个智能对象的区域。<br>用工具导出Sprite的时候，只会导出红框的大小。</p>
<hr>
<p>解决方法比较简单粗暴了，因为<a href="https://github.com/NtreevSoft/psd-parser/tree/master" target="_blank" rel="noopener">psd-parser</a>似乎不能很方便拿到智能对象的实际的区域尺寸，我只能让美术多做一个和需要导出的只能对象尺寸大小一样的纯色空图层。<br>同时新增两个后缀规则，让这个纯色空图层和需要依照智能对象尺寸导出的图层分别使用。</p>
<p>在<a href="https://github.com/zouhunter/unity-psd-ugui" target="_blank" rel="noopener">PSD2UGUI</a>中根据图层生成Texture的代码中添加后缀检查,检测到特殊规则的时候去去根据特殊的纯色图层的尺寸再去重新绘制Texture。同时在<a href="https://github.com/zouhunter/unity-psd-ugui" target="_blank" rel="noopener">PSD2UGUI</a>中根据图层创建他的ImageNode的时候有个Rect需要计算，这个Rect计算也要修改。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/07/30/20230730-ui-safe-area-rect/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="2C2C2C2">
      <meta itemprop="description" content="随便记录一些东西">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FishPlayer">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/30/20230730-ui-safe-area-rect/" class="post-title-link" itemprop="url">UGUI SafeArea 适配</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-07-30 16:21:00" itemprop="dateCreated datePublished" datetime="2023-07-30T16:21:00+08:00">2023-07-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-08-12 16:03:49" itemprop="dateModified" datetime="2023-08-12T16:03:49+08:00">2023-08-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UGUI/" itemprop="url" rel="index"><span itemprop="name">UGUI</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近有在做手游。各个厂商手机屏幕的尺寸和比例都各不相同。UI适配可以说是一大难题叻。UI美术那边在制作的也有考虑到适配方面的问题，有许多元素是需要我们根据安全区来适配的。<br>但比较坑爹的一些情况是这样的，要求页面A下方有个按钮托盘，按钮托盘打开的时候要有一个大图背景去阻挡玩家点击原本页面A上的元素。这个按钮托盘还是在其他页面中也有用到的。为了解决这个问题，做了两个Rect适配的脚本。<br>还没完成，但是感觉基本能用，就先拉上来记一下。</p>
<p>这两个脚本都依赖与当前UI使用的相机和根Canvas。所以在实际使用的时候需要准备好这两个东西。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">UIAreaRect</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">Camera <span class="title">GetUICamera</span>(<span class="params"></span>)</span>;</span><br><span class="line">        <span class="function">Canvas <span class="title">GetRootCanvas</span>(<span class="params"></span>)</span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Refresh</span>(<span class="params"></span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">ExecuteAlways</span>]</span><br><span class="line">    [<span class="meta">RequireComponent(typeof(RectTransform))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SafeAreaRect</span> : <span class="title">UIBehaviour</span>, <span class="title">ILayoutSelfController</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Vector2 s_specialPivot = Vector2.zero; <span class="comment">// HACK @Hiko self pivot</span></span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> RectOffset _rectOffset = <span class="keyword">new</span> RectOffset();</span><br><span class="line"></span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Camera _uiCamera;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Canvas _rootCanvas;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> RectTransform m_rect;</span><br><span class="line">        <span class="keyword">private</span> DrivenRectTransformTracker m_tracker;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> RectTransform selfRectTransform</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_rect == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_rect = GetComponent&lt;RectTransform&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> m_rect;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetLayoutHorizontal</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Refresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetLayoutVertical</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Refresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"Refresh"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Refresh</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">            RebuildTracker();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            Camera uiCamera = GetUICamera();</span><br><span class="line">            RectTransform rectTransform = selfRectTransform, rootCanvasRectTransform = rootCanvas.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            RectTransform parent = rectTransform.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            <span class="keyword">if</span> (parent == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">"This behaviour can not to be used on root recttransform"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rootCanvas == <span class="literal">null</span> || uiCamera == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Rect safeRect = CalcultateCurrentSafeAreaRect();</span><br><span class="line">            rectTransform.pivot = s_specialPivot;</span><br><span class="line">            Vector3 worldUIPos;</span><br><span class="line">            Vector2 localPos = rootCanvasRectTransform.GetLocalRectPosition(RectPositionType.BottomLeft);</span><br><span class="line">            localPos.x += safeRect.x + _rectOffset.left;</span><br><span class="line">            <span class="keyword">float</span> deltaX = _rectOffset.horizontal;</span><br><span class="line">            rectTransform.SetSizeWithCurrentAnchors(RectTransform.Axis.Horizontal, safeRect.width - deltaX);</span><br><span class="line">            localPos.y += safeRect.y + _rectOffset.bottom;</span><br><span class="line">            <span class="keyword">float</span> deltaY = _rectOffset.vertical;</span><br><span class="line">            rectTransform.SetSizeWithCurrentAnchors(RectTransform.Axis.Vertical, safeRect.height - deltaY);</span><br><span class="line">            worldUIPos = rootCanvasRectTransform.TransformPoint(localPos);</span><br><span class="line">            rectTransform.position = worldUIPos;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Camera <span class="title">GetUICamera</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// TODO implement the actual code to get camera while in game or in editor </span></span><br><span class="line">            <span class="keyword">return</span> _uiCamera;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Canvas <span class="title">GetRootCanvas</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// TODO implement the actual code to get root canvas while in game or in editor </span></span><br><span class="line">            <span class="keyword">return</span> _rootCanvas;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Rect <span class="title">CalcultateCurrentSafeAreaRect</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Rect safeRect;</span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            RectTransform rootRectTransform = rootCanvas.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Rect rootCanvasRect = rootRectTransform.rect;</span><br><span class="line">            <span class="keyword">float</span> rootCanvasWidth = rootCanvasRect.width;</span><br><span class="line">            <span class="keyword">float</span> rootCanvasHeight = rootCanvasRect.height;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// temp pretend it is ip12</span></span><br><span class="line">            <span class="keyword">float</span> horizontalGap = <span class="number">0.055f</span>;</span><br><span class="line">            <span class="keyword">float</span> verticalGap = <span class="number">0.053f</span>;</span><br><span class="line">            <span class="keyword">switch</span> (SystemInfo.deviceType)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> DeviceType.Handheld:</span><br><span class="line">                    Rect deviceSafeRect = Screen.safeArea;</span><br><span class="line">                    <span class="keyword">if</span> (Mathf.Approximately(deviceSafeRect.x, <span class="number">0f</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// a device with saferect as fullrect</span></span><br><span class="line">                        safeRect = <span class="keyword">new</span> Rect(<span class="keyword">new</span> Vector2(rootCanvasWidth * horizontalGap, <span class="number">0f</span>), <span class="keyword">new</span> Vector2(rootCanvasWidth * (<span class="number">1f</span> - <span class="number">2</span> * horizontalGap), rootCanvasHeight * (<span class="number">1f</span> - verticalGap)));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        Resolution resolution = Screen.currentResolution;</span><br><span class="line">                        <span class="keyword">float</span> scale = rootCanvasWidth / resolution.width;</span><br><span class="line">                        safeRect = <span class="keyword">new</span> Rect(deviceSafeRect.x * scale, deviceSafeRect.y * scale, deviceSafeRect.width * scale, deviceSafeRect.height * scale);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="comment">// HACK @Hiko it's on PC, create a temp saferect and pretend it is ip12</span></span><br><span class="line">                    safeRect = <span class="keyword">new</span> Rect(<span class="keyword">new</span> Vector2(rootCanvasWidth * horizontalGap, <span class="number">0f</span>), <span class="keyword">new</span> Vector2(rootCanvasWidth * (<span class="number">1f</span> - <span class="number">2</span> * horizontalGap), rootCanvasHeight * (<span class="number">1f</span> - verticalGap)));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> safeRect;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RebuildTracker</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_tracker.Clear();</span><br><span class="line">            m_tracker.Add(<span class="keyword">this</span>, selfRectTransform, DrivenTransformProperties.All);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">base</span>.OnEnable();</span><br><span class="line">            RebuildTracker();</span><br><span class="line">            SetDirty();</span><br><span class="line">            <span class="keyword">if</span> (Application.isPlaying)</span><br><span class="line">            &#123;</span><br><span class="line">                Refresh();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDisable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_tracker.Clear();</span><br><span class="line">            LayoutRebuilder.MarkLayoutForRebuild(selfRectTransform);</span><br><span class="line">            <span class="keyword">base</span>.OnDisable();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetDirty</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsActive())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            LayoutRebuilder.MarkLayoutForRebuild(selfRectTransform);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Editor readonly debug stuff"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Rect _editorSafeRect;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _editorCurrentResolution;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _editorScreenSize;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> _editorScreenFactor;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> _editorScreenDpi;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> _editorCanvasFactor;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Rect _editorRootCanvasRect;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDrawGizmosSelected</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            UpdateEditorPreviewData();</span><br><span class="line">            Color color = Color.blue;</span><br><span class="line">            Rect safeRect = CalcultateCurrentSafeAreaRect();</span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            RectTransform rootRectTransform = rootCanvas.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Vector2 bottomLeft = rootRectTransform.GetLocalRectPosition(RectPositionType.BottomLeft);</span><br><span class="line">            bottomLeft.x += safeRect.x;</span><br><span class="line">            bottomLeft.y += safeRect.y;</span><br><span class="line">            DrawBox(rootRectTransform, bottomLeft, safeRect.size, color);</span><br><span class="line">            <span class="comment">// draw safe area end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Mathf.Approximately(_rectOffset.horizontal, <span class="number">0f</span>) &amp;&amp; Mathf.Approximately(_rectOffset.vertical, <span class="number">0f</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Rect nextRect = safeRect;</span><br><span class="line">            nextRect.width -= _rectOffset.horizontal;</span><br><span class="line">            nextRect.height -= _rectOffset.vertical;</span><br><span class="line">            nextRect.x += _rectOffset.left;</span><br><span class="line">            nextRect.y += _rectOffset.bottom;</span><br><span class="line">            bottomLeft = rootRectTransform.GetLocalRectPosition(RectPositionType.BottomLeft);</span><br><span class="line">            bottomLeft.x += nextRect.x;</span><br><span class="line">            bottomLeft.y += nextRect.y;</span><br><span class="line">            color.a *= <span class="number">0.8f</span>;</span><br><span class="line">            DrawBox(rootRectTransform, bottomLeft, nextRect.size, color);</span><br><span class="line">            <span class="comment">// draw actual safe area end</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawBox</span>(<span class="params">RectTransform reference, Vector2 bottomLeftLocalPos, Vector2 size, Color color</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Color cachedColor = Gizmos.color;</span><br><span class="line">            Gizmos.color = color;</span><br><span class="line">            <span class="keyword">if</span> (reference != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos), reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x));</span><br><span class="line">                Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos), reference.TransformPoint(bottomLeftLocalPos + Vector2.up * size.y));</span><br><span class="line">                Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x), reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x + Vector2.up * size.y));</span><br><span class="line">                Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos + Vector2.up * size.y), reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x + Vector2.up * size.y));</span><br><span class="line">            &#125;</span><br><span class="line">            Gizmos.color = cachedColor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateEditorPreviewData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            _editorSafeRect = CalcultateCurrentSafeAreaRect();</span><br><span class="line">            _editorScreenSize = <span class="keyword">new</span> Vector2(Screen.width, Screen.height);</span><br><span class="line">            _editorCurrentResolution = <span class="keyword">new</span> Vector2(Screen.currentResolution.width, Screen.currentResolution.height);</span><br><span class="line">            _editorScreenFactor = Screen.currentResolution.width / Screen.width;</span><br><span class="line">            _editorScreenDpi = Screen.dpi;</span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            <span class="keyword">if</span> (rootCanvas != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _editorCanvasFactor = rootCanvas.scaleFactor;</span><br><span class="line">                _editorRootCanvasRect = (rootCanvas.transform <span class="keyword">as</span> RectTransform).rect;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     [<span class="meta">ExecuteAlways</span>]</span><br><span class="line">    [<span class="meta">RequireComponent(typeof(RectTransform))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ScreenRawRect</span> : <span class="title">UIBehaviour</span>, <span class="title">ILayoutSelfController</span>, <span class="title">UIAreaRect</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Vector2 s_specialPivot = Vector2.zero; <span class="comment">// HACK @Hiko self pivot</span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> RectOffset _rectOffset = <span class="keyword">new</span> RectOffset();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> RectTransform m_rect;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> RectTransform selfRectTransform</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_rect == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_rect = GetComponent&lt;RectTransform&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> m_rect;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// temp solution for testing</span></span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Camera m_uiCamera;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Canvas m_rootCanvas;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> DrivenRectTransformTracker m_tracker;</span><br><span class="line">        <span class="keyword">private</span> RectTransform m_rectTransform;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> RectTransform rectTransform</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_rectTransform == <span class="literal">null</span>)</span><br><span class="line">                    m_rectTransform = GetComponent&lt;RectTransform&gt;();</span><br><span class="line">                <span class="keyword">return</span> m_rectTransform;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetLayoutHorizontal</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Refresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetLayoutVertical</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Refresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"Refresh"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Refresh</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Camera uiCamera = GetUICamera();</span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            RectTransform rootCanvasRectTransform = rootCanvas.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Rect sizeRect = rootCanvasRectTransform.rect;</span><br><span class="line">            RectTransform selfRectTransform = rectTransform;</span><br><span class="line">            selfRectTransform.pivot = s_specialPivot;</span><br><span class="line">            Vector3 worldUIPos = RectTransformEx.ScreenToWorld(Vector2.zero, rootCanvas, uiCamera);</span><br><span class="line">            selfRectTransform.position = worldUIPos;</span><br><span class="line">            Vector2 localPos = selfRectTransform.localPosition;</span><br><span class="line">            <span class="keyword">float</span> leftOffset = _rectOffset.left;</span><br><span class="line">            localPos.x += leftOffset;</span><br><span class="line">            <span class="keyword">float</span> deltaX = _rectOffset.horizontal;</span><br><span class="line">            selfRectTransform.SetSizeWithCurrentAnchors(RectTransform.Axis.Horizontal, sizeRect.width - deltaX);</span><br><span class="line">            <span class="keyword">float</span> bottomOffset = _rectOffset.bottom;</span><br><span class="line">            localPos.y += bottomOffset;</span><br><span class="line">            <span class="keyword">float</span> deltaY = _rectOffset.vertical;</span><br><span class="line">            selfRectTransform.SetSizeWithCurrentAnchors(RectTransform.Axis.Vertical, sizeRect.height - deltaY);</span><br><span class="line">            selfRectTransform.localPosition = localPos;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Camera <span class="title">GetUICamera</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_uiCamera;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Canvas <span class="title">GetRootCanvas</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_rootCanvas;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetDirty</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsActive())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            LayoutRebuilder.MarkLayoutForRebuild(rectTransform);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RebuildTracker</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_tracker.Clear();</span><br><span class="line">            m_tracker.Add(<span class="keyword">this</span>, selfRectTransform, DrivenTransformProperties.All);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">base</span>.OnEnable();</span><br><span class="line">            RebuildTracker();</span><br><span class="line">            SetDirty();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDisable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_tracker.Clear();</span><br><span class="line">            LayoutRebuilder.MarkLayoutForRebuild(rectTransform);</span><br><span class="line">            <span class="keyword">base</span>.OnDisable();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Editor readonly debug stuff"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _editorCurrentResolution;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _editorScreenSize;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> _editorScreenFactor;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> _editorScreenDpi;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> _editorCanvasFactor;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Rect _editorRootCanvasRect;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDrawGizmosSelected</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Color color = Color.blue;</span><br><span class="line">            UpdateEditorPreviewData();</span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            RectTransform rootRectTransform = rootCanvas.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Rect rect = rootRectTransform.rect;</span><br><span class="line">            Vector2 bottomLeft = rootRectTransform.GetLocalRectPosition(RectPositionType.BottomLeft);</span><br><span class="line">            DrawBox(rootRectTransform, bottomLeft, <span class="keyword">new</span> Vector2(rect.width, rect.height), color);</span><br><span class="line">            <span class="comment">// draw raw rect</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Mathf.Approximately(_rectOffset.horizontal, <span class="number">0f</span>) &amp;&amp; Mathf.Approximately(_rectOffset.vertical, <span class="number">0f</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            rect.width -= _rectOffset.horizontal;</span><br><span class="line">            rect.height -= _rectOffset.vertical;</span><br><span class="line">            bottomLeft.x += _rectOffset.left;</span><br><span class="line">            bottomLeft.y += _rectOffset.bottom;</span><br><span class="line">            DrawBox(rootRectTransform, bottomLeft, <span class="keyword">new</span> Vector2(rect.width, rect.height), color);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawBox</span>(<span class="params">RectTransform reference, Vector2 bottomLeftLocalPos, Vector2 size, Color color</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Color cachedColor = Gizmos.color;</span><br><span class="line">            Gizmos.color = color;</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos), reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x));</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos), reference.TransformPoint(bottomLeftLocalPos + Vector2.up * size.y));</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x), reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x + Vector2.up * size.y));</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos + Vector2.up * size.y), reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x + Vector2.up * size.y));</span><br><span class="line">            Gizmos.color = cachedColor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateEditorPreviewData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            _editorScreenSize = <span class="keyword">new</span> Vector2(Screen.width, Screen.height);</span><br><span class="line">            _editorCurrentResolution = <span class="keyword">new</span> Vector2(Screen.currentResolution.width, Screen.currentResolution.height);</span><br><span class="line">            _editorScreenFactor = Screen.currentResolution.width / Screen.width;</span><br><span class="line">            _editorScreenDpi = Screen.dpi;</span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            <span class="keyword">if</span> (rootCanvas != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _editorCanvasFactor = rootCanvas.scaleFactor;</span><br><span class="line">                _editorRootCanvasRect = (rootCanvas.transform <span class="keyword">as</span> RectTransform).rect;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">RectTransformEx</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">GetLocalRectPosition</span>(<span class="params"><span class="keyword">this</span> RectTransform target, RectPositionType offsetType</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Vector3 result = Vector3.zero;</span><br><span class="line">            Vector2 targetSize = target.rect.size;</span><br><span class="line">            Vector2 targetPivot = target.pivot;</span><br><span class="line"></span><br><span class="line">            Vector2 pivotOffset = Vector2.one * <span class="number">0.5f</span> - targetPivot;</span><br><span class="line">            pivotOffset.x *= targetSize.x;</span><br><span class="line">            pivotOffset.y *= targetSize.y;</span><br><span class="line"></span><br><span class="line">            result += (Vector3)pivotOffset;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (offsetType)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Top:</span><br><span class="line">                    result.y += targetSize.y * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Bottom:</span><br><span class="line">                    result.y -= targetSize.y * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Left:</span><br><span class="line">                    result.x -= targetSize.x * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Right:</span><br><span class="line">                    result.x += targetSize.x * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> RectPositionType.TopLeft:</span><br><span class="line">                    result.y += targetSize.y * <span class="number">0.5f</span>;</span><br><span class="line">                    result.x -= targetSize.x * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.TopRight:</span><br><span class="line">                    result.y += targetSize.y * <span class="number">0.5f</span>;</span><br><span class="line">                    result.x += targetSize.x * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> RectPositionType.BottomLeft:</span><br><span class="line">                    result.y -= targetSize.y * <span class="number">0.5f</span>;</span><br><span class="line">                    result.x -= targetSize.x * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> RectPositionType.BottomRight:</span><br><span class="line">                    result.y -= targetSize.y * <span class="number">0.5f</span>;</span><br><span class="line">                    result.x += targetSize.x * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">ScreenToWorld</span>(<span class="params">Vector2 screenPoint, Canvas rootCanvas, Camera uiCamera</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">switch</span> (rootCanvas.renderMode)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> RenderMode.ScreenSpaceOverlay:</span><br><span class="line">                    <span class="keyword">return</span> screenPoint;</span><br><span class="line">                <span class="keyword">case</span> RenderMode.ScreenSpaceCamera:</span><br><span class="line">                    RectTransformUtility.ScreenPointToWorldPointInRectangle((RectTransform)rootCanvas.transform, screenPoint, uiCamera, <span class="keyword">out</span> Vector3 worldPoint);</span><br><span class="line">                    <span class="keyword">return</span> worldPoint;</span><br><span class="line">                <span class="keyword">case</span> RenderMode.WorldSpace:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> System.NotImplementedException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<img src="/2023/07/30/20230730-ui-safe-area-rect/20230730-ui-safe-area-rect-pic001.png" class="" title="split">
<p>最开始做的时候我很粗心的直接把 Screen.SafeArea 的大小直接给应用到 RectTransform 上了。后来发现这样是不对的，Screen.SafeArea 获取到的是实际的物理尺寸的安全区。<br>后来我是算出物理尺寸和根Canvas尺寸的笔直，再去计算出实际的RectTransform大小。</p>
<p>基本上可以凑合使用了。还比较遗憾的一点是，我没有能够让其支持只适配四个方向中的任1或者任2方向。比较简单的解决方法就是让不同适配的RectTransform互相套一下。</p>
<p>UI同学在调整动效以及物体布局的时候，会用Unity中的Device Simulator尝试切换不同的机型来查看不同设备上的UI 预览。这个时候可能需要有一个编辑器的监听器去监听设备变更的事件，然后发起全部UI尺寸刷新的请求。<br>这样会更方便他们做预览。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/07/23/20230723-int-draw-as-enum/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="2C2C2C2">
      <meta itemprop="description" content="随便记录一些东西">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FishPlayer">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/23/20230723-int-draw-as-enum/" class="post-title-link" itemprop="url">Unity编辑器中以enum的方式绘制int</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-07-23 17:34:10" itemprop="dateCreated datePublished" datetime="2023-07-23T17:34:10+08:00">2023-07-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-25 00:07:44" itemprop="dateModified" datetime="2023-07-25T00:07:44+08:00">2023-07-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnityEditor/" itemprop="url" rel="index"><span itemprop="name">UnityEditor</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>项目里的UI框架有非常方便实用的数据绑定功能。各种UI表现件也可以根据数据集里的某个int改变UI表现。但是比较逆天的是我们经常把enum转int然后再到表现件上去调对应的各种状态。<br>对着magic number调配置确实很让人苦恼。</p>
<p>思路就是再需要根据int来调偶配置的component上添加一个编辑器里专用的Type对象，然后根据这个对象类型去画int。基于Odin做的，但我觉得这个思路应该还不错。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="comment">// use a string to temply store the type</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">AttributeUsage(AttributeTargets.Field)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnumTypeQualifiedName</span>: <span class="title">Attribute</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DrawerPriority(DrawerPriorityLevel.WrapperPriority)</span>]</span><br><span class="line">    public class EnumTypeQualifiedNameAttributeDrawer : OdinAttributeDrawer&lt;EnumTypeQualifiedName, string&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title">EditingState</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;Type&gt; tempQuery;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">bool</span> wannaSet = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">public</span> Type selectedType = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DrawPropertyLayout</span>(<span class="params">GUIContent label</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">string</span> currentName = <span class="keyword">this</span>.ValueEntry.SmartValue;</span><br><span class="line">            Type enumType = <span class="keyword">string</span>.IsNullOrEmpty(currentName) ? <span class="literal">null</span> : Type.GetType(currentName);</span><br><span class="line">            <span class="keyword">string</span> enumTypeNiceName = enumType == <span class="literal">null</span> ? <span class="string">"invalid!!!"</span> : enumType.GetNiceName();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> controlId = GUIUtility.GetControlID(FocusType.Passive);</span><br><span class="line">            EditingState state = GUIUtility.GetStateObject(<span class="keyword">typeof</span>(EditingState), controlId) <span class="keyword">as</span> EditingState;</span><br><span class="line">            <span class="keyword">if</span> (state.wannaSet)</span><br><span class="line">            &#123;</span><br><span class="line">                currentName = state.selectedType.AssemblyQualifiedName;</span><br><span class="line">                state.selectedType = <span class="literal">null</span>;</span><br><span class="line">                state.wannaSet = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">this</span>.ValueEntry.SmartValue = currentName;</span><br><span class="line">            &#125;</span><br><span class="line">            EditorGUILayout.BeginVertical();</span><br><span class="line">            GUIStyle guiStyle = <span class="keyword">new</span> GUIStyle(EditorStyles.label);</span><br><span class="line">            guiStyle.alignment = TextAnchor.MiddleLeft;</span><br><span class="line">            EditorGUILayout.LabelField(<span class="keyword">this</span>.Property.NiceName, guiStyle);</span><br><span class="line"></span><br><span class="line">            guiStyle = <span class="keyword">new</span> GUIStyle(EditorStyles.popup);</span><br><span class="line">            guiStyle.alignment = TextAnchor.MiddleLeft;</span><br><span class="line">            <span class="keyword">if</span> (EditorGUILayout.DropdownButton(<span class="keyword">new</span> GUIContent(<span class="string">$"Preview Enum Type (<span class="subst">&#123;enumTypeNiceName&#125;</span>)"</span>), FocusType.Keyboard, guiStyle))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (EditingState.tempQuery == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    EditingState.tempQuery = GetTargetEnumTypes();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                TypeSelector selector = <span class="keyword">new</span> TypeSelector(EditingState.tempQuery, <span class="literal">false</span>);</span><br><span class="line">                selector.EnableSingleClickToSelect();</span><br><span class="line">                selector.ShowInPopup();</span><br><span class="line">                selector.SelectionConfirmed += selection =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> resultTypeArray = selection.ToArray();</span><br><span class="line">                    <span class="keyword">if</span> (resultTypeArray.Length &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Type selectedType = resultTypeArray.GetValue(<span class="number">0</span>) <span class="keyword">as</span> Type;</span><br><span class="line">                        EditingState state = GUIUtility.GetStateObject(<span class="keyword">typeof</span>(EditingState), controlId) <span class="keyword">as</span> EditingState;</span><br><span class="line">                        state.selectedType = selectedType;</span><br><span class="line">                        state.wannaSet = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            EditorGUILayout.EndVertical();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IEnumerable&lt;Type&gt; <span class="title">GetTargetEnumTypes</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// TODO @Hiko here to get actual enum types</span></span><br><span class="line">            TypeCache.TypeCollection cache = TypeCache.GetTypesDerivedFrom&lt;Enum&gt;();</span><br><span class="line">            <span class="keyword">var</span> query = cache.Where(t =&gt; t.IsEnum &amp;&amp; t.IsPublic);</span><br><span class="line">            <span class="keyword">return</span> query;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// put temply data into a sturct </span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> IntAsEnumEditorPack</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> showIntAsEnumForTaggedField;</span><br><span class="line">        [<span class="meta">EnumTypeQualifiedName</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> enumTypeQualifiedName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IIntAsEnumPackHolder</span></span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        IntAsEnumEditorPack holderData &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// draw enum popup for int</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">AttributeUsage(AttributeTargets.Field)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IntAsEnumAttribute</span> : <span class="title">Attribute</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DrawerPriority(DrawerPriorityLevel.WrapperPriority)</span>]</span><br><span class="line">    public class IntAsEnumAttributeDrawer : OdinAttributeDrawer&lt;IntAsEnumAttribute, int&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DrawPropertyLayout</span>(<span class="params">GUIContent label</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> nextValue, prevValue = <span class="keyword">this</span>.ValueEntry.SmartValue;</span><br><span class="line">            InspectorProperty containerProterty = <span class="keyword">this</span>.ValueEntry.Property;</span><br><span class="line">            Type holderType = <span class="keyword">typeof</span>(IIntAsEnumPackHolder);</span><br><span class="line">            Type containerType = containerProterty.ParentType;</span><br><span class="line">            <span class="keyword">bool</span> doContinue = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">while</span> (doContinue)</span><br><span class="line">            &#123;</span><br><span class="line">                Type parentType = containerProterty.ParentType;</span><br><span class="line">                <span class="keyword">if</span> (parentType == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                containerType = parentType;</span><br><span class="line">                containerProterty = containerProterty.Parent;</span><br><span class="line">                <span class="keyword">if</span> (holderType.IsAssignableFrom(containerType))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            GUIStyle guiStyle = <span class="keyword">new</span> GUIStyle(EditorStyles.label);</span><br><span class="line">            guiStyle.alignment = TextAnchor.MiddleLeft;</span><br><span class="line">            <span class="keyword">if</span> (containerType != <span class="literal">null</span> &amp;&amp; holderType.IsAssignableFrom(containerType))</span><br><span class="line">            &#123;</span><br><span class="line">                IIntAsEnumPackHolder holder = containerProterty.ValueEntry.WeakSmartValue <span class="keyword">as</span> IIntAsEnumPackHolder;</span><br><span class="line">                IntAsEnumEditorPack packData = holder.holderData;</span><br><span class="line">                <span class="keyword">if</span> (packData.showIntAsEnumForTaggedField)</span><br><span class="line">                &#123;</span><br><span class="line">                    EditorGUILayout.BeginVertical();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="keyword">this</span>.Property.NiceName, guiStyle);</span><br><span class="line">                    Type enumType = <span class="keyword">string</span>.IsNullOrEmpty(packData.enumTypeQualifiedName) ? <span class="literal">null</span> : Type.GetType(packData.enumTypeQualifiedName);</span><br><span class="line">                    <span class="keyword">if</span> (enumType != <span class="literal">null</span> &amp;&amp; enumType.IsEnum)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Enum prevEnumValue;</span><br><span class="line">                        <span class="keyword">if</span> (!enumType.IsEnumDefined(prevValue))</span><br><span class="line">                        &#123;</span><br><span class="line">                            prevEnumValue = Enum.GetValues(enumType).GetValue(<span class="number">0</span>) <span class="keyword">as</span> Enum;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            prevEnumValue = (Enum)Enum.ToObject(enumType, prevValue);</span><br><span class="line">                        &#125;</span><br><span class="line">                        guiStyle = <span class="keyword">new</span> GUIStyle(EditorStyles.popup);</span><br><span class="line">                        guiStyle.stretchWidth = <span class="literal">false</span>;</span><br><span class="line">                        guiStyle.alignment = TextAnchor.MiddleLeft;</span><br><span class="line">                        Enum nextEnumValue = EditorGUILayout.EnumPopup(prevEnumValue, guiStyle);</span><br><span class="line">                        nextValue = Convert.ToInt32(nextEnumValue);</span><br><span class="line">                        <span class="keyword">this</span>.ValueEntry.SmartValue = nextValue;</span><br><span class="line">                        guiStyle = <span class="keyword">new</span> GUIStyle(EditorStyles.label);</span><br><span class="line">                        guiStyle.alignment = TextAnchor.MiddleLeft;</span><br><span class="line">                        guiStyle.stretchWidth = <span class="literal">false</span>;</span><br><span class="line">                        EditorGUILayout.LabelField(<span class="string">$"int value: (<span class="subst">&#123;nextValue&#125;</span>)"</span>, guiStyle);</span><br><span class="line">                    &#125;</span><br><span class="line">                    EditorGUILayout.EndVertical();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// can not find the target preview enum type, draw normal int field</span></span><br><span class="line">            EditorGUILayout.BeginHorizontal();</span><br><span class="line">            EditorGUILayout.LabelField(<span class="keyword">this</span>.Property.NiceName);</span><br><span class="line">            nextValue = EditorGUILayout.IntField(prevValue);</span><br><span class="line">            <span class="keyword">this</span>.ValueEntry.SmartValue = nextValue;</span><br><span class="line">            EditorGUILayout.EndHorizontal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// test case</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TesterA</span> : <span class="title">MonoBehaviour</span>, <span class="title">IIntAsEnumPackHolder</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> IntAsEnumEditorPack intAsEnumEditorPack;</span><br><span class="line">        <span class="keyword">public</span> IntAsEnumEditorPack holderData =&gt; intAsEnumEditorPack;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">Serializable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">struct</span> TempStructA</span><br><span class="line">        &#123;</span><br><span class="line">            [<span class="meta">IntAsEnum</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">int</span> tempInt;</span><br><span class="line">            <span class="keyword">public</span> Color tempColor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> TempStructA[] tempArray;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">IntAsEnum</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> tempIntA;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>效果如下<br><img src="/2023/07/23/20230723-int-draw-as-enum/20230723-int-draw-as-enum-pic001.png" class="" title="split"></p>
<p>用起来是方便了，但是也引入了一个问题。这个做法会需要序列化一这两个小小的字段到物体上。导致Prefab变肥了，但感觉打包的时候打出来的prefab里应该不会包含这俩字段，应该还凑合啦。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/07/09/20230709-dictionary-enum-boxing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="2C2C2C2">
      <meta itemprop="description" content="随便记录一些东西">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FishPlayer">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/09/20230709-dictionary-enum-boxing/" class="post-title-link" itemprop="url">CSharp字典使用enum的装箱</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-07-09 17:43:00 / 修改时间：18:14:09" itemprop="dateCreated datePublished" datetime="2023-07-09T17:43:00+08:00">2023-07-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSharp/" itemprop="url" rel="index"><span itemprop="name">CSharp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天看了下Unity官方2016年发的一个关于移动端小优化的一些分享视频。其中有一个关于把enum作为Dictionary中的key来使用时的boxing优化。</p>
<img src="/2023/07/09/20230709-dictionary-enum-boxing/20230709-dictionary-enum-boxing-01.png" class="" title="split">
<p>这个用法在我之前的项目里用得还挺多吧。直接上图看IL code。</p>
<img src="/2023/07/09/20230709-dictionary-enum-boxing/20230709-dictionary-enum-boxing-02.png" class="" title="split">
<p>Dictionary的增删查操作其实都会有用comparer.Equals()来判断是否相等的情况。<br>构建Dictionary时如果不传入指定的comparer，他会自己赋予一个’默认的’。这个默认的显然不适那么的友好。</p>
<img src="/2023/07/09/20230709-dictionary-enum-boxing/20230709-dictionary-enum-boxing-05.png" class="" title="split">
<p>我们创建一个comparer，然后直接看使用comparer和不使用的两种不同情况下的IL code。</p>
<img src="/2023/07/09/20230709-dictionary-enum-boxing/20230709-dictionary-enum-boxing-03.png" class="" title="split">
<img src="/2023/07/09/20230709-dictionary-enum-boxing/20230709-dictionary-enum-boxing-04.png" class="" title="split">
<p>很明显使用我们自己的comparer可以免去装箱的消耗。</p>
<p>后来我又拿到Unity里跑了一下看profiler。尝试跑了查询和添加，差距确实有，但是从Profiler中看结果，200万次的操作下，GC是差不多的，时间上使用comparer快了1300多ms。<br>说实在的觉得是我的测试方法有问题。而且我跑在桌面端，这样测试也不严谨。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/06/18/20230618-animating-layout-params/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="2C2C2C2">
      <meta itemprop="description" content="随便记录一些东西">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FishPlayer">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/18/20230618-animating-layout-params/" class="post-title-link" itemprop="url">Unity动画控制Layout参数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-06-18 10:29:43 / 修改时间：13:37:20" itemprop="dateCreated datePublished" datetime="2023-06-18T10:29:43+08:00">2023-06-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在实际制作UI的时候，为了完成一些排版设计，我们会经常用到Unity的布局(Layout)组件。甚至有些复杂的排版，我会用嵌套布局来实现。<br>UI美术人经常希望在这些布局上加上一些进场出场动画(甚至包括spacing变动)，但布局组件上的数值是没法在动画中修改的，怎么办呢？</p>
<h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2><p>在布局中添加一些空物体或是在布局外面套空物体。然后再使用Tween动画来完成UI美术们想要的那些进出场动画。<br>美术人不太喜欢的方法，因为有那么一点点不太方便和Animation直接一起预览，但如果整体进出场动画不依赖UnityAnimation且不是很复杂，这种方法完全够用。</p>
<h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2><p>用通过动画控制脚本上的可序列化的数值，再传递到布局组件上。<br>个人感觉这个方法也还不错，还能支持预览，UI美术更偏向于这一个解决方法。</p>
<p>但是在动画窗口里里看到的curve是锯齿状的，很奇怪。之后还需要看下如何才能像其他属性一样拉正常的曲线。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line">[<span class="meta">ExecuteAlways</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LayoutGroupTempAnimationParam</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> LayoutGroup _target;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _left;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _right;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _top;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _bottom;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Header(<span class="meta-string">"GridLayout must use GridSpacing"</span>)</span>]</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> _alsoControlSpacing;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _normalSpacing = <span class="number">0</span>;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> Vector2 _gridSpacing = Vector2.zero;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RectOffset m_targetPadding;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnDidApplyAnimationProperties</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_target == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ApplyPadding();</span><br><span class="line">        <span class="keyword">if</span> (_alsoControlSpacing)</span><br><span class="line">        &#123;</span><br><span class="line">            ApplySpacing();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// need to notify refresh</span></span><br><span class="line">        RectTransform rectTransform = <span class="keyword">this</span>.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">        LayoutRebuilder.MarkLayoutForRebuild(rectTransform);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyPadding</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_targetPadding = _target.padding;</span><br><span class="line">        <span class="keyword">if</span> (m_targetPadding != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_targetPadding.left = _left;</span><br><span class="line">            m_targetPadding.right = _right;</span><br><span class="line">            m_targetPadding.top = _top;</span><br><span class="line">            m_targetPadding.bottom = _bottom;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplySpacing</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_target <span class="keyword">is</span> HorizontalOrVerticalLayoutGroup layoutGroup)</span><br><span class="line">        &#123;</span><br><span class="line">            layoutGroup.spacing = _normalSpacing;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (_target <span class="keyword">is</span> GridLayoutGroup gridLayoutGroup)</span><br><span class="line">        &#123;</span><br><span class="line">            gridLayoutGroup.spacing = _gridSpacing;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnValidate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ApplyPadding();</span><br><span class="line">        <span class="keyword">if</span> (_alsoControlSpacing)</span><br><span class="line">        &#123;</span><br><span class="line">            ApplySpacing();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!Application.isPlaying)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// need to notify refresh</span></span><br><span class="line">            RectTransform rectTransform = <span class="keyword">this</span>.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            LayoutRebuilder.MarkLayoutForRebuild(rectTransform);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _target = <span class="keyword">this</span>.GetComponent&lt;LayoutGroup&gt;();</span><br><span class="line">        m_targetPadding = _target.padding;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2023/06/18/20230618-animating-layout-params/20230618-animating-layout-params-01.gif" class="" title="split">
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/06/17/20230617-editor-wwise-mute/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="2C2C2C2">
      <meta itemprop="description" content="随便记录一些东西">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FishPlayer">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/17/20230617-editor-wwise-mute/" class="post-title-link" itemprop="url">Unity编辑器内静音Wwise</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-17 10:15:00" itemprop="dateCreated datePublished" datetime="2023-06-17T10:15:00+08:00">2023-06-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-18 10:29:17" itemprop="dateModified" datetime="2023-06-18T10:29:17+08:00">2023-06-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnityEditor/" itemprop="url" rel="index"><span itemprop="name">UnityEditor</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>项目引入Wwise以后，相信蛮多人都和我一样，平时不想听游戏声音就想听歌捶码修BUG的。但是Unity原本的mute按钮没法直接直接对Wwise那边做操作。<br>一开始不知道是搜索引擎的使用姿势不对还是咋的，查了好久都没查出来。导师研究了一下弄了一个版，大家用了感觉都很不错，决定分享出来。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">EditorWwiseManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> m_isPaused = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">EditorWwiseManager</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        EditorApplication.update += OnUpdate;</span><br><span class="line">        EditorApplication.pauseStateChanged += OnPauseStateChanged;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnPauseStateChanged</span>(<span class="params">PauseState state</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (state)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> PauseState.Paused:</span><br><span class="line">                m_isPaused = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PauseState.Unpaused:</span><br><span class="line">                m_isPaused = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnUpdate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (EditorUtility.audioMasterMute &amp;&amp; !m_isPaused)</span><br><span class="line">        &#123;</span><br><span class="line">            AkSoundEngine.Suspend(<span class="literal">true</span>);</span><br><span class="line">            m_isPaused = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!EditorUtility.audioMasterMute &amp;&amp; m_isPaused)</span><br><span class="line">        &#123;</span><br><span class="line">            AkSoundEngine.WakeupFromSuspend();</span><br><span class="line">            m_isPaused = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就可以通过Editor SceneView上的mute按钮把Wwise静音，超级方便凹。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/05/01/20230501-list-pass-predicate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="2C2C2C2">
      <meta itemprop="description" content="随便记录一些东西">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FishPlayer">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/01/20230501-list-pass-predicate/" class="post-title-link" itemprop="url">传入Predicate的小事</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-05-01 14:16:03 / 修改时间：14:47:56" itemprop="dateCreated datePublished" datetime="2023-05-01T14:16:03+08:00">2023-05-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSharp/" itemprop="url" rel="index"><span itemprop="name">CSharp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>现在依旧是在项目里负责一些UI业务的编写。前段时间需要需要给游戏中的 popup提示 做一些简单的重构，正好发现了我一直以来都误解的一个小点，决定记下来。</p>
<p>业务的要求就是做那种会弹出来一会儿再消失的提示，比如道具获取之类的UI。</p>
<p>我的做法就是用一个list去存着当前的提示，并 tick 检查它们是否结束，然后移除已经结束的相关数据。<br>大概的用法如下。</p>
<img src="/2023/05/01/20230501-list-pass-predicate/20230501-pic001.png" class="" title="split">
<p>但其实啊，这个做法在 tick 是非常不好的。同事很快地通过 JetBrainsRider 查看 IL Code ，并告诉我，直接这样传入会每次都 new obj 。有比较大的消耗。<br>所以在这种需要<strong>经常</strong> tick 并且条件<strong>比较固定</strong>的情况下。我们可以创建好 predicate 然后直接重复使用(可以存在成员变量里，这里演示就直接存在本地变量里了)。</p>
<img src="/2023/05/01/20230501-list-pass-predicate/20230501-pic002.png" class="" title="split">
<p>最后附上测试代码和结果 测试 count 为 100000</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PredicateTempTest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> TempPack</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> tempValue;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Random s_random = <span class="keyword">new</span> Random(DateTime.Now.Millisecond);</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TempPack <span class="title">CreateTempPack</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            TempPack pack = <span class="keyword">default</span>;</span><br><span class="line">            <span class="keyword">if</span> (s_random == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                s_random = <span class="keyword">new</span> Random(DateTime.Now.Millisecond);</span><br><span class="line">            &#125;</span><br><span class="line">            pack.tempValue = s_random.Next(<span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">            <span class="keyword">return</span> pack;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;List&lt;TempPack&gt;&gt; s_tempListContainer = <span class="keyword">new</span> List&lt;List&lt;TempPack&gt;&gt;(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoTest</span>(<span class="params"><span class="keyword">int</span> tempCount</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        FillTestData(tempCount);</span><br><span class="line">        DoTestLambda();</span><br><span class="line">        DoTestPassMethod();</span><br><span class="line">        DoTestPassExistPredicate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FillTestData</span>(<span class="params"><span class="keyword">int</span> tempCount</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        s_tempListContainer.Clear();</span><br><span class="line">        s_tempListContainer.Capacity = tempCount;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tempCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;TempPack&gt; tempList = <span class="keyword">new</span> List&lt;TempPack&gt;(tempCount);</span><br><span class="line">            s_tempListContainer.Add(tempList);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; tempCount; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                tempList.Add(TempPack.CreateTempPack());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoTestLambda</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">""</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">"TestLambda start"</span>);</span><br><span class="line">        Stopwatch stopWatch = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">        stopWatch.Start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, containerSize = s_tempListContainer.Count; i &lt; containerSize; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;TempPack&gt; tempList = s_tempListContainer[i];</span><br><span class="line">            tempList.Find((existPack) =&gt; existPack.tempValue % <span class="number">5</span> == <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        stopWatch.Stop();</span><br><span class="line">        Console.WriteLine(<span class="string">$"TestLambda end, result_<span class="subst">&#123;stopWatch.ElapsedMilliseconds&#125;</span>ms"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoTestPassMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">""</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">"PassMethod start"</span>);</span><br><span class="line">        Stopwatch stopWatch = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">        stopWatch.Start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, containerSize = s_tempListContainer.Count; i &lt; containerSize; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;TempPack&gt; tempList = s_tempListContainer[i];</span><br><span class="line">            tempList.Find(CheckPack);</span><br><span class="line">        &#125;</span><br><span class="line">        stopWatch.Stop();</span><br><span class="line">        Console.WriteLine(<span class="string">$"PassMethod end, result_<span class="subst">&#123;stopWatch.ElapsedMilliseconds&#125;</span>ms"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoTestPassExistPredicate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">""</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">"PassExistPredicate start"</span>);</span><br><span class="line">        Stopwatch stopWatch = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">        stopWatch.Start();</span><br><span class="line">        Predicate&lt;TempPack&gt; predicate = <span class="keyword">new</span> Predicate&lt;TempPack&gt;(CheckPack);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, containerSize = s_tempListContainer.Count; i &lt; containerSize; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;TempPack&gt; tempList = s_tempListContainer[i];</span><br><span class="line">            tempList.Find(predicate);</span><br><span class="line">        &#125;</span><br><span class="line">        stopWatch.Stop();</span><br><span class="line">        Console.WriteLine(<span class="string">$"PassExistPredicate end, result_<span class="subst">&#123;stopWatch.ElapsedMilliseconds&#125;</span>ms"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">CheckPack</span>(<span class="params">TempPack pack</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> pack.tempValue % <span class="number">5</span> == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2023/05/01/20230501-list-pass-predicate/20230501-pic003.png" class="" title="split">
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/03/26/20230326-ui-element-positioning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="2C2C2C2">
      <meta itemprop="description" content="随便记录一些东西">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FishPlayer">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/26/20230326-ui-element-positioning/" class="post-title-link" itemprop="url">根据一个UI物体的位置摆放另一个UI物体</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-26 13:55:12" itemprop="dateCreated datePublished" datetime="2023-03-26T13:55:12+08:00">2023-03-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-08 23:08:21" itemprop="dateModified" datetime="2023-06-08T23:08:21+08:00">2023-06-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近在遇到了一个需求，要点击某个道具UI之后，显示一个小的关于该道具的信息框。<br>大概是入下图这个样子的。</p>
<img src="/2023/03/26/20230326-ui-element-positioning/20230326-pic001.png" class="" title="split">
<p>还好之前做过，于是乎直接修修补补腾过去。至于为什么要修补，是因为在之前的项目里虽然写了一些和RectTransform相关的一些utils，但都因为懒和菜，没有去维护。有重复的方法还有错误的方法，麻了。<br>这次说是修补，也稍微重写了一些和RectTransform相关的一些utils,也准备带进项目里看看有没有地方可以用的。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Temp</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> RectPositionType</span><br><span class="line">    &#123;</span><br><span class="line">        Center = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        Top = <span class="number">1</span>,</span><br><span class="line">        Bottom = <span class="number">2</span>,</span><br><span class="line">        Left = <span class="number">3</span>,</span><br><span class="line">        Right = <span class="number">4</span>,</span><br><span class="line"></span><br><span class="line">        TopLeft = <span class="number">5</span>,</span><br><span class="line">        TopRight = <span class="number">6</span>,</span><br><span class="line"></span><br><span class="line">        BottomLeft = <span class="number">7</span>,</span><br><span class="line">        BottomRight = <span class="number">8</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIElementPositionSetter</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Target setting"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> RectPositionType _targetRectPosition = RectPositionType.Center;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _targetPivot = Vector2.zero;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _extraOffset = Vector2.zero;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> RectOffset _adaptionOffset;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _doScreenAdaption;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Other setting"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> RectTransform _defaultBoundsCanvasTransform;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _adjustHorizontal = <span class="literal">true</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _adjustVertical = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetPosition</span>(<span class="params">RectTransform target</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            RectTransform self = transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Vector3 spawnPos = GetLocalRectPosition(self, _targetRectPosition);</span><br><span class="line">            spawnPos += <span class="keyword">new</span> Vector3(_extraOffset.x, _extraOffset.y, <span class="number">0f</span>);</span><br><span class="line">            spawnPos = self.localToWorldMatrix.MultiplyPoint(spawnPos);</span><br><span class="line">            target.pivot = _targetPivot;</span><br><span class="line">            target.position = spawnPos;</span><br><span class="line">            <span class="keyword">if</span> (_doScreenAdaption)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// HACK @Hiko force rebuild to make sure the size is correct</span></span><br><span class="line">                LayoutRebuilder.ForceRebuildLayoutImmediate(target);</span><br><span class="line">                DoAdaption(target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoAdaption</span>(<span class="params">RectTransform targetTransform</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_adjustHorizontal)</span><br><span class="line">            &#123;</span><br><span class="line">                AdjustHorizontal(targetTransform, _defaultBoundsCanvasTransform);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (_adjustVertical)</span><br><span class="line">            &#123;</span><br><span class="line">                AdjustVertical(targetTransform, _defaultBoundsCanvasTransform);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AdjustHorizontal</span>(<span class="params">RectTransform target, RectTransform outterBoundRectTransform</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Vector2 targetSize = target.rect.size;</span><br><span class="line">            Matrix4x4 targetLocalToWorld = target.localToWorldMatrix;</span><br><span class="line">            Matrix4x4 boundRectWorldToLocal = outterBoundRectTransform.worldToLocalMatrix;</span><br><span class="line">            Vector2 topLeftPos = GetLocalRectPosition(target, RectPositionType.TopLeft);</span><br><span class="line"></span><br><span class="line">            Vector3 checkWorldPoint = targetLocalToWorld.MultiplyPoint(topLeftPos + Vector2.down * targetSize.y * <span class="number">0.5f</span> + Vector2.left * _adaptionOffset.left);</span><br><span class="line">            Vector2 leftCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">            Vector2 leftCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Left);</span><br><span class="line">            <span class="keyword">bool</span> leftOut = leftCheckLocalPoint.x &lt; leftCheckBoundPoint.x;</span><br><span class="line"></span><br><span class="line">            checkWorldPoint = targetLocalToWorld.MultiplyPoint(topLeftPos + Vector2.down * targetSize.y * <span class="number">0.5f</span> + Vector2.right * targetSize.x + Vector2.right * _adaptionOffset.right);</span><br><span class="line">            Vector2 rightCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">            Vector2 rightCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Right);</span><br><span class="line">            <span class="keyword">bool</span> rightOut = rightCheckLocalPoint.x &gt; rightCheckBoundPoint.x;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (leftOut &amp;&amp; rightOut)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// outter bound is too small</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (leftOut)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">float</span> xDelta = leftCheckLocalPoint.x - leftCheckBoundPoint.x;</span><br><span class="line">                Vector3 tempPos = target.localPosition;</span><br><span class="line">                tempPos.x -= xDelta;</span><br><span class="line">                target.localPosition = tempPos;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rightOut)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">float</span> xDelta = rightCheckLocalPoint.x - rightCheckBoundPoint.x;</span><br><span class="line">                Vector3 tempPos = target.localPosition;</span><br><span class="line">                tempPos.x -= xDelta;</span><br><span class="line">                target.localPosition = tempPos;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (leftOut || rightOut)</span><br><span class="line">            &#123;</span><br><span class="line">                LayoutRebuilder.ForceRebuildLayoutImmediate(target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AdjustVertical</span>(<span class="params">RectTransform target, RectTransform outterBoundRectTransform</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Vector2 targetSize = target.rect.size;</span><br><span class="line">            Matrix4x4 targetLocalToWorld = target.localToWorldMatrix;</span><br><span class="line">            Matrix4x4 boundRectWorldToLocal = outterBoundRectTransform.worldToLocalMatrix;</span><br><span class="line">            Vector2 topLeftPos = GetLocalRectPosition(target, RectPositionType.TopLeft);</span><br><span class="line"></span><br><span class="line">            Vector3 checkWorldPoint = targetLocalToWorld.MultiplyPoint(topLeftPos + Vector2.right * targetSize.x * <span class="number">0.5f</span> + Vector2.up * _adaptionOffset.top);</span><br><span class="line">            Vector2 topCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">            Vector2 topCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Top);</span><br><span class="line">            <span class="keyword">bool</span> topOut = topCheckLocalPoint.y &gt; topCheckBoundPoint.y;</span><br><span class="line"></span><br><span class="line">            checkWorldPoint = targetLocalToWorld.MultiplyPoint(topLeftPos + Vector2.down * targetSize.y + Vector2.right * targetSize.x * <span class="number">0.5f</span> + Vector2.down * _adaptionOffset.bottom);</span><br><span class="line">            Vector2 bottomCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">            Vector2 bottomCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Bottom);</span><br><span class="line">            <span class="keyword">bool</span> bottomOut = bottomCheckLocalPoint.y &lt; bottomCheckBoundPoint.y;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (topOut &amp;&amp; bottomOut)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// outter bound is too small</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (topOut)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">float</span> yDelta = topCheckLocalPoint.y - topCheckBoundPoint.y;</span><br><span class="line">                Vector3 tempPos = target.localPosition;</span><br><span class="line">                tempPos.y -= yDelta;</span><br><span class="line">                target.localPosition = tempPos;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (bottomOut)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">float</span> yDelta = bottomCheckLocalPoint.y - bottomCheckBoundPoint.y;</span><br><span class="line">                Vector3 tempPos = target.localPosition;</span><br><span class="line">                tempPos.y -= yDelta;</span><br><span class="line">                target.localPosition = tempPos;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (topOut || bottomOut)</span><br><span class="line">            &#123;</span><br><span class="line">                LayoutRebuilder.ForceRebuildLayoutImmediate(target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> position util</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector2 <span class="title">GetLocalRectPosition</span>(<span class="params">RectTransform target, RectPositionType offsetType</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> GetLocalRectPosition(target, offsetType, Vector2.zero);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector2 <span class="title">GetLocalRectPosition</span>(<span class="params">RectTransform target, RectPositionType offsetType, Vector2 offset</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> GetLocalRectPosition(target.rect.size, target.pivot, offsetType, offset);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector2 <span class="title">GetLocalRectPosition</span>(<span class="params">Vector2 targetSize, Vector2 targetPivot, RectPositionType offsetType, Vector2 offset</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Vector2 bottomLeft = Vector2.zero;</span><br><span class="line">            bottomLeft.x -= targetPivot.x * targetSize.x;</span><br><span class="line">            bottomLeft.y -= targetPivot.y * targetSize.y;</span><br><span class="line">            Vector2 result = bottomLeft;</span><br><span class="line">            <span class="keyword">switch</span> (offsetType)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Top:</span><br><span class="line">                    result += Vector2.right * <span class="number">0.5f</span> * targetSize.x + Vector2.up * targetSize.y;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Bottom:</span><br><span class="line">                    result += Vector2.right * <span class="number">0.5f</span> * targetSize.x;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Left:</span><br><span class="line">                    result += Vector2.up * <span class="number">0.5f</span> * targetSize.y;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Right:</span><br><span class="line">                    result += Vector2.right * targetSize.x + Vector2.up * <span class="number">0.5f</span> * targetSize.y;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.TopLeft:</span><br><span class="line">                    result += Vector2.up * targetSize.y;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.TopRight:</span><br><span class="line">                    result += Vector2.right * targetSize.x + Vector2.up * targetSize.y;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.BottomRight:</span><br><span class="line">                    result += Vector2.right * targetSize.x;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.BottomLeft:</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result + offset;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">RectPositionToWorld</span>(<span class="params">RectTransform rect, RectPositionType offsetType</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> RectPositionToWorld(rect, offsetType, Vector2.zero);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">RectPositionToWorld</span>(<span class="params">RectTransform rect, RectPositionType offsetType, Vector2 offset</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> localPosition = GetLocalRectPosition(rect, offsetType, offset);</span><br><span class="line">            <span class="keyword">return</span> rect.TransformPoint(localPosition);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Vector2 <span class="title">GetTargetRectPositionInLocalReference</span>(<span class="params">RectPositionType offsetType</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            RectTransform self = transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Vector2 targetPivotPos = GetLocalRectPosition(self, _targetRectPosition, _extraOffset);</span><br><span class="line">            Vector2 virtualCenterPos = targetPivotPos;</span><br><span class="line">            virtualCenterPos += GetLocalRectPosition(_targetSize, _targetPivot, offsetType, Vector2.zero);</span><br><span class="line">            <span class="keyword">return</span> virtualCenterPos;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Preview setting"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _targetSize = Vector2.one * <span class="number">128f</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Color _previewColor = Color.white;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _doDrawAdaptionOffsetRect = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">System.Serializable</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">struct</span> TempCheckResult</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">bool</span> previewLeftOut;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">bool</span> previewRightOut;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">bool</span> previewTopOut;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">bool</span> previewBottomOut;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> TempCheckResult _checkResult;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _previewLeftOut;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _previewRightOut;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _previewTopOut;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _previewBottomOut;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDrawGizmosSelected</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// draw A box to show the position of target</span></span><br><span class="line">            RectTransform self = transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Vector2 localSpawnPos = GetLocalRectPosition(self, _targetRectPosition);</span><br><span class="line">            localSpawnPos += _extraOffset;</span><br><span class="line"></span><br><span class="line">            Vector2 pivot = _targetPivot;</span><br><span class="line">            Vector2 topLeftPos = localSpawnPos;</span><br><span class="line">            topLeftPos.x -= pivot.x * _targetSize.x;</span><br><span class="line">            topLeftPos.y -= (pivot.y - <span class="number">1f</span>) * _targetSize.y;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_doScreenAdaption)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// do adaption</span></span><br><span class="line">                <span class="keyword">if</span> (_defaultBoundsCanvasTransform != <span class="literal">null</span>) <span class="comment">// if there is no bound, we can take the screen as the bound</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Matrix4x4 localToWorld = self.localToWorldMatrix;</span><br><span class="line">                    RectTransform outterBoundRectTransform = _defaultBoundsCanvasTransform;</span><br><span class="line">                    Matrix4x4 boundRectWorldToLocal = outterBoundRectTransform.worldToLocalMatrix;</span><br><span class="line"></span><br><span class="line">                    Vector3 checkWorldPoint = localToWorld.MultiplyPoint(topLeftPos + Vector2.down * _targetSize.y * <span class="number">0.5f</span> + Vector2.left * _adaptionOffset.left);</span><br><span class="line">                    Vector2 leftCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">                    Vector2 leftCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Left);</span><br><span class="line">                    _previewLeftOut = leftCheckLocalPoint.x &lt; leftCheckBoundPoint.x;</span><br><span class="line"></span><br><span class="line">                    checkWorldPoint = localToWorld.MultiplyPoint(topLeftPos + Vector2.down * _targetSize.y * <span class="number">0.5f</span> + Vector2.right * _targetSize.x + Vector2.right * _adaptionOffset.right);</span><br><span class="line">                    Vector2 rightCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">                    Vector2 rightCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Right);</span><br><span class="line">                    _previewRightOut = rightCheckLocalPoint.x &gt; rightCheckBoundPoint.x;</span><br><span class="line"></span><br><span class="line">                    checkWorldPoint = localToWorld.MultiplyPoint(topLeftPos + Vector2.right * _targetSize.x * <span class="number">0.5f</span> + Vector2.up * _adaptionOffset.top);</span><br><span class="line">                    Vector2 topCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">                    Vector2 topCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Top);</span><br><span class="line">                    _previewTopOut = topCheckLocalPoint.y &gt; topCheckBoundPoint.y;</span><br><span class="line"></span><br><span class="line">                    checkWorldPoint = localToWorld.MultiplyPoint(topLeftPos + Vector2.down * _targetSize.y + Vector2.right * _targetSize.x * <span class="number">0.5f</span> + Vector2.down * _adaptionOffset.bottom);</span><br><span class="line">                    Vector2 bottomCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">                    Vector2 bottomCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Bottom);</span><br><span class="line">                    _previewBottomOut = bottomCheckLocalPoint.y &lt; bottomCheckBoundPoint.y;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (_adjustHorizontal)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (_previewLeftOut &amp;&amp; _previewRightOut)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// bound too small</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (_previewLeftOut)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">float</span> xDelta = leftCheckLocalPoint.x - leftCheckBoundPoint.x;</span><br><span class="line">                                Vector3 tempPos = topLeftPos;</span><br><span class="line">                                tempPos.x -= xDelta;</span><br><span class="line">                                topLeftPos = tempPos;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (_previewRightOut)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">float</span> xDelta = rightCheckLocalPoint.x - rightCheckBoundPoint.x;</span><br><span class="line">                                Vector3 tempPos = topLeftPos;</span><br><span class="line">                                tempPos.x -= xDelta;</span><br><span class="line">                                topLeftPos = tempPos;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (_adjustVertical)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (_previewTopOut &amp;&amp; _previewBottomOut)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// bound too small</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (_previewTopOut)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">float</span> yDelta = topCheckLocalPoint.y - topCheckBoundPoint.y;</span><br><span class="line">                                Vector3 tempPos = topLeftPos;</span><br><span class="line">                                tempPos.y -= yDelta;</span><br><span class="line">                                topLeftPos = tempPos;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (_previewBottomOut)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">float</span> yDelta = bottomCheckLocalPoint.y - bottomCheckBoundPoint.y;</span><br><span class="line">                                Vector3 tempPos = topLeftPos;</span><br><span class="line">                                tempPos.y -= yDelta;</span><br><span class="line">                                topLeftPos = tempPos;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _checkResult.previewLeftOut = _previewLeftOut;</span><br><span class="line">            _checkResult.previewRightOut = _previewRightOut;</span><br><span class="line">            _checkResult.previewTopOut = _previewTopOut;</span><br><span class="line">            _checkResult.previewBottomOut = _previewBottomOut;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_doDrawAdaptionOffsetRect &amp;&amp; _defaultBoundsCanvasTransform != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Vector2 innerBoundLeftPos = GetLocalRectPosition(_defaultBoundsCanvasTransform, RectPositionType.TopLeft, <span class="keyword">new</span> Vector2(_adaptionOffset.left, -_adaptionOffset.top));</span><br><span class="line">                Vector2 size = _defaultBoundsCanvasTransform.rect.size;</span><br><span class="line">                size.x -= _adaptionOffset.horizontal;</span><br><span class="line">                size.y -= _adaptionOffset.vertical;</span><br><span class="line">                DrawBox(_defaultBoundsCanvasTransform, innerBoundLeftPos, size, Color.blue);</span><br><span class="line">            &#125;</span><br><span class="line">            DrawBox(self, topLeftPos, _targetSize, _previewColor);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawBox</span>(<span class="params">RectTransform reference, Vector2 topLeftPos, Vector2 size, Color color</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Color cachedColor = Gizmos.color;</span><br><span class="line">            Gizmos.color = color;</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(topLeftPos), reference.TransformPoint(topLeftPos + Vector2.right * size.x));</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(topLeftPos), reference.TransformPoint(topLeftPos + Vector2.down * size.y));</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(topLeftPos + Vector2.right * size.x), reference.TransformPoint(topLeftPos + Vector2.right * size.x + Vector2.down * size.y));</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(topLeftPos + Vector2.down * size.y), reference.TransformPoint(topLeftPos + Vector2.right * size.x + Vector2.down * size.y));</span><br><span class="line">            Gizmos.color = cachedColor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2023/03/26/20230326-ui-element-positioning/20230326-pic002.gif" class="" title="split">
<p>还是像以前一样，先在debug draw里把功能完成再给移到实际的物体上。<br>但这次还是很可惜没有把功能很好抽出成比较单独的数学运算，而且感觉要用到的参数好多也没法拆分，最后留了一个多参的入口。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/10/05/20221005-rapid-UGUI-creation-note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="2C2C2C2">
      <meta itemprop="description" content="随便记录一些东西">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FishPlayer">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/05/20221005-rapid-UGUI-creation-note/" class="post-title-link" itemprop="url">Rapid UI Creation Note</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-05 10:55:21" itemprop="dateCreated datePublished" datetime="2022-10-05T10:55:21+08:00">2022-10-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-03-26 14:33:58" itemprop="dateModified" datetime="2023-03-26T14:33:58+08:00">2023-03-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>When I searching some articles about MVC and MVVM, I see this talk.<br>Basiclly they does same stuff as my current project, but we still have some differences on our implementation.<br>I’d like to share it and take some notes :D</p>
<p>Here is the talk abour UGUI implementation.<br><a href="https://www.youtube.com/watch?v=uDQU_dlO-ZM" target="_blank" rel="noopener">video</a>.<br><a href="https://www.gdcvault.com/play/1024453/Data-Binding-Architectures-for-Rapid" target="_blank" rel="noopener">ppt</a>.<br><a href="https://stackoverflow.com/questions/667781/what-is-the-difference-between-mvc-and-mvvm" target="_blank" rel="noopener">temp</a>.</p>
<h1 id="Main-note"><a href="#Main-note" class="headerlink" title="Main note"></a>Main note</h1><h2 id="Architecture-in-lt-Lost-Survivor-gt"><a href="#Architecture-in-lt-Lost-Survivor-gt" class="headerlink" title="Architecture in &lt; Lost Survivor &gt;"></a>Architecture in &lt; Lost Survivor &gt;</h2><ul>
<li>Artist works directly in Unity (Creating prefabs, setup aniamtions; well that’s what I my current project does, so I guess they did the same)</li>
<li>Dev works on GameLogic and UILogic</li>
<li>Dev/Art work decoupled</li>
<li>Dev/Art work parallel (This happens a lot in iteration)</li>
</ul>
<h2 id="The-Pattern-used-in-lt-Lost-Survivor-gt"><a href="#The-Pattern-used-in-lt-Lost-Survivor-gt" class="headerlink" title="The Pattern used in &lt; Lost Survivor &gt;"></a>The Pattern used in &lt; Lost Survivor &gt;</h2><h3 id="MVCVM-they-choose-this"><a href="#MVCVM-they-choose-this" class="headerlink" title="MVCVM (they choose this)"></a>MVCVM (they choose this)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">                                                                                                                               </span><br><span class="line">                                                        +---------------------------------------+                              </span><br><span class="line">                                                        |                data binding           |                              </span><br><span class="line">                                                        |                    &lt;-&gt;                |                              </span><br><span class="line">                                                        |                                       |                              </span><br><span class="line">                                                        |                                       |                              </span><br><span class="line">+------------------------------+                        |                                       |                              </span><br><span class="line">|                              | +----------------------|-------+    +------------------------------+ +-----------------------+</span><br><span class="line">----------Controller------------ |         Model                |    |        View Model            | |    View (UGUI View)   |</span><br><span class="line">|                              | --------------------------------    -------------------------------- -------------------------</span><br><span class="line">| void GainXP();               | |      int XP;                 |    |                              | | Text XP;              |</span><br><span class="line">| void LevelUp();              | |      int Level;              |    |                              | | Text Attribute;       |</span><br><span class="line">|                              | |                              |    |                              | | Button ReAllocate;    |</span><br><span class="line">|                              | +--------------&#x2F;---------------+    +---------------\--------------+ | int WeaponATK;        |</span><br><span class="line">+---------------\--------------+              &#x2F;-                                      -\              |                       |</span><br><span class="line">                 \                          &#x2F;-                                          -\            +-----------&#x2F;-----------+</span><br><span class="line">                  -\                      &#x2F;-                                              \                      |             </span><br><span class="line">                    \                   &#x2F;-                                                 -\                    &#x2F;             </span><br><span class="line">            +---------------------------------------------------------------------------------------------------|-------+      </span><br><span class="line">            |                                                                                                           |      </span><br><span class="line">            |                                               Message Bus                                                 |      </span><br><span class="line">            +-----------------------------------------------------|-----------------------------------------------------+      </span><br><span class="line">                                                                  |                                                            </span><br><span class="line">                                                                  |                                                            </span><br><span class="line">                                                                  |                                                            </span><br><span class="line">                                                    +-------------|------------+                                               </span><br><span class="line">                                                    |                          |                                               </span><br><span class="line">                                                    |      server backend      |                                               </span><br><span class="line">                                                    |                          |                                               </span><br><span class="line">                                                    +--------------------------+</span><br></pre></td></tr></table></figure>
<p>This is the pattern they use for their project.<br>The one thing that I cant understand is that the View will receive events from MessageBus. IDK why they did like this. For me, I prefer to let view only receive direct events from VM, bind to many stuff to MessageBus will make it slow.</p>
<h3 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">                                                                                                                                                                                                   </span><br><span class="line">                                   +------------------------------+                                    </span><br><span class="line">                                   |          Controller          |                                    </span><br><span class="line">+---------------------------------------------------------------------------------------------+        </span><br><span class="line">|         user action -&gt;           |  void GainXp();              |       update -&gt;           |        </span><br><span class="line">|                                  |  Void LevelUp();             |                           |        </span><br><span class="line">|                                  |  int GetAttribute(type);     |                           |        </span><br><span class="line">|                                  |                              |                           |        </span><br><span class="line">|                                  |                              |                           |        </span><br><span class="line">|                                  +-------|--------------|-------+                           |        </span><br><span class="line">|                                          |              |                                   |        </span><br><span class="line">|------------------------------+           |              |            +----------------------|-------+</span><br><span class="line">|    Character View            |           |              |            |         Model                |</span><br><span class="line">--------------------------------           |              |            --------------------------------</span><br><span class="line">| Text XP;                     |           |              |            | int AmountXp;                |</span><br><span class="line">| Text Attribute;              ------------+              |            | int AttributeTypeA;          |</span><br><span class="line">| Button ReAllocate;           | &lt;- update                |            | int AttributeTypeB;          |</span><br><span class="line">|                              |                          +-------------                              |</span><br><span class="line">|                              |                     &lt;- notify change? |                              |</span><br><span class="line">+------------------------------+                                       +------------------------------+</span><br></pre></td></tr></table></figure>
<p>I’m sure this pattern is kind of useful. I use this a lot when I did the first version of some UI pages. But later the Controller become a giant class.<br>And also I think the View and Controller in this pattern is not very reusable.</p>
<h3 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">                                                                                                                            </span><br><span class="line">                                                                                            +------------------------------+</span><br><span class="line">                                                                                            |         Model Character      |</span><br><span class="line">                                                                            +-----------------------------------------------</span><br><span class="line">                                                                            |               | int AmountXp;                |</span><br><span class="line">                                                                            |               | int AttributeTypeA;          |</span><br><span class="line">                                                                            |               | int AttributeTypeB;          |</span><br><span class="line">                                                                            |               |                              |</span><br><span class="line">                                                                            |               |                              |</span><br><span class="line">                                                                            |               +------------------------------+</span><br><span class="line">+------------------------------+                     +----------------------|-------+                                       </span><br><span class="line">|      Character View          |   data binding &lt;-&gt;  |        View Model            |                                       </span><br><span class="line">--------------------------------   notifications &lt;-  --------------------------------                                       </span><br><span class="line">| Text XP;                     |   command -&gt;        |int AmountXP;                 |                                       </span><br><span class="line">| Text Attribute;              ----------------------+int WeaponATK;                |                                       </span><br><span class="line">| Button ReAllocate;           |                     |int WeaponLevel;              |       +------------------------------+</span><br><span class="line">| int WeaponATK;               |                     |                              |       |         Model Weapon         |</span><br><span class="line">|                              |                     |                              |       --------------------------------</span><br><span class="line">+------------------------------+                     +----------------------|-------+       | int ATK;                     |</span><br><span class="line">                                                                            |               | int Level;                   |</span><br><span class="line">                                                                            +----------------                              |</span><br><span class="line">                                                                                            +------------------------------+</span><br></pre></td></tr></table></figure>
<ul>
<li>ViewModel serves the View</li>
<li>One ViewModel per View</li>
<li>Based on Data Binding</li>
</ul>
<p>After a few iterations, I find this pattern is also a good solutions. And I feel that we can even use CompositePattern in ViewModel to create big ViewModel for some big views(resuable).</p>
<p>In my current project, for the UI-View, we create some basic view that can receive similar types of data. And the good thing from this pattern is that the VM can send notificaiton to View to update, then I dun need to have lots of update method from Controller to update different data (cuz some data update need aniamtion, I cant just update all).</p>
<h2 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h2><p>Previously it says that separating UIPrefabs creation and UILogic code may solve “Not my problem attitude”. But actually not.<br>In production state, everyone is busy, and we are iterating View-Scripts and VM-Scripts together. Sometimes it is diffcult to tell that is code issues or setup issues. Unless we have solid View-Scripts.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This talk has lots of similiar content as the DivisionUI talk. And I also realise that the game development has lots of unknow shit. It’s very difficult to have some resuable components that always works. Even the thougts are similar, the implementation can be different. A solution can be that having some solid, simple, basic and resuable compoents.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="2C2C2C2"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">2C2C2C2</p>
  <div class="site-description" itemprop="description">随便记录一些东西</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">39</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/2C2C2C" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;2C2C2C" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">2C2C2C2</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
