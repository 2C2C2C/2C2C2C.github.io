<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>FishPlayer</title>
  
  <subtitle>一个喜欢摸鱼的废物</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2024-07-14T09:56:54.654Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>2C2C2C2</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Unity Serialization 序列化小笔记</title>
    <link href="http://yoursite.com/2024/07/14/20240714-unity-serialization-1/"/>
    <id>http://yoursite.com/2024/07/14/20240714-unity-serialization-1/</id>
    <published>2024-07-14T09:47:27.000Z</published>
    <updated>2024-07-14T09:56:54.654Z</updated>
    
    <content type="html"><![CDATA[<p>序列化（serialization）在计算机科学的资料处理中，是指将数据结构或对象状态转换成可取用格式（例如存成文件，存于缓冲，或经由网络中发送），以留待后续在相同或另一台计算机环境中，能恢复原先状态的过程。</p><h1 id="序列化的发生"><a href="#序列化的发生" class="headerlink" title="序列化的发生"></a>序列化的发生</h1><p>当我们用(UnityEngine.Object.Instantiate())此方法去生成一个 UnityObject 时候，就经历了序列化和反序列化的操作。</p><blockquote><p>Original Object —serialize—&gt; mid-data —deserialize—&gt; Spawned Object</p></blockquote><h1 id="序列化使用场景"><a href="#序列化使用场景" class="headerlink" title="序列化使用场景"></a>序列化使用场景</h1><h2 id="保存相关资产"><a href="#保存相关资产" class="headerlink" title="保存相关资产"></a>保存相关资产</h2><p>我们的许多 UnityObject 资产 scene, prefab, material 都是以文本文件(YAML)的形式保存在项目中。编辑器时，会在 Library 中存放’中间物体’。<br>我猜测，编辑器时会使用这些’中间物体’以减少实际序列化的步骤来加速运行。</p><p>当我们将磁盘里的 Asset 加载到游戏的运行时里的 UnityObject 的过程，是一个反序列化操作，把YAML反序列化成 UnityObject。</p><p>在编辑器时，我们会修改脚本，改变一些数据类型。把字段名称修改后，原本序列化的值丢失了。我猜是因为项目在 Refresh 的时候，会先把所有必要的数据都序列化存入’中间物体’，然后等代码编译完，生成了新的类型，再尝试把原本的’中间物体’用新的类型反序列化生成新物体并在序列化生成新的’中间物体’。这个过程中由于是使用新类型进行反序列化了，自然会抛弃新类型中没有的(不同名且类型不匹配的)数据。引擎C#层重载 HotReloading 会报错但是有可能凑合能跑估计也是这个原因，所以 HotReloading 实际上是为了让我们快速修改业务逻辑看看有无修好的。</p><p>FormerlySerializedAs(PROPERTY_NAME) 这个特性可以解决上面说的这个问题，但其实就是要求这个字段做序列化相关操作时沿用旧的字段名(PROPERTY_NAME)。这样在 prefab 中序列化下来记录的字段名一直都是那个旧的字段名。</p><!-- check https://zhuanlan.zhihu.com/p/139978773 --><h2 id="编辑器的字段绘制"><a href="#编辑器的字段绘制" class="headerlink" title="编辑器的字段绘制"></a>编辑器的字段绘制</h2><p>当我们对字段做做编辑器绘制的时候，也会有序列化以及反序列化的操作。</p><blockquote><p>Inspector —update changes—&gt; Serialized Properties —deserialize—&gt; Spawned Object<br>Inspector &lt;—update view— Serialized Properties —serialize—&gt; Spawned Object</p></blockquote><p>UnityObject 中的字段值会被序列化到 Serialized Properties 集合中，然后编辑器绘制相关的代码拿到序列化后得到的数据集合，再把他们提出来并根据数据类型画不同的样式。<br>下面是一个 PropertuDrawer 的例子，在绘制方法的参数中有 SerializedProperty，这个就是用于存放 UnityObject 中被序列化字段的 wrapper。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">CustomPropertyDrawer(typeof(NormalizedCurve))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NormalizedCurvePropertyDrawer</span> : <span class="title">PropertyDrawer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">string</span> CURVE_FIELD = <span class="string">"_curve"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">readonly</span> Rect RANGES = <span class="keyword">new</span> Rect(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params">Rect position, SerializedProperty property, GUIContent label</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        EditorGUI.BeginProperty(position, label, property);</span><br><span class="line">        <span class="keyword">var</span> curveProperty = property.FindPropertyRelative(CURVE_FIELD);</span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="对-UnityObject-引用的序列化"><a href="#对-UnityObject-引用的序列化" class="headerlink" title="对 UnityObject 引用的序列化"></a>对 UnityObject 引用的序列化</h2><p>哦我的老兄，这个大家都很熟悉了。以文本的形式打开我们的 prefab 康康。摘一段</p><p><a href="https://docs.unity3d.com/Manual/ClassIDReference.html" target="_blank" rel="noopener">UnityScriptClassType</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">--- !u!114 &amp;7941049597127225971 &#x2F;&#x2F; !u!CLASS_TYPE &amp;OBJECT_FILE_ID</span><br><span class="line">MonoBehaviour:</span><br><span class="line">  m_ObjectHideFlags: 0</span><br><span class="line">  m_CorrespondingSourceObject: &#123;fileID: 0&#125;</span><br><span class="line">  m_PrefabInstance: &#123;fileID: 0&#125;</span><br><span class="line">  m_PrefabAsset: &#123;fileID: 0&#125;</span><br><span class="line">  m_GameObject: &#123;fileID: 3753066996938937369&#125;</span><br><span class="line">  m_Enabled: 1</span><br><span class="line">  m_EditorHideFlags: 0</span><br><span class="line">  m_Script: &#123;fileID: 11500000, guid: 43f865a8433367346843b29a2464c1a7, type: 3&#125; &#x2F;&#x2F; guid point to this object instance&#39;s asset source</span><br><span class="line">  m_Name: </span><br><span class="line">  m_EditorClassIdentifier: </span><br><span class="line">  m_Material: &#123;fileID: 0&#125;</span><br><span class="line">  m_Color: &#123;r: 1, g: 1, b: 1, a: 1&#125;</span><br><span class="line">  m_RaycastTarget: 1</span><br><span class="line">  m_RaycastPadding: &#123;x: 0, y: 0, z: 0, w: 0&#125;</span><br></pre></td></tr></table></figure><p>首行表明了该 UnityObject 的类型以及它在这个 Prefab 中的唯一标识ID。<br>m_Script 这一行表明了这个物体是个 .cs 脚本。</p><p>我们还能发现有些字段只记录 { FileID }, 有些却要记录三个参数 {fileID, guid, type} 。记录三个参数的表明的是这个 prefab 内的物体的外部来源。听起来很别扭，我说详细点吧，就好比说一个 prefab A 中包含了一个 prefab B，那么 B 物体就是需要在 prefab A 中以如上方式记录。 其中 guid 是 prefab B 所在(定义处)的资源文件的 guid, FileID 则是这个物体在资源内的唯一ID，type 是这个物体的资源类型。</p><p>所以 UnityObject 引用的序列化是依靠以文本的形式记录ID完成的。</p><h2 id="对空引用-null-的支持"><a href="#对空引用-null-的支持" class="headerlink" title="对空引用(null)的支持"></a>对空引用(null)的支持</h2><p>空引用只支持 UnityObject 捏，如果是我们自定义的 C# class, 序列化时会生成默认的给他。这个时候如果有疯狂嵌套的 C# class就会爆炸了，因为他会一直往里层生成默认值给这些可序列化的 C# Class object。</p><!-- 相关资料 --><!-- https://zhuanlan.zhihu.com/p/565721314 -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;序列化（serialization）在计算机科学的资料处理中，是指将数据结构或对象状态转换成可取用格式（例如存成文件，存于缓冲，或经由网络中发送），以留待后续在相同或另一台计算机环境中，能恢复原先状态的过程。&lt;/p&gt;
&lt;h1 id=&quot;序列化的发生&quot;&gt;&lt;a href=&quot;#序列
      
    
    </summary>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/categories/UnityEditor/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UnityEditor" scheme="http://yoursite.com/tags/UnityEditor/"/>
    
  </entry>
  
  <entry>
    <title>Unity Library Artifacts 目录下的文件初看！</title>
    <link href="http://yoursite.com/2024/07/13/20240713-unity-library-artifacts/"/>
    <id>http://yoursite.com/2024/07/13/20240713-unity-library-artifacts/</id>
    <published>2024-07-13T09:50:31.000Z</published>
    <updated>2024-07-14T11:20:59.163Z</updated>
    
    <content type="html"><![CDATA[<p>Library 目录下有大量的缓存文件。其中包含着导入进项目里的资源文件以及一些导入资源后产生的用于文件(可能是用于记录关系或是一些关于资源的额外的缓存数据？)。</p><p>每当有资源导入/刷新修改时，Library 都会有文件发生变更(增删改)。</p><h1 id="Artifacts-目录"><a href="#Artifacts-目录" class="headerlink" title="Artifacts 目录"></a>Artifacts 目录</h1><p>Unity 提供了一个工具可以把 Artifacts 里的文件转成人话 </p><blockquote><p>C:\Program Files\Unity\Hub\Editor\UNITY_VERSION\Editor\Data\Tools\binary2text.exe</p></blockquote><p>Artifacts 目录下存放各个资源在导入阶段后期生成的缓存文件。似乎这些文件由资产的哈希值作为键来命名。这些文件在 Unity 内部被称为 producedFiles (在 Log 中使用改名字称呼这些文件；但在AssetV2中似乎已经没有这个东西)。</p><p>为什么 Libraray 目录会比 Asset 大很多，其中一个原因是这样的。以脚本文件举例，在这个缓存文件中，不仅仅有该脚本的代码文本，同时还以文本的形式记录着该资产相关的一些ID，以及资产的存储类型？。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">ID: 3 (ClassID: 1035) MonoImporter</span><br><span class="line">m_ObjectHideFlags 0 (unsigned int)</span><br><span class="line">m_CorrespondingSourceObject  (PPtr&lt;EditorExtension&gt;)</span><br><span class="line">m_FileID 0 (int)</span><br><span class="line">m_PathID 0 (SInt64) &#x2F;&#x2F; signed long?</span><br><span class="line">m_PrefabInstance  (PPtr&lt;PrefabInstance&gt;)</span><br><span class="line">m_FileID 0 (int)</span><br><span class="line">m_PathID 0 (SInt64)</span><br><span class="line">m_PrefabAsset  (PPtr&lt;Prefab&gt;)</span><br><span class="line">m_FileID 0 (int)</span><br><span class="line">m_PathID 0 (SInt64)</span><br><span class="line">m_Name &quot;&quot; (string)</span><br><span class="line">m_ExternalObjects  (map)</span><br><span class="line">size 0 (int)</span><br><span class="line"></span><br><span class="line">m_UsedFileIDs  (set)</span><br><span class="line">size 1 (int)</span><br><span class="line">data (SInt64) #0: 11500000</span><br><span class="line">m_DefaultReferences  (vector)</span><br><span class="line">size 0 (int)</span><br><span class="line"></span><br><span class="line">executionOrder 0 (SInt16)</span><br><span class="line">icon  (PPtr&lt;Texture2D&gt;)</span><br><span class="line">m_FileID 0 (int)</span><br><span class="line">m_PathID 0 (SInt64)</span><br><span class="line">m_UserData &quot;&quot; (string)</span><br><span class="line">m_AssetBundleName &quot;&quot; (string)</span><br><span class="line">m_AssetBundleVariant &quot;&quot; (string)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ID: 11500000 (ClassID: 115) MonoScript</span><br><span class="line">m_ObjectHideFlags 0 (unsigned int)</span><br><span class="line">m_CorrespondingSourceObject  (PPtr&lt;EditorExtension&gt;)</span><br><span class="line">m_FileID 0 (int)</span><br><span class="line">m_PathID 0 (SInt64)</span><br><span class="line">m_PrefabInstance  (PPtr&lt;PrefabInstance&gt;)</span><br><span class="line">m_FileID 0 (int)</span><br><span class="line">m_PathID 0 (SInt64)</span><br><span class="line">m_PrefabAsset  (PPtr&lt;Prefab&gt;)</span><br><span class="line">m_FileID 0 (int)</span><br><span class="line">m_PathID 0 (SInt64)</span><br><span class="line">m_Name &quot;IntEqualBehaviour&quot; (string)</span><br><span class="line">m_Script &quot;using UnityEngine;</span><br><span class="line"></span><br><span class="line">&quot; (string) &#x2F;&#x2F; 资产的存储类型?</span><br><span class="line">m_DefaultReferences  (map)</span><br><span class="line">size 0 (int)</span><br><span class="line"></span><br><span class="line">m_Icon  (PPtr&lt;Object&gt;)</span><br><span class="line">m_FileID 0 (int)</span><br><span class="line">m_PathID 0 (SInt64)</span><br><span class="line">m_ExecutionOrder 0 (int)</span><br><span class="line">m_ClassName &quot;IntEqualBehaviour&quot; (string)</span><br><span class="line">m_Namespace &quot;Core.UI&quot; (string)</span><br></pre></td></tr></table></figure><p>这是一条导入的Log.</p><blockquote><p>[Worker0] Start importing Assets/Script/UI/Core/PrimitiveBehaviour/IntEqualBehaviour.cs using Guid(ce9400962fc00544a89e0e69c863b84c) Importer(815301076,1909f56bfc062723c751e8b465ee728b) [Worker0]  -&gt; (artifact id: ‘840ab621654cd480e1699784fa88cf93’) in 0.005725 seconds </p></blockquote><p>‘ce9400962fc00544a89e0e69c863b84c’ 是该脚本作为资产的GUID，和meta文件中的GUID一致。<br>Importer(815301076,1909f56bfc062723c751e8b465ee728b) 猜测为指向倒入该资源使用的导入器类型，以及该导入器作为 Asset 时候的GUID。</p><p>如下代码用于追踪某个资产在 Artifacts 中的键名和位置。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> guidString = AssetDatabase.AssetPathToGUID(assetPath);</span><br><span class="line"><span class="keyword">string</span> hash = AssetDatabaseExperimental.GetArtifactHash(guidString);</span><br><span class="line">AssetDatabaseExperimental.GetArtifactPaths(hash, <span class="keyword">out</span> <span class="keyword">var</span> paths);</span><br></pre></td></tr></table></figure><h2 id="缓存损坏处理"><a href="#缓存损坏处理" class="headerlink" title="缓存损坏处理"></a>缓存损坏处理</h2><p>这个问题造成的原因很多，但是基本就是 Artifacts 里的关于资产的缓存文件坏了。其表现就是那个资产的图标变成白纸，然后无法使用了。<br>但是有时候对着这个资产点击 Reimport 并不能解决问题。</p><p>我认为正确的思路就是把这个坏的缓存杀掉，再生成一个新的</p><ol><li>只有几个资产的缓存坏掉的情况，可以把这几个资产从项目中拿出来。刷新项目，再把资产放回去，重新生成缓存。</li><li>有多个资产缓存爆炸的情况，需要先收集资产列表，然后用上面的代码追溯所有坏掉的缓存并杀掉，再重新导入这些资产。(只是猜测，并未实践过。因为这个情况很少见，感觉不如直接把Library杀了全部重刷下班吃饭)</li></ol><h2 id="资料来源"><a href="#资料来源" class="headerlink" title="资料来源"></a>资料来源</h2><p><a href="https://uninomicon.com/library" target="_blank" rel="noopener">网上找到的活爹</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Library 目录下有大量的缓存文件。其中包含着导入进项目里的资源文件以及一些导入资源后产生的用于文件(可能是用于记录关系或是一些关于资源的额外的缓存数据？)。&lt;/p&gt;
&lt;p&gt;每当有资源导入/刷新修改时，Library 都会有文件发生变更(增删改)。&lt;/p&gt;
&lt;h1 id
      
    
    </summary>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/categories/UnityEditor/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UnityEditor" scheme="http://yoursite.com/tags/UnityEditor/"/>
    
  </entry>
  
  <entry>
    <title>Unity Inspector 绘制非序列化字段</title>
    <link href="http://yoursite.com/2024/06/29/20240629-drawnonserializefields/"/>
    <id>http://yoursite.com/2024/06/29/20240629-drawnonserializefields/</id>
    <published>2024-06-29T08:13:10.000Z</published>
    <updated>2024-07-08T13:46:26.541Z</updated>
    
    <content type="html"><![CDATA[<p>在MonoBehaviour里给字段打上 <code>[SerializedField]</code> 特性标记即可把这个字段显示在 Inspector 上，同时还会把这个字段序列化到资源里。<br>在实际开发项目的时候，有些字段我们只是想从 Inspector 上看到数值以方便差错，并不想序列化这个字段(浪费空间)。在 Unity 商城里有 Odin Inspector， Naughty Attributes 之类的编辑器拓展插件可以完成这个功能。</p><p>最近在座的项目里使用了 Mirror Networking 和 Naughty Attributes，但是我发现 Naughty Attributes 的 <code>[ShowInInspector]</code> 没法用在 <code>Mirror.NerworkBehaviour</code> 上。只能照着 Naughty Attributes 源码里的方式把 <code>[ShowInInspector]</code> 的功能给 <code>Mirror.NerworkBehaviour</code> 在实现一次，于是有了今天这篇笔记。</p><h1 id="基本思路"><a href="#基本思路" class="headerlink" title="基本思路"></a>基本思路</h1><p>为什么 <code>Mirror.NerworkBehaviour</code> 无法使用另一个编辑器插件里的 <code>[ShowInInspector]</code> 呢？我们通过查看源码得知， Naughty Attributes 编写了一个应用于 UnityObject 的 Inspector 编辑器脚本，用于在里面调用自己 Attibutes 的相关绘制方法，并且设置为应用于子类。而 <code>Mirror.NerworkBehaviour</code> 正好也有一个自己专有的 Inspector 绘制脚本，并且要应用于子类。所以继承 <code>Mirror.NerworkBehaviour</code> 的脚本就使用了 Mirror 准备的编辑器绘制脚本，无法再使用 Naughty Attributes，而项目里其他 MonoBehaviour 还仍然使用 Naughty Attributes 的编辑器绘制。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">CanEditMultipleObjects]</span><br><span class="line">[<span class="meta">CustomEditor(typeof(UnityEngine.Object), true)</span>]</span><br><span class="line">public class NaughtyInspector : UnityEditor.Editor</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">CustomEditor(typeof(NetworkBehaviour), true)</span>]</span><br><span class="line">[<span class="meta">CanEditMultipleObjects</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">NetworkBehaviourInspector</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么我的思路很简单:</p><ol><li>在 Mirror 中也定义一个 <code>[ShowInInspector]</code> 类似的特性</li><li>在 <code>Mirror.NerworkBehaviour</code> 的Inspector绘制脚本中对 <code>[Mirror.TempShowInInspector]</code> 进行检测, 收集有此特性的字段</li><li>在 <code>Mirror.NerworkBehaviour</code> 的Inspector原本的绘制方法结束后，对有 <code>[Mirror.TempShowInInspector]</code> 特性的字段进行绘制</li></ol><h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>为了让代码看起来干净整洁，下面放出的代码是用于在空的Unity工程中实现 <code>[ShowInInspector]</code>。</p><p>先定义特性</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TempShowInInspectorAttribute</span> : <span class="title">Attribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> IsReadonlyField &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="isReadonly"&gt;</span>If this field is readonly in inspector.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Set it to readonly would save some performance<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TempShowInInspectorAttribute</span>(<span class="params"><span class="keyword">bool</span> isReadonly = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            IsReadonlyField = isReadonly;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后编写一个 Helper 类。在这个 Helper 类中，要编写方法获取一个 UnityObject 中的字段。<br>同时还要编写方法去绘制字段。绘制字段的函数非常庞大，由于在实际项目中会有 Struct 嵌套的情况，所以我写了一个可以递归调用的方法以处理嵌套。<br>但我只是粗暴的设置了允许嵌套的层数，因为我觉得实际使用情境中是不太会有太深层的嵌套了，因为此类数据一般都是从配置表中拿到或者是一些运行时的参数组合。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core.Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">TempGUIHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">int</span> DRAW_DEPTH_LIMIT = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DrawTempShowInInspectorField</span>(<span class="params">UnityObject target, FieldInfo field, <span class="keyword">bool</span> isReadonly = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">object</span> <span class="keyword">value</span> = field.GetValue(target);</span><br><span class="line">            <span class="keyword">string</span> niceVariableName = ObjectNames.NicifyVariableName(field.Name);</span><br><span class="line">            <span class="keyword">if</span> (field.IsStatic)</span><br><span class="line">            &#123;</span><br><span class="line">                niceVariableName = <span class="string">$"<span class="subst">&#123;niceVariableName&#125;</span>(static) "</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == <span class="keyword">value</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// TODO @Hiko if field is a class pack, better to spawn one for it; But why do ppl make a data pack into class, it should just be struct;</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (TryDrawField(<span class="keyword">value</span>, niceVariableName, field.FieldType, <span class="number">0</span>, <span class="keyword">out</span> <span class="keyword">object</span> nextValueObject, <span class="keyword">out</span> <span class="keyword">bool</span> setNextValue, isReadonly))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (setNextValue &amp;&amp; !isReadonly)</span><br><span class="line">                &#123;</span><br><span class="line">                    field.SetValue(target, nextValueObject);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">TryDrawField</span>(<span class="params"><span class="keyword">object</span> <span class="keyword">value</span>, <span class="keyword">string</span> lable, Type expectedType, <span class="keyword">int</span> depth, <span class="keyword">out</span> <span class="keyword">object</span> nextValue, <span class="keyword">out</span> <span class="keyword">bool</span> setNextValue, <span class="keyword">bool</span> readonlyField = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            nextValue = <span class="literal">null</span>;</span><br><span class="line">            setNextValue = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">string</span> showLableName = lable;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> &lt; depth) <span class="comment">// HACK @Hiko pad left</span></span><br><span class="line">            &#123;</span><br><span class="line">                showLableName = lable.PadLeft(lable.Length + depth * <span class="number">4</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (depth &gt;= DRAW_DEPTH_LIMIT)</span><br><span class="line">            &#123;</span><br><span class="line">                EditorGUILayout.BeginVertical();</span><br><span class="line">                EditorGUILayout.LabelField(<span class="string">$"<span class="subst">&#123;showLableName&#125;</span>(OutOfDrawDepthLimit):"</span>);</span><br><span class="line">                <span class="keyword">string</span> tempContent = <span class="keyword">value</span>.ToString();</span><br><span class="line">                tempContent = tempContent.PadLeft(tempContent.Length + depth * <span class="number">4</span>);</span><br><span class="line">                EditorGUILayout.LabelField(tempContent);</span><br><span class="line">                EditorGUILayout.EndVertical();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">new</span> EditorGUI.DisabledScope(disabled: readonlyField))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">bool</span> isDrawn = <span class="literal">true</span>;</span><br><span class="line">                Type valueType = Equals(<span class="keyword">value</span>, <span class="literal">null</span>) ? expectedType : <span class="keyword">value</span>.GetType();</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == valueType)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(<span class="keyword">bool</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">bool</span> prevBool = (<span class="keyword">bool</span>)<span class="keyword">value</span>;</span><br><span class="line">                    <span class="keyword">bool</span> nextBool = EditorGUILayout.Toggle(showLableName, prevBool);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevBool != nextBool)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextBool;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(<span class="keyword">short</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">short</span> prevShort = (<span class="keyword">short</span>)<span class="keyword">value</span>;</span><br><span class="line">                    <span class="keyword">short</span> nextShort = (<span class="keyword">short</span>)Mathf.Clamp(EditorGUILayout.IntField(showLableName, (<span class="keyword">int</span>)prevShort), <span class="keyword">short</span>.MinValue, <span class="keyword">short</span>.MaxValue); <span class="comment">// need clamp</span></span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevShort != nextShort)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextShort;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(<span class="keyword">ushort</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">ushort</span> prevUshort = (<span class="keyword">ushort</span>)<span class="keyword">value</span>;</span><br><span class="line">                    <span class="keyword">ushort</span> nextUshort = (<span class="keyword">ushort</span>)Mathf.Clamp(EditorGUILayout.IntField(showLableName, (<span class="keyword">ushort</span>)<span class="keyword">value</span>), <span class="keyword">ushort</span>.MinValue, <span class="keyword">ushort</span>.MaxValue); <span class="comment">// need clamp</span></span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevUshort != nextUshort)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextUshort;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(<span class="keyword">int</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">int</span> prevInt = (<span class="keyword">int</span>)<span class="keyword">value</span>;</span><br><span class="line">                    <span class="keyword">int</span> nextInt = EditorGUILayout.IntField(showLableName, prevInt);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevInt != nextInt)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextInt;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(<span class="keyword">uint</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">uint</span> prevUint = (<span class="keyword">uint</span>)<span class="keyword">value</span>;</span><br><span class="line">                    <span class="keyword">uint</span> nextUint = (<span class="keyword">uint</span>)Mathf.Clamp(EditorGUILayout.LongField(showLableName, prevUint), <span class="keyword">uint</span>.MinValue, <span class="keyword">uint</span>.MaxValue); <span class="comment">// need clamp</span></span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevUint != nextUint)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextUint;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(<span class="keyword">long</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">long</span> prevLong = (<span class="keyword">long</span>)<span class="keyword">value</span>;</span><br><span class="line">                    <span class="keyword">long</span> nextLong = EditorGUILayout.LongField(showLableName, prevLong);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevLong != nextLong)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextLong;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(<span class="keyword">ulong</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">ulong</span> prevUlong = (<span class="keyword">ulong</span>)<span class="keyword">value</span>;</span><br><span class="line">                    <span class="keyword">string</span> nextUlongStr = EditorGUILayout.TextField(showLableName, prevUlong.ToString());</span><br><span class="line">                    nextUlongStr = Regex.Replace(nextUlongStr, <span class="string">@"[^a-zA-Z0-9 ]"</span>, <span class="string">""</span>); <span class="comment">// force convert all to number</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">ulong</span>.TryParse(nextUlongStr, <span class="keyword">out</span> <span class="keyword">ulong</span> nextUlong) &amp;&amp; (setNextValue = prevUlong != nextUlong))</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextUlongStr;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(<span class="keyword">float</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">float</span> prevFloat = (<span class="keyword">float</span>)<span class="keyword">value</span>;</span><br><span class="line">                    <span class="keyword">float</span> nextFloat = EditorGUILayout.FloatField(showLableName, (<span class="keyword">float</span>)<span class="keyword">value</span>);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = !Mathf.Approximately(prevFloat, nextFloat))</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextFloat;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(<span class="keyword">double</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">double</span> prevDouble = (<span class="keyword">double</span>)<span class="keyword">value</span>;</span><br><span class="line">                    <span class="keyword">double</span> nextDouble = EditorGUILayout.DoubleField(showLableName, prevDouble);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevDouble != nextDouble)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextDouble;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(<span class="keyword">string</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">string</span> prevString = (<span class="keyword">string</span>)<span class="keyword">value</span>;</span><br><span class="line">                    <span class="keyword">string</span> nextString = EditorGUILayout.TextField(showLableName, prevString);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevString != nextString)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextString;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(Vector2))</span><br><span class="line">                &#123;</span><br><span class="line">                    Vector2 prevVector2 = (Vector2)<span class="keyword">value</span>;</span><br><span class="line">                    Vector2 nextVector2 = EditorGUILayout.Vector2Field(showLableName, prevVector2);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevVector2 != nextVector2)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = prevVector2;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(Vector3))</span><br><span class="line">                &#123;</span><br><span class="line">                    Vector3 prevVector3 = (Vector3)<span class="keyword">value</span>;</span><br><span class="line">                    Vector3 nextVector3 = EditorGUILayout.Vector3Field(showLableName, prevVector3);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevVector3 != nextVector3)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextVector3;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(Vector4))</span><br><span class="line">                &#123;</span><br><span class="line">                    Vector4 prevVector4 = (Vector4)<span class="keyword">value</span>;</span><br><span class="line">                    Vector4 nextVector4 = EditorGUILayout.Vector4Field(showLableName, prevVector4);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevVector4 != nextVector4)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextVector4;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(Vector2Int))</span><br><span class="line">                &#123;</span><br><span class="line">                    Vector2Int prevV2int = (Vector2Int)<span class="keyword">value</span>;</span><br><span class="line">                    Vector2Int nextV2int = EditorGUILayout.Vector2IntField(showLableName, prevV2int);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevV2int != nextV2int)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextV2int;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(Vector3Int))</span><br><span class="line">                &#123;</span><br><span class="line">                    Vector3Int prevV3int = (Vector3Int)<span class="keyword">value</span>;</span><br><span class="line">                    Vector3Int nextV3int = EditorGUILayout.Vector3IntField(showLableName, prevV3int);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevV3int != nextV3int)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextV3int;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(Color))</span><br><span class="line">                &#123;</span><br><span class="line">                    Color prevColor = (Color)<span class="keyword">value</span>;</span><br><span class="line">                    Color nextColor = EditorGUILayout.ColorField(showLableName, prevColor);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevColor != nextColor)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextColor;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(Bounds))</span><br><span class="line">                &#123;</span><br><span class="line">                    Bounds prevBounds = (Bounds)<span class="keyword">value</span>;</span><br><span class="line">                    Bounds nextBounds = EditorGUILayout.BoundsField(showLableName, prevBounds);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevBounds != nextBounds)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextBounds;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(Rect))</span><br><span class="line">                &#123;</span><br><span class="line">                    Rect prevRect = (Rect)<span class="keyword">value</span>;</span><br><span class="line">                    Rect nextRect = EditorGUILayout.RectField(showLableName, prevRect);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevRect != nextRect)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextRect;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType == <span class="keyword">typeof</span>(RectInt))</span><br><span class="line">                &#123;</span><br><span class="line">                    RectInt prevRectInt = (RectInt)<span class="keyword">value</span>;</span><br><span class="line">                    RectInt nextRectInt = EditorGUILayout.RectIntField(showLableName, prevRectInt);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = !prevRectInt.Equals(nextRectInt))</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextRectInt;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span>(UnityObject).IsAssignableFrom(valueType))</span><br><span class="line">                &#123;</span><br><span class="line">                    UnityObject prevUnityObj = (UnityObject)<span class="keyword">value</span>;</span><br><span class="line">                    UnityObject nextUnityObj = EditorGUILayout.ObjectField(showLableName, prevUnityObj, valueType, <span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevUnityObj != nextUnityObj)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextUnityObj;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType.BaseType == <span class="keyword">typeof</span>(Enum))</span><br><span class="line">                &#123;</span><br><span class="line">                    Enum prevEnum = (Enum)<span class="keyword">value</span>;</span><br><span class="line">                    Enum nextEnum = EditorGUILayout.EnumPopup(showLableName, prevEnum);</span><br><span class="line">                    <span class="keyword">if</span> (setNextValue = prevEnum != nextEnum)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nextValue = nextEnum;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (valueType.BaseType == <span class="keyword">typeof</span>(TypeInfo))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">bool</span> tempPrev = GUI.enabled;</span><br><span class="line">                    GUI.enabled = tempPrev;</span><br><span class="line">                    EditorGUILayout.TextField(showLableName, <span class="keyword">value</span>.ToString());</span><br><span class="line">                    GUI.enabled = tempPrev;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// TODO @Hiko add fold/unfold to save some space</span></span><br><span class="line">                    <span class="keyword">bool</span> isSerializable = <span class="literal">null</span> != valueType.GetCustomAttribute&lt;SerializableAttribute&gt;(); <span class="comment">// check if target is Serializable.</span></span><br><span class="line">                    <span class="keyword">if</span> (isSerializable)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">object</span> structValueObject = <span class="keyword">value</span>;</span><br><span class="line">                        EditorGUILayout.LabelField(showLableName);</span><br><span class="line">                        FieldInfo[] members = valueType.GetFields();</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, length = members.Length; i &lt; length; i++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            FieldInfo memberInfo = members[i];</span><br><span class="line">                            <span class="keyword">if</span> (MemberTypes.Field == memberInfo.MemberType &amp;&amp; !memberInfo.IsStatic) <span class="comment">// I dun need static/const field</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                Type fieldType = memberInfo.FieldType; <span class="comment">// better to pass this type in, cuz value could be null</span></span><br><span class="line">                                <span class="keyword">object</span> prevValueObj = memberInfo.GetValue(<span class="keyword">value</span>);</span><br><span class="line">                                <span class="keyword">if</span> (TryDrawField(prevValueObj, memberInfo.Name, fieldType, depth + <span class="number">1</span>, <span class="keyword">out</span> <span class="keyword">object</span> nextValueObj, <span class="keyword">out</span> <span class="keyword">bool</span> setNext, readonlyField))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (setNext)</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        setNextValue = <span class="literal">true</span>;</span><br><span class="line">                                        memberInfo.SetValue(structValueObject, nextValueObj);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                isDrawn = <span class="literal">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        nextValue = structValueObject;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        EditorGUILayout.BeginVertical();</span><br><span class="line">                        EditorGUILayout.LabelField(<span class="string">$"<span class="subst">&#123;showLableName&#125;</span>(NonSupprtType/NonSerializable):"</span>);</span><br><span class="line">                        <span class="keyword">string</span> valueStr = <span class="keyword">value</span>.ToString();</span><br><span class="line">                        valueStr = valueStr.PadLeft(valueStr.Length + (depth + <span class="number">1</span>) * <span class="number">4</span>);</span><br><span class="line">                        EditorGUILayout.LabelField(valueStr);</span><br><span class="line">                        EditorGUILayout.EndVertical();</span><br><span class="line">                        isDrawn = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> isDrawn;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;FieldInfo&gt; <span class="title">GetAllFields</span>(<span class="params"><span class="keyword">object</span> target, Func&lt;FieldInfo, <span class="keyword">bool</span>&gt; predicate</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (target == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">"The target object is null. Check for missing scripts."</span>);</span><br><span class="line">                <span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;Type&gt; types = GetSelfAndBaseTypes(target);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = types.Count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                IEnumerable&lt;FieldInfo&gt; fieldInfos = types[i]</span><br><span class="line">                    .GetFields(BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.DeclaredOnly)</span><br><span class="line">                    .Where(predicate);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> fieldInfo <span class="keyword">in</span> fieldInfos)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">yield</span> <span class="keyword">return</span> fieldInfo;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Type&gt; <span class="title">GetSelfAndBaseTypes</span>(<span class="params"><span class="keyword">object</span> target</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            List&lt;Type&gt; types = <span class="keyword">new</span> List&lt;Type&gt;()</span><br><span class="line">            &#123;</span><br><span class="line">                target.GetType()</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (types.Last().BaseType != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                types.Add(types.Last().BaseType);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> types;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来就是编写一个 Inpector 脚本了。最后一步，非常简单。在默认的绘制之后再绘制我们捕捉到的需要绘制的非序列化字段。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core.Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">CanEditMultipleObjects</span>]</span><br><span class="line">    [<span class="meta">CustomEditor(typeof(UnityObject), true)</span>]</span><br><span class="line">    public class TempInspector : UnityEditor.Editor</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> IEnumerable&lt;FieldInfo&gt; m_nonSerializedFields;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_nonSerializedFields = TempGUIHelper.GetAllFields(target, f =&gt; f.GetCustomAttributes(<span class="keyword">typeof</span>(TempShowInInspectorAttribute), <span class="literal">true</span>).Length &gt; <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInspectorGUI</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            DrawDefaultInspector(); <span class="comment">// draw default, make sure old stuff works</span></span><br><span class="line">            DrawNonSerializeFileds();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">DrawNonSerializeFileds</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_nonSerializedFields.Any())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> field <span class="keyword">in</span> m_nonSerializedFields)</span><br><span class="line">                &#123;</span><br><span class="line">                    TempShowInInspectorAttribute fieldAttribute = field.GetCustomAttribute&lt;TempShowInInspectorAttribute&gt;();</span><br><span class="line">                    <span class="keyword">bool</span> isReadonlyField = <span class="literal">null</span> == fieldAttribute || fieldAttribute.IsReadonlyField || field.IsStatic; <span class="comment">// make static fields readonly cuz I just think we should not change them</span></span><br><span class="line">                    TempGUIHelper.DrawTempShowInInspectorField(serializedObject.targetObject, field, isReadonlyField);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2024/06/29/20240629-drawnonserializefields/20240629-drawnonserializefields-pic001.png" class="" title="split"><h1 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h1><p>其实这个绘制的功能是我最开始工作的时候一直好奇且想去做的，那个时候也上网看了下论坛很快就明白了做法，但是因为项目组买了 Odin 所以就没必要我再做一次了。<br>没想到这段时间却因为项目中使用的两个插件冲突而有这个机会去依葫芦画瓢实现一次这个功能，还挺开心的。</p><p>P.S: Mirror 还定义了一个 Attribute 叫做 <code>[Mirror.ShowInInspector]</code>，它的用处是展示 <code>SyncList</code> 里的内容。但是，它展示 <code>SyncList</code> 内容的方法是把每个元素都 ToSting。<br>这个坑我也是看了他的代码才知道，我一开始还觉得它画不出 <code>SyncList&lt;CustomType&gt;</code> 是我自己的问题，恁麻了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在MonoBehaviour里给字段打上 &lt;code&gt;[SerializedField]&lt;/code&gt; 特性标记即可把这个字段显示在 Inspector 上，同时还会把这个字段序列化到资源里。&lt;br&gt;在实际开发项目的时候，有些字段我们只是想从 Inspector 上看到数值
      
    
    </summary>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/categories/UnityEditor/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UnityEditor" scheme="http://yoursite.com/tags/UnityEditor/"/>
    
  </entry>
  
  <entry>
    <title>UGUI 一些自用UI表现件基础</title>
    <link href="http://yoursite.com/2024/02/16/20240216-primitivebehaviour/"/>
    <id>http://yoursite.com/2024/02/16/20240216-primitivebehaviour/</id>
    <published>2024-02-16T05:26:35.000Z</published>
    <updated>2024-06-29T08:14:14.106Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Temp"><a href="#Temp" class="headerlink" title="Temp"></a>Temp</h1><p>自从开始加班以后就没什么干劲了。这段时间重头工作就是接用户SDK然后补以前落下的一些细节需求。</p><p>比较蚌埠住的是，这段时间发现了自己写的很多重复的UI组件代码。而且在这个时候已经不方便再整合替换了，整合替换可能会导致爆炸。</p><p>为了尽可能杜绝此类事情发生，决定先把用到的一些基础代码总结一下写在这里，方便下次直接过来抄而不是再手搓了。</p><h1 id="上代码"><a href="#上代码" class="headerlink" title="上代码"></a>上代码</h1><h2 id="PrimitiveBehaviour-基本结构"><a href="#PrimitiveBehaviour-基本结构" class="headerlink" title="PrimitiveBehaviour(基本结构)"></a>PrimitiveBehaviour(基本结构)</h2><p>首先定义表现件的最基本的结构。实质就是一个接收值的更新。<br>此外还多了一个标志，可用于调整该组件是否在第一次收到值得时候使用快进动画。<br>因为该功能在实际使用的时候，是根据美术的要求来决定的，所以我觉得不写在代码里而是开放出来供直接在prefab更改会更方便。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core.UI</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// where T : IComparable, IComparable&lt;T&gt;, IConvertible, IEquatable&lt;T&gt; 其实就是为了限制 T 必须是这些基础类型，但是感觉还是没必要这么写</span></span><br><span class="line">    public interface IBehaviourDispatcher&lt;T&gt; where T : IComparable, IComparable&lt;T&gt;, IConvertible, IEquatable&lt;T&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">DispatchValueChange</span>(<span class="params">T nextValue, <span class="keyword">bool</span> instant</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public abstract class PrimitiveBehaviour&lt;T&gt; : MonoBehaviour where T : IComparable, IComparable&lt;T&gt;, IConvertible, IEquatable&lt;T&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_instantApplyInitValue = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_hasInit = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> T m_currentValue;</span><br><span class="line">        <span class="keyword">private</span> T m_previousValue;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> T currentValue =&gt; m_currentValue;</span><br><span class="line">        <span class="keyword">public</span> T previousValue =&gt; m_previousValue;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> hasInited =&gt; m_hasInit;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 持有数据的一方主动调用该方法，以对表现进行更新</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="nextValue"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="instant"&gt;</span>instant changing value can also used to fast forward anim<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ChangeValue</span>(<span class="params">T nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_hasInit)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!instant &amp;&amp; IsValueEqual(currentValue, nextValue))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                m_previousValue = m_currentValue;</span><br><span class="line">                m_currentValue = nextValue;</span><br><span class="line">                NotifyValueChanged(nextValue, instant);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            instant = instant || m_instantApplyInitValue;</span><br><span class="line">            NotifyValueChanged(nextValue, instant);</span><br><span class="line">            m_previousValue = m_currentValue = nextValue;</span><br><span class="line">            m_hasInit = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">IsValueEqual</span>(<span class="params">T l, T r</span>)</span> =&gt; <span class="number">0</span> == l.CompareTo(r);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">NotifyValueChanged</span>(<span class="params">T nextValue, <span class="keyword">bool</span> instant</span>)</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="BoolBehaviour"><a href="#BoolBehaviour" class="headerlink" title="BoolBehaviour"></a>BoolBehaviour</h2><p>需要下发数据的一方需要持有一个 BoolBehaviourDispatcher 变量，并通过其把数据变更下发出去。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core.UI</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> BoolBehaviourDispatcher : IBehaviourDispatcher&lt;<span class="keyword">bool</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> BoolBehaviour[] m_behaviours;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DispatchValueChange</span>(<span class="params"><span class="keyword">bool</span> nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> count = m_behaviours.Length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                BoolBehaviour behaviour = m_behaviours[i];</span><br><span class="line">                <span class="keyword">if</span> (behaviour.gameObject.activeInHierarchy &amp;&amp; behaviour.enabled)</span><br><span class="line">                &#123;</span><br><span class="line">                    behaviour.ChangeValue(nextValue, instant);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"FindInChildren"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">FindInChildren</span>(<span class="params">GameObject source</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> behaviors = source.GetComponentsInChildren&lt;BoolBehaviour&gt;();</span><br><span class="line">            m_behaviours = behaviors;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public abstract class BoolBehaviour : PrimitiveBehaviour&lt;bool&gt; </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Editor preview"</span>), NonReorderable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> previewValue_editor = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> previrwInstant = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"SetValuePreview"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetValuePreview</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Application.isPlaying)</span><br><span class="line">            &#123;</span><br><span class="line">                NotifyValueChanged(previewValue_editor, previrwInstant);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            NotifyValueChanged(previewValue_editor, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="FloatBehaviour"><a href="#FloatBehaviour" class="headerlink" title="FloatBehaviour"></a>FloatBehaviour</h2><p>需要下发数据的一方需要持有一个 FloatBehaviourDispatcher 变量，并通过其把数据变更下发出去。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core.UI</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> FloatBehaviourDispatcher: IBehaviourDispatcher&lt;<span class="keyword">float</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> FloatBehaviour[] m_behaviours;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DispatchValueChange</span>(<span class="params"><span class="keyword">float</span> nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> count = m_behaviours.Length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> behaviour = m_behaviours[i];</span><br><span class="line">                <span class="keyword">if</span> (behaviour.gameObject.activeInHierarchy &amp;&amp; behaviour.enabled)</span><br><span class="line">                &#123;</span><br><span class="line">                    behaviour.ChangeValue(nextValue, instant);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"FindInChildren"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">FindInChildren</span>(<span class="params">GameObject source</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> behaviors = source.GetComponentsInChildren&lt;FloatBehaviour&gt;();</span><br><span class="line">            m_behaviours = behaviors;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public abstract class FloatBehaviour : PrimitiveBehaviour&lt;float&gt;</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Editor preview"</span>), NonReorderable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> previewValue_editor = <span class="number">1f</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> previrwInstant = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"SetValuePreview"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetValuePreview</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Application.isPlaying)</span><br><span class="line">            &#123;</span><br><span class="line">                NotifyValueChanged(previewValue_editor, previrwInstant);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            NotifyValueChanged(previewValue_editor, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="IntBehaviour"><a href="#IntBehaviour" class="headerlink" title="IntBehaviour"></a>IntBehaviour</h2><p>需要下发数据的一方需要持有一个 IntBehaviourDispatcher 变量，并通过其把数据变更下发出去。<br>IntBehaviour 我定义成一个抽象类。因为实际使用的时候(我暂时遇到的情况)，在UI表现上会需要有持有一个数值，数值相同不同时的表现，或是UI收到不同的数值再有不同的表现。<br>所以这边分做成了两个 Beheaviour 。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core.UI</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> IntBehaviourDispatcher : IBehaviourDispatcher&lt;<span class="keyword">int</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> IntBehaviour[] m_behaviours;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DispatchValueChange</span>(<span class="params"><span class="keyword">int</span> nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> count = m_behaviours.Length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> behaviour = m_behaviours[i];</span><br><span class="line">                <span class="keyword">if</span> (behaviour.gameObject.activeInHierarchy &amp;&amp; behaviour.enabled)</span><br><span class="line">                &#123;</span><br><span class="line">                    behaviour.ChangeValue(nextValue, instant);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"FindInChildren"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">FindInChildren</span>(<span class="params">GameObject source</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> behaviors = source.GetComponentsInChildren&lt;IntBehaviour&gt;();</span><br><span class="line">            m_behaviours = behaviors;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public abstract class IntBehaviour : PrimitiveBehaviour&lt;int&gt; </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Editor preview"</span>), NonReorderable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> previewValue_editor = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> previrwInstant = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"SetValuePreview"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetValuePreview</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Application.isPlaying)</span><br><span class="line">            &#123;</span><br><span class="line">                NotifyValueChanged(previewValue_editor, previrwInstant);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            NotifyValueChanged(previewValue_editor, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据收到的值不同 而作不同表现</span></span><br><span class="line">    public abstract class IntSwitchBehaviour&lt;T&gt; : PrimitiveBehaviour&lt;int&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Serializable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">struct</span> IntPack</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">int</span> intValue;</span><br><span class="line">            <span class="keyword">public</span> T targetValueDataPack;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Extra param"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_hasDefaultPack = <span class="literal">false</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> m_defaultPackIndex = <span class="number">0</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_unapplyPrevPack = <span class="literal">true</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> IntPack[] m_packArray;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">sealed</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">NotifyValueChanged</span>(<span class="params"><span class="keyword">int</span> nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> length = m_packArray.Length;</span><br><span class="line">            <span class="keyword">int</span> meetIndex = <span class="number">-1</span>;</span><br><span class="line">            IntPack pack;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                pack = m_packArray[i];</span><br><span class="line">                <span class="keyword">if</span> (pack.intValue == nextValue)</span><br><span class="line">                &#123;</span><br><span class="line">                    meetIndex = i;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (m_unapplyPrevPack)</span><br><span class="line">                &#123;</span><br><span class="line">                    UnApplyPack(pack.targetValueDataPack);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (meetIndex &gt; <span class="number">0</span>) <span class="comment">// has meet</span></span><br><span class="line">            &#123;</span><br><span class="line">                pack = m_packArray[meetIndex];</span><br><span class="line">                ApplyPack(pack.targetValueDataPack, instant);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// apply default one</span></span><br><span class="line">            pack = m_packArray[m_defaultPackIndex];</span><br><span class="line">            ApplyPack(pack.targetValueDataPack, instant);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">ApplyPack</span>(<span class="params">T pack, <span class="keyword">bool</span> instant</span>)</span>;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">UnApplyPack</span>(<span class="params">T pack</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 持有一个数值，判断传进来的值是否相等，再做表现</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">IntEqualBehaviour</span> : <span class="title">IntBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> m_targetValue;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_isPreviousValueEqual = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">sealed</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">NotifyValueChanged</span>(<span class="params"><span class="keyword">int</span> nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">bool</span> isEqual = IsValueEqual(nextValue, m_targetValue);</span><br><span class="line">            <span class="keyword">bool</span> hasChanged = isEqual != m_isPreviousValueEqual;</span><br><span class="line">            <span class="keyword">if</span> (hasInited)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (hasChanged)</span><br><span class="line">                &#123;</span><br><span class="line">                    NotifyValueEqual(isEqual, instant);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            NotifyValueEqual(isEqual, instant);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">NotifyValueEqual</span>(<span class="params"><span class="keyword">bool</span> equal, <span class="keyword">bool</span> instant</span>)</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h2><p>下面是一个 FloatBehaviour 和 BoolBehaviour 的例子。<br>只需要收到数值，FloatBehaviour 启动tween去修改 Image 的填充/ BoolBehaviour 去开关物体。其它还会用到的表现还有更改颜色，开关物体之类的，<br>当然实际使用的情况还得考虑 target 是否会无效，以及物体从来没开过，却调用 NotifyValueChanged 之类的细节问题的。</p><img src="/2024/02/16/20240216-primitivebehaviour/20240216-primitivebehaviour-pic001.png" class="" title="split"><img src="/2024/02/16/20240216-primitivebehaviour/20240216-primitivebehaviour-pic002.png" class="" title="split"><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core.UI</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">RequireComponent(typeof(Image))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SlicesImageFill</span> : <span class="title">FloatBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Fields"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Image m_target;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_reverse = <span class="literal">false</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 m_range = <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">1f</span>);</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_doTweenFill = <span class="literal">false</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> TweenParameter m_tweenParameter;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Tween m_currentTween;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">NotifyValueChanged</span>(<span class="params"><span class="keyword">float</span> nextValue, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_currentTween?.Kill();</span><br><span class="line">            <span class="keyword">float</span> targetFill = CalculateFillValue(nextValue);</span><br><span class="line">            <span class="keyword">if</span> (instant || !m_doTweenFill)</span><br><span class="line">            &#123;</span><br><span class="line">                m_target.fillAmount = targetFill;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            m_currentTween = m_target.DOFillAmount(targetFill, m_tweenParameter.duration);</span><br><span class="line">            m_currentTween.ApplyParam(m_tweenParameter);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">float</span> <span class="title">CalculateFillValue</span>(<span class="params"><span class="keyword">float</span> rawValue</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> Mathf.Lerp(m_range.x, m_range.y, m_reverse ? <span class="number">1</span> - rawValue : rawValue);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDestroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_currentTween?.Kill();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_target = GetComponent&lt;Image&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BoolReactorObjectActive</span> : <span class="title">BoolBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Serializable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">struct</span> ObjectActivePack</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> GameObject target;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">bool</span> inverse;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Extra param"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> ObjectActivePack[] m_packs;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">NotifyValueChanged</span>(<span class="params"><span class="keyword">bool</span> <span class="keyword">value</span>, <span class="keyword">bool</span> instant</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, length = m_packs.Length; i &lt; length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                ObjectActivePack pack = m_packs[i];</span><br><span class="line">                pack.target.SetActive(pack.inverse ? !<span class="keyword">value</span> : <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Temp&quot;&gt;&lt;a href=&quot;#Temp&quot; class=&quot;headerlink&quot; title=&quot;Temp&quot;&gt;&lt;/a&gt;Temp&lt;/h1&gt;&lt;p&gt;自从开始加班以后就没什么干劲了。这段时间重头工作就是接用户SDK然后补以前落下的一些细节需求。&lt;/p&gt;
&lt;p&gt;比较蚌埠住的是
      
    
    </summary>
    
    
      <category term="UGUI" scheme="http://yoursite.com/categories/UGUI/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UGUI" scheme="http://yoursite.com/tags/UGUI/"/>
    
  </entry>
  
  <entry>
    <title>UGUI PSD智能对象导图小记</title>
    <link href="http://yoursite.com/2023/10/15/20231015-psd-complexlayer-export/"/>
    <id>http://yoursite.com/2023/10/15/20231015-psd-complexlayer-export/</id>
    <published>2023-10-15T04:43:02.000Z</published>
    <updated>2023-10-15T06:15:00.741Z</updated>
    
    <content type="html"><![CDATA[<p>当前的项目里因为UI缺乏UI美术人，没有人力导图拼图，所以使用了<a href="https://github.com/zouhunter/unity-psd-ugui" target="_blank" rel="noopener">PSD2UGUI</a>插件。这个插件又依赖一个分析PSD的解析库<a href="https://github.com/NtreevSoft/psd-parser/tree/master" target="_blank" rel="noopener">psd-parser</a>。<br>这俩东西都已经有点老旧了，美术那边遇到了一个问题，他们做的智能对象图层不能正确导出。</p><img src="/2023/10/15/20231015-psd-complexlayer-export/20231015-psd-complexlayer-export-pic001.png" class="" title="split"><p>直接用文字有点难描述，大概是这样的。他们做的智能对象大小就和图里这个黑底一样大，但实际有图案部分就像红框里的那样，不会占满整个智能对象的区域。<br>用工具导出Sprite的时候，只会导出红框的大小。</p><hr><p>解决方法比较简单粗暴了，因为<a href="https://github.com/NtreevSoft/psd-parser/tree/master" target="_blank" rel="noopener">psd-parser</a>似乎不能很方便拿到智能对象的实际的区域尺寸，我只能让美术多做一个和需要导出的只能对象尺寸大小一样的纯色空图层。<br>同时新增两个后缀规则，让这个纯色空图层和需要依照智能对象尺寸导出的图层分别使用。</p><p>在<a href="https://github.com/zouhunter/unity-psd-ugui" target="_blank" rel="noopener">PSD2UGUI</a>中根据图层生成Texture的代码中添加后缀检查,检测到特殊规则的时候去去根据特殊的纯色图层的尺寸再去重新绘制Texture。同时在<a href="https://github.com/zouhunter/unity-psd-ugui" target="_blank" rel="noopener">PSD2UGUI</a>中根据图层创建他的ImageNode的时候有个Rect需要计算，这个Rect计算也要修改。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;当前的项目里因为UI缺乏UI美术人，没有人力导图拼图，所以使用了&lt;a href=&quot;https://github.com/zouhunter/unity-psd-ugui&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;PSD2UGUI&lt;/a&gt;插件。这个插件又
      
    
    </summary>
    
    
      <category term="UGUI" scheme="http://yoursite.com/categories/UGUI/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UGUI" scheme="http://yoursite.com/tags/UGUI/"/>
    
  </entry>
  
  <entry>
    <title>UGUI SafeArea 适配</title>
    <link href="http://yoursite.com/2023/07/30/20230730-ui-safe-area-rect/"/>
    <id>http://yoursite.com/2023/07/30/20230730-ui-safe-area-rect/</id>
    <published>2023-07-30T08:21:00.000Z</published>
    <updated>2023-08-12T08:03:49.394Z</updated>
    
    <content type="html"><![CDATA[<p>最近有在做手游。各个厂商手机屏幕的尺寸和比例都各不相同。UI适配可以说是一大难题叻。UI美术那边在制作的也有考虑到适配方面的问题，有许多元素是需要我们根据安全区来适配的。<br>但比较坑爹的一些情况是这样的，要求页面A下方有个按钮托盘，按钮托盘打开的时候要有一个大图背景去阻挡玩家点击原本页面A上的元素。这个按钮托盘还是在其他页面中也有用到的。为了解决这个问题，做了两个Rect适配的脚本。<br>还没完成，但是感觉基本能用，就先拉上来记一下。</p><p>这两个脚本都依赖与当前UI使用的相机和根Canvas。所以在实际使用的时候需要准备好这两个东西。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">UIAreaRect</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">Camera <span class="title">GetUICamera</span>(<span class="params"></span>)</span>;</span><br><span class="line">        <span class="function">Canvas <span class="title">GetRootCanvas</span>(<span class="params"></span>)</span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Refresh</span>(<span class="params"></span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">ExecuteAlways</span>]</span><br><span class="line">    [<span class="meta">RequireComponent(typeof(RectTransform))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SafeAreaRect</span> : <span class="title">UIBehaviour</span>, <span class="title">ILayoutSelfController</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Vector2 s_specialPivot = Vector2.zero; <span class="comment">// HACK @Hiko self pivot</span></span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> RectOffset _rectOffset = <span class="keyword">new</span> RectOffset();</span><br><span class="line"></span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Camera _uiCamera;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Canvas _rootCanvas;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> RectTransform m_rect;</span><br><span class="line">        <span class="keyword">private</span> DrivenRectTransformTracker m_tracker;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> RectTransform selfRectTransform</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_rect == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_rect = GetComponent&lt;RectTransform&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> m_rect;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetLayoutHorizontal</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Refresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetLayoutVertical</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Refresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"Refresh"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Refresh</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">            RebuildTracker();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            Camera uiCamera = GetUICamera();</span><br><span class="line">            RectTransform rectTransform = selfRectTransform, rootCanvasRectTransform = rootCanvas.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            RectTransform parent = rectTransform.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            <span class="keyword">if</span> (parent == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">"This behaviour can not to be used on root recttransform"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rootCanvas == <span class="literal">null</span> || uiCamera == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Rect safeRect = CalcultateCurrentSafeAreaRect();</span><br><span class="line">            rectTransform.pivot = s_specialPivot;</span><br><span class="line">            Vector3 worldUIPos;</span><br><span class="line">            Vector2 localPos = rootCanvasRectTransform.GetLocalRectPosition(RectPositionType.BottomLeft);</span><br><span class="line">            localPos.x += safeRect.x + _rectOffset.left;</span><br><span class="line">            <span class="keyword">float</span> deltaX = _rectOffset.horizontal;</span><br><span class="line">            rectTransform.SetSizeWithCurrentAnchors(RectTransform.Axis.Horizontal, safeRect.width - deltaX);</span><br><span class="line">            localPos.y += safeRect.y + _rectOffset.bottom;</span><br><span class="line">            <span class="keyword">float</span> deltaY = _rectOffset.vertical;</span><br><span class="line">            rectTransform.SetSizeWithCurrentAnchors(RectTransform.Axis.Vertical, safeRect.height - deltaY);</span><br><span class="line">            worldUIPos = rootCanvasRectTransform.TransformPoint(localPos);</span><br><span class="line">            rectTransform.position = worldUIPos;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Camera <span class="title">GetUICamera</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// TODO implement the actual code to get camera while in game or in editor </span></span><br><span class="line">            <span class="keyword">return</span> _uiCamera;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Canvas <span class="title">GetRootCanvas</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// TODO implement the actual code to get root canvas while in game or in editor </span></span><br><span class="line">            <span class="keyword">return</span> _rootCanvas;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Rect <span class="title">CalcultateCurrentSafeAreaRect</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Rect safeRect;</span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            RectTransform rootRectTransform = rootCanvas.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Rect rootCanvasRect = rootRectTransform.rect;</span><br><span class="line">            <span class="keyword">float</span> rootCanvasWidth = rootCanvasRect.width;</span><br><span class="line">            <span class="keyword">float</span> rootCanvasHeight = rootCanvasRect.height;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// temp pretend it is ip12</span></span><br><span class="line">            <span class="keyword">float</span> horizontalGap = <span class="number">0.055f</span>;</span><br><span class="line">            <span class="keyword">float</span> verticalGap = <span class="number">0.053f</span>;</span><br><span class="line">            <span class="keyword">switch</span> (SystemInfo.deviceType)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> DeviceType.Handheld:</span><br><span class="line">                    Rect deviceSafeRect = Screen.safeArea;</span><br><span class="line">                    <span class="keyword">if</span> (Mathf.Approximately(deviceSafeRect.x, <span class="number">0f</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// a device with saferect as fullrect</span></span><br><span class="line">                        safeRect = <span class="keyword">new</span> Rect(<span class="keyword">new</span> Vector2(rootCanvasWidth * horizontalGap, <span class="number">0f</span>), <span class="keyword">new</span> Vector2(rootCanvasWidth * (<span class="number">1f</span> - <span class="number">2</span> * horizontalGap), rootCanvasHeight * (<span class="number">1f</span> - verticalGap)));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        Resolution resolution = Screen.currentResolution;</span><br><span class="line">                        <span class="keyword">float</span> scale = rootCanvasWidth / resolution.width;</span><br><span class="line">                        safeRect = <span class="keyword">new</span> Rect(deviceSafeRect.x * scale, deviceSafeRect.y * scale, deviceSafeRect.width * scale, deviceSafeRect.height * scale);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="comment">// HACK @Hiko it's on PC, create a temp saferect and pretend it is ip12</span></span><br><span class="line">                    safeRect = <span class="keyword">new</span> Rect(<span class="keyword">new</span> Vector2(rootCanvasWidth * horizontalGap, <span class="number">0f</span>), <span class="keyword">new</span> Vector2(rootCanvasWidth * (<span class="number">1f</span> - <span class="number">2</span> * horizontalGap), rootCanvasHeight * (<span class="number">1f</span> - verticalGap)));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> safeRect;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RebuildTracker</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_tracker.Clear();</span><br><span class="line">            m_tracker.Add(<span class="keyword">this</span>, selfRectTransform, DrivenTransformProperties.All);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">base</span>.OnEnable();</span><br><span class="line">            RebuildTracker();</span><br><span class="line">            SetDirty();</span><br><span class="line">            <span class="keyword">if</span> (Application.isPlaying)</span><br><span class="line">            &#123;</span><br><span class="line">                Refresh();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDisable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_tracker.Clear();</span><br><span class="line">            LayoutRebuilder.MarkLayoutForRebuild(selfRectTransform);</span><br><span class="line">            <span class="keyword">base</span>.OnDisable();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetDirty</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsActive())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            LayoutRebuilder.MarkLayoutForRebuild(selfRectTransform);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Editor readonly debug stuff"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Rect _editorSafeRect;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _editorCurrentResolution;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _editorScreenSize;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> _editorScreenFactor;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> _editorScreenDpi;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> _editorCanvasFactor;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Rect _editorRootCanvasRect;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDrawGizmosSelected</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            UpdateEditorPreviewData();</span><br><span class="line">            Color color = Color.blue;</span><br><span class="line">            Rect safeRect = CalcultateCurrentSafeAreaRect();</span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            RectTransform rootRectTransform = rootCanvas.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Vector2 bottomLeft = rootRectTransform.GetLocalRectPosition(RectPositionType.BottomLeft);</span><br><span class="line">            bottomLeft.x += safeRect.x;</span><br><span class="line">            bottomLeft.y += safeRect.y;</span><br><span class="line">            DrawBox(rootRectTransform, bottomLeft, safeRect.size, color);</span><br><span class="line">            <span class="comment">// draw safe area end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Mathf.Approximately(_rectOffset.horizontal, <span class="number">0f</span>) &amp;&amp; Mathf.Approximately(_rectOffset.vertical, <span class="number">0f</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Rect nextRect = safeRect;</span><br><span class="line">            nextRect.width -= _rectOffset.horizontal;</span><br><span class="line">            nextRect.height -= _rectOffset.vertical;</span><br><span class="line">            nextRect.x += _rectOffset.left;</span><br><span class="line">            nextRect.y += _rectOffset.bottom;</span><br><span class="line">            bottomLeft = rootRectTransform.GetLocalRectPosition(RectPositionType.BottomLeft);</span><br><span class="line">            bottomLeft.x += nextRect.x;</span><br><span class="line">            bottomLeft.y += nextRect.y;</span><br><span class="line">            color.a *= <span class="number">0.8f</span>;</span><br><span class="line">            DrawBox(rootRectTransform, bottomLeft, nextRect.size, color);</span><br><span class="line">            <span class="comment">// draw actual safe area end</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawBox</span>(<span class="params">RectTransform reference, Vector2 bottomLeftLocalPos, Vector2 size, Color color</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Color cachedColor = Gizmos.color;</span><br><span class="line">            Gizmos.color = color;</span><br><span class="line">            <span class="keyword">if</span> (reference != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos), reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x));</span><br><span class="line">                Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos), reference.TransformPoint(bottomLeftLocalPos + Vector2.up * size.y));</span><br><span class="line">                Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x), reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x + Vector2.up * size.y));</span><br><span class="line">                Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos + Vector2.up * size.y), reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x + Vector2.up * size.y));</span><br><span class="line">            &#125;</span><br><span class="line">            Gizmos.color = cachedColor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateEditorPreviewData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            _editorSafeRect = CalcultateCurrentSafeAreaRect();</span><br><span class="line">            _editorScreenSize = <span class="keyword">new</span> Vector2(Screen.width, Screen.height);</span><br><span class="line">            _editorCurrentResolution = <span class="keyword">new</span> Vector2(Screen.currentResolution.width, Screen.currentResolution.height);</span><br><span class="line">            _editorScreenFactor = Screen.currentResolution.width / Screen.width;</span><br><span class="line">            _editorScreenDpi = Screen.dpi;</span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            <span class="keyword">if</span> (rootCanvas != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _editorCanvasFactor = rootCanvas.scaleFactor;</span><br><span class="line">                _editorRootCanvasRect = (rootCanvas.transform <span class="keyword">as</span> RectTransform).rect;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     [<span class="meta">ExecuteAlways</span>]</span><br><span class="line">    [<span class="meta">RequireComponent(typeof(RectTransform))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ScreenRawRect</span> : <span class="title">UIBehaviour</span>, <span class="title">ILayoutSelfController</span>, <span class="title">UIAreaRect</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Vector2 s_specialPivot = Vector2.zero; <span class="comment">// HACK @Hiko self pivot</span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> RectOffset _rectOffset = <span class="keyword">new</span> RectOffset();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> RectTransform m_rect;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> RectTransform selfRectTransform</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_rect == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_rect = GetComponent&lt;RectTransform&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> m_rect;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// temp solution for testing</span></span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Camera m_uiCamera;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Canvas m_rootCanvas;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> DrivenRectTransformTracker m_tracker;</span><br><span class="line">        <span class="keyword">private</span> RectTransform m_rectTransform;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> RectTransform rectTransform</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_rectTransform == <span class="literal">null</span>)</span><br><span class="line">                    m_rectTransform = GetComponent&lt;RectTransform&gt;();</span><br><span class="line">                <span class="keyword">return</span> m_rectTransform;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetLayoutHorizontal</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Refresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetLayoutVertical</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Refresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"Refresh"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Refresh</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Camera uiCamera = GetUICamera();</span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            RectTransform rootCanvasRectTransform = rootCanvas.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Rect sizeRect = rootCanvasRectTransform.rect;</span><br><span class="line">            RectTransform selfRectTransform = rectTransform;</span><br><span class="line">            selfRectTransform.pivot = s_specialPivot;</span><br><span class="line">            Vector3 worldUIPos = RectTransformEx.ScreenToWorld(Vector2.zero, rootCanvas, uiCamera);</span><br><span class="line">            selfRectTransform.position = worldUIPos;</span><br><span class="line">            Vector2 localPos = selfRectTransform.localPosition;</span><br><span class="line">            <span class="keyword">float</span> leftOffset = _rectOffset.left;</span><br><span class="line">            localPos.x += leftOffset;</span><br><span class="line">            <span class="keyword">float</span> deltaX = _rectOffset.horizontal;</span><br><span class="line">            selfRectTransform.SetSizeWithCurrentAnchors(RectTransform.Axis.Horizontal, sizeRect.width - deltaX);</span><br><span class="line">            <span class="keyword">float</span> bottomOffset = _rectOffset.bottom;</span><br><span class="line">            localPos.y += bottomOffset;</span><br><span class="line">            <span class="keyword">float</span> deltaY = _rectOffset.vertical;</span><br><span class="line">            selfRectTransform.SetSizeWithCurrentAnchors(RectTransform.Axis.Vertical, sizeRect.height - deltaY);</span><br><span class="line">            selfRectTransform.localPosition = localPos;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Camera <span class="title">GetUICamera</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_uiCamera;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Canvas <span class="title">GetRootCanvas</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_rootCanvas;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetDirty</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsActive())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            LayoutRebuilder.MarkLayoutForRebuild(rectTransform);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RebuildTracker</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_tracker.Clear();</span><br><span class="line">            m_tracker.Add(<span class="keyword">this</span>, selfRectTransform, DrivenTransformProperties.All);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">base</span>.OnEnable();</span><br><span class="line">            RebuildTracker();</span><br><span class="line">            SetDirty();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDisable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_tracker.Clear();</span><br><span class="line">            LayoutRebuilder.MarkLayoutForRebuild(rectTransform);</span><br><span class="line">            <span class="keyword">base</span>.OnDisable();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Editor readonly debug stuff"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _editorCurrentResolution;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _editorScreenSize;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> _editorScreenFactor;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> _editorScreenDpi;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> _editorCanvasFactor;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Rect _editorRootCanvasRect;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDrawGizmosSelected</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Color color = Color.blue;</span><br><span class="line">            UpdateEditorPreviewData();</span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            RectTransform rootRectTransform = rootCanvas.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Rect rect = rootRectTransform.rect;</span><br><span class="line">            Vector2 bottomLeft = rootRectTransform.GetLocalRectPosition(RectPositionType.BottomLeft);</span><br><span class="line">            DrawBox(rootRectTransform, bottomLeft, <span class="keyword">new</span> Vector2(rect.width, rect.height), color);</span><br><span class="line">            <span class="comment">// draw raw rect</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Mathf.Approximately(_rectOffset.horizontal, <span class="number">0f</span>) &amp;&amp; Mathf.Approximately(_rectOffset.vertical, <span class="number">0f</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            rect.width -= _rectOffset.horizontal;</span><br><span class="line">            rect.height -= _rectOffset.vertical;</span><br><span class="line">            bottomLeft.x += _rectOffset.left;</span><br><span class="line">            bottomLeft.y += _rectOffset.bottom;</span><br><span class="line">            DrawBox(rootRectTransform, bottomLeft, <span class="keyword">new</span> Vector2(rect.width, rect.height), color);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawBox</span>(<span class="params">RectTransform reference, Vector2 bottomLeftLocalPos, Vector2 size, Color color</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Color cachedColor = Gizmos.color;</span><br><span class="line">            Gizmos.color = color;</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos), reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x));</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos), reference.TransformPoint(bottomLeftLocalPos + Vector2.up * size.y));</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x), reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x + Vector2.up * size.y));</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(bottomLeftLocalPos + Vector2.up * size.y), reference.TransformPoint(bottomLeftLocalPos + Vector2.right * size.x + Vector2.up * size.y));</span><br><span class="line">            Gizmos.color = cachedColor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateEditorPreviewData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            _editorScreenSize = <span class="keyword">new</span> Vector2(Screen.width, Screen.height);</span><br><span class="line">            _editorCurrentResolution = <span class="keyword">new</span> Vector2(Screen.currentResolution.width, Screen.currentResolution.height);</span><br><span class="line">            _editorScreenFactor = Screen.currentResolution.width / Screen.width;</span><br><span class="line">            _editorScreenDpi = Screen.dpi;</span><br><span class="line">            Canvas rootCanvas = GetRootCanvas();</span><br><span class="line">            <span class="keyword">if</span> (rootCanvas != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _editorCanvasFactor = rootCanvas.scaleFactor;</span><br><span class="line">                _editorRootCanvasRect = (rootCanvas.transform <span class="keyword">as</span> RectTransform).rect;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">RectTransformEx</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">GetLocalRectPosition</span>(<span class="params"><span class="keyword">this</span> RectTransform target, RectPositionType offsetType</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Vector3 result = Vector3.zero;</span><br><span class="line">            Vector2 targetSize = target.rect.size;</span><br><span class="line">            Vector2 targetPivot = target.pivot;</span><br><span class="line"></span><br><span class="line">            Vector2 pivotOffset = Vector2.one * <span class="number">0.5f</span> - targetPivot;</span><br><span class="line">            pivotOffset.x *= targetSize.x;</span><br><span class="line">            pivotOffset.y *= targetSize.y;</span><br><span class="line"></span><br><span class="line">            result += (Vector3)pivotOffset;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (offsetType)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Top:</span><br><span class="line">                    result.y += targetSize.y * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Bottom:</span><br><span class="line">                    result.y -= targetSize.y * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Left:</span><br><span class="line">                    result.x -= targetSize.x * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Right:</span><br><span class="line">                    result.x += targetSize.x * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> RectPositionType.TopLeft:</span><br><span class="line">                    result.y += targetSize.y * <span class="number">0.5f</span>;</span><br><span class="line">                    result.x -= targetSize.x * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.TopRight:</span><br><span class="line">                    result.y += targetSize.y * <span class="number">0.5f</span>;</span><br><span class="line">                    result.x += targetSize.x * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> RectPositionType.BottomLeft:</span><br><span class="line">                    result.y -= targetSize.y * <span class="number">0.5f</span>;</span><br><span class="line">                    result.x -= targetSize.x * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> RectPositionType.BottomRight:</span><br><span class="line">                    result.y -= targetSize.y * <span class="number">0.5f</span>;</span><br><span class="line">                    result.x += targetSize.x * <span class="number">0.5f</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">ScreenToWorld</span>(<span class="params">Vector2 screenPoint, Canvas rootCanvas, Camera uiCamera</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">switch</span> (rootCanvas.renderMode)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> RenderMode.ScreenSpaceOverlay:</span><br><span class="line">                    <span class="keyword">return</span> screenPoint;</span><br><span class="line">                <span class="keyword">case</span> RenderMode.ScreenSpaceCamera:</span><br><span class="line">                    RectTransformUtility.ScreenPointToWorldPointInRectangle((RectTransform)rootCanvas.transform, screenPoint, uiCamera, <span class="keyword">out</span> Vector3 worldPoint);</span><br><span class="line">                    <span class="keyword">return</span> worldPoint;</span><br><span class="line">                <span class="keyword">case</span> RenderMode.WorldSpace:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> System.NotImplementedException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><img src="/2023/07/30/20230730-ui-safe-area-rect/20230730-ui-safe-area-rect-pic001.png" class="" title="split"><p>最开始做的时候我很粗心的直接把 Screen.SafeArea 的大小直接给应用到 RectTransform 上了。后来发现这样是不对的，Screen.SafeArea 获取到的是实际的物理尺寸的安全区。<br>后来我是算出物理尺寸和根Canvas尺寸的笔直，再去计算出实际的RectTransform大小。</p><p>基本上可以凑合使用了。还比较遗憾的一点是，我没有能够让其支持只适配四个方向中的任1或者任2方向。比较简单的解决方法就是让不同适配的RectTransform互相套一下。</p><p>UI同学在调整动效以及物体布局的时候，会用Unity中的Device Simulator尝试切换不同的机型来查看不同设备上的UI 预览。这个时候可能需要有一个编辑器的监听器去监听设备变更的事件，然后发起全部UI尺寸刷新的请求。<br>这样会更方便他们做预览。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近有在做手游。各个厂商手机屏幕的尺寸和比例都各不相同。UI适配可以说是一大难题叻。UI美术那边在制作的也有考虑到适配方面的问题，有许多元素是需要我们根据安全区来适配的。&lt;br&gt;但比较坑爹的一些情况是这样的，要求页面A下方有个按钮托盘，按钮托盘打开的时候要有一个大图背景去阻
      
    
    </summary>
    
    
      <category term="UGUI" scheme="http://yoursite.com/categories/UGUI/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UGUI" scheme="http://yoursite.com/tags/UGUI/"/>
    
  </entry>
  
  <entry>
    <title>Unity编辑器中以enum的方式绘制int</title>
    <link href="http://yoursite.com/2023/07/23/20230723-int-draw-as-enum/"/>
    <id>http://yoursite.com/2023/07/23/20230723-int-draw-as-enum/</id>
    <published>2023-07-23T09:34:10.000Z</published>
    <updated>2023-07-24T16:07:44.072Z</updated>
    
    <content type="html"><![CDATA[<p>项目里的UI框架有非常方便实用的数据绑定功能。各种UI表现件也可以根据数据集里的某个int改变UI表现。但是比较逆天的是我们经常把enum转int然后再到表现件上去调对应的各种状态。<br>对着magic number调配置确实很让人苦恼。</p><p>思路就是再需要根据int来调偶配置的component上添加一个编辑器里专用的Type对象，然后根据这个对象类型去画int。基于Odin做的，但我觉得这个思路应该还不错。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="comment">// use a string to temply store the type</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">AttributeUsage(AttributeTargets.Field)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnumTypeQualifiedName</span>: <span class="title">Attribute</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DrawerPriority(DrawerPriorityLevel.WrapperPriority)</span>]</span><br><span class="line">    public class EnumTypeQualifiedNameAttributeDrawer : OdinAttributeDrawer&lt;EnumTypeQualifiedName, string&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title">EditingState</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;Type&gt; tempQuery;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">bool</span> wannaSet = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">public</span> Type selectedType = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DrawPropertyLayout</span>(<span class="params">GUIContent label</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">string</span> currentName = <span class="keyword">this</span>.ValueEntry.SmartValue;</span><br><span class="line">            Type enumType = <span class="keyword">string</span>.IsNullOrEmpty(currentName) ? <span class="literal">null</span> : Type.GetType(currentName);</span><br><span class="line">            <span class="keyword">string</span> enumTypeNiceName = enumType == <span class="literal">null</span> ? <span class="string">"invalid!!!"</span> : enumType.GetNiceName();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> controlId = GUIUtility.GetControlID(FocusType.Passive);</span><br><span class="line">            EditingState state = GUIUtility.GetStateObject(<span class="keyword">typeof</span>(EditingState), controlId) <span class="keyword">as</span> EditingState;</span><br><span class="line">            <span class="keyword">if</span> (state.wannaSet)</span><br><span class="line">            &#123;</span><br><span class="line">                currentName = state.selectedType.AssemblyQualifiedName;</span><br><span class="line">                state.selectedType = <span class="literal">null</span>;</span><br><span class="line">                state.wannaSet = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">this</span>.ValueEntry.SmartValue = currentName;</span><br><span class="line">            &#125;</span><br><span class="line">            EditorGUILayout.BeginVertical();</span><br><span class="line">            GUIStyle guiStyle = <span class="keyword">new</span> GUIStyle(EditorStyles.label);</span><br><span class="line">            guiStyle.alignment = TextAnchor.MiddleLeft;</span><br><span class="line">            EditorGUILayout.LabelField(<span class="keyword">this</span>.Property.NiceName, guiStyle);</span><br><span class="line"></span><br><span class="line">            guiStyle = <span class="keyword">new</span> GUIStyle(EditorStyles.popup);</span><br><span class="line">            guiStyle.alignment = TextAnchor.MiddleLeft;</span><br><span class="line">            <span class="keyword">if</span> (EditorGUILayout.DropdownButton(<span class="keyword">new</span> GUIContent(<span class="string">$"Preview Enum Type (<span class="subst">&#123;enumTypeNiceName&#125;</span>)"</span>), FocusType.Keyboard, guiStyle))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (EditingState.tempQuery == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    EditingState.tempQuery = GetTargetEnumTypes();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                TypeSelector selector = <span class="keyword">new</span> TypeSelector(EditingState.tempQuery, <span class="literal">false</span>);</span><br><span class="line">                selector.EnableSingleClickToSelect();</span><br><span class="line">                selector.ShowInPopup();</span><br><span class="line">                selector.SelectionConfirmed += selection =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> resultTypeArray = selection.ToArray();</span><br><span class="line">                    <span class="keyword">if</span> (resultTypeArray.Length &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Type selectedType = resultTypeArray.GetValue(<span class="number">0</span>) <span class="keyword">as</span> Type;</span><br><span class="line">                        EditingState state = GUIUtility.GetStateObject(<span class="keyword">typeof</span>(EditingState), controlId) <span class="keyword">as</span> EditingState;</span><br><span class="line">                        state.selectedType = selectedType;</span><br><span class="line">                        state.wannaSet = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            EditorGUILayout.EndVertical();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IEnumerable&lt;Type&gt; <span class="title">GetTargetEnumTypes</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// TODO @Hiko here to get actual enum types</span></span><br><span class="line">            TypeCache.TypeCollection cache = TypeCache.GetTypesDerivedFrom&lt;Enum&gt;();</span><br><span class="line">            <span class="keyword">var</span> query = cache.Where(t =&gt; t.IsEnum &amp;&amp; t.IsPublic);</span><br><span class="line">            <span class="keyword">return</span> query;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// put temply data into a sturct </span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> IntAsEnumEditorPack</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> showIntAsEnumForTaggedField;</span><br><span class="line">        [<span class="meta">EnumTypeQualifiedName</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> enumTypeQualifiedName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IIntAsEnumPackHolder</span></span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        IntAsEnumEditorPack holderData &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// draw enum popup for int</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">AttributeUsage(AttributeTargets.Field)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IntAsEnumAttribute</span> : <span class="title">Attribute</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DrawerPriority(DrawerPriorityLevel.WrapperPriority)</span>]</span><br><span class="line">    public class IntAsEnumAttributeDrawer : OdinAttributeDrawer&lt;IntAsEnumAttribute, int&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DrawPropertyLayout</span>(<span class="params">GUIContent label</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> nextValue, prevValue = <span class="keyword">this</span>.ValueEntry.SmartValue;</span><br><span class="line">            InspectorProperty containerProterty = <span class="keyword">this</span>.ValueEntry.Property;</span><br><span class="line">            Type holderType = <span class="keyword">typeof</span>(IIntAsEnumPackHolder);</span><br><span class="line">            Type containerType = containerProterty.ParentType;</span><br><span class="line">            <span class="keyword">bool</span> doContinue = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">while</span> (doContinue)</span><br><span class="line">            &#123;</span><br><span class="line">                Type parentType = containerProterty.ParentType;</span><br><span class="line">                <span class="keyword">if</span> (parentType == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                containerType = parentType;</span><br><span class="line">                containerProterty = containerProterty.Parent;</span><br><span class="line">                <span class="keyword">if</span> (holderType.IsAssignableFrom(containerType))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            GUIStyle guiStyle = <span class="keyword">new</span> GUIStyle(EditorStyles.label);</span><br><span class="line">            guiStyle.alignment = TextAnchor.MiddleLeft;</span><br><span class="line">            <span class="keyword">if</span> (containerType != <span class="literal">null</span> &amp;&amp; holderType.IsAssignableFrom(containerType))</span><br><span class="line">            &#123;</span><br><span class="line">                IIntAsEnumPackHolder holder = containerProterty.ValueEntry.WeakSmartValue <span class="keyword">as</span> IIntAsEnumPackHolder;</span><br><span class="line">                IntAsEnumEditorPack packData = holder.holderData;</span><br><span class="line">                <span class="keyword">if</span> (packData.showIntAsEnumForTaggedField)</span><br><span class="line">                &#123;</span><br><span class="line">                    EditorGUILayout.BeginVertical();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="keyword">this</span>.Property.NiceName, guiStyle);</span><br><span class="line">                    Type enumType = <span class="keyword">string</span>.IsNullOrEmpty(packData.enumTypeQualifiedName) ? <span class="literal">null</span> : Type.GetType(packData.enumTypeQualifiedName);</span><br><span class="line">                    <span class="keyword">if</span> (enumType != <span class="literal">null</span> &amp;&amp; enumType.IsEnum)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Enum prevEnumValue;</span><br><span class="line">                        <span class="keyword">if</span> (!enumType.IsEnumDefined(prevValue))</span><br><span class="line">                        &#123;</span><br><span class="line">                            prevEnumValue = Enum.GetValues(enumType).GetValue(<span class="number">0</span>) <span class="keyword">as</span> Enum;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            prevEnumValue = (Enum)Enum.ToObject(enumType, prevValue);</span><br><span class="line">                        &#125;</span><br><span class="line">                        guiStyle = <span class="keyword">new</span> GUIStyle(EditorStyles.popup);</span><br><span class="line">                        guiStyle.stretchWidth = <span class="literal">false</span>;</span><br><span class="line">                        guiStyle.alignment = TextAnchor.MiddleLeft;</span><br><span class="line">                        Enum nextEnumValue = EditorGUILayout.EnumPopup(prevEnumValue, guiStyle);</span><br><span class="line">                        nextValue = Convert.ToInt32(nextEnumValue);</span><br><span class="line">                        <span class="keyword">this</span>.ValueEntry.SmartValue = nextValue;</span><br><span class="line">                        guiStyle = <span class="keyword">new</span> GUIStyle(EditorStyles.label);</span><br><span class="line">                        guiStyle.alignment = TextAnchor.MiddleLeft;</span><br><span class="line">                        guiStyle.stretchWidth = <span class="literal">false</span>;</span><br><span class="line">                        EditorGUILayout.LabelField(<span class="string">$"int value: (<span class="subst">&#123;nextValue&#125;</span>)"</span>, guiStyle);</span><br><span class="line">                    &#125;</span><br><span class="line">                    EditorGUILayout.EndVertical();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// can not find the target preview enum type, draw normal int field</span></span><br><span class="line">            EditorGUILayout.BeginHorizontal();</span><br><span class="line">            EditorGUILayout.LabelField(<span class="keyword">this</span>.Property.NiceName);</span><br><span class="line">            nextValue = EditorGUILayout.IntField(prevValue);</span><br><span class="line">            <span class="keyword">this</span>.ValueEntry.SmartValue = nextValue;</span><br><span class="line">            EditorGUILayout.EndHorizontal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// test case</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TesterA</span> : <span class="title">MonoBehaviour</span>, <span class="title">IIntAsEnumPackHolder</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> IntAsEnumEditorPack intAsEnumEditorPack;</span><br><span class="line">        <span class="keyword">public</span> IntAsEnumEditorPack holderData =&gt; intAsEnumEditorPack;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">Serializable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">struct</span> TempStructA</span><br><span class="line">        &#123;</span><br><span class="line">            [<span class="meta">IntAsEnum</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">int</span> tempInt;</span><br><span class="line">            <span class="keyword">public</span> Color tempColor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> TempStructA[] tempArray;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">IntAsEnum</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> tempIntA;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>效果如下<br><img src="/2023/07/23/20230723-int-draw-as-enum/20230723-int-draw-as-enum-pic001.png" class="" title="split"></p><p>用起来是方便了，但是也引入了一个问题。这个做法会需要序列化一这两个小小的字段到物体上。导致Prefab变肥了，但感觉打包的时候打出来的prefab里应该不会包含这俩字段，应该还凑合啦。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;项目里的UI框架有非常方便实用的数据绑定功能。各种UI表现件也可以根据数据集里的某个int改变UI表现。但是比较逆天的是我们经常把enum转int然后再到表现件上去调对应的各种状态。&lt;br&gt;对着magic number调配置确实很让人苦恼。&lt;/p&gt;
&lt;p&gt;思路就是再需要根据
      
    
    </summary>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/categories/UnityEditor/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UnityEditor" scheme="http://yoursite.com/tags/UnityEditor/"/>
    
  </entry>
  
  <entry>
    <title>CSharp字典使用enum的装箱</title>
    <link href="http://yoursite.com/2023/07/09/20230709-dictionary-enum-boxing/"/>
    <id>http://yoursite.com/2023/07/09/20230709-dictionary-enum-boxing/</id>
    <published>2023-07-09T09:43:00.000Z</published>
    <updated>2023-07-09T10:14:09.719Z</updated>
    
    <content type="html"><![CDATA[<p>今天看了下Unity官方2016年发的一个关于移动端小优化的一些分享视频。其中有一个关于把enum作为Dictionary中的key来使用时的boxing优化。</p><img src="/2023/07/09/20230709-dictionary-enum-boxing/20230709-dictionary-enum-boxing-01.png" class="" title="split"><p>这个用法在我之前的项目里用得还挺多吧。直接上图看IL code。</p><img src="/2023/07/09/20230709-dictionary-enum-boxing/20230709-dictionary-enum-boxing-02.png" class="" title="split"><p>Dictionary的增删查操作其实都会有用comparer.Equals()来判断是否相等的情况。<br>构建Dictionary时如果不传入指定的comparer，他会自己赋予一个’默认的’。这个默认的显然不适那么的友好。</p><img src="/2023/07/09/20230709-dictionary-enum-boxing/20230709-dictionary-enum-boxing-05.png" class="" title="split"><p>我们创建一个comparer，然后直接看使用comparer和不使用的两种不同情况下的IL code。</p><img src="/2023/07/09/20230709-dictionary-enum-boxing/20230709-dictionary-enum-boxing-03.png" class="" title="split"><img src="/2023/07/09/20230709-dictionary-enum-boxing/20230709-dictionary-enum-boxing-04.png" class="" title="split"><p>很明显使用我们自己的comparer可以免去装箱的消耗。</p><p>后来我又拿到Unity里跑了一下看profiler。尝试跑了查询和添加，差距确实有，但是从Profiler中看结果，200万次的操作下，GC是差不多的，时间上使用comparer快了1300多ms。<br>说实在的觉得是我的测试方法有问题。而且我跑在桌面端，这样测试也不严谨。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;今天看了下Unity官方2016年发的一个关于移动端小优化的一些分享视频。其中有一个关于把enum作为Dictionary中的key来使用时的boxing优化。&lt;/p&gt;
&lt;img src=&quot;/2023/07/09/20230709-dictionary-enum-boxin
      
    
    </summary>
    
    
      <category term="CSharp" scheme="http://yoursite.com/categories/CSharp/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="CSharp" scheme="http://yoursite.com/tags/CSharp/"/>
    
  </entry>
  
  <entry>
    <title>Unity动画控制Layout参数</title>
    <link href="http://yoursite.com/2023/06/18/20230618-animating-layout-params/"/>
    <id>http://yoursite.com/2023/06/18/20230618-animating-layout-params/</id>
    <published>2023-06-18T02:29:43.000Z</published>
    <updated>2023-06-18T05:37:20.904Z</updated>
    
    <content type="html"><![CDATA[<p>在实际制作UI的时候，为了完成一些排版设计，我们会经常用到Unity的布局(Layout)组件。甚至有些复杂的排版，我会用嵌套布局来实现。<br>UI美术人经常希望在这些布局上加上一些进场出场动画(甚至包括spacing变动)，但布局组件上的数值是没法在动画中修改的，怎么办呢？</p><h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2><p>在布局中添加一些空物体或是在布局外面套空物体。然后再使用Tween动画来完成UI美术们想要的那些进出场动画。<br>美术人不太喜欢的方法，因为有那么一点点不太方便和Animation直接一起预览，但如果整体进出场动画不依赖UnityAnimation且不是很复杂，这种方法完全够用。</p><h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2><p>用通过动画控制脚本上的可序列化的数值，再传递到布局组件上。<br>个人感觉这个方法也还不错，还能支持预览，UI美术更偏向于这一个解决方法。</p><p>但是在动画窗口里里看到的curve是锯齿状的，很奇怪。之后还需要看下如何才能像其他属性一样拉正常的曲线。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line">[<span class="meta">ExecuteAlways</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LayoutGroupTempAnimationParam</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> LayoutGroup _target;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _left;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _right;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _top;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _bottom;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Header(<span class="meta-string">"GridLayout must use GridSpacing"</span>)</span>]</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> _alsoControlSpacing;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _normalSpacing = <span class="number">0</span>;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> Vector2 _gridSpacing = Vector2.zero;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RectOffset m_targetPadding;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnDidApplyAnimationProperties</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_target == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ApplyPadding();</span><br><span class="line">        <span class="keyword">if</span> (_alsoControlSpacing)</span><br><span class="line">        &#123;</span><br><span class="line">            ApplySpacing();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// need to notify refresh</span></span><br><span class="line">        RectTransform rectTransform = <span class="keyword">this</span>.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">        LayoutRebuilder.MarkLayoutForRebuild(rectTransform);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyPadding</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_targetPadding = _target.padding;</span><br><span class="line">        <span class="keyword">if</span> (m_targetPadding != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_targetPadding.left = _left;</span><br><span class="line">            m_targetPadding.right = _right;</span><br><span class="line">            m_targetPadding.top = _top;</span><br><span class="line">            m_targetPadding.bottom = _bottom;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplySpacing</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_target <span class="keyword">is</span> HorizontalOrVerticalLayoutGroup layoutGroup)</span><br><span class="line">        &#123;</span><br><span class="line">            layoutGroup.spacing = _normalSpacing;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (_target <span class="keyword">is</span> GridLayoutGroup gridLayoutGroup)</span><br><span class="line">        &#123;</span><br><span class="line">            gridLayoutGroup.spacing = _gridSpacing;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnValidate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ApplyPadding();</span><br><span class="line">        <span class="keyword">if</span> (_alsoControlSpacing)</span><br><span class="line">        &#123;</span><br><span class="line">            ApplySpacing();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!Application.isPlaying)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// need to notify refresh</span></span><br><span class="line">            RectTransform rectTransform = <span class="keyword">this</span>.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            LayoutRebuilder.MarkLayoutForRebuild(rectTransform);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _target = <span class="keyword">this</span>.GetComponent&lt;LayoutGroup&gt;();</span><br><span class="line">        m_targetPadding = _target.padding;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/06/18/20230618-animating-layout-params/20230618-animating-layout-params-01.gif" class="" title="split">]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在实际制作UI的时候，为了完成一些排版设计，我们会经常用到Unity的布局(Layout)组件。甚至有些复杂的排版，我会用嵌套布局来实现。&lt;br&gt;UI美术人经常希望在这些布局上加上一些进场出场动画(甚至包括spacing变动)，但布局组件上的数值是没法在动画中修改的，怎么办
      
    
    </summary>
    
    
      <category term="Unity" scheme="http://yoursite.com/categories/Unity/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UGUI" scheme="http://yoursite.com/tags/UGUI/"/>
    
  </entry>
  
  <entry>
    <title>Unity编辑器内静音Wwise</title>
    <link href="http://yoursite.com/2023/06/17/20230617-editor-wwise-mute/"/>
    <id>http://yoursite.com/2023/06/17/20230617-editor-wwise-mute/</id>
    <published>2023-06-17T02:15:00.000Z</published>
    <updated>2023-06-18T02:29:17.469Z</updated>
    
    <content type="html"><![CDATA[<p>项目引入Wwise以后，相信蛮多人都和我一样，平时不想听游戏声音就想听歌捶码修BUG的。但是Unity原本的mute按钮没法直接直接对Wwise那边做操作。<br>一开始不知道是搜索引擎的使用姿势不对还是咋的，查了好久都没查出来。导师研究了一下弄了一个版，大家用了感觉都很不错，决定分享出来。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">EditorWwiseManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> m_isPaused = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">EditorWwiseManager</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        EditorApplication.update += OnUpdate;</span><br><span class="line">        EditorApplication.pauseStateChanged += OnPauseStateChanged;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnPauseStateChanged</span>(<span class="params">PauseState state</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (state)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> PauseState.Paused:</span><br><span class="line">                m_isPaused = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PauseState.Unpaused:</span><br><span class="line">                m_isPaused = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnUpdate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (EditorUtility.audioMasterMute &amp;&amp; !m_isPaused)</span><br><span class="line">        &#123;</span><br><span class="line">            AkSoundEngine.Suspend(<span class="literal">true</span>);</span><br><span class="line">            m_isPaused = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!EditorUtility.audioMasterMute &amp;&amp; m_isPaused)</span><br><span class="line">        &#123;</span><br><span class="line">            AkSoundEngine.WakeupFromSuspend();</span><br><span class="line">            m_isPaused = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就可以通过Editor SceneView上的mute按钮把Wwise静音，超级方便凹。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;项目引入Wwise以后，相信蛮多人都和我一样，平时不想听游戏声音就想听歌捶码修BUG的。但是Unity原本的mute按钮没法直接直接对Wwise那边做操作。&lt;br&gt;一开始不知道是搜索引擎的使用姿势不对还是咋的，查了好久都没查出来。导师研究了一下弄了一个版，大家用了感觉都很不
      
    
    </summary>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/categories/UnityEditor/"/>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/tags/UnityEditor/"/>
    
  </entry>
  
  <entry>
    <title>传入Predicate的小事</title>
    <link href="http://yoursite.com/2023/05/01/20230501-list-pass-predicate/"/>
    <id>http://yoursite.com/2023/05/01/20230501-list-pass-predicate/</id>
    <published>2023-05-01T06:16:03.000Z</published>
    <updated>2023-05-01T06:47:56.718Z</updated>
    
    <content type="html"><![CDATA[<p>现在依旧是在项目里负责一些UI业务的编写。前段时间需要需要给游戏中的 popup提示 做一些简单的重构，正好发现了我一直以来都误解的一个小点，决定记下来。</p><p>业务的要求就是做那种会弹出来一会儿再消失的提示，比如道具获取之类的UI。</p><p>我的做法就是用一个list去存着当前的提示，并 tick 检查它们是否结束，然后移除已经结束的相关数据。<br>大概的用法如下。</p><img src="/2023/05/01/20230501-list-pass-predicate/20230501-pic001.png" class="" title="split"><p>但其实啊，这个做法在 tick 是非常不好的。同事很快地通过 JetBrainsRider 查看 IL Code ，并告诉我，直接这样传入会每次都 new obj 。有比较大的消耗。<br>所以在这种需要<strong>经常</strong> tick 并且条件<strong>比较固定</strong>的情况下。我们可以创建好 predicate 然后直接重复使用(可以存在成员变量里，这里演示就直接存在本地变量里了)。</p><img src="/2023/05/01/20230501-list-pass-predicate/20230501-pic002.png" class="" title="split"><p>最后附上测试代码和结果 测试 count 为 100000</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PredicateTempTest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> TempPack</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> tempValue;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Random s_random = <span class="keyword">new</span> Random(DateTime.Now.Millisecond);</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TempPack <span class="title">CreateTempPack</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            TempPack pack = <span class="keyword">default</span>;</span><br><span class="line">            <span class="keyword">if</span> (s_random == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                s_random = <span class="keyword">new</span> Random(DateTime.Now.Millisecond);</span><br><span class="line">            &#125;</span><br><span class="line">            pack.tempValue = s_random.Next(<span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">            <span class="keyword">return</span> pack;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;List&lt;TempPack&gt;&gt; s_tempListContainer = <span class="keyword">new</span> List&lt;List&lt;TempPack&gt;&gt;(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoTest</span>(<span class="params"><span class="keyword">int</span> tempCount</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        FillTestData(tempCount);</span><br><span class="line">        DoTestLambda();</span><br><span class="line">        DoTestPassMethod();</span><br><span class="line">        DoTestPassExistPredicate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FillTestData</span>(<span class="params"><span class="keyword">int</span> tempCount</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        s_tempListContainer.Clear();</span><br><span class="line">        s_tempListContainer.Capacity = tempCount;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tempCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;TempPack&gt; tempList = <span class="keyword">new</span> List&lt;TempPack&gt;(tempCount);</span><br><span class="line">            s_tempListContainer.Add(tempList);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; tempCount; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                tempList.Add(TempPack.CreateTempPack());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoTestLambda</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">""</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">"TestLambda start"</span>);</span><br><span class="line">        Stopwatch stopWatch = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">        stopWatch.Start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, containerSize = s_tempListContainer.Count; i &lt; containerSize; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;TempPack&gt; tempList = s_tempListContainer[i];</span><br><span class="line">            tempList.Find((existPack) =&gt; existPack.tempValue % <span class="number">5</span> == <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        stopWatch.Stop();</span><br><span class="line">        Console.WriteLine(<span class="string">$"TestLambda end, result_<span class="subst">&#123;stopWatch.ElapsedMilliseconds&#125;</span>ms"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoTestPassMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">""</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">"PassMethod start"</span>);</span><br><span class="line">        Stopwatch stopWatch = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">        stopWatch.Start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, containerSize = s_tempListContainer.Count; i &lt; containerSize; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;TempPack&gt; tempList = s_tempListContainer[i];</span><br><span class="line">            tempList.Find(CheckPack);</span><br><span class="line">        &#125;</span><br><span class="line">        stopWatch.Stop();</span><br><span class="line">        Console.WriteLine(<span class="string">$"PassMethod end, result_<span class="subst">&#123;stopWatch.ElapsedMilliseconds&#125;</span>ms"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoTestPassExistPredicate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">""</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">"PassExistPredicate start"</span>);</span><br><span class="line">        Stopwatch stopWatch = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">        stopWatch.Start();</span><br><span class="line">        Predicate&lt;TempPack&gt; predicate = <span class="keyword">new</span> Predicate&lt;TempPack&gt;(CheckPack);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, containerSize = s_tempListContainer.Count; i &lt; containerSize; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;TempPack&gt; tempList = s_tempListContainer[i];</span><br><span class="line">            tempList.Find(predicate);</span><br><span class="line">        &#125;</span><br><span class="line">        stopWatch.Stop();</span><br><span class="line">        Console.WriteLine(<span class="string">$"PassExistPredicate end, result_<span class="subst">&#123;stopWatch.ElapsedMilliseconds&#125;</span>ms"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">CheckPack</span>(<span class="params">TempPack pack</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> pack.tempValue % <span class="number">5</span> == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/05/01/20230501-list-pass-predicate/20230501-pic003.png" class="" title="split">]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;现在依旧是在项目里负责一些UI业务的编写。前段时间需要需要给游戏中的 popup提示 做一些简单的重构，正好发现了我一直以来都误解的一个小点，决定记下来。&lt;/p&gt;
&lt;p&gt;业务的要求就是做那种会弹出来一会儿再消失的提示，比如道具获取之类的UI。&lt;/p&gt;
&lt;p&gt;我的做法就是用一
      
    
    </summary>
    
    
      <category term="CSharp" scheme="http://yoursite.com/categories/CSharp/"/>
    
    
      <category term="CSharp" scheme="http://yoursite.com/tags/CSharp/"/>
    
  </entry>
  
  <entry>
    <title>根据一个UI物体的位置摆放另一个UI物体</title>
    <link href="http://yoursite.com/2023/03/26/20230326-ui-element-positioning/"/>
    <id>http://yoursite.com/2023/03/26/20230326-ui-element-positioning/</id>
    <published>2023-03-26T05:55:12.000Z</published>
    <updated>2023-06-08T15:08:21.508Z</updated>
    
    <content type="html"><![CDATA[<p>最近在遇到了一个需求，要点击某个道具UI之后，显示一个小的关于该道具的信息框。<br>大概是入下图这个样子的。</p><img src="/2023/03/26/20230326-ui-element-positioning/20230326-pic001.png" class="" title="split"><p>还好之前做过，于是乎直接修修补补腾过去。至于为什么要修补，是因为在之前的项目里虽然写了一些和RectTransform相关的一些utils，但都因为懒和菜，没有去维护。有重复的方法还有错误的方法，麻了。<br>这次说是修补，也稍微重写了一些和RectTransform相关的一些utils,也准备带进项目里看看有没有地方可以用的。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Temp</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> RectPositionType</span><br><span class="line">    &#123;</span><br><span class="line">        Center = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        Top = <span class="number">1</span>,</span><br><span class="line">        Bottom = <span class="number">2</span>,</span><br><span class="line">        Left = <span class="number">3</span>,</span><br><span class="line">        Right = <span class="number">4</span>,</span><br><span class="line"></span><br><span class="line">        TopLeft = <span class="number">5</span>,</span><br><span class="line">        TopRight = <span class="number">6</span>,</span><br><span class="line"></span><br><span class="line">        BottomLeft = <span class="number">7</span>,</span><br><span class="line">        BottomRight = <span class="number">8</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIElementPositionSetter</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Target setting"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> RectPositionType _targetRectPosition = RectPositionType.Center;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _targetPivot = Vector2.zero;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _extraOffset = Vector2.zero;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> RectOffset _adaptionOffset;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _doScreenAdaption;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Other setting"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> RectTransform _defaultBoundsCanvasTransform;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _adjustHorizontal = <span class="literal">true</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _adjustVertical = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetPosition</span>(<span class="params">RectTransform target</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            RectTransform self = transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Vector3 spawnPos = GetLocalRectPosition(self, _targetRectPosition);</span><br><span class="line">            spawnPos += <span class="keyword">new</span> Vector3(_extraOffset.x, _extraOffset.y, <span class="number">0f</span>);</span><br><span class="line">            spawnPos = self.localToWorldMatrix.MultiplyPoint(spawnPos);</span><br><span class="line">            target.pivot = _targetPivot;</span><br><span class="line">            target.position = spawnPos;</span><br><span class="line">            <span class="keyword">if</span> (_doScreenAdaption)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// HACK @Hiko force rebuild to make sure the size is correct</span></span><br><span class="line">                LayoutRebuilder.ForceRebuildLayoutImmediate(target);</span><br><span class="line">                DoAdaption(target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoAdaption</span>(<span class="params">RectTransform targetTransform</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_adjustHorizontal)</span><br><span class="line">            &#123;</span><br><span class="line">                AdjustHorizontal(targetTransform, _defaultBoundsCanvasTransform);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (_adjustVertical)</span><br><span class="line">            &#123;</span><br><span class="line">                AdjustVertical(targetTransform, _defaultBoundsCanvasTransform);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AdjustHorizontal</span>(<span class="params">RectTransform target, RectTransform outterBoundRectTransform</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Vector2 targetSize = target.rect.size;</span><br><span class="line">            Matrix4x4 targetLocalToWorld = target.localToWorldMatrix;</span><br><span class="line">            Matrix4x4 boundRectWorldToLocal = outterBoundRectTransform.worldToLocalMatrix;</span><br><span class="line">            Vector2 topLeftPos = GetLocalRectPosition(target, RectPositionType.TopLeft);</span><br><span class="line"></span><br><span class="line">            Vector3 checkWorldPoint = targetLocalToWorld.MultiplyPoint(topLeftPos + Vector2.down * targetSize.y * <span class="number">0.5f</span> + Vector2.left * _adaptionOffset.left);</span><br><span class="line">            Vector2 leftCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">            Vector2 leftCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Left);</span><br><span class="line">            <span class="keyword">bool</span> leftOut = leftCheckLocalPoint.x &lt; leftCheckBoundPoint.x;</span><br><span class="line"></span><br><span class="line">            checkWorldPoint = targetLocalToWorld.MultiplyPoint(topLeftPos + Vector2.down * targetSize.y * <span class="number">0.5f</span> + Vector2.right * targetSize.x + Vector2.right * _adaptionOffset.right);</span><br><span class="line">            Vector2 rightCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">            Vector2 rightCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Right);</span><br><span class="line">            <span class="keyword">bool</span> rightOut = rightCheckLocalPoint.x &gt; rightCheckBoundPoint.x;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (leftOut &amp;&amp; rightOut)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// outter bound is too small</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (leftOut)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">float</span> xDelta = leftCheckLocalPoint.x - leftCheckBoundPoint.x;</span><br><span class="line">                Vector3 tempPos = target.localPosition;</span><br><span class="line">                tempPos.x -= xDelta;</span><br><span class="line">                target.localPosition = tempPos;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rightOut)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">float</span> xDelta = rightCheckLocalPoint.x - rightCheckBoundPoint.x;</span><br><span class="line">                Vector3 tempPos = target.localPosition;</span><br><span class="line">                tempPos.x -= xDelta;</span><br><span class="line">                target.localPosition = tempPos;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (leftOut || rightOut)</span><br><span class="line">            &#123;</span><br><span class="line">                LayoutRebuilder.ForceRebuildLayoutImmediate(target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AdjustVertical</span>(<span class="params">RectTransform target, RectTransform outterBoundRectTransform</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Vector2 targetSize = target.rect.size;</span><br><span class="line">            Matrix4x4 targetLocalToWorld = target.localToWorldMatrix;</span><br><span class="line">            Matrix4x4 boundRectWorldToLocal = outterBoundRectTransform.worldToLocalMatrix;</span><br><span class="line">            Vector2 topLeftPos = GetLocalRectPosition(target, RectPositionType.TopLeft);</span><br><span class="line"></span><br><span class="line">            Vector3 checkWorldPoint = targetLocalToWorld.MultiplyPoint(topLeftPos + Vector2.right * targetSize.x * <span class="number">0.5f</span> + Vector2.up * _adaptionOffset.top);</span><br><span class="line">            Vector2 topCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">            Vector2 topCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Top);</span><br><span class="line">            <span class="keyword">bool</span> topOut = topCheckLocalPoint.y &gt; topCheckBoundPoint.y;</span><br><span class="line"></span><br><span class="line">            checkWorldPoint = targetLocalToWorld.MultiplyPoint(topLeftPos + Vector2.down * targetSize.y + Vector2.right * targetSize.x * <span class="number">0.5f</span> + Vector2.down * _adaptionOffset.bottom);</span><br><span class="line">            Vector2 bottomCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">            Vector2 bottomCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Bottom);</span><br><span class="line">            <span class="keyword">bool</span> bottomOut = bottomCheckLocalPoint.y &lt; bottomCheckBoundPoint.y;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (topOut &amp;&amp; bottomOut)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// outter bound is too small</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (topOut)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">float</span> yDelta = topCheckLocalPoint.y - topCheckBoundPoint.y;</span><br><span class="line">                Vector3 tempPos = target.localPosition;</span><br><span class="line">                tempPos.y -= yDelta;</span><br><span class="line">                target.localPosition = tempPos;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (bottomOut)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">float</span> yDelta = bottomCheckLocalPoint.y - bottomCheckBoundPoint.y;</span><br><span class="line">                Vector3 tempPos = target.localPosition;</span><br><span class="line">                tempPos.y -= yDelta;</span><br><span class="line">                target.localPosition = tempPos;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (topOut || bottomOut)</span><br><span class="line">            &#123;</span><br><span class="line">                LayoutRebuilder.ForceRebuildLayoutImmediate(target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> position util</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector2 <span class="title">GetLocalRectPosition</span>(<span class="params">RectTransform target, RectPositionType offsetType</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> GetLocalRectPosition(target, offsetType, Vector2.zero);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector2 <span class="title">GetLocalRectPosition</span>(<span class="params">RectTransform target, RectPositionType offsetType, Vector2 offset</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> GetLocalRectPosition(target.rect.size, target.pivot, offsetType, offset);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector2 <span class="title">GetLocalRectPosition</span>(<span class="params">Vector2 targetSize, Vector2 targetPivot, RectPositionType offsetType, Vector2 offset</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Vector2 bottomLeft = Vector2.zero;</span><br><span class="line">            bottomLeft.x -= targetPivot.x * targetSize.x;</span><br><span class="line">            bottomLeft.y -= targetPivot.y * targetSize.y;</span><br><span class="line">            Vector2 result = bottomLeft;</span><br><span class="line">            <span class="keyword">switch</span> (offsetType)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Top:</span><br><span class="line">                    result += Vector2.right * <span class="number">0.5f</span> * targetSize.x + Vector2.up * targetSize.y;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Bottom:</span><br><span class="line">                    result += Vector2.right * <span class="number">0.5f</span> * targetSize.x;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Left:</span><br><span class="line">                    result += Vector2.up * <span class="number">0.5f</span> * targetSize.y;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.Right:</span><br><span class="line">                    result += Vector2.right * targetSize.x + Vector2.up * <span class="number">0.5f</span> * targetSize.y;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.TopLeft:</span><br><span class="line">                    result += Vector2.up * targetSize.y;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.TopRight:</span><br><span class="line">                    result += Vector2.right * targetSize.x + Vector2.up * targetSize.y;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.BottomRight:</span><br><span class="line">                    result += Vector2.right * targetSize.x;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RectPositionType.BottomLeft:</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result + offset;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">RectPositionToWorld</span>(<span class="params">RectTransform rect, RectPositionType offsetType</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> RectPositionToWorld(rect, offsetType, Vector2.zero);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">RectPositionToWorld</span>(<span class="params">RectTransform rect, RectPositionType offsetType, Vector2 offset</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> localPosition = GetLocalRectPosition(rect, offsetType, offset);</span><br><span class="line">            <span class="keyword">return</span> rect.TransformPoint(localPosition);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Vector2 <span class="title">GetTargetRectPositionInLocalReference</span>(<span class="params">RectPositionType offsetType</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            RectTransform self = transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Vector2 targetPivotPos = GetLocalRectPosition(self, _targetRectPosition, _extraOffset);</span><br><span class="line">            Vector2 virtualCenterPos = targetPivotPos;</span><br><span class="line">            virtualCenterPos += GetLocalRectPosition(_targetSize, _targetPivot, offsetType, Vector2.zero);</span><br><span class="line">            <span class="keyword">return</span> virtualCenterPos;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"Preview setting"</span>)</span>]</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Vector2 _targetSize = Vector2.one * <span class="number">128f</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Color _previewColor = Color.white;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _doDrawAdaptionOffsetRect = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">System.Serializable</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">struct</span> TempCheckResult</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">bool</span> previewLeftOut;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">bool</span> previewRightOut;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">bool</span> previewTopOut;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">bool</span> previewBottomOut;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> TempCheckResult _checkResult;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _previewLeftOut;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _previewRightOut;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _previewTopOut;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _previewBottomOut;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDrawGizmosSelected</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// draw A box to show the position of target</span></span><br><span class="line">            RectTransform self = transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            Vector2 localSpawnPos = GetLocalRectPosition(self, _targetRectPosition);</span><br><span class="line">            localSpawnPos += _extraOffset;</span><br><span class="line"></span><br><span class="line">            Vector2 pivot = _targetPivot;</span><br><span class="line">            Vector2 topLeftPos = localSpawnPos;</span><br><span class="line">            topLeftPos.x -= pivot.x * _targetSize.x;</span><br><span class="line">            topLeftPos.y -= (pivot.y - <span class="number">1f</span>) * _targetSize.y;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_doScreenAdaption)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// do adaption</span></span><br><span class="line">                <span class="keyword">if</span> (_defaultBoundsCanvasTransform != <span class="literal">null</span>) <span class="comment">// if there is no bound, we can take the screen as the bound</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Matrix4x4 localToWorld = self.localToWorldMatrix;</span><br><span class="line">                    RectTransform outterBoundRectTransform = _defaultBoundsCanvasTransform;</span><br><span class="line">                    Matrix4x4 boundRectWorldToLocal = outterBoundRectTransform.worldToLocalMatrix;</span><br><span class="line"></span><br><span class="line">                    Vector3 checkWorldPoint = localToWorld.MultiplyPoint(topLeftPos + Vector2.down * _targetSize.y * <span class="number">0.5f</span> + Vector2.left * _adaptionOffset.left);</span><br><span class="line">                    Vector2 leftCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">                    Vector2 leftCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Left);</span><br><span class="line">                    _previewLeftOut = leftCheckLocalPoint.x &lt; leftCheckBoundPoint.x;</span><br><span class="line"></span><br><span class="line">                    checkWorldPoint = localToWorld.MultiplyPoint(topLeftPos + Vector2.down * _targetSize.y * <span class="number">0.5f</span> + Vector2.right * _targetSize.x + Vector2.right * _adaptionOffset.right);</span><br><span class="line">                    Vector2 rightCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">                    Vector2 rightCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Right);</span><br><span class="line">                    _previewRightOut = rightCheckLocalPoint.x &gt; rightCheckBoundPoint.x;</span><br><span class="line"></span><br><span class="line">                    checkWorldPoint = localToWorld.MultiplyPoint(topLeftPos + Vector2.right * _targetSize.x * <span class="number">0.5f</span> + Vector2.up * _adaptionOffset.top);</span><br><span class="line">                    Vector2 topCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">                    Vector2 topCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Top);</span><br><span class="line">                    _previewTopOut = topCheckLocalPoint.y &gt; topCheckBoundPoint.y;</span><br><span class="line"></span><br><span class="line">                    checkWorldPoint = localToWorld.MultiplyPoint(topLeftPos + Vector2.down * _targetSize.y + Vector2.right * _targetSize.x * <span class="number">0.5f</span> + Vector2.down * _adaptionOffset.bottom);</span><br><span class="line">                    Vector2 bottomCheckLocalPoint = boundRectWorldToLocal.MultiplyPoint(checkWorldPoint);</span><br><span class="line">                    Vector2 bottomCheckBoundPoint = GetLocalRectPosition(outterBoundRectTransform, RectPositionType.Bottom);</span><br><span class="line">                    _previewBottomOut = bottomCheckLocalPoint.y &lt; bottomCheckBoundPoint.y;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (_adjustHorizontal)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (_previewLeftOut &amp;&amp; _previewRightOut)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// bound too small</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (_previewLeftOut)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">float</span> xDelta = leftCheckLocalPoint.x - leftCheckBoundPoint.x;</span><br><span class="line">                                Vector3 tempPos = topLeftPos;</span><br><span class="line">                                tempPos.x -= xDelta;</span><br><span class="line">                                topLeftPos = tempPos;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (_previewRightOut)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">float</span> xDelta = rightCheckLocalPoint.x - rightCheckBoundPoint.x;</span><br><span class="line">                                Vector3 tempPos = topLeftPos;</span><br><span class="line">                                tempPos.x -= xDelta;</span><br><span class="line">                                topLeftPos = tempPos;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (_adjustVertical)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (_previewTopOut &amp;&amp; _previewBottomOut)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// bound too small</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (_previewTopOut)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">float</span> yDelta = topCheckLocalPoint.y - topCheckBoundPoint.y;</span><br><span class="line">                                Vector3 tempPos = topLeftPos;</span><br><span class="line">                                tempPos.y -= yDelta;</span><br><span class="line">                                topLeftPos = tempPos;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (_previewBottomOut)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">float</span> yDelta = bottomCheckLocalPoint.y - bottomCheckBoundPoint.y;</span><br><span class="line">                                Vector3 tempPos = topLeftPos;</span><br><span class="line">                                tempPos.y -= yDelta;</span><br><span class="line">                                topLeftPos = tempPos;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _checkResult.previewLeftOut = _previewLeftOut;</span><br><span class="line">            _checkResult.previewRightOut = _previewRightOut;</span><br><span class="line">            _checkResult.previewTopOut = _previewTopOut;</span><br><span class="line">            _checkResult.previewBottomOut = _previewBottomOut;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_doDrawAdaptionOffsetRect &amp;&amp; _defaultBoundsCanvasTransform != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Vector2 innerBoundLeftPos = GetLocalRectPosition(_defaultBoundsCanvasTransform, RectPositionType.TopLeft, <span class="keyword">new</span> Vector2(_adaptionOffset.left, -_adaptionOffset.top));</span><br><span class="line">                Vector2 size = _defaultBoundsCanvasTransform.rect.size;</span><br><span class="line">                size.x -= _adaptionOffset.horizontal;</span><br><span class="line">                size.y -= _adaptionOffset.vertical;</span><br><span class="line">                DrawBox(_defaultBoundsCanvasTransform, innerBoundLeftPos, size, Color.blue);</span><br><span class="line">            &#125;</span><br><span class="line">            DrawBox(self, topLeftPos, _targetSize, _previewColor);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawBox</span>(<span class="params">RectTransform reference, Vector2 topLeftPos, Vector2 size, Color color</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Color cachedColor = Gizmos.color;</span><br><span class="line">            Gizmos.color = color;</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(topLeftPos), reference.TransformPoint(topLeftPos + Vector2.right * size.x));</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(topLeftPos), reference.TransformPoint(topLeftPos + Vector2.down * size.y));</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(topLeftPos + Vector2.right * size.x), reference.TransformPoint(topLeftPos + Vector2.right * size.x + Vector2.down * size.y));</span><br><span class="line">            Gizmos.DrawLine(reference.TransformPoint(topLeftPos + Vector2.down * size.y), reference.TransformPoint(topLeftPos + Vector2.right * size.x + Vector2.down * size.y));</span><br><span class="line">            Gizmos.color = cachedColor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/03/26/20230326-ui-element-positioning/20230326-pic002.gif" class="" title="split"><p>还是像以前一样，先在debug draw里把功能完成再给移到实际的物体上。<br>但这次还是很可惜没有把功能很好抽出成比较单独的数学运算，而且感觉要用到的参数好多也没法拆分，最后留了一个多参的入口。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近在遇到了一个需求，要点击某个道具UI之后，显示一个小的关于该道具的信息框。&lt;br&gt;大概是入下图这个样子的。&lt;/p&gt;
&lt;img src=&quot;/2023/03/26/20230326-ui-element-positioning/20230326-pic001.png&quot; cl
      
    
    </summary>
    
    
      <category term="Unity" scheme="http://yoursite.com/categories/Unity/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UGUI" scheme="http://yoursite.com/tags/UGUI/"/>
    
  </entry>
  
  <entry>
    <title>Rapid UI Creation Note</title>
    <link href="http://yoursite.com/2022/10/05/20221005-rapid-UGUI-creation-note/"/>
    <id>http://yoursite.com/2022/10/05/20221005-rapid-UGUI-creation-note/</id>
    <published>2022-10-05T02:55:21.000Z</published>
    <updated>2023-03-26T06:33:58.713Z</updated>
    
    <content type="html"><![CDATA[<p>When I searching some articles about MVC and MVVM, I see this talk.<br>Basiclly they does same stuff as my current project, but we still have some differences on our implementation.<br>I’d like to share it and take some notes :D</p><p>Here is the talk abour UGUI implementation.<br><a href="https://www.youtube.com/watch?v=uDQU_dlO-ZM" target="_blank" rel="noopener">video</a>.<br><a href="https://www.gdcvault.com/play/1024453/Data-Binding-Architectures-for-Rapid" target="_blank" rel="noopener">ppt</a>.<br><a href="https://stackoverflow.com/questions/667781/what-is-the-difference-between-mvc-and-mvvm" target="_blank" rel="noopener">temp</a>.</p><h1 id="Main-note"><a href="#Main-note" class="headerlink" title="Main note"></a>Main note</h1><h2 id="Architecture-in-lt-Lost-Survivor-gt"><a href="#Architecture-in-lt-Lost-Survivor-gt" class="headerlink" title="Architecture in &lt; Lost Survivor &gt;"></a>Architecture in &lt; Lost Survivor &gt;</h2><ul><li>Artist works directly in Unity (Creating prefabs, setup aniamtions; well that’s what I my current project does, so I guess they did the same)</li><li>Dev works on GameLogic and UILogic</li><li>Dev/Art work decoupled</li><li>Dev/Art work parallel (This happens a lot in iteration)</li></ul><h2 id="The-Pattern-used-in-lt-Lost-Survivor-gt"><a href="#The-Pattern-used-in-lt-Lost-Survivor-gt" class="headerlink" title="The Pattern used in &lt; Lost Survivor &gt;"></a>The Pattern used in &lt; Lost Survivor &gt;</h2><h3 id="MVCVM-they-choose-this"><a href="#MVCVM-they-choose-this" class="headerlink" title="MVCVM (they choose this)"></a>MVCVM (they choose this)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">                                                                                                                               </span><br><span class="line">                                                        +---------------------------------------+                              </span><br><span class="line">                                                        |                data binding           |                              </span><br><span class="line">                                                        |                    &lt;-&gt;                |                              </span><br><span class="line">                                                        |                                       |                              </span><br><span class="line">                                                        |                                       |                              </span><br><span class="line">+------------------------------+                        |                                       |                              </span><br><span class="line">|                              | +----------------------|-------+    +------------------------------+ +-----------------------+</span><br><span class="line">----------Controller------------ |         Model                |    |        View Model            | |    View (UGUI View)   |</span><br><span class="line">|                              | --------------------------------    -------------------------------- -------------------------</span><br><span class="line">| void GainXP();               | |      int XP;                 |    |                              | | Text XP;              |</span><br><span class="line">| void LevelUp();              | |      int Level;              |    |                              | | Text Attribute;       |</span><br><span class="line">|                              | |                              |    |                              | | Button ReAllocate;    |</span><br><span class="line">|                              | +--------------&#x2F;---------------+    +---------------\--------------+ | int WeaponATK;        |</span><br><span class="line">+---------------\--------------+              &#x2F;-                                      -\              |                       |</span><br><span class="line">                 \                          &#x2F;-                                          -\            +-----------&#x2F;-----------+</span><br><span class="line">                  -\                      &#x2F;-                                              \                      |             </span><br><span class="line">                    \                   &#x2F;-                                                 -\                    &#x2F;             </span><br><span class="line">            +---------------------------------------------------------------------------------------------------|-------+      </span><br><span class="line">            |                                                                                                           |      </span><br><span class="line">            |                                               Message Bus                                                 |      </span><br><span class="line">            +-----------------------------------------------------|-----------------------------------------------------+      </span><br><span class="line">                                                                  |                                                            </span><br><span class="line">                                                                  |                                                            </span><br><span class="line">                                                                  |                                                            </span><br><span class="line">                                                    +-------------|------------+                                               </span><br><span class="line">                                                    |                          |                                               </span><br><span class="line">                                                    |      server backend      |                                               </span><br><span class="line">                                                    |                          |                                               </span><br><span class="line">                                                    +--------------------------+</span><br></pre></td></tr></table></figure><p>This is the pattern they use for their project.<br>The one thing that I cant understand is that the View will receive events from MessageBus. IDK why they did like this. For me, I prefer to let view only receive direct events from VM, bind to many stuff to MessageBus will make it slow.</p><h3 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">                                                                                                                                                                                                   </span><br><span class="line">                                   +------------------------------+                                    </span><br><span class="line">                                   |          Controller          |                                    </span><br><span class="line">+---------------------------------------------------------------------------------------------+        </span><br><span class="line">|         user action -&gt;           |  void GainXp();              |       update -&gt;           |        </span><br><span class="line">|                                  |  Void LevelUp();             |                           |        </span><br><span class="line">|                                  |  int GetAttribute(type);     |                           |        </span><br><span class="line">|                                  |                              |                           |        </span><br><span class="line">|                                  |                              |                           |        </span><br><span class="line">|                                  +-------|--------------|-------+                           |        </span><br><span class="line">|                                          |              |                                   |        </span><br><span class="line">|------------------------------+           |              |            +----------------------|-------+</span><br><span class="line">|    Character View            |           |              |            |         Model                |</span><br><span class="line">--------------------------------           |              |            --------------------------------</span><br><span class="line">| Text XP;                     |           |              |            | int AmountXp;                |</span><br><span class="line">| Text Attribute;              ------------+              |            | int AttributeTypeA;          |</span><br><span class="line">| Button ReAllocate;           | &lt;- update                |            | int AttributeTypeB;          |</span><br><span class="line">|                              |                          +-------------                              |</span><br><span class="line">|                              |                     &lt;- notify change? |                              |</span><br><span class="line">+------------------------------+                                       +------------------------------+</span><br></pre></td></tr></table></figure><p>I’m sure this pattern is kind of useful. I use this a lot when I did the first version of some UI pages. But later the Controller become a giant class.<br>And also I think the View and Controller in this pattern is not very reusable.</p><h3 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">                                                                                                                            </span><br><span class="line">                                                                                            +------------------------------+</span><br><span class="line">                                                                                            |         Model Character      |</span><br><span class="line">                                                                            +-----------------------------------------------</span><br><span class="line">                                                                            |               | int AmountXp;                |</span><br><span class="line">                                                                            |               | int AttributeTypeA;          |</span><br><span class="line">                                                                            |               | int AttributeTypeB;          |</span><br><span class="line">                                                                            |               |                              |</span><br><span class="line">                                                                            |               |                              |</span><br><span class="line">                                                                            |               +------------------------------+</span><br><span class="line">+------------------------------+                     +----------------------|-------+                                       </span><br><span class="line">|      Character View          |   data binding &lt;-&gt;  |        View Model            |                                       </span><br><span class="line">--------------------------------   notifications &lt;-  --------------------------------                                       </span><br><span class="line">| Text XP;                     |   command -&gt;        |int AmountXP;                 |                                       </span><br><span class="line">| Text Attribute;              ----------------------+int WeaponATK;                |                                       </span><br><span class="line">| Button ReAllocate;           |                     |int WeaponLevel;              |       +------------------------------+</span><br><span class="line">| int WeaponATK;               |                     |                              |       |         Model Weapon         |</span><br><span class="line">|                              |                     |                              |       --------------------------------</span><br><span class="line">+------------------------------+                     +----------------------|-------+       | int ATK;                     |</span><br><span class="line">                                                                            |               | int Level;                   |</span><br><span class="line">                                                                            +----------------                              |</span><br><span class="line">                                                                                            +------------------------------+</span><br></pre></td></tr></table></figure><ul><li>ViewModel serves the View</li><li>One ViewModel per View</li><li>Based on Data Binding</li></ul><p>After a few iterations, I find this pattern is also a good solutions. And I feel that we can even use CompositePattern in ViewModel to create big ViewModel for some big views(resuable).</p><p>In my current project, for the UI-View, we create some basic view that can receive similar types of data. And the good thing from this pattern is that the VM can send notificaiton to View to update, then I dun need to have lots of update method from Controller to update different data (cuz some data update need aniamtion, I cant just update all).</p><h2 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h2><p>Previously it says that separating UIPrefabs creation and UILogic code may solve “Not my problem attitude”. But actually not.<br>In production state, everyone is busy, and we are iterating View-Scripts and VM-Scripts together. Sometimes it is diffcult to tell that is code issues or setup issues. Unless we have solid View-Scripts.</p><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This talk has lots of similiar content as the DivisionUI talk. And I also realise that the game development has lots of unknow shit. It’s very difficult to have some resuable components that always works. Even the thougts are similar, the implementation can be different. A solution can be that having some solid, simple, basic and resuable compoents.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;When I searching some articles about MVC and MVVM, I see this talk.&lt;br&gt;Basiclly they does same stuff as my current project, but we still 
      
    
    </summary>
    
    
      <category term="Unity" scheme="http://yoursite.com/categories/Unity/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UGUI" scheme="http://yoursite.com/tags/UGUI/"/>
    
  </entry>
  
  <entry>
    <title>查询Asset在工程中的引用(GUID)</title>
    <link href="http://yoursite.com/2022/09/12/20220912-unity-findref-guid/"/>
    <id>http://yoursite.com/2022/09/12/20220912-unity-findref-guid/</id>
    <published>2022-09-12T02:55:21.000Z</published>
    <updated>2023-05-01T06:22:03.532Z</updated>
    
    <content type="html"><![CDATA[<p>之前我用Unity自带的API去查询一些物体的引用，结果当然是超超超超超级慢，对于那些把项目工程放在辣鸡机械盘上的同事，这个工具根本是没法好好用的。而且因为要用Unity的APi，自然是没办法使用async的。</p><p>最近导师拿到QA那边提供的一个类似的工具，改了一下，做了一个超级快的版本。</p><h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>思路其实是非常简单的。我们知道Unity Asset会有一个唯一的GUID，那我们就可以用这个GUID去查询其引用。<br>查询的时候我们也不需要使用Unity API去检查引用，而是把我们的各种Asset都当成文本文件直接读取，然后直接在这些文本里去匹配我们需要查询的GUID。</p><h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// guidRegex just contains the asset guid</span></span><br><span class="line"><span class="function">List&lt;<span class="keyword">string</span>&gt; <span class="title">GetResult</span>(<span class="params"><span class="keyword">string</span>[] folders, Regex guidRegex</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">string</span>[] files = folders.SelectMany(folder =&gt; Directory.GetFiles(folder, <span class="string">"*"</span>SearchOption.AllDirectories)).ToArray();</span><br><span class="line">    List&lt;<span class="keyword">string</span>&gt; result = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;(<span class="number">200</span>);</span><br><span class="line">    <span class="keyword">int</span> count = files.Length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">string</span> filePath = files[i];</span><br><span class="line">        <span class="keyword">if</span> (ChecKFile(filePath, guidRegex))</span><br><span class="line">        &#123;</span><br><span class="line">            result.Add(filePath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ChecKFile</span>(<span class="params"><span class="keyword">string</span> filepath, Regex fileContent</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">string</span> assetText = File.ReadAllText(filepath);</span><br><span class="line">    MatchCollection matches = fileContent.Matches(assetText);</span><br><span class="line">    <span class="keyword">return</span> matches.Count &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关键代码和Unity API毫无关系，可以避免长时间的卡死，而且我们也能加入取消搜索的功能之类的。如果在乎性能的话可以还可以在读文件检查这边做优化。不过感觉这样已经比之前快了许多了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;之前我用Unity自带的API去查询一些物体的引用，结果当然是超超超超超级慢，对于那些把项目工程放在辣鸡机械盘上的同事，这个工具根本是没法好好用的。而且因为要用Unity的APi，自然是没办法使用async的。&lt;/p&gt;
&lt;p&gt;最近导师拿到QA那边提供的一个类似的工具，改了一
      
    
    </summary>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/categories/UnityEditor/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UnityEditor" scheme="http://yoursite.com/tags/UnityEditor/"/>
    
  </entry>
  
  <entry>
    <title>Unity RectTransform 小笔记</title>
    <link href="http://yoursite.com/2022/08/14/20220814-unity-recttransform/"/>
    <id>http://yoursite.com/2022/08/14/20220814-unity-recttransform/</id>
    <published>2022-08-14T02:55:21.000Z</published>
    <updated>2022-09-12T08:00:32.969Z</updated>
    
    <content type="html"><![CDATA[<p>之前看了一些关于RectTransform的文章，但是最终记忆都不是很深刻。而且要用的时候重新找还挺麻烦的。<br>干脆把别人的笔记抄来一些好了，以后也方便就着自己的笔记和UXUI同学解释。</p><h1 id="Pivot"><a href="#Pivot" class="headerlink" title="Pivot"></a>Pivot</h1><p>中心点，是UI元素旋转/缩放的中心点。使用归一化Vector2表示。</p><h1 id="Anchor"><a href="#Anchor" class="headerlink" title="Anchor"></a>Anchor</h1><p>其实是由两个点组成的(AnchorMin, AnchorMax)。并使用归一化Vector2来表示。<br>数值代表了在父类X轴和Y轴方向的百分比。</p><h2 id="绝对布局"><a href="#绝对布局" class="headerlink" title="绝对布局"></a>绝对布局</h2><blockquote><p>当anchorMax与anchorMin相等时，Anchor呈现为一个点，称之为锚点<br>在使用锚点的情况下，anchoredPosition是元素Pivot到Anchor的距离</p></blockquote><p>此时会有4个重要的属性。</p><ul><li>PosX, posY : 中心点到锚点的参数，实际像素值</li><li>Width, Height : UI 元素的尺寸</li></ul><p>绝对布局的情况下无论分辨率是多少，父物体多大，该UI元素的大小是恒定的。</p><h2 id="相对布局"><a href="#相对布局" class="headerlink" title="相对布局"></a>相对布局</h2><blockquote><p>当anchorMax与anchorMin不相等时，Anchor呈现为一个框，称之为锚框<br>在使用锚框的情况下，anchoredPosition是元素Pivot到锚框中心点的距离</p></blockquote><p>这种情况下UI元素的四个角，距离四个对应的锚点的距离是不变的，在这种情况下RectTransform的属性又变为了Left,Top,Right,Bottom。</p><ul><li>Left,Top,Right,Bottom : 四个点的数值分别是(Left,Top,Right,Bottom)锚点到实际的rect的这4个位置的点的距离。</li></ul><h1 id="SizeDelta"><a href="#SizeDelta" class="headerlink" title="SizeDelta"></a>SizeDelta</h1><h2 id="OffsetMin-OffsetMax"><a href="#OffsetMin-OffsetMax" class="headerlink" title="OffsetMin/OffsetMax"></a>OffsetMin/OffsetMax</h2><p>min是实际UI原素相对于AnchorMin的偏移，另外一个不言而喻.</p><p>sizeDelta就是offsetMax - offsetMin的值。</p><blockquote><p>所以这个属性之所以叫做sizeDelta，是因为在锚点情况下其表征的是size（大小），在锚框的情况下其表征的是Delta（UI元素实际的属性值与锚框的差值）</p></blockquote><h1 id="Rect"><a href="#Rect" class="headerlink" title="Rect"></a>Rect</h1><p>rect中的属性，不与UI元素所在的位置有关，只和其自身属性相关。根据rect中提供的width和height可以得到UI元素实际的尺寸大小。</p><p>rect.position指的是以Pivot为原点，UI元素左下角的坐标。(right,up 为正方向)</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://zhuanlan.zhihu.com/p/194317677" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/194317677</a><br><a href="https://blog.csdn.net/jmu201521121014/article/details/105725175" target="_blank" rel="noopener">https://blog.csdn.net/jmu201521121014/article/details/105725175</a></p><p>顺便推荐一下在线画图小工具，不方便贴图的时候用这个还挺不错的。<br><a href="https://asciiflow.com/#/" target="_blank" rel="noopener">https://asciiflow.com/#/</a><br><a href="https://textik.com/" target="_blank" rel="noopener">https://textik.com/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;之前看了一些关于RectTransform的文章，但是最终记忆都不是很深刻。而且要用的时候重新找还挺麻烦的。&lt;br&gt;干脆把别人的笔记抄来一些好了，以后也方便就着自己的笔记和UXUI同学解释。&lt;/p&gt;
&lt;h1 id=&quot;Pivot&quot;&gt;&lt;a href=&quot;#Pivot&quot; class
      
    
    </summary>
    
    
      <category term="Unity" scheme="http://yoursite.com/categories/Unity/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UGUI" scheme="http://yoursite.com/tags/UGUI/"/>
    
  </entry>
  
  <entry>
    <title>Unity Video Url source 赋值小坑</title>
    <link href="http://yoursite.com/2022/08/10/20220810-unity-video-url-delay/"/>
    <id>http://yoursite.com/2022/08/10/20220810-unity-video-url-delay/</id>
    <published>2022-08-10T02:55:21.000Z</published>
    <updated>2022-08-11T14:12:40.314Z</updated>
    
    <content type="html"><![CDATA[<p>这周赶版本，接到了一个前同事留下来的bug。是说UI上的教程视频一直不播放。<br>我们的视频资源是在 StreamingAssets 下的，用path进行加载。<br>播放相关的代码如下。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_player.prepareCompleted += OnPrepareCompleted;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnPrepareCompleted</span>(<span class="params">VideoPlayer source</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Debug.Log(<span class="string">"OnPrepareCompleted"</span>);</span><br><span class="line">    m_player.Play();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetVideo</span>(<span class="params"><span class="keyword">string</span> path</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_player.source = VideoSource.Url;</span><br><span class="line">    <span class="comment">// I guess this process may not be finished now.</span></span><br><span class="line">    m_player.url = path;</span><br><span class="line">    m_player.Prepare();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查了一下，发现在调用了 SetVideo 之后，OnPrepareCompleted没有被调用，意思是 VideoPlayer的prepareCompleted事件没有触发。<br>我猜发生这个情况的原因是，当我们使用url来设置视频资源的那一帧，VideoPlayer还没能获取到视频资源的一些属性，或是上一个视频资源还在占用着当前的播放器，所以这个时候如果调用PrePare，其实是没有用的。</p><p>所以我使用的Hacky Fix是在设置完资源的URL之后，等一帧再调用Prepare，然后等待 prepareCompleted 事件。</p><p>顺便在网上查了一下，也有些人遇到类似的问题，说是赋值URL之后不知道视频资源什么时候才能正确播放。<br>论坛里有个人给出的解决方法是去检查 VideoPlayer.isPrepared 的这个属性。但赋值URL之后这个值并不会在某一时刻变成true。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这周赶版本，接到了一个前同事留下来的bug。是说UI上的教程视频一直不播放。&lt;br&gt;我们的视频资源是在 StreamingAssets 下的，用path进行加载。&lt;br&gt;播放相关的代码如下。&lt;/p&gt;
&lt;figure class=&quot;highlight csharp&quot;&gt;&lt;tab
      
    
    </summary>
    
    
      <category term="Unity" scheme="http://yoursite.com/categories/Unity/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
  </entry>
  
  <entry>
    <title>notes dat I took from the Divsion UI talk</title>
    <link href="http://yoursite.com/2022/08/06/20220806-division-UI-talk-note/"/>
    <id>http://yoursite.com/2022/08/06/20220806-division-UI-talk-note/</id>
    <published>2022-08-06T02:55:21.000Z</published>
    <updated>2022-10-05T06:48:07.153Z</updated>
    
    <content type="html"><![CDATA[<p>Well just ignore dat weird tag. :D</p><p>Here is muy notes dat I learn from the Divsion UI talk.</p><p>The key is iteration, threading and data.</p><p>Iterate your stuff to make it better.</p><p>Threading and data driven make the work efficient.</p><p><a href="https://www.youtube.com/watch?v=H1MLtML0np0" target="_blank" rel="noopener">video</a>.</p><h1 id="Snow-drop-UI"><a href="#Snow-drop-UI" class="headerlink" title="Snow drop UI"></a>Snow drop UI</h1><ul><li>No canvas</li><li>Immediate Mode<ul><li>Constant cost (maybe it’s more statble?).</li></ul></li><li>Vector Graphics<ul><li>Shapes(scaling friendly, dun rely on resolution) over textures masks.</li><li>Save GPU load by only rendering the pixels gonna be used.</li><li>Artist can play with it.</li></ul></li></ul><h1 id="Game-Data-amp-Node-graph"><a href="#Game-Data-amp-Node-graph" class="headerlink" title="Game Data &amp; Node graph"></a>Game Data &amp; Node graph</h1><ul><li><p>Lots of data getter (get pure data?) (in graph node), used in UI and also game play.</p></li><li><p>Auto conversion to save some performance.</p></li><li><p>custom UI logic components.</p></li><li><p>custom reusable compounds.</p></li></ul><h1 id="Iteration"><a href="#Iteration" class="headerlink" title="Iteration"></a>Iteration</h1><h2 id="For-coder"><a href="#For-coder" class="headerlink" title="For coder"></a>For coder</h2><h3 id="Reduce-complie-time"><a href="#Reduce-complie-time" class="headerlink" title="Reduce complie time"></a>Reduce complie time</h3><ul><li>Blob builds(idk what is this).</li><li>Header file reduction.</li><li>Keep refactoring code to make it efficient.</li><li>Remove nolonger used code.</li></ul><h3 id="Reduce-startup-time-and-Load-time"><a href="#Reduce-startup-time-and-Load-time" class="headerlink" title="Reduce startup time and Load time"></a>Reduce startup time and Load time</h3><ul><li>Only load needed stuff.</li><li>UI preview with live data for easy iteration.</li><li>Well some debug UI will also help :).</li></ul><p>(for my unity project)</p><ul><li>Have a UI preview scene (UI only, we can preview states and transitions).</li><li>Have simple a gym dat provide gameplay with enough content.</li></ul><h3 id="Coder-to-Artist"><a href="#Coder-to-Artist" class="headerlink" title="Coder to Artist"></a>Coder to Artist</h3><ul><li><p>Coder work with artist (react fast to feedbacks).</p></li><li><p>Resable compounds, arist can directly use.</p></li></ul><h2 id="Drawback-of-iteration"><a href="#Drawback-of-iteration" class="headerlink" title="Drawback of iteration"></a>Drawback of iteration</h2><ul><li>Hard to stop.</li><li>Set clear goals and deadlines. (do not waste time)</li><li>Greate for prototyping, risk for delivering. (need a lead to shut down iteration, make the decision)</li></ul><h1 id="Building-blocks-of-UI"><a href="#Building-blocks-of-UI" class="headerlink" title="Building blocks of UI"></a>Building blocks of UI</h1><p>To let arist and designers to have full(or more) control?</p><h2 id="Widget-and-Graphics"><a href="#Widget-and-Graphics" class="headerlink" title="Widget and Graphics"></a>Widget and Graphics</h2><p>Widget define space, accept input. Graphic improve widget, relative size, also accept input?</p><h2 id="5-Basic-widgets-with-a-few-variations"><a href="#5-Basic-widgets-with-a-few-variations" class="headerlink" title="5 Basic widgets with a few variations."></a>5 Basic widgets with a few variations.</h2><p>Use basic widgets, and use them to build functionalities.</p><ul><li><p>Window</p><ul><li>2D and 3D (anchoring functionalities, pixels or percentage; prepare some options for different auto scaling and apply to different UI widgets/graphic and situations).</li><li>Vertical Stack (stack the (children)widgets)</li><li>Layering</li></ul></li><li><p>Text</p><ul><li>JIT font generaion (wtf, keep memory down)</li><li>Fich text formatting lib to build customize text(icon, color …).</li><li>Auto clip (no idea how to do it)</li></ul></li><li><p>Image</p><ul><li>Use color/gradient more. (looks good with vector graphic)</li><li>Texture and loose image(ikd this, no border image?) into sprite sheet.</li></ul></li><li><p>Stack container</p><ul><li>For sorting elements.</li><li>Spacing and padding (how to do it with stack)</li><li>Invert for quick right to left language fixes (wtf)</li></ul></li><li><p>Scroll Box</p><ul><li>Fixed size(viewport size) with a virtual inner space(content).</li></ul></li></ul><h2 id="7-Graphics-nodes"><a href="#7-Graphics-nodes" class="headerlink" title="7 Graphics (nodes)"></a>7 Graphics (nodes)</h2><ul><li>Text with effects.</li><li>Images(basic) with more shapes, flat or curved.</li><li>Lines(strait, curved list?, 3d)</li><li>Points, single point or large squares(for effects?)</li><li>Shapes </li><li>Sector (why? for their art style?)</li><li>Custom graphics</li></ul><h1 id="Simply-Ui-workflow"><a href="#Simply-Ui-workflow" class="headerlink" title="Simply Ui workflow"></a>Simply Ui workflow</h1><ul><li>Complex and powerful (lots of resuable compounds, and threading stuff)</li><li>Documentation and examples(I guess examples are better and save time)</li></ul><h2 id="For-coder-1"><a href="#For-coder-1" class="headerlink" title="For coder"></a>For coder</h2><ul><li>Simple code; Less code, less bugs </li><li>Simple Tools; Do not overthink. Simple base, complex behaviour.</li></ul><h2 id="For-UI-artist-designer"><a href="#For-UI-artist-designer" class="headerlink" title="For UI artist/designer"></a>For UI artist/designer</h2><ul><li>Communicate to avoid merge conflicts, get ahead of it (cuz yaml merge wont help u all the time).</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Well just ignore dat weird tag. :D&lt;/p&gt;
&lt;p&gt;Here is muy notes dat I learn from the Divsion UI talk.&lt;/p&gt;
&lt;p&gt;The key is iteration, threading 
      
    
    </summary>
    
    
      <category term="Unity" scheme="http://yoursite.com/categories/Unity/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
  </entry>
  
  <entry>
    <title>使用 State Object 暂存 property drawer 的状态。</title>
    <link href="http://yoursite.com/2022/07/30/20220730-unity-editor-stateobj/"/>
    <id>http://yoursite.com/2022/07/30/20220730-unity-editor-stateobj/</id>
    <published>2022-07-30T09:55:21.000Z</published>
    <updated>2023-05-01T06:21:54.625Z</updated>
    
    <content type="html"><![CDATA[<p>最近在做红点功能，path是用string挂在UI物体上的。UI同学那边想要一个按钮可以切换path在inspector是可编辑或不可编辑的状态。<br>最开始毫无思路，因为本身path是一个string，我自然不可以它身上记录这个编辑与否的状态。后来想着能不能把这个状态存在path的protperty drawer上。问了下导师，可行，但是没法直接存。</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>创建一个object存储这个状态，这个object存入editor的state object里。<br>在Property drawer进行绘制的时候获取/更新这个object。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>代码很简单</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UITagDrawer</span> : <span class="title">PropertyDrawer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// the object for string state</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title">EditingState</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> IsEditing = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params">Rect position, SerializedProperty property, GUIContent label</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">/***/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// get state object</span></span><br><span class="line">        EditingState state = GUIUtility.GetStateObject(<span class="keyword">typeof</span>(EditingState), GUIUtility.GetControlID(FocusType.Passive)) <span class="keyword">as</span> EditingState;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">new</span> EditorGUILayout.HorizontalScope(style))</span><br><span class="line">        &#123;</span><br><span class="line">            Rect editButtonRect = <span class="keyword">new</span> Rect(position.x, position.y, <span class="number">16f</span>, <span class="number">16f</span>);</span><br><span class="line">            <span class="keyword">if</span> (GUI.Button(editButtonRect, <span class="string">"E"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// well since it's a class we dun need to set it back :&gt;</span></span><br><span class="line">                state.IsEditing = !state.IsEditing;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (GUILayout.Button(<span class="string">"X"</span>, GUILayout.Width(<span class="number">18</span>)))</span><br><span class="line">            &#123;</span><br><span class="line">                state.IsEditing = !state.IsEditing;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (state.IsEditing)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// show text field</span></span><br><span class="line">                tagStr = EditorGUILayout.TextField(tagStr);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// show lable</span></span><br><span class="line">                EditorGUILayout.LabelField(tagStr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近在做红点功能，path是用string挂在UI物体上的。UI同学那边想要一个按钮可以切换path在inspector是可编辑或不可编辑的状态。&lt;br&gt;最开始毫无思路，因为本身path是一个string，我自然不可以它身上记录这个编辑与否的状态。后来想着能不能把这个状态存
      
    
    </summary>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/categories/UnityEditor/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UnityEditor" scheme="http://yoursite.com/tags/UnityEditor/"/>
    
  </entry>
  
  <entry>
    <title>查询MonoBehaviour在工程中的引用</title>
    <link href="http://yoursite.com/2022/07/24/20220724-find-script-reference/"/>
    <id>http://yoursite.com/2022/07/24/20220724-find-script-reference/</id>
    <published>2022-07-24T09:55:21.000Z</published>
    <updated>2023-05-01T06:21:48.968Z</updated>
    
    <content type="html"><![CDATA[<p>以前弄过一个在项目中查找Asset引用的。虽然很泛用，但跑起来非常的慢。<br>其实我们实际使用的时候，我们会经常做某一种搜索(比如查找脚本在预制体上的引用)。对于这种需要使用的特定条件的查找，单独做一个小工具可能效率会更高。</p><p>本来还在烦恼怎么做，导师很快就做好了，跑起来很快。他告诉我，秘诀是 GetComponent。</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>代码不方便直接贴出来，但还是想分享(记录)一下几个关键的步骤和思路~</p><h3 id="选择脚本"><a href="#选择脚本" class="headerlink" title="选择脚本"></a>选择脚本</h3><p>我们需要在编辑器上用一个 field 去放我们想要搜寻的脚本。<br>但是没办法是用在泛型类上。需要指定实际的类型。</p><p>Interface也可以查，放心用！</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">targetScript = EditorGUILayout.ObjectField(m_targetScript, <span class="keyword">typeof</span>(MonoScript), <span class="literal">false</span>) <span class="keyword">as</span> MonoScript;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">class SomeMono&lt;TData&gt; : MonoBehaviour</span></span><br><span class="line"><span class="comment">doesnt work on this case, the result will be null     </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">Type targetType = m_targetScript.GetClass();</span><br></pre></td></tr></table></figure><h3 id="获取预制体"><a href="#获取预制体" class="headerlink" title="获取预制体"></a>获取预制体</h3><p>从我们选择的目录下获取所有的prefab，相信Unity，这一步不会很慢的。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// we can also set the folderPath to save our time :D </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> paths = AssetDatabase.FindAssets(<span class="string">$"t: prefab"</span>, <span class="keyword">new</span>[] &#123; folderPath &#125;);</span><br><span class="line">GameObject[] toCheck = <span class="keyword">new</span> GameObject[paths.Length];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paths.Length; i++)</span><br><span class="line">    toCheck[i] = AssetDatabase.LoadAssetAtPath&lt;GameObject&gt;(AssetDatabase.GUIDToAssetPath(paths[i]));</span><br></pre></td></tr></table></figure><h3 id="查询引用"><a href="#查询引用" class="headerlink" title="查询引用"></a>查询引用</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Type targetType;</span><br><span class="line">GameObject prefab;</span><br><span class="line"><span class="keyword">var</span> components = prefab.GetComponents(targetType);</span><br><span class="line"><span class="comment">// if components is not empty, then you get your stuff :D</span></span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>如果要说学到了什么的话，大概是做工具前要搞明白它的使用情景，不能太脱节Tw.T</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;以前弄过一个在项目中查找Asset引用的。虽然很泛用，但跑起来非常的慢。&lt;br&gt;其实我们实际使用的时候，我们会经常做某一种搜索(比如查找脚本在预制体上的引用)。对于这种需要使用的特定条件的查找，单独做一个小工具可能效率会更高。&lt;/p&gt;
&lt;p&gt;本来还在烦恼怎么做，导师很快就做
      
    
    </summary>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/categories/UnityEditor/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UnityEditor" scheme="http://yoursite.com/tags/UnityEditor/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2022/06/12/hello-world/"/>
    <id>http://yoursite.com/2022/06/12/hello-world/</id>
    <published>2022-06-11T16:43:52.482Z</published>
    <updated>2020-05-03T04:47:50.757Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
    
  </entry>
  
</feed>
