<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>FishPlayer</title>
  
  <subtitle>一个喜欢摸鱼的废物</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2021-04-23T13:48:20.194Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>2C2C2C2</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Git 本地忽略文件</title>
    <link href="http://yoursite.com/2021/04/23/20210423-gitignore-locally/"/>
    <id>http://yoursite.com/2021/04/23/20210423-gitignore-locally/</id>
    <published>2021-04-23T13:33:14.000Z</published>
    <updated>2021-04-23T13:48:20.194Z</updated>
    
    <content type="html"><![CDATA[<p>最近在拼UI，需要建立几个临时的场景在本地。自然不能上传，但是又想手贱 git add . 还是决定在本地手动设置忽略一些文件。</p><h1 id="设置Git-exclude"><a href="#设置Git-exclude" class="headerlink" title="设置Git exclude"></a>设置Git exclude</h1><p>首先需要找到这个文件。</p><p>exclude 文件在 如图的目录中</p><img src="/2021/04/23/20210423-gitignore-locally/20210423-gitignore-locally-pic01.png" class="" title="split"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\.git\info\</span><br></pre></td></tr></table></figure><p>找到以后以文本文件的形式打开，用法和 gitignore 差不多，我还么有深入研究，但我差不多这样用。</p><img src="/2021/04/23/20210423-gitignore-locally/20210423-gitignore-locally-pic02.png" class="" title="split"><p>把我需要忽略的本地目录填上去就可以了。<br>顺便一说，若使用这个方式忽略了某个目录，当把已经进行版本控制的文件丢进这个目录里时，Git中会生成一个delete的改动。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近在拼UI，需要建立几个临时的场景在本地。自然不能上传，但是又想手贱 git add . 还是决定在本地手动设置忽略一些文件。&lt;/p&gt;
&lt;h1 id=&quot;设置Git-exclude&quot;&gt;&lt;a href=&quot;#设置Git-exclude&quot; class=&quot;headerlink&quot; t
      
    
    </summary>
    
    
      <category term="Git" scheme="http://yoursite.com/categories/Git/"/>
    
    
      <category term="Git" scheme="http://yoursite.com/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>修改commit消息</title>
    <link href="http://yoursite.com/2021/04/08/20210408-edit-commit-msg/"/>
    <id>http://yoursite.com/2021/04/08/20210408-edit-commit-msg/</id>
    <published>2021-04-08T12:53:35.000Z</published>
    <updated>2021-04-08T13:38:25.620Z</updated>
    
    <content type="html"><![CDATA[<p>前几天打游戏太疯了，上班的时候脑子都不清醒，commit的时候输错了东西，push的时候被block了才发现。<br>结果还因为不会改commit消息，还错误地操作使得工作全没了。</p><h1 id="修改当前最新的一条commit消息"><a href="#修改当前最新的一条commit消息" class="headerlink" title="修改当前最新的一条commit消息"></a>修改当前最新的一条commit消息</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 修改当前最新的一条commit消息</span></span><br><span class="line">git commit --amend</span><br></pre></td></tr></table></figure><p>非常简单，一个命令就搞定了。然后就可以正常push了。</p><p>如果是需要修改已经推送到远端的commit，可以再这个命令之后尝试push —force。<br>不过我觉得这样的情景非常之少，都已经PUSH上去了为啥还需要改啊:(</p><h1 id="修改往前第N条commit消息-还未推送到远端的"><a href="#修改往前第N条commit消息-还未推送到远端的" class="headerlink" title="修改往前第N条commit消息(还未推送到远端的)"></a>修改往前第N条commit消息(还未推送到远端的)</h1><img src="/2021/04/08/20210408-edit-commit-msg/20210408-edit-commit-msg-01.png" class="" title="split"><p>如图，我需要修改图中选定的那一个commit。从我当前位置数，是第3个commit。<br>则X就应该是3。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">git rebase -i HEAD~X</span><br><span class="line"><span class="comment"># X is the number of commits to go back</span></span><br><span class="line"><span class="comment"># Move to the line of your commit, change pick into edit,</span></span><br><span class="line"><span class="comment"># then change your commit message:</span></span><br><span class="line">git commit --amend</span><br><span class="line"><span class="comment"># Finish the rebase with:</span></span><br><span class="line">git rebase --<span class="built_in">continue</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># :D</span></span><br><span class="line">git push</span><br></pre></td></tr></table></figure><p>执行rebase后，会让选择需要对哪条commit进行什么样的操作。</p><img src="/2021/04/08/20210408-edit-commit-msg/20210408-edit-commit-msg-02.png" class="" title="split"><p>需要编辑消息则就把pick改成edit，然后保存，退出文本编辑。就可以使用 commit —amend 来修改消息了，然后再执行下一条命令完成rebase。<br>然后就是快乐push。</p><p>其实也可以同时edit多条commit。这样，在使用　commit —amend　时会从最老的commit开始编辑。完成一条的编辑就需要 rebase —continue。<br>之后才能继续编辑下一条。</p><img src="/2021/04/08/20210408-edit-commit-msg/20210408-edit-commit-msg-03.png" class="" title="split"><p>如果修改了曾经push过的commit，就需要push —force。</p><img src="/2021/04/08/20210408-edit-commit-msg/20210408-edit-commit-msg-04.png" class="" title="split"><img src="/2021/04/08/20210408-edit-commit-msg/20210408-edit-commit-msg-05.png" class="" title="split">]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;前几天打游戏太疯了，上班的时候脑子都不清醒，commit的时候输错了东西，push的时候被block了才发现。&lt;br&gt;结果还因为不会改commit消息，还错误地操作使得工作全没了。&lt;/p&gt;
&lt;h1 id=&quot;修改当前最新的一条commit消息&quot;&gt;&lt;a href=&quot;#修改当前最
      
    
    </summary>
    
    
      <category term="Git" scheme="http://yoursite.com/categories/Git/"/>
    
    
      <category term="Git" scheme="http://yoursite.com/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>Unity UGUI ScrollRect 学习笔记 (2)</title>
    <link href="http://yoursite.com/2021/01/31/20210131-UGUI-ScrollRect-Learn-02/"/>
    <id>http://yoursite.com/2021/01/31/20210131-UGUI-ScrollRect-Learn-02/</id>
    <published>2021-01-31T03:06:27.000Z</published>
    <updated>2021-01-31T05:22:00.181Z</updated>
    
    <content type="html"><![CDATA[<p>这几个月基本都在给策划做各种原型，都没怎么摸项目里的UI。也还算是抽时间试着做了一个循环的scrollrect，毕竟之前的项目里有一些需要显示玩家物品的仓库界面，打开就卡爆，滚动也卡爆。</p><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>项目中的物品列表基本都使用了grid layout。于是乎我也打算做一个能够给grid item使用的简单循环列表。</p><h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>和在网上能搜索到的大多数循环滚动列表一样，我有一个空的content，调整其尺寸来模拟列表的滚动，再根据滚动的当前数据去绘制应该显示的部分。但我还是太懒了，所以我把需要显示的实际内容放在了另一个物体下面。</p><p>所以这个滚动列表总共需要3个脚本，除了Unity自带的滚动视图以外，我们再添加自己的一个控制器和内容Item。</p><p>为了方便，我大概做了一个比较简单的grid layout控制，感觉足够对付简单的列表显示。</p><p>由于我实在太菜了，所以我只能默认以左上角为UI内容的起始点。</p><h1 id="开搞"><a href="#开搞" class="headerlink" title="开搞"></a>开搞</h1><p>在具体显示UI前，我决定先用Debug.Draw来试试我的计算是否正确。</p><p>先绘制整体content,这个content是用来模拟滚动的，其尺寸需要包含padding。<br>为了兼容scale，我获取了viewport的scale,但不太清楚这样做是否正确。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// run it in OnDrawGizmos()</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawDebugContentSize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == m_dataList)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    Vector3 rootScale = m_viewport.lossyScale;</span><br><span class="line">    RectOffset padding = GridLayoutData.RectPadding;</span><br><span class="line">    Vector2 paddingValueRaw = <span class="keyword">new</span> Vector2(padding.horizontal, padding.vertical);</span><br><span class="line"></span><br><span class="line">    Vector2 actualContentSize = (m_actualContentSizeRaw + paddingValueRaw);</span><br><span class="line">    actualContentSize.x *= rootScale.x;</span><br><span class="line">    actualContentSize.y *= rootScale.y;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get 4 points of content rect</span></span><br><span class="line">    Vector3 topLeftPoint = m_dragContent.position;</span><br><span class="line">    Vector3 topRightPoint = topLeftPoint;</span><br><span class="line">    topRightPoint.x += actualContentSize.x;</span><br><span class="line"></span><br><span class="line">    Vector3 bottomLeftPoint = topLeftPoint;</span><br><span class="line">    Vector3 BottomRightPoint = topRightPoint;</span><br><span class="line">    bottomLeftPoint.y -= actualContentSize.y;</span><br><span class="line">    BottomRightPoint.y -= actualContentSize.y;</span><br><span class="line"></span><br><span class="line">    Debug.DrawLine(topLeftPoint, topRightPoint, Color.magenta);</span><br><span class="line">    Debug.DrawLine(topLeftPoint, bottomLeftPoint, Color.magenta);</span><br><span class="line">    Debug.DrawLine(topRightPoint, BottomRightPoint, Color.magenta);</span><br><span class="line">    Debug.DrawLine(bottomLeftPoint, BottomRightPoint, Color.magenta);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，我们还需要绘制grids，这样我们就能大概知道grid是如何铺在UI上的。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// run it in OnDrawGizmos()</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawOneDebugGridItem</span>(<span class="params">Vector3 topLeftPoint, Vector3 itemSize, Color color</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Vector3 topRightPoint = topLeftPoint;</span><br><span class="line">    topRightPoint.x += itemSize.x;</span><br><span class="line"></span><br><span class="line">    Vector3 bottomLeftPoint = topLeftPoint;</span><br><span class="line">    bottomLeftPoint.y -= itemSize.y;</span><br><span class="line"></span><br><span class="line">    Vector3 bottomRightPoint = topRightPoint;</span><br><span class="line">    bottomRightPoint.y -= itemSize.y;</span><br><span class="line"></span><br><span class="line">    Debug.DrawLine(topLeftPoint, topRightPoint, color);</span><br><span class="line">    Debug.DrawLine(bottomLeftPoint, bottomRightPoint, color);</span><br><span class="line"></span><br><span class="line">    Debug.DrawLine(topLeftPoint, bottomLeftPoint, color);</span><br><span class="line">    Debug.DrawLine(topRightPoint, bottomRightPoint, color);</span><br><span class="line"></span><br><span class="line">    Debug.DrawLine(topLeftPoint, bottomRightPoint, color);</span><br><span class="line">    Debug.DrawLine(topRightPoint, bottomLeftPoint, color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// run it in OnDrawGizmos()</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawDebugGrids</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == m_dataList)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> dataCount = m_dataList.Count;</span><br><span class="line">    Vector3 rowItemTopLeftPos = <span class="keyword">default</span>;</span><br><span class="line">    Vector3 columnStartItemTopLeftPos = m_dragContent.position;</span><br><span class="line">    columnStartItemTopLeftPos.z = <span class="number">0.0f</span>;</span><br><span class="line">    Vector3 rootScale = m_viewport.lossyScale;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != GridLayoutData)</span><br><span class="line">    &#123;</span><br><span class="line">        RectOffset padding = GridLayoutData.RectPadding;</span><br><span class="line">        columnStartItemTopLeftPos += <span class="keyword">new</span> Vector3(padding.left * rootScale.x, -padding.top * rootScale.y, <span class="number">0.0f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Vector2 spacing = <span class="keyword">new</span> Vector2(m_gridLayoutGroup.Spacing.x * rootScale.x, m_gridLayoutGroup.Spacing.y * rootScale.y);</span><br><span class="line">    Vector2 itemSize = <span class="keyword">new</span> Vector2(m_gridLayoutGroup.CellSize.x * rootScale.x, m_gridLayoutGroup.CellSize.y * rootScale.y);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// should know which axis get constrained</span></span><br><span class="line">    <span class="keyword">int</span> constraintCount = m_gridLayoutGroup.constraintCount;</span><br><span class="line">    <span class="keyword">int</span> dynamicCount = (dataCount % constraintCount &gt; <span class="number">0</span>) ? (dataCount / constraintCount) + <span class="number">1</span> : (dataCount /constraintCount);</span><br><span class="line">    <span class="keyword">if</span> (BoundlessGridLayoutData.Constraint.FixedColumnCount == m_gridLayoutGroup.constraint)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dynamicCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            rowItemTopLeftPos = columnStartItemTopLeftPos;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; constraintCount; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                DrawOneDebugGridItem(rowItemTopLeftPos, itemSize, Color.blue);</span><br><span class="line">                rowItemTopLeftPos.x += spacing.x + itemSize.x;</span><br><span class="line">            &#125;</span><br><span class="line">            columnStartItemTopLeftPos.y -= itemSize.y + spacing.y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// if (BoundlessGridLayoutData.Constraint.FixedRowCount ==m_gridLayoutGroup.constraint)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; constraintCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            rowItemTopLeftPos = columnStartItemTopLeftPos;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; dynamicCount; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                DrawOneDebugGridItem(rowItemTopLeftPos, itemSize, Color.blue);</span><br><span class="line">                rowItemTopLeftPos.x += spacing.x + itemSize.x;</span><br><span class="line">            &#125;</span><br><span class="line">            columnStartItemTopLeftPos.y -= itemSize.y + spacing.y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来是最关键的地方了，要把实际显示在视口中的grid高亮出来，同时把不应该显示的grid高亮成另一种颜色，方便调试。</p><p>我参考了Unity的滚动视图源码，也使用Bounds在检查一个grid是否出现在viewport中。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawDebugShowingGrids</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Vector3 dragContentPostion = m_dragContent.position;</span><br><span class="line">    Vector3 dragAnchorContentPostion = m_dragContent.anchoredPosition;</span><br><span class="line">    Vector3 globalScale = m_viewport.lossyScale;</span><br><span class="line"></span><br><span class="line">    RectOffset padding = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != GridLayoutData)</span><br><span class="line">        padding = GridLayoutData.RectPadding;</span><br><span class="line"></span><br><span class="line">    Vector2 tempWa = dragAnchorContentPostion;</span><br><span class="line">    <span class="keyword">float</span> xMove = (Mathf.Abs(tempWa.x) - padding.horizontal) * globalScale.x;</span><br><span class="line">    xMove = Mathf.Clamp(xMove, <span class="number">0.0f</span>, Mathf.Abs(xMove));</span><br><span class="line">    <span class="keyword">float</span> yMove = (Mathf.Abs(tempWa.y) - padding.vertical) * globalScale.y;</span><br><span class="line">    yMove = Mathf.Clamp(yMove, <span class="number">0.0f</span>, Mathf.Abs(yMove));</span><br><span class="line"></span><br><span class="line">    Vector2 itemSize = <span class="keyword">new</span> Vector2(m_gridLayoutGroup.CellSize.x * globalScale.x, m_gridLayoutGroup.CellSize.y * globalScale.y);</span><br><span class="line">    Vector2 spacing = <span class="keyword">new</span> Vector2(m_gridLayoutGroup.Spacing.x * globalScale.x, m_gridLayoutGroup.Spacing.y * globalScale.y);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// re calculate</span></span><br><span class="line">    <span class="keyword">int</span> tempXIndex = Mathf.FloorToInt((xMove + spacing.x) / (itemSize.x + spacing.x));</span><br><span class="line">    <span class="keyword">if</span> (xMove % (itemSize.x + spacing.x) - itemSize.x &gt; spacing.x)</span><br><span class="line">        tempXIndex = Mathf.Clamp(tempXIndex - <span class="number">1</span>, <span class="number">0</span>, tempXIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> tempYIndex = Mathf.FloorToInt((yMove + spacing.y) / (itemSize.y + spacing.y));</span><br><span class="line">    <span class="keyword">if</span> (yMove % (itemSize.y + spacing.y) - itemSize.y &gt; spacing.y)</span><br><span class="line">        tempYIndex = Mathf.Clamp(tempYIndex - <span class="number">1</span>, <span class="number">0</span>, tempYIndex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO temp calculate from top left</span></span><br><span class="line">    Vector3 tempMove = <span class="keyword">new</span> Vector3(tempXIndex * (itemSize.x + spacing.x), -tempYIndex * (itemSize.y + spacing.y), <span class="number">0.0f</span>);</span><br><span class="line">    Vector2 actualContentSize = <span class="keyword">new</span> Vector2(m_actualContentSizeRaw.x * globalScale.x, m_actualContentSizeRaw.y * globalScale.y);</span><br><span class="line">    Vector3 boundsCenter = m_dragContent.position;</span><br><span class="line">    boundsCenter.x += padding.left * globalScale.x;</span><br><span class="line">    boundsCenter.y -= padding.top * globalScale.y;</span><br><span class="line">    Bounds contentBounds = <span class="keyword">new</span> Bounds(boundsCenter + <span class="keyword">new</span> Vector3(actualContentSize.x * <span class="number">0.5f</span>, -actualContentSize.y * <span class="number">0.5f</span>, <span class="number">0.0f</span>), actualContentSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deal with content from left to right (simple case) first</span></span><br><span class="line">    Vector3 rowTopLeftPosition = <span class="keyword">default</span>, itemTopLeftPosition = <span class="keyword">default</span>;</span><br><span class="line">    rowTopLeftPosition = dragContentPostion + tempMove;</span><br><span class="line">    rowTopLeftPosition += <span class="keyword">new</span> Vector3(padding.left * globalScale.x, -padding.top * globalScale.y, <span class="number">0.0f</span>);</span><br><span class="line">    <span class="comment">// use bounds to check for noobs like mey :)</span></span><br><span class="line">    Bounds gridBounds = <span class="keyword">new</span> Bounds(rowTopLeftPosition, itemSize);</span><br><span class="line">    Vector3 gridBoundsCenter = <span class="keyword">default</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> rowIndex = <span class="number">0</span>; rowIndex &lt; m_viewItemCountInColumn; rowIndex++)</span><br><span class="line">    &#123;</span><br><span class="line">        itemTopLeftPosition = rowTopLeftPosition;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> columnIndex = <span class="number">0</span>; columnIndex &lt; m_viewItemCountInRow; columnIndex++)</span><br><span class="line">        &#123;</span><br><span class="line">            gridBoundsCenter = itemTopLeftPosition;</span><br><span class="line">            gridBoundsCenter.x += itemSize.x;</span><br><span class="line">            gridBoundsCenter.y -= itemSize.y;</span><br><span class="line">            gridBounds.center = gridBoundsCenter;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (contentBounds.Intersects(gridBounds))</span><br><span class="line">                DrawOneDebugGridItem(itemTopLeftPosition, itemSize, Color.white); <span class="comment">// the real grid in the content</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                DrawOneDebugGridItem(itemTopLeftPosition, itemSize, Color.yellow); <span class="comment">// the grid should not show</span></span><br><span class="line"></span><br><span class="line">            itemTopLeftPosition.x += spacing.x + itemSize.x;</span><br><span class="line">        &#125;</span><br><span class="line">        rowTopLeftPosition.y -= spacing.y + itemSize.y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用这几个debug draw能够很方便的让我预览我的代码是否正确，也让我把困难都切开了一个个攻克。</p><img src="/2021/01/31/20210131-UGUI-ScrollRect-Learn-02/20210131-scrollrect01.gif" class="" title="split"><p>完整代码:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BoundlessBaseScrollRectItem</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">protected</span> RectTransform m_rectTransform = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> CanvasGroup m_canvasGroup = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Vector2 m_itemSize = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RectTransform ItemRectTransform =&gt; m_rectTransform;</span><br><span class="line">    <span class="keyword">public</span> Vector2 ItemSize =&gt; m_itemSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> to inject data and cast data</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="data"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">InjectData</span>(<span class="params">IBoundlessScrollRectItemData data</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_canvasGroup.alpha = <span class="number">1.0f</span>;</span><br><span class="line">        m_canvasGroup.interactable = <span class="literal">true</span>;</span><br><span class="line">        m_canvasGroup.blocksRaycasts = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Hide</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_canvasGroup.alpha = <span class="number">0.0f</span>;</span><br><span class="line">        m_canvasGroup.interactable = <span class="literal">false</span>;</span><br><span class="line">        m_canvasGroup.blocksRaycasts = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetItemSize</span>(<span class="params">Vector2 nextSize</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_itemSize = nextSize;</span><br><span class="line">        m_rectTransform.sizeDelta = m_itemSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> mono method</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_rectTransform = GetComponent&lt;RectTransform&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_rectTransform = GetComponent&lt;RectTransform&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[<span class="meta">System.Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BoundlessGridLayoutData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> TODO to find a way to do those  </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment">// public enum StartCorner</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     UpperLeft = 0,</span></span><br><span class="line">    <span class="comment">//     UpperRight = 1,</span></span><br><span class="line">    <span class="comment">//     LowerLeft = 2,</span></span><br><span class="line">    <span class="comment">//     LowerRight = 3</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> Constraint</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// in this mode they will just extend vertical side</span></span><br><span class="line">        FixedColumnCount = <span class="number">0</span>,</span><br><span class="line">        <span class="comment">// in this mode they will just extend horizontal side</span></span><br><span class="line">        FixedRowCount = <span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> StartAxis</span><br><span class="line">    &#123;</span><br><span class="line">        Horizontal = <span class="number">0</span>,</span><br><span class="line">        Vertical = <span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// // TODO use it</span></span><br><span class="line">    <span class="comment">// public StartCorner m_startCorner = StartCorner.UpperLeft;</span></span><br><span class="line">    <span class="keyword">public</span> Constraint constraint = Constraint.FixedColumnCount;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializeField, Tooltip(<span class="meta-string">"auto fit means calculate the constraint count by viewport size"</span>)</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> m_autoFit = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsAutoFit</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> =&gt; m_autoFit;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_autoFit = <span class="keyword">value</span>;</span><br><span class="line">            OnFitTypeChanged?.Invoke(m_autoFit);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Min(1)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> constraintCount = <span class="keyword">default</span>;</span><br><span class="line">    <span class="keyword">public</span> StartAxis startAxis = StartAxis.Horizontal;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Padding is to expend/shrink the REAL content</span></span><br><span class="line">    <span class="keyword">public</span> RectOffset RectPadding = <span class="literal">null</span>;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> Vector2 m_cellSize = Vector2.one * <span class="number">100.0f</span>;</span><br><span class="line">    <span class="keyword">public</span> Vector2 CellSize</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> =&gt; m_cellSize;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_cellSize = <span class="keyword">value</span>;</span><br><span class="line">            OnCellSizeChanged?.Invoke(m_cellSize);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Vector2 Spacing = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> StopMagSqrVel = <span class="number">50.0f</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> BoundlessTempScrollRectItem m_gridItemPrefab = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> BoundlessTempScrollRectItem GridItemPrefab =&gt; m_gridItemPrefab;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> result is 'autofit'</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> System.Action&lt;<span class="keyword">bool</span>&gt; OnFitTypeChanged;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> result is 'cellsize'</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> System.Action&lt;Vector2&gt; OnCellSizeChanged;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[<span class="meta">RequireComponent(typeof(ScrollRect), typeof(GridLayoutGroup))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BoundlessScrollRectController</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> ScrollRect m_scrollRect = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> RectTransform m_viewport = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// !!! these 2 content anchor are on top left </span></span><br><span class="line">    [<span class="meta">SerializeField, Tooltip(<span class="meta-string">"the content that used to drag"</span>)</span>]</span><br><span class="line">    <span class="keyword">private</span> RectTransform m_dragContent = <span class="literal">null</span>; <span class="comment">// currently only support 1 type of top left pivor</span></span><br><span class="line">    [<span class="meta">SerializeField, Tooltip(<span class="meta-string">"another content hold UI elements"</span>)</span>]</span><br><span class="line">    <span class="keyword">private</span> RectTransform m_actualContent = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// !!! these 2 content anchor are on top left </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Transform m_rootTransfrom = null;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_viewItemCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_viewItemCountInRow = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_viewItemCountInColumn = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> including spacing</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Vector2 m_actualContentSizeRaw = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;BoundlessBaseScrollRectItem&gt; m_uiItems = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> IReadOnlyList&lt;IBoundlessScrollRectItemData&gt; m_dataList = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* a test component, we will move this component</span></span><br><span class="line"><span class="comment">    * and use this to setup the grid size</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    [<span class="meta">Space, Header(<span class="meta-string">"Grid Layout Setting"</span>), SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> BoundlessGridLayoutData m_gridLayoutGroup = <span class="keyword">default</span>;</span><br><span class="line">    <span class="keyword">public</span> BoundlessGridLayoutData GridLayoutData =&gt; m_gridLayoutGroup;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// may need this to correctly scale the items :(</span></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> Canvas m_canvas = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">    [<span class="meta">Space, Header(<span class="meta-string">"Debug settings"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> m_drawContentSize = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> m_drawGrids = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> m_drawShowingGrids = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> m_drawActualUIItems = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RefreshLayout</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// if value on inspector got changed or some value being changed by code, should also call this</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_dataList)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        UpdateAcutalContentSizeRaw();</span><br><span class="line">        OnScrollRectValueChanged(Vector2.zero);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InjectData</span>(<span class="params">IReadOnlyList&lt;IBoundlessScrollRectItemData&gt; dataList</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_dataList = dataList;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// to set actual content correctly?</span></span><br><span class="line">        m_actualContent.anchorMax = m_viewport.anchorMax;</span><br><span class="line">        m_actualContent.anchorMin = m_viewport.anchorMin;</span><br><span class="line">        m_actualContent.pivot = m_viewport.pivot;</span><br><span class="line"></span><br><span class="line">        m_actualContent.localPosition = m_viewport.localPosition;</span><br><span class="line">        m_actualContent.anchoredPosition = m_viewport.anchoredPosition;</span><br><span class="line">        m_actualContent.sizeDelta = m_viewport.sizeDelta;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// set default simple draw stuff</span></span><br><span class="line"></span><br><span class="line">        AdjustCachedItems();</span><br><span class="line">        Vector3 globalScale = m_viewport.lossyScale;</span><br><span class="line">        Vector2 itemSize = <span class="keyword">new</span> Vector2(GridLayoutData.CellSize.x * globalScale.x, GridLayoutData.CellSize.y * globalScale.y);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_uiItems.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; dataList.Count)</span><br><span class="line">            &#123;</span><br><span class="line">                m_uiItems[i].InjectData(dataList[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Vector3 pos = m_uiItems[i].ItemRectTransform.anchoredPosition3D;</span><br><span class="line">            pos -= i * m_uiItems[i].ItemRectTransform.up * itemSize.y;</span><br><span class="line">            m_uiItems[i].ItemRectTransform.anchoredPosition = pos;</span><br><span class="line">            m_uiItems[i].gameObject.SetActive(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SyncSize();</span><br><span class="line">        UpdateAcutalContentSizeRaw();</span><br><span class="line">        OnScrollRectValueChanged(Vector2.zero);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateConstraintWithAutoFit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (GridLayoutData.IsAutoFit)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> constraintCount = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">float</span> viewportHeight = <span class="number">0.0f</span>, viewportWidth = <span class="number">0.0f</span>;</span><br><span class="line">            Vector2 spacing = GridLayoutData.Spacing;</span><br><span class="line">            viewportHeight = m_viewport.rect.height;</span><br><span class="line">            viewportWidth = m_viewport.rect.width;</span><br><span class="line">            Vector3 globalScale = m_viewport.lossyScale;</span><br><span class="line">            Vector2 itemSize = <span class="keyword">new</span> Vector2(GridLayoutData.CellSize.x * globalScale.x, GridLayoutData.CellSize.y * globalScale.y);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (BoundlessGridLayoutData.Constraint.FixedColumnCount == GridLayoutData.constraint)</span><br><span class="line">            &#123;</span><br><span class="line">                constraintCount = Mathf.FloorToInt(viewportWidth / (itemSize.x + spacing.x));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                constraintCount = Mathf.FloorToInt(viewportHeight / (itemSize.y + spacing.y));</span><br><span class="line">            &#125;</span><br><span class="line">            constraintCount = Mathf.Clamp(constraintCount, <span class="number">1</span>, <span class="keyword">int</span>.MaxValue);</span><br><span class="line">            GridLayoutData.constraintCount = constraintCount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateAcutalContentSizeRaw</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        RectOffset m_padding = GridLayoutData.RectPadding;</span><br><span class="line">        Vector2 itemSize = m_gridLayoutGroup.CellSize;</span><br><span class="line">        Vector2 spacing = m_gridLayoutGroup.Spacing;</span><br><span class="line">        <span class="keyword">int</span> dataCount = m_dataList.Count;</span><br><span class="line">        Vector2 result = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO @Hiko when calaulate size, should also deal with padding</span></span><br><span class="line">        <span class="keyword">int</span> constraintCount = m_gridLayoutGroup.constraintCount;</span><br><span class="line">        <span class="keyword">int</span> dynamicCount = (dataCount % constraintCount &gt; <span class="number">0</span>) ? (dataCount / constraintCount) + <span class="number">1</span> : (dataCount / constraintCount);</span><br><span class="line">        <span class="keyword">if</span> (m_gridLayoutGroup.constraint == BoundlessGridLayoutData.Constraint.FixedColumnCount)</span><br><span class="line">        &#123;</span><br><span class="line">            result.x = (constraintCount * itemSize.x) + ((constraintCount - <span class="number">1</span>) * spacing.x);</span><br><span class="line">            result.y = dynamicCount * itemSize.y + (dynamicCount - <span class="number">1</span>) * spacing.y;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (m_gridLayoutGroup.constraint == BoundlessGridLayoutData.Constraint.FixedRowCount)</span><br><span class="line">        &#123;</span><br><span class="line">            result.y = (constraintCount * itemSize.y) + ((constraintCount - <span class="number">1</span>) * spacing.y);</span><br><span class="line">            result.x = dynamicCount * itemSize.x + (dynamicCount - <span class="number">1</span>) * spacing.x;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_actualContentSizeRaw = result;</span><br><span class="line">        m_dragContent.sizeDelta = m_actualContentSizeRaw;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != GridLayoutData)</span><br><span class="line">        &#123;</span><br><span class="line">            RectOffset padding = GridLayoutData.RectPadding;</span><br><span class="line">            m_dragContent.sizeDelta += <span class="keyword">new</span> Vector2(padding.horizontal, padding.vertical);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnScrollRectValueChanged</span>(<span class="params">Vector2 position</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        RefreshItemStartPosition();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        <span class="keyword">if</span> (m_drawActualUIItems)</span><br><span class="line">            DrawContentItem();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// hide all Items</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_uiItems.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                m_uiItems[i].Hide();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        DrawContentItem();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RefreshItemStartPosition</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        UpdateAcutalContentSizeRaw();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> minStartPosX = <span class="number">0.0f</span>, maxStartPosX = <span class="number">0.0f</span>;</span><br><span class="line">        <span class="keyword">float</span> minStartPosY = <span class="number">0.0f</span>, maxStartPosY = <span class="number">0.0f</span>;</span><br><span class="line">        RectOffset padding = GridLayoutData.RectPadding;</span><br><span class="line">        Vector2 actualContentWithPaddingSizeRaw = m_actualContentSizeRaw + <span class="keyword">new</span> Vector2(padding.horizontal, padding.vertical);</span><br><span class="line">        <span class="keyword">if</span> (BoundlessGridLayoutData.Constraint.FixedColumnCount == m_gridLayoutGroup.constraint)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// content may move vertical</span></span><br><span class="line">            <span class="comment">// start from left to right for test</span></span><br><span class="line">            <span class="comment">// start from up to down for test</span></span><br><span class="line">            minStartPosY = <span class="number">0.0f</span>;</span><br><span class="line">            maxStartPosY = actualContentWithPaddingSizeRaw.y - m_viewport.rect.height;</span><br><span class="line"></span><br><span class="line">            minStartPosX = <span class="number">0.0f</span>;</span><br><span class="line">            maxStartPosX = m_viewport.rect.width - actualContentWithPaddingSizeRaw.x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (BoundlessGridLayoutData.Constraint.FixedRowCount == m_gridLayoutGroup.constraint)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// content may move horizontal or...</span></span><br><span class="line">            <span class="comment">// start from left to right for test</span></span><br><span class="line">            <span class="comment">// start from up to down for test</span></span><br><span class="line">            minStartPosY = <span class="number">0.0f</span>;</span><br><span class="line">            maxStartPosY = actualContentWithPaddingSizeRaw.y - m_viewport.rect.height;</span><br><span class="line"></span><br><span class="line">            minStartPosX = <span class="number">0.0f</span>;</span><br><span class="line">            maxStartPosX = m_viewport.rect.width - actualContentWithPaddingSizeRaw.x;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Vector2 nextTopPos = <span class="keyword">new</span> Vector2(m_dragContent.anchoredPosition.x, m_dragContent.anchoredPosition.y);</span><br><span class="line">        nextTopPos.x = Mathf.Clamp(nextTopPos.x, Mathf.Min(minStartPosX, maxStartPosX), Mathf.Max(minStartPosX, maxStartPosX));</span><br><span class="line">        nextTopPos.y = Mathf.Clamp(nextTopPos.y, Mathf.Min(minStartPosY, maxStartPosY), Mathf.Max(minStartPosY, maxStartPosY));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawContentItem</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Vector3 dragContentPostion = m_dragContent.position;</span><br><span class="line">        Vector3 dragAnchorContentPostion = m_dragContent.anchoredPosition;</span><br><span class="line">        m_actualContent.anchoredPosition = Vector2.zero;</span><br><span class="line">        Vector3 globalScale = m_viewport.lossyScale;</span><br><span class="line"></span><br><span class="line">        Vector2 itemSize = <span class="keyword">new</span> Vector2(GridLayoutData.CellSize.x * globalScale.x, GridLayoutData.CellSize.y * globalScale.y);</span><br><span class="line">        Vector2 spacing = <span class="keyword">new</span> Vector2(GridLayoutData.Spacing.x * globalScale.x, GridLayoutData.Spacing.y * globalScale.y);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO use offset as padding correctly</span></span><br><span class="line">        RectOffset padding = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != GridLayoutData)</span><br><span class="line">            padding = GridLayoutData.RectPadding;</span><br><span class="line"></span><br><span class="line">        Vector2 tempWa = dragAnchorContentPostion;</span><br><span class="line">        <span class="keyword">float</span> xMove = (Mathf.Abs(tempWa.x) - padding.horizontal) * globalScale.x;</span><br><span class="line">        xMove = Mathf.Clamp(xMove, <span class="number">0.0f</span>, Mathf.Abs(xMove));</span><br><span class="line">        <span class="keyword">float</span> yMove = (Mathf.Abs(tempWa.y) - padding.vertical) * globalScale.y;</span><br><span class="line">        yMove = Mathf.Clamp(yMove, <span class="number">0.0f</span>, Mathf.Abs(yMove));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> tempColumnIndex = Mathf.FloorToInt((xMove + spacing.x) / (itemSize.x + spacing.x));</span><br><span class="line">        <span class="keyword">if</span> (xMove % (itemSize.x + spacing.x) - itemSize.x &gt; spacing.x)</span><br><span class="line">            tempColumnIndex = Mathf.Clamp(tempColumnIndex - <span class="number">1</span>, <span class="number">0</span>, tempColumnIndex);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> tempRowIndex = Mathf.FloorToInt((yMove + spacing.y) / (itemSize.y + spacing.y));</span><br><span class="line">        <span class="keyword">if</span> (yMove % (itemSize.y + spacing.y) - itemSize.y &gt; spacing.y)</span><br><span class="line">            tempRowIndex = Mathf.Clamp(tempRowIndex - <span class="number">1</span>, <span class="number">0</span>, tempRowIndex);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO fix temp calculate (now it isfrom top left)</span></span><br><span class="line">        Vector3 tempMove = <span class="keyword">new</span> Vector3(tempColumnIndex * (itemSize.x + spacing.x), -tempRowIndex * (itemSize.y + spacing.y), <span class="number">0.0f</span>);</span><br><span class="line">        Vector2 actualContentSize = <span class="keyword">new</span> Vector2(m_actualContentSizeRaw.x * globalScale.x, m_actualContentSizeRaw.y * globalScale.y);</span><br><span class="line">        Vector3 boundsCenter = m_dragContent.position;</span><br><span class="line">        boundsCenter.x += padding.left * globalScale.x;</span><br><span class="line">        boundsCenter.y -= padding.top * globalScale.y;</span><br><span class="line">        Bounds contentBounds = <span class="keyword">new</span> Bounds(boundsCenter + <span class="keyword">new</span> Vector3(actualContentSize.x * <span class="number">0.5f</span>, -actualContentSize.y * <span class="number">0.5f</span>, <span class="number">0.0f</span>), actualContentSize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// to calculate it somewhere else :)</span></span><br><span class="line">        <span class="keyword">int</span> rowDataCount = <span class="number">0</span>, columnDataCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (BoundlessGridLayoutData.Constraint.FixedColumnCount == m_gridLayoutGroup.constraint)</span><br><span class="line">        &#123;</span><br><span class="line">            rowDataCount = m_gridLayoutGroup.constraintCount;</span><br><span class="line">            columnDataCount = (<span class="keyword">int</span>)Mathf.CeilToInt((<span class="keyword">float</span>)m_dataList.Count / rowDataCount);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            columnDataCount = m_gridLayoutGroup.constraintCount;</span><br><span class="line">            rowDataCount = (<span class="keyword">int</span>)Mathf.CeilToInt((<span class="keyword">float</span>)m_dataList.Count / columnDataCount);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// deal with content from left to right (simple case) first</span></span><br><span class="line">        <span class="keyword">int</span> rowFirstDataIndex = <span class="number">0</span>, dataIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> uiItemIndex = <span class="number">0</span>;</span><br><span class="line">        Vector3 rowTopLeftPosition = <span class="keyword">default</span>, itemTopLeftPosition = <span class="keyword">default</span>;</span><br><span class="line">        rowTopLeftPosition = dragContentPostion + tempMove;</span><br><span class="line">        rowTopLeftPosition += <span class="keyword">new</span> Vector3(padding.left * globalScale.x, -padding.top * globalScale.y, <span class="number">0.0f</span>);</span><br><span class="line">        Bounds currentGridBounds = <span class="keyword">new</span> Bounds(rowTopLeftPosition, itemSize);</span><br><span class="line">        Vector3 currentGridBoundsCenter = <span class="keyword">default</span>;</span><br><span class="line">        <span class="keyword">bool</span> hideItem = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// draw from left to right for test</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> rowIndex = <span class="number">0</span>; rowIndex &lt; m_viewItemCountInColumn; rowIndex++)</span><br><span class="line">        &#123;</span><br><span class="line">            itemTopLeftPosition = rowTopLeftPosition;</span><br><span class="line">            <span class="keyword">if</span> (BoundlessGridLayoutData.StartAxis.Horizontal == m_gridLayoutGroup.startAxis)</span><br><span class="line">                rowFirstDataIndex = (tempRowIndex + rowIndex) * rowDataCount;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                rowFirstDataIndex = tempRowIndex + rowIndex + tempColumnIndex * columnDataCount;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> columnIndex = <span class="number">0</span>; columnIndex &lt; m_viewItemCountInRow; columnIndex++)</span><br><span class="line">            &#123;</span><br><span class="line">                currentGridBoundsCenter = itemTopLeftPosition;</span><br><span class="line">                currentGridBoundsCenter.x += itemSize.x;</span><br><span class="line">                currentGridBoundsCenter.y -= itemSize.y;</span><br><span class="line">                currentGridBounds.center = currentGridBoundsCenter;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (BoundlessGridLayoutData.StartAxis.Horizontal == m_gridLayoutGroup.startAxis)</span><br><span class="line">                    dataIndex = rowFirstDataIndex + tempColumnIndex + columnIndex;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    dataIndex = rowFirstDataIndex + columnIndex * columnDataCount;</span><br><span class="line"></span><br><span class="line">                hideItem = !contentBounds.Intersects(currentGridBounds) || dataIndex &gt;= m_dataList.Count || dataIndex &lt; <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (hideItem)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_uiItems[uiItemIndex].ItemRectTransform.position = Vector2.zero;</span><br><span class="line">                    m_uiItems[uiItemIndex].Hide();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    m_uiItems[uiItemIndex].ItemRectTransform.position = itemTopLeftPosition;</span><br><span class="line">                    m_uiItems[uiItemIndex].InjectData(m_dataList[dataIndex]);</span><br><span class="line">                    m_uiItems[uiItemIndex].Show();</span><br><span class="line">                    uiItemIndex++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                itemTopLeftPosition.x += spacing.x + itemSize.x;</span><br><span class="line">            &#125;</span><br><span class="line">            rowTopLeftPosition.y -= spacing.y + itemSize.y;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (uiItemIndex &lt; m_uiItems.Count)</span><br><span class="line">        &#123;</span><br><span class="line">            m_uiItems[uiItemIndex].Hide();</span><br><span class="line">            m_uiItems[uiItemIndex].ItemRectTransform.anchoredPosition = Vector2.zero;</span><br><span class="line">            uiItemIndex++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CalculateViewportShowCount</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_viewItemCountInRow = <span class="number">0</span>;</span><br><span class="line">        m_viewItemCountInColumn = <span class="number">0</span>;</span><br><span class="line">        Vector3 globalScale = m_viewport.lossyScale;</span><br><span class="line">        Vector2 itemSize = <span class="keyword">new</span> Vector2(m_gridLayoutGroup.CellSize.x * globalScale.x, m_gridLayoutGroup.CellSize.y * globalScale.y);</span><br><span class="line"></span><br><span class="line">        Vector2 spacing = m_gridLayoutGroup.Spacing;</span><br><span class="line">        <span class="keyword">float</span> viewportHeight = Mathf.Abs(m_viewport.rect.height * m_viewport.localScale.y);</span><br><span class="line">        <span class="keyword">float</span> viewportWidth = Mathf.Abs(m_viewport.rect.width * m_viewport.localScale.y);</span><br><span class="line">        m_viewItemCountInColumn = Mathf.FloorToInt(viewportHeight / (itemSize.y + spacing.y));</span><br><span class="line">        m_viewItemCountInRow = Mathf.FloorToInt(viewportWidth / (itemSize.x + spacing.x));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (viewportHeight % (itemSize.y + spacing.y) &gt; <span class="number">0</span>)</span><br><span class="line">            m_viewItemCountInColumn += <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            m_viewItemCountInColumn += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (viewportWidth % (itemSize.x + spacing.x) &gt; <span class="number">0</span>)</span><br><span class="line">            m_viewItemCountInRow += <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            m_viewItemCountInRow += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (BoundlessGridLayoutData.Constraint.FixedColumnCount == GridLayoutData.constraint)</span><br><span class="line">            m_viewItemCountInRow = Mathf.Clamp(m_viewItemCountInRow, <span class="number">1</span>, GridLayoutData.constraintCount);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            m_viewItemCountInColumn = Mathf.Clamp(m_viewItemCountInColumn, <span class="number">1</span>, GridLayoutData.constraintCount);</span><br><span class="line"></span><br><span class="line">        m_viewItemCount = m_viewItemCountInRow * m_viewItemCountInColumn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AdjustCachedItems</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_uiItems)</span><br><span class="line">            m_uiItems = <span class="keyword">new</span> List&lt;BoundlessBaseScrollRectItem&gt;();</span><br><span class="line"></span><br><span class="line">        BoundlessBaseScrollRectItem tempItem = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (m_viewItemCount &lt; m_uiItems.Count)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> countTest = (<span class="keyword">int</span>)(m_uiItems.Count * <span class="number">0.75f</span>);</span><br><span class="line">            <span class="keyword">if</span> (countTest &gt; m_viewItemCount)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// need delete</span></span><br><span class="line">                <span class="keyword">int</span> deleteCount = m_uiItems.Count - countTest;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deleteCount; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    tempItem = m_uiItems[m_uiItems.Count - <span class="number">1</span> - i];</span><br><span class="line">                    m_uiItems.RemoveAt(m_uiItems.Count - <span class="number">1</span> - i);</span><br><span class="line">                    Destroy(tempItem.gameObject);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> spawnCount = m_viewItemCount - m_uiItems.Count;</span><br><span class="line">            Vector3 globalScale = m_viewport.lossyScale;</span><br><span class="line">            Vector2 itemSize = <span class="keyword">new</span> Vector2(GridLayoutData.CellSize.x * globalScale.x, GridLayoutData.CellSize.y * globalScale.y);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spawnCount; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                tempItem = Instantiate(m_gridLayoutGroup.GridItemPrefab, m_actualContent);</span><br><span class="line">                tempItem.SetItemSize(itemSize);</span><br><span class="line">                m_uiItems.Add(tempItem);</span><br><span class="line">                tempItem.Hide();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ClearCachedItems</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_uiItems)</span><br><span class="line">            m_uiItems.Clear();</span><br><span class="line">        DestroyAllChildren(m_actualContent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ClampVelocityToToStop</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">float</span> sqrLimit = m_gridLayoutGroup.StopMagSqrVel;</span><br><span class="line">        sqrLimit *= sqrLimit;</span><br><span class="line">        <span class="keyword">float</span> velocitySqrMag = m_scrollRect.velocity.sqrMagnitude;</span><br><span class="line">        <span class="comment">// if (!Mathf.Approximately(0.0f, velocitySqrMag))</span></span><br><span class="line">        <span class="comment">//     Debug.Log($"test vel &#123;m_scrollRect.velocity&#125;, test sqr mag &#123;velocitySqrMag&#125;");</span></span><br><span class="line">        <span class="keyword">if</span> (velocitySqrMag &lt; sqrLimit &amp;&amp; !Mathf.Approximately(<span class="number">0.0f</span>, velocitySqrMag)) <span class="comment">// try to clamped move to save </span></span><br><span class="line">            m_scrollRect.StopMovement();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnLayoutFitTypeChanged</span>(<span class="params"><span class="keyword">bool</span> autoFit</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        UpdateConstraintWithAutoFit();</span><br><span class="line">        AdjustCachedItems();</span><br><span class="line">        CalculateViewportShowCount();</span><br><span class="line">        AdjustCachedItems();</span><br><span class="line">        RefreshLayout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnCellSizeChanged</span>(<span class="params">Vector2 cellSize</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        SyncSize();</span><br><span class="line">        CalculateViewportShowCount();</span><br><span class="line">        AdjustCachedItems();</span><br><span class="line">        RefreshLayout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> mono method</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// m_rootTransfrom = this.transform;</span></span><br><span class="line">        m_scrollRect.GetComponent&lt;ScrollRect&gt;();</span><br><span class="line">        m_scrollRect.StopMovement();</span><br><span class="line">        m_dragContent = m_scrollRect.content;</span><br><span class="line">        m_canvas = GetComponentInParent&lt;Canvas&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_canvas = GetComponentInParent&lt;Canvas&gt;();</span><br><span class="line">        m_scrollRect.onValueChanged.AddListener(OnScrollRectValueChanged);</span><br><span class="line">        UpdateConstraintWithAutoFit();</span><br><span class="line">        CalculateViewportShowCount();</span><br><span class="line">        ClearCachedItems();</span><br><span class="line">        AdjustCachedItems();</span><br><span class="line">        GridLayoutData.OnFitTypeChanged += OnLayoutFitTypeChanged;</span><br><span class="line">        GridLayoutData.OnCellSizeChanged += OnCellSizeChanged;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDisable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_scrollRect.onValueChanged.RemoveListener(OnScrollRectValueChanged);</span><br><span class="line">        ClearCachedItems();</span><br><span class="line">        GridLayoutData.OnFitTypeChanged -= OnLayoutFitTypeChanged;</span><br><span class="line">        GridLayoutData.OnCellSizeChanged -= OnCellSizeChanged;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ClampVelocityToToStop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DestroyAllChildren</span>(<span class="params">Transform target</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == target)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> childCount = target.childCount;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            Destroy(target.GetChild(i).gameObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SyncSize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// sync the size form grid data</span></span><br><span class="line">        <span class="comment">// the actual item size will also directly affected by parent canvas's scale factor, so we may not need to multiple it :D</span></span><br><span class="line">        Vector2 itemAcutalSize = m_gridLayoutGroup.CellSize;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != m_uiItems)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_uiItems.Count; i++)</span><br><span class="line">                m_uiItems[i].SetItemSize(itemAcutalSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_EDITOR // some method to debug drawing or sth</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDrawGizmos</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!Application.isPlaying)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_drawContentSize)</span><br><span class="line">            DrawDebugContentSize();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_drawGrids)</span><br><span class="line">            DrawDebugGrids();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_drawShowingGrids)</span><br><span class="line">            DrawDebugShowingGrids();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawDebugContentSize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_dataList)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        RectOffset padding = GridLayoutData.RectPadding;</span><br><span class="line">        Vector2 paddingValueRaw = <span class="keyword">new</span> Vector2(padding.horizontal, padding.vertical);</span><br><span class="line">        Vector3 rootScale = m_viewport.lossyScale;</span><br><span class="line"></span><br><span class="line">        Vector2 actualContentSize = (m_actualContentSizeRaw + paddingValueRaw);</span><br><span class="line">        actualContentSize.x *= rootScale.x;</span><br><span class="line">        actualContentSize.y *= rootScale.y;</span><br><span class="line"></span><br><span class="line">        Vector3 topLeftPoint = m_dragContent.position;</span><br><span class="line">        Vector3 topRightPoint = topLeftPoint;</span><br><span class="line">        topRightPoint.x += actualContentSize.x;</span><br><span class="line"></span><br><span class="line">        Vector3 bottomLeftPoint = topLeftPoint;</span><br><span class="line">        Vector3 BottomRightPoint = topRightPoint;</span><br><span class="line">        bottomLeftPoint.y -= actualContentSize.y;</span><br><span class="line">        BottomRightPoint.y -= actualContentSize.y;</span><br><span class="line"></span><br><span class="line">        Debug.DrawLine(topLeftPoint, topRightPoint, Color.magenta);</span><br><span class="line">        Debug.DrawLine(topLeftPoint, bottomLeftPoint, Color.magenta);</span><br><span class="line">        Debug.DrawLine(topRightPoint, BottomRightPoint, Color.magenta);</span><br><span class="line">        Debug.DrawLine(bottomLeftPoint, BottomRightPoint, Color.magenta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawDebugGrids</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_dataList)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> dataCount = m_dataList.Count;</span><br><span class="line">        Vector3 rowItemTopLeftPos = <span class="keyword">default</span>;</span><br><span class="line">        Vector3 columnStartItemTopLeftPos = m_dragContent.position;</span><br><span class="line">        columnStartItemTopLeftPos.z = <span class="number">0.0f</span>;</span><br><span class="line">        Vector3 rootScale = m_viewport.lossyScale;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO use offset as padding correctly</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != GridLayoutData)</span><br><span class="line">        &#123;</span><br><span class="line">            RectOffset padding = GridLayoutData.RectPadding;</span><br><span class="line">            columnStartItemTopLeftPos += <span class="keyword">new</span> Vector3(padding.left * rootScale.x, -padding.top * rootScale.y, <span class="number">0.0f</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Vector2 spacing = <span class="keyword">new</span> Vector2(m_gridLayoutGroup.Spacing.x * rootScale.x, m_gridLayoutGroup.Spacing.y * rootScale.y);</span><br><span class="line">        Vector2 itemSize = <span class="keyword">new</span> Vector2(m_gridLayoutGroup.CellSize.x * rootScale.x, m_gridLayoutGroup.CellSize.y * rootScale.y);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// should know which axis get constrained</span></span><br><span class="line">        <span class="keyword">int</span> constraintCount = m_gridLayoutGroup.constraintCount;</span><br><span class="line">        <span class="keyword">int</span> dynamicCount = (dataCount % constraintCount &gt; <span class="number">0</span>) ? (dataCount / constraintCount) + <span class="number">1</span> : (dataCount / constraintCount);</span><br><span class="line">        <span class="keyword">if</span> (BoundlessGridLayoutData.Constraint.FixedColumnCount == m_gridLayoutGroup.constraint)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dynamicCount; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                rowItemTopLeftPos = columnStartItemTopLeftPos;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; constraintCount; j++)</span><br><span class="line">                &#123;</span><br><span class="line">                    DrawOneDebugGridItem(rowItemTopLeftPos, itemSize, Color.blue);</span><br><span class="line">                    rowItemTopLeftPos.x += spacing.x + itemSize.x;</span><br><span class="line">                &#125;</span><br><span class="line">                columnStartItemTopLeftPos.y -= itemSize.y + spacing.y;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">// if (BoundlessGridLayoutData.Constraint.FixedRowCount == m_gridLayoutGroup.constraint)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; constraintCount; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                rowItemTopLeftPos = columnStartItemTopLeftPos;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; dynamicCount; j++)</span><br><span class="line">                &#123;</span><br><span class="line">                    DrawOneDebugGridItem(rowItemTopLeftPos, itemSize, Color.blue);</span><br><span class="line">                    rowItemTopLeftPos.x += spacing.x + itemSize.x;</span><br><span class="line">                &#125;</span><br><span class="line">                columnStartItemTopLeftPos.y -= itemSize.y + spacing.y;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawDebugShowingGrids</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Vector3 dragContentPostion = m_dragContent.position;</span><br><span class="line">        Vector3 dragAnchorContentPostion = m_dragContent.anchoredPosition;</span><br><span class="line">        Vector3 globalScale = m_viewport.lossyScale;</span><br><span class="line"></span><br><span class="line">        RectOffset padding = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != GridLayoutData)</span><br><span class="line">            padding = GridLayoutData.RectPadding;</span><br><span class="line"></span><br><span class="line">        Vector2 tempWa = dragAnchorContentPostion;</span><br><span class="line">        <span class="keyword">float</span> xMove = (Mathf.Abs(tempWa.x) - padding.horizontal) * globalScale.x;</span><br><span class="line">        xMove = Mathf.Clamp(xMove, <span class="number">0.0f</span>, Mathf.Abs(xMove));</span><br><span class="line">        <span class="keyword">float</span> yMove = (Mathf.Abs(tempWa.y) - padding.vertical) * globalScale.y;</span><br><span class="line">        yMove = Mathf.Clamp(yMove, <span class="number">0.0f</span>, Mathf.Abs(yMove));</span><br><span class="line"></span><br><span class="line">        Vector2 itemSize = <span class="keyword">new</span> Vector2(m_gridLayoutGroup.CellSize.x * globalScale.x, m_gridLayoutGroup.CellSize.y * globalScale.y);</span><br><span class="line">        Vector2 spacing = <span class="keyword">new</span> Vector2(m_gridLayoutGroup.Spacing.x * globalScale.x, m_gridLayoutGroup.Spacing.y * globalScale.y);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// re calculate</span></span><br><span class="line">        <span class="keyword">int</span> tempXIndex = Mathf.FloorToInt((xMove + spacing.x) / (itemSize.x + spacing.x));</span><br><span class="line">        <span class="keyword">if</span> (xMove % (itemSize.x + spacing.x) - itemSize.x &gt; spacing.x)</span><br><span class="line">            tempXIndex = Mathf.Clamp(tempXIndex - <span class="number">1</span>, <span class="number">0</span>, tempXIndex);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> tempYIndex = Mathf.FloorToInt((yMove + spacing.y) / (itemSize.y + spacing.y));</span><br><span class="line">        <span class="keyword">if</span> (yMove % (itemSize.y + spacing.y) - itemSize.y &gt; spacing.y)</span><br><span class="line">            tempYIndex = Mathf.Clamp(tempYIndex - <span class="number">1</span>, <span class="number">0</span>, tempYIndex);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO temp calculate from top left</span></span><br><span class="line">        Vector3 tempMove = <span class="keyword">new</span> Vector3(tempXIndex * (itemSize.x + spacing.x), -tempYIndex * (itemSize.y + spacing.y), <span class="number">0.0f</span>);</span><br><span class="line">        Vector2 actualContentSize = <span class="keyword">new</span> Vector2(m_actualContentSizeRaw.x * globalScale.x, m_actualContentSizeRaw.y * globalScale.y);</span><br><span class="line">        Vector3 boundsCenter = m_dragContent.position;</span><br><span class="line">        boundsCenter.x += padding.left * globalScale.x;</span><br><span class="line">        boundsCenter.y -= padding.top * globalScale.y;</span><br><span class="line">        Bounds contentBounds = <span class="keyword">new</span> Bounds(boundsCenter + <span class="keyword">new</span> Vector3(actualContentSize.x * <span class="number">0.5f</span>, -actualContentSize.y * <span class="number">0.5f</span>, <span class="number">0.0f</span>), actualContentSize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// deal with content from left to right (simple case) first</span></span><br><span class="line">        Vector3 rowTopLeftPosition = <span class="keyword">default</span>, itemTopLeftPosition = <span class="keyword">default</span>;</span><br><span class="line">        rowTopLeftPosition = dragContentPostion + tempMove;</span><br><span class="line">        rowTopLeftPosition += <span class="keyword">new</span> Vector3(padding.left * globalScale.x, -padding.top * globalScale.y, <span class="number">0.0f</span>);</span><br><span class="line">        Bounds gridBounds = <span class="keyword">new</span> Bounds(rowTopLeftPosition, itemSize);</span><br><span class="line">        Vector3 gridBoundsCenter = <span class="keyword">default</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> rowIndex = <span class="number">0</span>; rowIndex &lt; m_viewItemCountInColumn; rowIndex++)</span><br><span class="line">        &#123;</span><br><span class="line">            itemTopLeftPosition = rowTopLeftPosition;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> columnIndex = <span class="number">0</span>; columnIndex &lt; m_viewItemCountInRow; columnIndex++)</span><br><span class="line">            &#123;</span><br><span class="line">                gridBoundsCenter = itemTopLeftPosition;</span><br><span class="line">                gridBoundsCenter.x += itemSize.x;</span><br><span class="line">                gridBoundsCenter.y -= itemSize.y;</span><br><span class="line">                gridBounds.center = gridBoundsCenter;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (contentBounds.Intersects(gridBounds))</span><br><span class="line">                    DrawOneDebugGridItem(itemTopLeftPosition, itemSize, Color.white); <span class="comment">// the real grid in the content</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    DrawOneDebugGridItem(itemTopLeftPosition, itemSize, Color.yellow); <span class="comment">// the grid should not show</span></span><br><span class="line"></span><br><span class="line">                itemTopLeftPosition.x += spacing.x + itemSize.x;</span><br><span class="line">            &#125;</span><br><span class="line">            rowTopLeftPosition.y -= spacing.y + itemSize.y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawOneDebugGridItem</span>(<span class="params">Vector3 topLeftPoint, Vector3 itemSize, Color color</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Vector3 topRightPoint = topLeftPoint;</span><br><span class="line">        topRightPoint.x += itemSize.x;</span><br><span class="line"></span><br><span class="line">        Vector3 bottomLeftPoint = topLeftPoint;</span><br><span class="line">        bottomLeftPoint.y -= itemSize.y;</span><br><span class="line"></span><br><span class="line">        Vector3 bottomRightPoint = topRightPoint;</span><br><span class="line">        bottomRightPoint.y -= itemSize.y;</span><br><span class="line"></span><br><span class="line">        Debug.DrawLine(topLeftPoint, topRightPoint, color);</span><br><span class="line">        Debug.DrawLine(bottomLeftPoint, bottomRightPoint, color);</span><br><span class="line"></span><br><span class="line">        Debug.DrawLine(topLeftPoint, bottomLeftPoint, color);</span><br><span class="line">        Debug.DrawLine(topRightPoint, bottomRightPoint, color);</span><br><span class="line"></span><br><span class="line">        Debug.DrawLine(topLeftPoint, bottomRightPoint, color);</span><br><span class="line">        Debug.DrawLine(topRightPoint, bottomLeftPoint, color);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[<span class="meta">CustomEditor(typeof(BoundlessScrollRectController))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BoundlessScrollRectControllerEditor</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> BoundlessScrollRectController m_target = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInspectorGUI</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_target)</span><br><span class="line">            m_target = <span class="keyword">base</span>.target <span class="keyword">as</span> BoundlessScrollRectController;</span><br><span class="line"></span><br><span class="line">        EditorGUI.BeginChangeCheck();</span><br><span class="line">        <span class="keyword">base</span>.OnInspectorGUI();</span><br><span class="line">        <span class="keyword">bool</span> hasChanged = EditorGUI.EndChangeCheck();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasChanged)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// too bad :)</span></span><br><span class="line">            <span class="comment">// I do this is to update the layout when I changed properties at runtime</span></span><br><span class="line">            m_target.GridLayoutData.IsAutoFit = m_target.GridLayoutData.IsAutoFit;</span><br><span class="line">            m_target.GridLayoutData.CellSize = m_target.GridLayoutData.CellSize;</span><br><span class="line">            m_target.RefreshLayout();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>一开始很想做一个能够多扩展多复用的的组件，后来发现非常困难无从下手，就决定从简单的开始，一步步走过去。</p><p>下面是我的全部代码：<br><a href="https://github.com/2C2C2C/MuyScrollRect" target="_blank" rel="noopener">https://github.com/2C2C2C/MuyScrollRect</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这几个月基本都在给策划做各种原型，都没怎么摸项目里的UI。也还算是抽时间试着做了一个循环的scrollrect，毕竟之前的项目里有一些需要显示玩家物品的仓库界面，打开就卡爆，滚动也卡爆。&lt;/p&gt;
&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;header
      
    
    </summary>
    
    
      <category term="Unity" scheme="http://yoursite.com/categories/Unity/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UGUI" scheme="http://yoursite.com/tags/UGUI/"/>
    
  </entry>
  
  <entry>
    <title>JS脚本删除豆瓣广播</title>
    <link href="http://yoursite.com/2020/12/20/20201220-delete-douban-post/"/>
    <id>http://yoursite.com/2020/12/20/20201220-delete-douban-post/</id>
    <published>2020-12-20T14:23:02.000Z</published>
    <updated>2020-12-20T17:03:51.404Z</updated>
    
    <content type="html"><![CDATA[<h1 id="JS脚本删除豆瓣广播"><a href="#JS脚本删除豆瓣广播" class="headerlink" title="JS脚本删除豆瓣广播"></a>JS脚本删除豆瓣广播</h1><p>很久以前为了清理自己SPAM在微博的东西，找过批量删除微博的脚本。现在也想顺手清理一下豆瓣的，不过没找到比较好用的。<br>不过完全不会WEB开发，也只能自己拼凑一下。</p><p>直接上代码吧</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>豆瓣有保护机制的，如果在短时间内疯狂发送请求，会在一定时间内被BAN IP（亲身经历）。<br>所以我们可以试着用随机等待的方式来避免这个问题。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// I steal this from somewhere</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleepWait</span>(<span class="params">waitMsec</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> startMsec = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">new</span> <span class="built_in">Date</span>() - startMsec &lt; waitMsec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execTest</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> step = <span class="number">0</span>; step &lt; <span class="number">10</span>; step++) &#123;</span><br><span class="line">        location.reload();</span><br><span class="line">        <span class="keyword">var</span> waitDuration = (<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">10</span>) + <span class="number">1</span>) * <span class="number">10000</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'test log, next exec in'</span> + waitDuration + <span class="string">'ms'</span>);</span><br><span class="line">        sleepWait(waitDuration);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>删除的代码是我白嫖来的，在 我的广播 的页面里执行这个函数大概可以删除当前页面中的所有广播。<br>不过转发好像不一定能删除，之后还得找别的方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// I steal this from somewhere</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execDelTest</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="function"><span class="keyword">function</span>(<span class="params">c</span>) </span>&#123; $.post_withck(<span class="string">"/j/status/delete"</span>, &#123; <span class="attr">sid</span>: c &#125;) &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> b = <span class="function"><span class="keyword">function</span>(<span class="params">c</span>) </span>&#123; $.post_withck(<span class="string">"/j/status/unreshare"</span>, &#123; <span class="attr">sid</span>: c &#125;) &#125;;</span><br><span class="line"></span><br><span class="line">    $(<span class="string">"a[data-reshare-id]"</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        b($(<span class="keyword">this</span>).attr(<span class="string">"data-reshare-id"</span>));</span><br><span class="line">        $(<span class="keyword">this</span>).hide()</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $(<span class="string">"div[data-sid]"</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        a($(<span class="keyword">this</span>).attr(<span class="string">"data-sid"</span>));</span><br><span class="line">        $(<span class="keyword">this</span>).hide()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>完整代码如下，不过真的怕被BAN IP 可以把随机等待的时间设定得长一些</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// I steal this from somewhere</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleepWait</span>(<span class="params">waitMsec</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> startMsec = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">new</span> <span class="built_in">Date</span>() - startMsec &lt; waitMsec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// I steal this from somewhere</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execDelTest</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="function"><span class="keyword">function</span>(<span class="params">c</span>) </span>&#123; $.post_withck(<span class="string">"/j/status/delete"</span>, &#123; <span class="attr">sid</span>: c &#125;) &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> b = <span class="function"><span class="keyword">function</span>(<span class="params">c</span>) </span>&#123; $.post_withck(<span class="string">"/j/status/unreshare"</span>, &#123; <span class="attr">sid</span>: c &#125;) &#125;;</span><br><span class="line"></span><br><span class="line">    $(<span class="string">"a[data-reshare-id]"</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        b($(<span class="keyword">this</span>).attr(<span class="string">"data-reshare-id"</span>));</span><br><span class="line">        $(<span class="keyword">this</span>).hide()</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $(<span class="string">"div[data-sid]"</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        a($(<span class="keyword">this</span>).attr(<span class="string">"data-sid"</span>));</span><br><span class="line">        $(<span class="keyword">this</span>).hide()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execDelLoop</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> step = <span class="number">0</span>; step &lt; <span class="number">10</span>; step++) &#123;</span><br><span class="line">        location.reload();</span><br><span class="line">        <span class="keyword">var</span> waitDuration = (<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">10</span>) + <span class="number">1</span>) * <span class="number">10000</span>;</span><br><span class="line">        sleepWait(waitDuration);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// finally execute deletion :D</span></span><br><span class="line">execDelLoop();</span><br></pre></td></tr></table></figure><h2 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h2><p>感觉web这边可以做蛮多方便日常生活用的脚本，改天真的要开始学一学才行。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;JS脚本删除豆瓣广播&quot;&gt;&lt;a href=&quot;#JS脚本删除豆瓣广播&quot; class=&quot;headerlink&quot; title=&quot;JS脚本删除豆瓣广播&quot;&gt;&lt;/a&gt;JS脚本删除豆瓣广播&lt;/h1&gt;&lt;p&gt;很久以前为了清理自己SPAM在微博的东西，找过批量删除微博的脚本。现在也想顺
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/categories/JavaScript/"/>
    
    
      <category term="常用" scheme="http://yoursite.com/tags/%E5%B8%B8%E7%94%A8/"/>
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>查询Unity Object在工程中的引用</title>
    <link href="http://yoursite.com/2020/11/21/20201121-find-asset-reference/"/>
    <id>http://yoursite.com/2020/11/21/20201121-find-asset-reference/</id>
    <published>2020-11-21T05:59:08.000Z</published>
    <updated>2020-11-21T07:55:10.685Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上周把bug修得差不多了，这周稍微有点空闲时间了，就把以前想做的一些东西大概看了一下。<br>之前因为清理文件没有及时清除相关引用，结果项目跑起来的时候有各种沙雕报错。只能再一个个物体检查，好麻烦。<br>于是想试试能不能查到某个物体被其它哪些物体引用。</p><h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>好在 Unity提供了这个函数 AssetDatabase.GetDependencies() ,可以获得某个 asset 的依赖项。<br><a href="https://docs.unity3d.com/ScriptReference/AssetDatabase.GetDependencies.html" target="_blank" rel="noopener">AssetDatabase.GetDependencies()</a></p><p>假设我们需要知道物体 A 被哪些其他的物体引用。那就遍历所有物体的依赖项，把依赖项中包含物体 A 的物体筛选出来即可。</p><h1 id="上代码"><a href="#上代码" class="headerlink" title="上代码"></a>上代码</h1><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// to find the reference of the target unity object</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">FindReferencesInProject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">TryFindReferenceOfUobject</span>(<span class="params">UnityEngine.Object uobject</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">bool</span> result = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">string</span> path = AssetDatabase.GetAssetPath(uobject);</span><br><span class="line">        <span class="keyword">if</span> (AssetDatabase.IsValidFolder(path))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// dun do it for a folder :)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FindObjectReference(uobject);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// why the order is like this?</span></span><br><span class="line">    [<span class="meta">MenuItem(<span class="meta-string">"Assets/Find References In Project"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FindSelectedObjectReferences</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != Selection.activeObject)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">string</span> path = AssetDatabase.GetAssetPath(Selection.activeObject);</span><br><span class="line">            <span class="keyword">if</span> (!AssetDatabase.IsValidFolder(path))</span><br><span class="line">            &#123;</span><br><span class="line">                FindObjectReference(Selection.activeObject);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FindObjectReference</span>(<span class="params">UnityEngine.Object uobject</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        System.Diagnostics.Stopwatch stopWatcher = <span class="keyword">new</span> System.Diagnostics.Stopwatch();</span><br><span class="line">        stopWatcher.Start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">string</span> targetPath = AssetDatabase.GetAssetPath(uobject);</span><br><span class="line">        List&lt;<span class="keyword">string</span>&gt; referencesPaths = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">        Dictionary&lt;<span class="keyword">string</span>, List&lt;<span class="keyword">string</span>&gt;&gt; referenceCache = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, List&lt;<span class="keyword">string</span>&gt;&gt;();</span><br><span class="line">        <span class="keyword">string</span>[] assetGuids = AssetDatabase.FindAssets(<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; assetGuids.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">string</span> assetPath = AssetDatabase.GUIDToAssetPath(assetGuids[i]);</span><br><span class="line">            <span class="keyword">string</span>[] dependencies = AssetDatabase.GetDependencies(assetPath, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; dependencies.Length; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (dependencies[j] == targetPath)</span><br><span class="line">                &#123;</span><br><span class="line">                    referencesPaths.Add(assetPath);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FindReferencesInProjectEditor.OpenWindow();</span><br><span class="line">        FindReferencesInProjectEditor window = FindReferencesInProjectEditor.GetWindow();</span><br><span class="line">        window.SetPaths(referencesPaths.ToArray());</span><br><span class="line">        window.SetTargetUobject(uobject);</span><br><span class="line"></span><br><span class="line">        stopWatcher.Stop();</span><br><span class="line">        Debug.Log(<span class="string">$"search references for <span class="subst">&#123;uobject.name&#125;</span> cost <span class="subst">&#123;stopWatcher.ElapsedMilliseconds&#125;</span>ms"</span>);</span><br><span class="line"></span><br><span class="line">        referenceCache.Clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// a simple window to show the result, and also we can ping those result object :D</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FindReferencesInProjectEditor</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Rect m_viewportRect = <span class="keyword">default</span>;</span><br><span class="line">    <span class="keyword">private</span> Rect m_listRect = <span class="keyword">default</span>;</span><br><span class="line">    <span class="keyword">private</span> Rect m_bottomRect = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> m_scrollPosition = <span class="keyword">default</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span>[] m_targetPaths = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">float</span> ELEMENT_HEIGHT = <span class="number">20.0f</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">float</span> ELEMENT_ICON_SIZE = <span class="number">20.0f</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">float</span> SCROLLER_WIDTH = <span class="number">15.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> m_hasGetGUIStyle = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GUIStyle m_scrollerStyle = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> GUIStyle m_buttonElementStyle = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UnityEngine.Object m_selectedUnityObject = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> System.Type m_uobjType = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenWindow</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        FindReferencesInProjectEditor window = GetWindow&lt;FindReferencesInProjectEditor&gt;();</span><br><span class="line">        Texture2D icon = EditorGUIUtility.Load(<span class="string">"icons/UnityEditor.ConsoleWindow.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line">        window.titleContent = <span class="keyword">new</span> GUIContent(<span class="string">"reference find result"</span>, icon);</span><br><span class="line">        Vector2 minSize = <span class="keyword">new</span> Vector2(<span class="number">500.0f</span>, <span class="number">300.0f</span>);</span><br><span class="line">        window.minSize = minSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FindReferencesInProjectEditor <span class="title">GetWindow</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> GetWindow&lt;FindReferencesInProjectEditor&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetPaths</span>(<span class="params"><span class="keyword">in</span> <span class="keyword">string</span>[] paths</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_targetPaths = paths;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetTargetUobject</span>(<span class="params">UnityEngine.Object uobject</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_selectedUnityObject = uobject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawContent</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// only use half space of this shit window</span></span><br><span class="line">        m_viewportRect = <span class="keyword">new</span> Rect(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="keyword">this</span>.position.width - SCROLLER_WIDTH, <span class="keyword">this</span>.position.height * <span class="number">0.8f</span>);</span><br><span class="line">        m_listRect = <span class="keyword">new</span> Rect(<span class="number">0.0f</span>, <span class="number">0.0f</span>, m_viewportRect.width, m_viewportRect.height);</span><br><span class="line">        <span class="keyword">int</span> elementCount = m_targetPaths.Length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (elementCount &lt; <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        GUI.BeginClip(m_listRect); <span class="comment">// to clip the overflow stuff</span></span><br><span class="line">        <span class="keyword">int</span> indexOffset = Mathf.FloorToInt(m_scrollPosition / ELEMENT_HEIGHT);</span><br><span class="line">        <span class="keyword">int</span> showCount = Mathf.CeilToInt(m_listRect.height / ELEMENT_HEIGHT);</span><br><span class="line">        showCount = showCount &gt; elementCount ? elementCount : showCount;</span><br><span class="line">        <span class="keyword">float</span> startPosY = (indexOffset * ELEMENT_HEIGHT) - m_scrollPosition;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; showCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Rect elementRect = <span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span> + startPosY + i * ELEMENT_HEIGHT, m_listRect.width, ELEMENT_HEIGHT);</span><br><span class="line">            DrawElement(elementRect, indexOffset + i);</span><br><span class="line">        &#125;</span><br><span class="line">        GUI.EndClip();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawElement</span>(<span class="params">Rect elementRect, <span class="keyword">int</span> dataIndex</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dataIndex &lt; m_targetPaths.Length &amp;&amp; GUI.Button(elementRect, <span class="string">$"path <span class="subst">&#123;m_targetPaths[dataIndex]&#125;</span> ;"</span>, m_buttonElementStyle))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$"<span class="subst">&#123;m_targetPaths[dataIndex]&#125;</span>"</span>);</span><br><span class="line">            UnityEngine.Object targetObj = AssetDatabase.LoadAssetAtPath&lt;UnityEngine.Object&gt;(m_targetPaths[dataIndex]);</span><br><span class="line">            EditorGUIUtility.PingObject(targetObj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawScroller</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// draw scroller on the right correctly</span></span><br><span class="line">        <span class="keyword">int</span> elementCount = m_targetPaths.Length;</span><br><span class="line">        <span class="keyword">float</span> fullElementHeight = elementCount * ELEMENT_HEIGHT;</span><br><span class="line"></span><br><span class="line">        Rect scrollbarRect = <span class="keyword">new</span> Rect(m_viewportRect.x + m_viewportRect.width, m_viewportRect.y, SCROLLER_WIDTH, m_viewportRect.height);</span><br><span class="line">        m_scrollPosition = Mathf.Max(<span class="number">0</span>, GUI.VerticalScrollbar(scrollbarRect, m_scrollPosition, m_listRect.height, <span class="number">0</span>, Mathf.Max(fullElementHeight, m_listRect.height)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> controlId = GUIUtility.GetControlID(FocusType.Passive);</span><br><span class="line">        <span class="keyword">float</span> scrollSensitivity = ELEMENT_HEIGHT;</span><br><span class="line">        <span class="keyword">float</span> maxScrollPos = (fullElementHeight &gt; m_listRect.height) ? (fullElementHeight - m_listRect.height) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (EventType.ScrollWheel == Event.current.GetTypeForControl(controlId))</span><br><span class="line">        &#123;</span><br><span class="line">            m_scrollPosition = Mathf.Clamp(m_scrollPosition + Event.current.delta.y * scrollSensitivity, <span class="number">0</span>, maxScrollPos);</span><br><span class="line">            Event.current.Use();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">GetGUIStyle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// scroller</span></span><br><span class="line">        m_scrollerStyle = <span class="keyword">new</span> GUIStyle(GUI.skin.verticalScrollbar);</span><br><span class="line">        m_scrollerStyle.stretchWidth = <span class="literal">false</span>;</span><br><span class="line">        m_scrollerStyle.fixedWidth = SCROLLER_WIDTH;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// button element</span></span><br><span class="line">        m_buttonElementStyle = <span class="keyword">new</span> GUIStyle(GUI.skin.button);</span><br><span class="line">        m_buttonElementStyle.alignment = TextAnchor.MiddleLeft;</span><br><span class="line"></span><br><span class="line">        m_uobjType = <span class="keyword">typeof</span>(UnityEngine.Object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawBottom</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_bottomRect = <span class="keyword">new</span> Rect(<span class="number">0.0f</span>, <span class="keyword">this</span>.position.height * <span class="number">0.8f</span>, <span class="keyword">this</span>.position.width, <span class="keyword">this</span>.position.height * <span class="number">0.2f</span>);</span><br><span class="line">        Rect fieldRect = <span class="keyword">new</span> Rect(<span class="number">10.0f</span>, m_bottomRect.y + <span class="number">10.0f</span>, <span class="number">100.0f</span>, <span class="number">20.0f</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_uobjType)</span><br><span class="line">            m_uobjType = <span class="keyword">typeof</span>(UnityEngine.Object);</span><br><span class="line"></span><br><span class="line">        m_selectedUnityObject = EditorGUI.ObjectField(fieldRect, m_selectedUnityObject, m_uobjType, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        Rect buttonRect = <span class="keyword">new</span> Rect(<span class="number">150.0f</span>, m_bottomRect.y, <span class="number">200.0f</span>, <span class="number">40.0f</span>);</span><br><span class="line">        <span class="keyword">if</span> (GUI.Button(buttonRect, <span class="string">"try find reference"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            FindObjectReference();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">FindObjectReference</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_selectedUnityObject)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Clear();</span><br><span class="line">        FindReferencesInProject.TryFindReferenceOfUobject(m_selectedUnityObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Clear</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_targetPaths = System.Array.Empty&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!m_hasGetGUIStyle)</span><br><span class="line">        &#123;</span><br><span class="line">            GetGUIStyle();</span><br><span class="line">            m_hasGetGUIStyle = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DrawContent();</span><br><span class="line">        DrawScroller();</span><br><span class="line">        DrawBottom();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2020/11/21/20201121-find-asset-reference/20201121-pic001.png" class="" title="split"><img src="/2020/11/21/20201121-find-asset-reference/20201121-pic002.png" class="" title="split"><p>搜索结果我选择使用一个简单的 editor window 来显示。<br>同时还能填入新的目标物体再做一次搜索。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>最近都没有做编辑器这边的开发，感觉直接退回了起点。感觉Unity编辑器的文档没有想象中那么详细，很多时候反而没有问同事来得方便。可能该提高自己的英文水平了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;上周把bug修得差不多了，这周稍微有点空闲时间了，就把以前想做的一些东西大概看了一下。&lt;br&gt;之前因为清理文件没有及时清除相关引用，结果项目
      
    
    </summary>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/categories/UnityEditor/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="unityEditor" scheme="http://yoursite.com/tags/unityEditor/"/>
    
  </entry>
  
  <entry>
    <title>Unity OnAudioFilterRead 学习笔记</title>
    <link href="http://yoursite.com/2020/10/17/20201017-unity-onaudiofilterread/"/>
    <id>http://yoursite.com/2020/10/17/20201017-unity-onaudiofilterread/</id>
    <published>2020-10-17T11:03:52.000Z</published>
    <updated>2020-10-18T09:32:34.698Z</updated>
    
    <content type="html"><![CDATA[<p>最近想着做一个音乐游戏的DEMO试试，但是毫无头绪不知道怎么开始。看了下邦邦的视频决定先把节拍器做出来，再用节拍器提供的事件去支撑起其它的部分。</p><p>因为完全没做过音乐游戏，而且也对游戏引擎以及声音方面没有什么了解，所以开始在网上海搜节拍器的代码并拿来测试。</p><p>最后得到俩解决方案：1.在Unity里写一个；2.使用专业的音频插件（如CRIWARE或者WWISE），使用里面的节拍器。<br>因为只是尝试做做DEMO，决定先不引入音频插件了。</p><p>在冲浪查询的时候发现Unity的官方文档中已经写好了一个！真是太棒了，马上嫖过来用。为了方便之后使用，我也决定把这份代码尽可能看懂。</p><p>下面是Unity的源码<br><a href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.OnAudioFilterRead.html" target="_blank" rel="noopener">MonoBehaviour.OnAudioFilterRead(float[], int)</a><br><a href="https://docs.unity3d.com/ScriptReference/AudioSettings-dspTime.html" target="_blank" rel="noopener">AudioSettings.dspTime</a></p><h1 id="提取基本代码"><a href="#提取基本代码" class="headerlink" title="提取基本代码"></a>提取基本代码</h1><p>首先我大概跑了一下，看了一下，提取出了我认为是节拍器最基本的部分。</p><p>signatureHi / signatureLo =&gt; 这个就是我们所说的几几拍。<br>signatureHi是每小节的拍子数，signatureLo是指x分音符为1拍。accent是指当前小结内的拍子数。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[<span class="meta">RequireComponent(typeof(AudioSource))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MetronomeExample</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">double</span> bpm = <span class="number">128.0f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> signatureHi = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> signatureLo = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> nextTick = <span class="number">0.0F</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> sampleRate = <span class="number">0.0F</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> accent= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> running = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> System.Action&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; OnBeatTick;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        accent = signatureHi;</span><br><span class="line">        sampleRate = AudioSettings.outputSampleRate;</span><br><span class="line">        nextTick = AudioSettings.dspTime * sampleRate;</span><br><span class="line">        running = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnAudioFilterRead</span>(<span class="params"><span class="keyword">float</span>[] data, <span class="keyword">int</span> channels</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!running)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">double</span> samplesPerTick = sampleRate * (<span class="number">60.0f</span> / bpm) * (<span class="number">4.0f</span> / signatureLo);</span><br><span class="line">        <span class="keyword">double</span> sample = AudioSettings.dspTime * sampleRate;</span><br><span class="line">        <span class="keyword">int</span> dataLen = data.Length / channels;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (n &lt; dataLen)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (sample + n &gt;= nextTick)</span><br><span class="line">            &#123;</span><br><span class="line">                nextTick += samplesPerTick;</span><br><span class="line">                <span class="keyword">if</span> (++accent &gt; signatureHi)</span><br><span class="line">                &#123;</span><br><span class="line">                    accent = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                OnBeatTick?.Invoke(accent, signatureHi);</span><br><span class="line">                Debug.Log(<span class="string">$"Tick: <span class="subst">&#123;accent&#125;</span> / <span class="subst">&#123;signatureHi&#125;</span>"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            n++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">nextTick = AudioSettings.dspTime * sampleRate; </span><br><span class="line">``` </span><br><span class="line">从 Start() 开始，先做节拍器的初始化。 因为需要准确的音频数据，所以我们会使用音频相关的函数来操作，而不是使用 Update()。</span><br><span class="line">通过当前的时间 * 当前的采样率，大概就能得到当前的音频信息总量。</span><br><span class="line"></span><br><span class="line">``` CSharp</span><br><span class="line">OnAudioFilterRead(<span class="keyword">float</span>[] data, <span class="keyword">int</span> channels)</span><br><span class="line">``` </span><br><span class="line">接着我们可以把 OnAudioFilterRead() 看作 Update() 来使用。 </span><br><span class="line">channels 大概是声道数,比如我平时用的辣鸡机器是双声道（左右的），那么 channels 的值就是<span class="number">2</span>。</span><br><span class="line">data[] 中存储的是当前这一次遍历的音频数据，也会包含不同声道的音频信息，比如\[<span class="number">0L</span>, <span class="number">1</span>R, <span class="number">2L</span>, <span class="number">3</span>R....\]之类的。</span><br><span class="line"></span><br><span class="line">``` CSharp</span><br><span class="line"><span class="keyword">double</span> samplesPerTick = sampleRate * (<span class="number">60.0f</span> / bpm) * (<span class="number">4.0f</span> / signatureLo);</span><br><span class="line"><span class="keyword">double</span> sample = AudioSettings.dspTime * sampleRate;</span><br><span class="line">``` </span><br><span class="line">这里是用与计算拍子的间隔时间。(<span class="number">60.0f</span> / bpm) 所计算的是对于 <span class="number">4</span>/<span class="number">4</span> 拍而言的拍子间隔时间。</span><br><span class="line">而 (<span class="number">4.0f</span> / signatureLo) 可以算出一个参数，并乘给 <span class="number">4</span>/<span class="number">4</span> 拍而言的拍子间隔时间。</span><br><span class="line">sample 可以粗浅的认为是当前的时间。</span><br><span class="line"></span><br><span class="line">``` CSharp</span><br><span class="line"><span class="keyword">while</span> (n &lt; dataLen)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (sample + n &gt;= nextTick)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 用起来就相当于</span></span><br><span class="line">        <span class="comment">// nextTime = Time.time * timeInterval; </span></span><br><span class="line">        nextTick += samplesPerTick;</span><br><span class="line">        <span class="keyword">if</span> (++accent &gt; signatureHi)</span><br><span class="line">        &#123;</span><br><span class="line">            accent = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        OnBeatTick?.Invoke(accent, signatureHi);</span><br><span class="line">        Debug.Log(<span class="string">$"Tick: <span class="subst">&#123;accent&#125;</span> / <span class="subst">&#123;signatureHi&#125;</span>"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    n++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这边遍历一下接下来会播放的音频数据。根据数据的长度来判断是否会需要发出节拍器的 tick。</p><h1 id="节拍器音效"><a href="#节拍器音效" class="headerlink" title="节拍器音效"></a>节拍器音效</h1><p>在官方源码中还用到了一些其他的变量，并给data赋值，其实这些就是为了播放节拍器音效而存在的。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">while</span> (n&lt;dataLen)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">float</span> x = gain * amp * Mathf.Sin(phase);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; channels)</span><br><span class="line">    &#123;</span><br><span class="line">        data[n * channels + i] += x;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (sample + n &gt;= nextTick)</span><br><span class="line">    &#123;</span><br><span class="line">        nextTick += samplesPerTick;</span><br><span class="line">        amp = <span class="number">1.0F</span>;</span><br><span class="line">        <span class="keyword">if</span> (++accent &gt; signatureHi)</span><br><span class="line">        &#123;</span><br><span class="line">            accent = <span class="number">1</span>;</span><br><span class="line">            amp *= <span class="number">2.0F</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        OnBeatTick?.Invoke(accent, signatureHi);</span><br><span class="line">        Debug.Log(<span class="string">$"Tick: <span class="subst">&#123;accent&#125;</span> / <span class="subst">&#123;signatureHi&#125;</span>"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    phase += amp* <span class="number">0.3F</span>;</span><br><span class="line">    amp *= <span class="number">0.993F</span>;</span><br><span class="line">    n++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="摸了"><a href="#摸了" class="headerlink" title="摸了"></a>摸了</h1><p>感觉自己的知识面又窄又浅，还是需要多看书才行。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近想着做一个音乐游戏的DEMO试试，但是毫无头绪不知道怎么开始。看了下邦邦的视频决定先把节拍器做出来，再用节拍器提供的事件去支撑起其它的部分。&lt;/p&gt;
&lt;p&gt;因为完全没做过音乐游戏，而且也对游戏引擎以及声音方面没有什么了解，所以开始在网上海搜节拍器的代码并拿来测试。&lt;/p
      
    
    </summary>
    
    
      <category term="Unity" scheme="http://yoursite.com/categories/Unity/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="Audio" scheme="http://yoursite.com/tags/Audio/"/>
    
  </entry>
  
  <entry>
    <title>Unity UGUI ScrollRect 学习笔记 (1)</title>
    <link href="http://yoursite.com/2020/08/23/20200823-UGUI-ScrollRect-Learn-01/"/>
    <id>http://yoursite.com/2020/08/23/20200823-UGUI-ScrollRect-Learn-01/</id>
    <published>2020-08-23T07:43:16.000Z</published>
    <updated>2021-01-31T03:09:28.921Z</updated>
    
    <content type="html"><![CDATA[<p>入夏以后非常热，我房间里的空调闲置很久没清理，也一直不敢开，所以周末基本都毫无生产力，只能躺尸。<br>这段时间在公司里基本都是给UI朋友们做事，而且估计以后会更多的接触这方面的东西，决定开始学习一下UGUI了，为了以后能做出可靠复用性能友好的UI。</p><p>Unity UGUI的几乎所有c#代码都是开源的，在github上能够获取到，之前的BitBucket仓库已经关闭了。<br><a href="https://github.com/Unity-Technologies/uGUI/tree/2018.4" target="_blank" rel="noopener">unity UGUI source code</a></p><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>ScrollRect是个大家都很熟悉又很方便的组件，这个组件在任何时期都可能会引发性能问题。我们会有许多物品需要显示，在滑动的时候会卡，同时我们为了显示许多的物品会创建很多UI物体，这些物体也在吃内存。</p><p>之前在Editor中做了类似的功能，现在打算在UGUI上也实现。为了创建自己的ScrollRect我下载了UGUI ScrollRect的源码，但是发现我太菜了看不懂。UGUI的使用情景其实比Editor GUI要复杂。<br>一口吃不成胖子，那就多吃几口，我决定慢慢来，一步步写完这个组件。</p><p><a href="https://2c2c2c.github.io/2020/06/26/20200626-unity-editor-scrollview-pagination/" target="_blank" rel="noopener">UnityEditor Scrollview</a></p><h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>UI显示的逻辑依旧套用上次的那做法，但是这次我们没法简单处理用户的输入了。所以我依靠原始的ScrollRect代码来处理输入，再计算出我需要的结果。<br>因为我无法读懂ScrollRect的代码，所以需要另外写一个脚本来控制UI的显示。</p><img src="/2020/08/23/20200823-UGUI-ScrollRect-Learn-01/20200823-scrollrect02.png" class="" title="split"><img src="/2020/08/23/20200823-UGUI-ScrollRect-Learn-01/20200823-scrollrect03.png" class="" title="split"><p>其中，DragContent是用来接受用户拖拽的，不用于管理UI物体，所以直接暂时让其撑满整个Viewport。RealContent是用于管理UI物体的，其大小和 DragContent一样大就好，因为我不打算移动这个物体。</p><p>我这次也是直接重新排列所有有可能会参与显示的UI物体的位置，为了防止快速拖拽的时候穿帮，我们大概需要这么多UI物体 (能在视口内现实的UI数量)+2。当然，我还不会处理滑条的事件，所以现在滑条先由第二个脚本进行管理。</p><h1 id="上代码"><a href="#上代码" class="headerlink" title="上代码"></a>上代码</h1><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TempScrollRect</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Hiko shit</span></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> ScrollRectEvent m_OnValueChangedDelta = <span class="keyword">new</span> ScrollRectEvent(); <span class="comment">// value delta</span></span><br><span class="line">    <span class="keyword">public</span> ScrollRectEvent onValueChangedDelta &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_OnValueChangedDelta; &#125; <span class="keyword">set</span> &#123; m_OnValueChangedDelta = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .................</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Hiko shit</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnScroll</span>(<span class="params">PointerEventData data</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!IsActive())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        EnsureLayoutHasRebuilt();</span><br><span class="line">        UpdateBounds();</span><br><span class="line"></span><br><span class="line">        Vector2 delta = data.scrollDelta;</span><br><span class="line">        <span class="comment">// Down is positive for scroll events, while in UI system up is positive.</span></span><br><span class="line">        delta.y *= <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (vertical &amp;&amp; !horizontal)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Mathf.Abs(delta.x) &gt; Mathf.Abs(delta.y))</span><br><span class="line">                delta.y = delta.x;</span><br><span class="line">            delta.x = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (horizontal &amp;&amp; !vertical)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Mathf.Abs(delta.y) &gt; Mathf.Abs(delta.x))</span><br><span class="line">                delta.x = delta.y;</span><br><span class="line">            delta.y = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO @Hiko should also do stuff for elastic move</span></span><br><span class="line">        m_OnValueChangedDelta?.Invoke(delta * m_ScrollSensitivity * m_ViewRect.rect.height * <span class="number">0.1f</span>);</span><br><span class="line">        <span class="comment">//Debug.Log($"get on scroll data &#123;delta&#125;");</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Vector2 position = m_DragContent.anchoredPosition;</span></span><br><span class="line">        <span class="comment">//position += delta * m_ScrollSensitivity;</span></span><br><span class="line">        <span class="comment">//if (m_MovementType == MovementType.Clamped)</span></span><br><span class="line">        <span class="comment">//position += CalculateOffset(position - m_DragContent.anchoredPosition);</span></span><br><span class="line">        <span class="comment">//SetContentAnchoredPosition(position);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// in fact I dun know how to update bounds correctly yet</span></span><br><span class="line"></span><br><span class="line">        UpdateBounds();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Hiko shit</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnBeginDrag</span>(<span class="params">PointerEventData eventData</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (eventData.button != PointerEventData.InputButton.Left)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!IsActive())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        UpdateBounds();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// @Hiko shit</span></span><br><span class="line">        m_PointerStartLocalCursor = Vector2.zero;</span><br><span class="line">        RectTransformUtility.ScreenPointToLocalPointInRectangle(viewRect, eventData.position, eventData.pressEventCamera, <span class="keyword">out</span> m_PointerStartLocalCursor);</span><br><span class="line">        <span class="comment">//m_ContentStartPosition = m_DragContent.anchoredPosition;</span></span><br><span class="line">        m_Dragging = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnEndDrag</span>(<span class="params">PointerEventData eventData</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (eventData.button != PointerEventData.InputButton.Left)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// @Hiko shit</span></span><br><span class="line">        m_Dragging = <span class="literal">false</span>;</span><br><span class="line">        m_pointerPos = Vector2.zero;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Hiko shit</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector2 m_pointerPos = <span class="keyword">default</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnDrag</span>(<span class="params">PointerEventData eventData</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (eventData.button != PointerEventData.InputButton.Left)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!IsActive())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        Vector2 localCursor;</span><br><span class="line">        <span class="keyword">if</span> (!RectTransformUtility.ScreenPointToLocalPointInRectangle(viewRect, eventData.position, eventData.pressEventCamera, <span class="keyword">out</span> localCursor))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        UpdateBounds();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// it's delta from current point to the first start point</span></span><br><span class="line">        Vector2 pointerDelta = localCursor - m_PointerStartLocalCursor;</span><br><span class="line">        Vector2 currentDelta = pointerDelta - m_pointerPos;</span><br><span class="line">        m_pointerPos = pointerDelta;</span><br><span class="line">        <span class="comment">//Debug.Log($"check pointer delta &#123;currentDelta&#125;");</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO @Hiko</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span> || MovementType.Clamped == m_MovementType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// no speed move for it</span></span><br><span class="line">            m_OnValueChangedDelta.Invoke(currentDelta * m_ScrollSensitivity);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            FakeMoveContent();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// do it properly, for the drag content</span></span><br><span class="line">        <span class="comment">// Offset to get content into place in the view.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Vector2 offset = CalculateOffset(position - m_DragContent.anchoredPosition);</span></span><br><span class="line">        <span class="comment">//position += offset;</span></span><br><span class="line">        <span class="comment">//if (m_MovementType == MovementType.Elastic)</span></span><br><span class="line">        <span class="comment">//&#123;</span></span><br><span class="line">        <span class="comment">//    if (offset.x != 0)</span></span><br><span class="line">        <span class="comment">//        position.x = position.x - RubberDelta(offset.x, m_ViewBounds.size.x);</span></span><br><span class="line">        <span class="comment">//    if (offset.y != 0)</span></span><br><span class="line">        <span class="comment">//        position.y = position.y - RubberDelta(offset.y, m_ViewBounds.size.y);</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//SetContentAnchoredPosition(position);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Hiko shit</span></span><br><span class="line">    <span class="keyword">private</span> Vector2 m_contentMoveSpeed = <span class="keyword">default</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">FakeMoveContent</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// this is for elastic to move, maybe later</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Hiko shit</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetContentAnchoredPosition</span>(<span class="params">Vector2 position</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// disble it for now cuz I dun move content object</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!m_Horizontal)</span><br><span class="line">            position.x = m_DragContent.anchoredPosition.x;</span><br><span class="line">        <span class="keyword">if</span> (!m_Vertical)</span><br><span class="line">            position.y = m_DragContent.anchoredPosition.y;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (position != m_DragContent.anchoredPosition)</span><br><span class="line">        &#123;</span><br><span class="line">            m_DragContent.anchoredPosition = position;</span><br><span class="line">            UpdateBounds();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Hiko shit</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">LateUpdate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!m_DragContent)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        EnsureLayoutHasRebuilt();</span><br><span class="line"></span><br><span class="line">        UpdateScrollbarVisibility();</span><br><span class="line"></span><br><span class="line">        UpdateBounds();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> deltaTime = Time.unscaledDeltaTime;</span><br><span class="line">        Vector2 offset = CalculateOffset(Vector2.zero);</span><br><span class="line">        <span class="keyword">if</span> (!m_Dragging &amp;&amp; (offset != Vector2.zero || m_Velocity != Vector2.zero))</span><br><span class="line">        &#123;</span><br><span class="line">            Vector2 position = m_DragContent.anchoredPosition;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> axis = <span class="number">0</span>; axis &lt; <span class="number">2</span>; axis++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Apply spring physics if movement is elastic and content has an offset from the view.</span></span><br><span class="line">                <span class="keyword">if</span> (m_MovementType == MovementType.Elastic &amp;&amp; offset[axis] != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">float</span> speed = m_Velocity[axis];</span><br><span class="line">                    position[axis] = Mathf.SmoothDamp(m_DragContent.anchoredPosition[axis], m_DragContent.anchoredPosition[axis] + offset[axis], <span class="keyword">ref</span> speed, m_Elasticity, Mathf.Infinity, deltaTime);</span><br><span class="line">                    m_Velocity[axis] = speed;</span><br><span class="line">                    <span class="comment">// @Hiko </span></span><br><span class="line">                    <span class="comment">//if (Mathf. Abs(speed) &lt; 1)</span></span><br><span class="line">                    <span class="comment">//    speed = 0; </span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Else move content according to velocity with deceleration applied.</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (m_Inertia)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_Velocity[axis] *= Mathf.Pow(m_DecelerationRate, deltaTime);</span><br><span class="line">                    <span class="keyword">if</span> (Mathf.Abs(m_Velocity[axis]) &lt; <span class="number">1</span>)</span><br><span class="line">                        m_Velocity[axis] = <span class="number">0</span>;</span><br><span class="line">                    position[axis] += m_Velocity[axis] * deltaTime;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// If we have neither elaticity or friction, there shouldn't be any velocity.</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    m_Velocity[axis] = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (m_Velocity != Vector2.zero)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_MovementType == MovementType.Clamped)</span><br><span class="line">                &#123;</span><br><span class="line">                    offset = CalculateOffset(position - m_DragContent.anchoredPosition);</span><br><span class="line">                    position += offset;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                SetContentAnchoredPosition(position);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_Dragging &amp;&amp; m_Inertia)</span><br><span class="line">        &#123;</span><br><span class="line">            Vector3 newVelocity = (m_DragContent.anchoredPosition - m_PrevPosition) / deltaTime;</span><br><span class="line">            m_Velocity = Vector3.Lerp(m_Velocity, newVelocity, deltaTime * <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_ViewBounds != m_PrevViewBounds || m_ContentBounds != m_PrevContentBounds || m_DragContent.anchoredPosition != m_PrevPosition)</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateScrollbars(offset);</span><br><span class="line">            UISystemProfilerApi.AddMarker(<span class="string">"ScrollRect.value"</span>, <span class="keyword">this</span>);</span><br><span class="line">            m_OnValueChanged.Invoke(normalizedPosition);</span><br><span class="line">            UpdatePrevData();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Hiko shitZ</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateScrollbars</span>(<span class="params">Vector2 offset</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_HorizontalScrollbar)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_ContentBounds.size.x &gt; <span class="number">0</span>)</span><br><span class="line">                m_HorizontalScrollbar.size = Mathf.Clamp01((m_ViewBounds.size.x - Mathf.Abs(offset.x)) / m_ContentBounds.size.x);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                m_HorizontalScrollbar.size = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            m_HorizontalScrollbar.<span class="keyword">value</span> = horizontalNormalizedPosition;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO @Hiko use real data content len for scrollbar</span></span><br><span class="line">        <span class="keyword">if</span> (m_VerticalScrollbar)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_ContentBounds.size.y &gt; <span class="number">0</span>)</span><br><span class="line">                m_VerticalScrollbar.size = Mathf.Clamp01((m_ViewBounds.size.y - Mathf.Abs(offset.y)) / m_ContentBounds.size.y);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                m_VerticalScrollbar.size = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            m_VerticalScrollbar.<span class="keyword">value</span> = verticalNormalizedPosition;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Hiko shit</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetNormalizedPosition</span>(<span class="params"><span class="keyword">float</span> <span class="keyword">value</span>, <span class="keyword">int</span> axis</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// TODO @Hiko set scroll by real content height</span></span><br><span class="line"></span><br><span class="line">        EnsureLayoutHasRebuilt();</span><br><span class="line"></span><br><span class="line">        UpdateBounds();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// How much the content is larger than the view.</span></span><br><span class="line">        <span class="keyword">float</span> hiddenLength = m_ContentBounds.size[axis] - m_ViewBounds.size[axis];</span><br><span class="line">        <span class="comment">// Where the position of the lower left corner of the content bounds should be, in the space of the view.</span></span><br><span class="line">        <span class="keyword">float</span> contentBoundsMinPosition = m_ViewBounds.min[axis] - <span class="keyword">value</span> * hiddenLength;</span><br><span class="line">        <span class="comment">// The new content localPosition, in the space of the view.</span></span><br><span class="line">        <span class="keyword">float</span> newLocalPosition = m_DragContent.localPosition[axis] + contentBoundsMinPosition - m_ContentBounds.min[axis];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// change this cuz we dun use content for this</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Vector3 localPosition = m_Content.localPosition;</span></span><br><span class="line">        <span class="comment">// if (Mathf.Abs(localPosition[axis] - newLocalPosition) &gt; 0.01f)</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     localPosition[axis] = newLocalPosition;</span></span><br><span class="line">        <span class="comment">//     m_Content.localPosition = localPosition;</span></span><br><span class="line">        <span class="comment">//     m_Velocity[axis] = 0;</span></span><br><span class="line">        <span class="comment">//     UpdateBounds();</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这边我只修改了几个个简单的函数，原本这个函数是用来调整Content位置的，我在这边把位置的更改值接收到并通过事件发送出去。<br>同时，我们也在拖拽相关的函数中应用新的逻辑，获取每次拖拽的更改差值，方便计算。</p><p>代码很乱，之后会直接更新全部代码。<br>然后我们编写另外一个用于显示UI内容的简单控制器</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[<span class="meta">RequireComponent(typeof(TempScrollRect))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TempScrollGridController</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> TempScrollRect m_scrollRect = <span class="literal">null</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> Scrollbar m_verticalScrollBar = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">private</span> RectTransform m_scrollRectTransfrom = <span class="literal">null</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> RectTransform m_viewport = <span class="literal">null</span>;</span><br><span class="line">        [<span class="meta">SerializeField</span>]</span><br><span class="line">        <span class="keyword">private</span> RectTransform m_realContent = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> m_viewItemCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_isVertical = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> m_startIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> CACHE_COUNT = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Vector2 m_itemSize = Vector2.zero;</span><br><span class="line">        <span class="keyword">private</span> Vector2 m_itemStartPos = <span class="keyword">default</span>; <span class="comment">// the showing first item start pos in virwport</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_hasInited = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        List&lt;TempGridItem&gt; m_fakeItems = <span class="literal">null</span>;</span><br><span class="line">        IReadOnlyList&lt;TempDataItem&gt; m_dataList = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> test shit</span></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"test shit"</span>)</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> TempGridItem m_itemPrefab = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">ContextMenu(<span class="meta-string">"funs"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TestSet</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_scrollRect.normalizedPosition = Vector2.right;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InjectData</span>(<span class="params">IReadOnlyList&lt;TempDataItem&gt; dataList</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_dataList = dataList;</span><br><span class="line">            <span class="comment">// time to spawn shit</span></span><br><span class="line"></span><br><span class="line">            m_startIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// set default simple draw stuff</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_fakeItems.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                m_fakeItems[i].gameObject.SetActive(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">if</span> (i &lt; dataList.Count)</span><br><span class="line">                    m_fakeItems[i].Setup(dataList[i].TempName);</span><br><span class="line">                Vector3 pos = m_fakeItems[i].ItemRectTransform.anchoredPosition3D;</span><br><span class="line">                pos -= i * m_fakeItems[i].ItemRectTransform.up * m_itemSize.y;</span><br><span class="line">                m_fakeItems[i].ItemRectTransform.anchoredPosition = pos;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_verticalScrollBar)</span><br><span class="line">            &#123;</span><br><span class="line">                m_verticalScrollBar.<span class="keyword">value</span> = <span class="number">0.0f</span>;</span><br><span class="line">                m_verticalScrollBar.size = <span class="number">1.0f</span> / m_dataList.Count;</span><br><span class="line">            &#125;</span><br><span class="line">            m_itemStartPos.y = <span class="number">1.0f</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitController</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_hasInited = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDeltaPosition</span>(<span class="params">Vector2 deltaPos</span>) <span class="comment">// 0 ~ 1 for</span></span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// test vertical</span></span><br><span class="line">            deltaPos.x = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// maybe cache these 2 cuz we dun wanna cal the everytime :)</span></span><br><span class="line">            <span class="keyword">float</span> contentHeight = m_dataList.Count * m_itemSize.y;</span><br><span class="line">            <span class="keyword">float</span> maxStartPosY = contentHeight - m_viewport.rect.height;</span><br><span class="line"></span><br><span class="line">            Vector2 nextTopPos = m_itemStartPos + deltaPos;</span><br><span class="line">            nextTopPos.y = Mathf.Clamp(nextTopPos.y, <span class="number">0.0f</span>, maxStartPosY);</span><br><span class="line">            m_itemStartPos = nextTopPos;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_verticalScrollBar)</span><br><span class="line">                m_verticalScrollBar.SetValueWithoutNotify(m_itemStartPos.y / maxStartPosY);</span><br><span class="line">            <span class="comment">// Debug.Log($"content height &#123;contentHeight&#125;; max pos &#123;maxStartPos&#125;; next pos&#123;m_itemStartPos&#125;");</span></span><br><span class="line">            RefreshUIItem();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnScrollBarValueChanged</span>(<span class="params"><span class="keyword">float</span> nextValue</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">float</span> maxStartPosY = m_dataList.Count * m_itemSize.y - m_viewport.rect.height;</span><br><span class="line">            <span class="keyword">float</span> prevValue = m_itemStartPos.y / maxStartPosY;</span><br><span class="line">            <span class="keyword">float</span> deltaValue = nextValue - prevValue;</span><br><span class="line">            Vector2 deltaPos = <span class="keyword">new</span> Vector2(<span class="number">0.0f</span>, maxStartPosY * deltaValue);</span><br><span class="line"></span><br><span class="line">            Vector2 nextTopPos = m_itemStartPos + deltaPos;</span><br><span class="line">            nextTopPos.y = Mathf.Clamp(nextTopPos.y, <span class="number">0.0f</span>, maxStartPosY);</span><br><span class="line">            m_itemStartPos = nextTopPos;</span><br><span class="line"></span><br><span class="line">            RefreshUIItem();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RefreshUIItem</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Vector2 pos = m_itemStartPos;</span><br><span class="line">            pos.y = m_itemStartPos.y % m_itemSize.y;</span><br><span class="line">            m_startIndex = (<span class="keyword">int</span>)Mathf.FloorToInt(m_itemStartPos.y / m_itemSize.y);</span><br><span class="line">            <span class="comment">// Debug.Log($"check draw offset &#123;pos&#125;");</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_viewItemCount + <span class="number">1</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (i + m_startIndex &lt; m_dataList.Count)</span><br><span class="line">                    m_fakeItems[i].Setup(m_dataList[i + m_startIndex].TempName);</span><br><span class="line">                m_fakeItems[i].ItemRectTransform.anchoredPosition = pos - (i * Vector2.up * m_itemSize.y);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> mono method</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_scrollRect.GetComponent&lt;ScrollRect&gt;();</span><br><span class="line">            m_scrollRectTransfrom = m_scrollRect.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            m_realContent = m_scrollRect.dragContent;</span><br><span class="line">            m_isVertical = m_scrollRect.vertical;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_fakeItems = <span class="keyword">new</span> List&lt;TempGridItem&gt;();</span><br><span class="line">            DestroyAllChildren(m_realContent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_scrollRect.onValueChangedDelta.AddListener(OnDeltaPosition);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_verticalScrollBar)</span><br><span class="line">                m_verticalScrollBar.onValueChanged.AddListener(OnScrollBarValueChanged);</span><br><span class="line">            <span class="comment">// get some fake stuff to test</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> tempShit = Instantiate(m_itemPrefab, m_realContent);</span><br><span class="line">            m_itemSize = tempShit.ItemSize;</span><br><span class="line">            <span class="comment">// set it height of content</span></span><br><span class="line">            <span class="keyword">float</span> tempHeight = Mathf.Abs(m_viewport.rect.y * m_viewport.localScale.y);</span><br><span class="line">            m_viewItemCount = (<span class="keyword">int</span>)(tempHeight / m_itemSize.y);</span><br><span class="line">            Debug.Log(<span class="string">$"test viewport item count <span class="subst">&#123;m_viewItemCount&#125;</span>"</span>);</span><br><span class="line">            <span class="keyword">if</span> (tempHeight % m_itemSize.y &gt; <span class="number">0</span>)</span><br><span class="line">                m_viewItemCount++;</span><br><span class="line"></span><br><span class="line">            Vector2 size = m_realContent.sizeDelta;</span><br><span class="line">            size.y = m_itemSize.y * (m_viewItemCount + CACHE_COUNT);</span><br><span class="line">            m_realContent.sizeDelta = size;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> spawnCount = m_viewItemCount + CACHE_COUNT;</span><br><span class="line">            m_fakeItems.Add(tempShit);</span><br><span class="line">            tempShit.gameObject.SetActive(<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; spawnCount; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                tempShit = Instantiate(m_itemPrefab, m_realContent);</span><br><span class="line">                m_fakeItems.Add(tempShit);</span><br><span class="line">                tempShit.gameObject.SetActive(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDisable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_scrollRect.onValueChangedDelta.RemoveListener(OnDeltaPosition);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_verticalScrollBar)</span><br><span class="line">                m_verticalScrollBar.onValueChanged.RemoveListener(OnScrollBarValueChanged);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// wat should I do here</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DestroyAllChildren</span>(<span class="params">Transform target</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == target)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> childCount = target.childCount;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                Destroy(target.GetChild(i).gameObject);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TempGridItem</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> RectTransform m_rectTransform = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> RectTransform ItemRectTransform =&gt; m_rectTransform;</span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> Text m_label = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector2 m_itemSize = <span class="keyword">default</span>;</span><br><span class="line">    <span class="keyword">public</span> Vector2 ItemSize =&gt; m_itemSize;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Setup</span>(<span class="params"><span class="keyword">in</span> <span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_label.text = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> mono method</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_itemSize = <span class="keyword">new</span> Vector2(m_rectTransform.rect.width, m_rectTransform.rect.height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_itemSize = <span class="keyword">new</span> Vector2(m_rectTransform.rect.width, m_rectTransform.rect.height);</span><br><span class="line">        m_label.text = <span class="keyword">this</span>.GetInstanceID().ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span> </span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2020/08/23/20200823-UGUI-ScrollRect-Learn-01/20200823-scrollrectgit01.gif" class="" title="split"><p>OnDeltaPosition 和 OnScrollBarValueChanged 是分别从ScrollRect和ScrollBar接受事件的方法，并计算出下一次绘制时能够需要绘制的第一个UI物体的位置。因为我太菜了，先尝试绘制竖向的。<br>TempGridItem 是UI物体上的组件。</p><p>下面是我的全部代码：<br><a href="https://github.com/2C2C2C/MuyScrollRect/blob/master/Assets/Script/TempScrollRect.cs" target="_blank" rel="noopener">https://github.com/2C2C2C/MuyScrollRect/blob/master/Assets/Script/TempScrollRect.cs</a></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这期就到这里了，其实也没啥东西。其实我感觉也没必要整个重写，可以继承ScrollRect的代码，然后override需要的地方，但是我是真的看不懂，所以只能整片拿过来到处改改做实验。<br>而且我也希望能有更多的控制，把Layout直接集成进去。</p><p>下次我会尝试理解ScrollRect的MoveType是怎么实现的，因为我当前写的这个只支持elastic的移动方式。并且原本的ScrollRect在elastic移动模式下，即使看起来已经停止移动了，仍然可能还在继续产生draw call，因为速度还在变化。</p><p>顺便推荐一下这个ScrollRect，我觉得写得挺好的，值得学习。<br><a href="https://github.com/qiankanglai/LoopScrollRect" target="_blank" rel="noopener">https://github.com/qiankanglai/LoopScrollRect</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;入夏以后非常热，我房间里的空调闲置很久没清理，也一直不敢开，所以周末基本都毫无生产力，只能躺尸。&lt;br&gt;这段时间在公司里基本都是给UI朋友们做事，而且估计以后会更多的接触这方面的东西，决定开始学习一下UGUI了，为了以后能做出可靠复用性能友好的UI。&lt;/p&gt;
&lt;p&gt;Unit
      
    
    </summary>
    
    
      <category term="Unity" scheme="http://yoursite.com/categories/Unity/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UGUI" scheme="http://yoursite.com/tags/UGUI/"/>
    
  </entry>
  
  <entry>
    <title>UnityEditor Scrollview Pagination(分页)</title>
    <link href="http://yoursite.com/2020/06/26/20200626-unity-editor-scrollview-pagination/"/>
    <id>http://yoursite.com/2020/06/26/20200626-unity-editor-scrollview-pagination/</id>
    <published>2020-06-26T08:24:23.000Z</published>
    <updated>2020-11-21T06:03:03.941Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前在做CloneConsole的时候，会在每次绘制的时候尝试绘制所有的log，然后再交给UnityEditor自己去处理显示的逻辑。因为我们会堆积几百甚至几千条log，这样的做法无疑会带来性能问题，结果就是console卡得不能用。</p><h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>其实思路也很简单，只需要画那些会显示出来的item就行了。<br>在这之前需要算出哪些item是可以被显示出来的</p><ol><li>算出所有的item加起来有多高</li><li>用当前滑条的位置来推算出当前需要绘制的第一条item的索引</li><li>绘制item</li><li>绘制滑条并计算其下一次的位置</li></ol><p>其实这个思路应该也能应用到UGUI上，下次我也要试试。</p><h1 id="上代码"><a href="#上代码" class="headerlink" title="上代码"></a>上代码</h1><p>在一个新窗口中尝试画一画就好。<br>首先要准备好用来测试的一些数据。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TempDraw</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">System.Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> TempDrawData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> IconTag;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> TempMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TempDrawWindowTester</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> TempDrawWindowTester _instance = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> TempDrawWindowTester Instance =&gt; _instance;</span><br><span class="line"></span><br><span class="line">        List&lt;TempDrawData&gt; m_data = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// used to give out the data</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">event</span> System.Action&lt;List&lt;TempDrawData&gt;&gt; OnDataSpread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>把测试用的数据都存在这个Mono里，再用它的静态事件把数据传递到窗口中。<br>代码里的 Button attribute 是用来在editor上创建按钮的。</p><p>测试用的数据准备好了，我们来来进行绘制。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TempDraw</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TempDrawWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> WINDOW_NAME = <span class="string">"Temp Draw Window"</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> TempDrawWindow _instance = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> TempDrawWindow Instance =&gt; _instance;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> List&lt;TempDrawData&gt; m_data = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> m_scrollPosition = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> temp element</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">float</span> ELEMENT_HEIGHT = <span class="number">20.0f</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">float</span> ELEMENT_ICON_SIZE = <span class="number">20.0f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> icons</span></span><br><span class="line">        <span class="keyword">private</span> Texture2D m_infoIconSmall = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">private</span> Texture2D m_warningIconSmall = <span class="literal">null</span>;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">MenuItem(<span class="meta-string">"Window/Temp Draw Window"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenWindow</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            TempDrawWindow window = GetWindow&lt;TempDrawWindow&gt;();</span><br><span class="line">            Texture2D icon = EditorGUIUtility.Load(<span class="string">"icons/UnityEditor.ConsoleWindow.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line">            window.titleContent = <span class="keyword">new</span> GUIContent(WINDOW_NAME, icon);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetData</span>(<span class="params">List&lt;TempDrawData&gt; data</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == m_data)</span><br><span class="line">                m_data = <span class="keyword">new</span> List&lt;TempDrawData&gt;();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                m_data.Clear();</span><br><span class="line"></span><br><span class="line">            m_data.AddRange(data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawTempElement</span>(<span class="params">Rect elementRect, <span class="keyword">int</span> dataIndex</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Rect iconRect = <span class="keyword">new</span> Rect(elementRect.x, elementRect.y, ELEMENT_ICON_SIZE, elementRect.height);</span><br><span class="line">            <span class="keyword">if</span> (m_data[dataIndex].IconTag == <span class="number">0</span>)</span><br><span class="line">                GUI.Label(iconRect, m_infoIconSmall);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                GUI.Label(iconRect, m_warningIconSmall);</span><br><span class="line"></span><br><span class="line">            Rect labelRect = <span class="keyword">new</span> Rect(elementRect.x + ELEMENT_ICON_SIZE, elementRect.y, elementRect.width - ELEMENT_ICON_SIZE, elementRect.height);</span><br><span class="line">            GUI.Label(labelRect, <span class="string">$"Tag: <span class="subst">&#123;m_data[dataIndex].IconTag&#125;</span> ; Message: <span class="subst">&#123;m_data[dataIndex].TempMessage&#125;</span> ;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawTempRect</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// only use half space of this shit window</span></span><br><span class="line">            Rect viewportRect = <span class="keyword">new</span> Rect(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="keyword">this</span>.position.width, <span class="keyword">this</span>.position.height * <span class="number">0.5f</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">float</span> scrollbarWidth = GUI.skin.verticalScrollbar.fixedWidth;</span><br><span class="line">            Rect scrollbarRect = <span class="keyword">new</span> Rect(viewportRect.x + viewportRect.width - scrollbarWidth, viewportRect.y, scrollbarWidth, viewportRect.height);</span><br><span class="line">            Rect currentRect = <span class="keyword">new</span> Rect(<span class="number">0.0f</span>, <span class="number">0.0f</span>, viewportRect.width - scrollbarWidth, viewportRect.height);</span><br><span class="line">            <span class="keyword">float</span> viewportHeight = viewportRect.height;</span><br><span class="line">            <span class="keyword">int</span> elementCount = m_data.Count;</span><br><span class="line"></span><br><span class="line">            GUI.BeginClip(currentRect); <span class="comment">// to clip the overflow stuff</span></span><br><span class="line">            <span class="keyword">int</span> indexOffset = Mathf.FloorToInt(m_scrollPosition / ELEMENT_HEIGHT);</span><br><span class="line">            <span class="keyword">int</span> showCount = Mathf.CeilToInt(currentRect.height / ELEMENT_HEIGHT);</span><br><span class="line">            showCount = showCount &gt; elementCount ? elementCount : showCount;</span><br><span class="line">            <span class="keyword">float</span> startPosY = (indexOffset * ELEMENT_HEIGHT) - m_scrollPosition;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; showCount; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Rect elementRect = <span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span> + startPosY + i * ELEMENT_HEIGHT, currentRect.width, ELEMENT_HEIGHT);</span><br><span class="line">                DrawTempElement(elementRect, indexOffset + i);</span><br><span class="line">            &#125;</span><br><span class="line">            GUI.EndClip();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// do stuff for scroller</span></span><br><span class="line">            <span class="keyword">float</span> fullElementHeight = elementCount * ELEMENT_HEIGHT;</span><br><span class="line">            m_scrollPosition = Mathf.Max(<span class="number">0</span>, GUI.VerticalScrollbar(scrollbarRect, m_scrollPosition, currentRect.height, <span class="number">0</span>, Mathf.Max(fullElementHeight, currentRect.height)));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> controlId = GUIUtility.GetControlID(FocusType.Passive);</span><br><span class="line">            <span class="keyword">float</span> scrollSensitivity = ELEMENT_HEIGHT;</span><br><span class="line">            <span class="keyword">float</span> maxScrollPos = (fullElementHeight &gt; currentRect.height) ? (fullElementHeight - currentRect.height) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (EventType.ScrollWheel == Event.current.GetTypeForControl(controlId))</span><br><span class="line">            &#123;</span><br><span class="line">                m_scrollPosition = Mathf.Clamp(m_scrollPosition + Event.current.delta.y * scrollSensitivity, <span class="number">0</span>, maxScrollPos);</span><br><span class="line">                Event.current.Use();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">GetAsset</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_infoIconSmall = EditorGUIUtility.Load(<span class="string">"icons/console.infoicon.sml.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line">            m_warningIconSmall = EditorGUIUtility.Load(<span class="string">"icons/console.warnicon.sml.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> life cycle</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            _instance = <span class="keyword">this</span>;</span><br><span class="line">            m_data = <span class="keyword">new</span> List&lt;TempDrawData&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            TempDrawWindowTester.OnDataSpread -= SetData;</span><br><span class="line">            TempDrawWindowTester.OnDataSpread += SetData;</span><br><span class="line">            GetAsset();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            DrawTempRect();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDestroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            TempDrawWindowTester.OnDataSpread -= SetData;</span><br><span class="line">            _instance = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2020/06/26/20200626-unity-editor-scrollview-pagination/20200626-pic001.png" class="" title="split"><img src="/2020/06/26/20200626-unity-editor-scrollview-pagination/20200626-pic002.png" class="" title="split"><p>效果如图</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;之前在做CloneConsole的时候，会在每次绘制的时候尝试绘制所有的log，然后再交给UnityEditor自己去处理显示的逻辑。因为我
      
    
    </summary>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/categories/UnityEditor/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="unityEditor" scheme="http://yoursite.com/tags/unityEditor/"/>
    
  </entry>
  
  <entry>
    <title>Unity函数Awake和OnEnable执行顺序小坑</title>
    <link href="http://yoursite.com/2020/06/22/20200622-awake-enable-order/"/>
    <id>http://yoursite.com/2020/06/22/20200622-awake-enable-order/</id>
    <published>2020-06-22T15:48:08.000Z</published>
    <updated>2020-06-22T16:16:12.096Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Awake: This function is always called before any Start functions and also just after a prefabis instantiated. (If a GameObject is inactive during start up Awake is not called until it is made active.)</p><p>OnEnable: (only called if the Object is active): This function is called just after the object is enabled. This happens when a MonoBehaviour instance is created, such as when a level is loaded or a GameObject with the script component is instantiated.</p></blockquote><p><a href="https://docs.unity3d.com/Manual/ExecutionOrder.html" target="_blank" rel="noopener">check the exec order here</a></p><img src="/2020/06/22/20200622-awake-enable-order/20200622-pic001.png" class="" title="split"><p>今天做工时候遇到了一个问题，我在Mono A的 Awake 中把Mono A的实例绑定到了GameManager里，然后再Mono B的 OnEnable 中获取Mono A的实例，结果跳了个空引用异常。<br>把我惊了，原来这一年多来我一直在一个误区里。</p><p>我以前一直认为是当场景里所有的 Awake 跑完才开始跑 OnEnable()。但其实不是这样的。</p><p><strong>当一个Mono的 Awake 跑完以后会接着跑他的 OnEnable , 接着才去跑其他物体的 Awake 和 OnEnable。</strong></p><p>随便写两行测试一下就知道了。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TesterA1</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Type m_type = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_type = <span class="keyword">this</span>.GetType();</span><br><span class="line">        Debug.Log(<span class="string">$"<span class="subst">&#123;m_type.Name&#125;</span> awake"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$"<span class="subst">&#123;m_type.Name&#125;</span> on enable"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TesterB1</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="keyword">private</span> Type m_type = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_type = <span class="keyword">this</span>.GetType();</span><br><span class="line">        Debug.Log(<span class="string">$"<span class="subst">&#123;m_type.Name&#125;</span> awake"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$"<span class="subst">&#123;m_type.Name&#125;</span> on enable"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TesterC1</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Type m_type = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_type = <span class="keyword">this</span>.GetType();</span><br><span class="line">        Debug.Log(<span class="string">$"<span class="subst">&#123;m_type.Name&#125;</span> awake"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$"<span class="subst">&#123;m_type.Name&#125;</span> on enable"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>都整上一样的内容，A和C绑在物体tester01上，B绑在物体tester02上。</p><img src="/2020/06/22/20200622-awake-enable-order/20200622-pic002.png" class="" title="split">]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;Awake: This function is always called before any Start functions and also just after a prefabis instantiated. (If a GameObje
      
    
    </summary>
    
    
      <category term="Unity" scheme="http://yoursite.com/categories/Unity/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
  </entry>
  
  <entry>
    <title>UnityObject 空引用检查小测试</title>
    <link href="http://yoursite.com/2020/06/20/20200620-unity-obj-null-check/"/>
    <id>http://yoursite.com/2020/06/20/20200620-unity-obj-null-check/</id>
    <published>2020-06-20T04:32:19.000Z</published>
    <updated>2020-06-22T16:07:15.095Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Classes deriving from Unity. Object inherit equality operators that change the behaviour of the == and != operators.<br>While these operators will perform standard . NET reference equality, if comparing one side to null, these operators will call native code to check if the underlying native engine object is still alive. </p></blockquote><p>这段解释来自Rider的提示：<br><a href="https://github.com/JetBrains/resharper-unity/wiki/Avoid-null-comparisons-against-UnityEngine.Object-subclasses" target="_blank" rel="noopener">https://github.com/JetBrains/resharper-unity/wiki/Avoid-null-comparisons-against-UnityEngine.Object-subclasses</a></p><p>UnityEngine 底层是C++写的，所以说，其实我们对UnityObject的空引用检查都会再深入到里面C++那一层去再检查，这个检查是比较消耗的。<br>之前曾经遇到因为使用了 ?. 语法糖而导致的 this 指针为null的奇妙bug，大概也是因为这个原因。</p><p>现在的公司是做手游的，大家对性能都比较看重，不过我也真的好奇这个检查到底有多消耗，决定跑一跑试试。</p><h1 id="Test-Case"><a href="#Test-Case" class="headerlink" title="Test Case"></a>Test Case</h1><p>因为是做手游，随意干脆就在手机上测试好了。<br>大概是这样的环境:<br>Unity 2019.4 LTS</p><p>移动设备这边是<br>Google Pixel Verzion(俺穷买美版)<br>Android 9 (已获取Root权限)</p><p>TestCase 这边其实我都是瞎弄的。</p><p>分别进行三种测试：<br>Unity Object 的空引用检查；<br>POCO Object 的空引用检查；<br>bool 的直接检查；(因为我觉得这是一个代替Unity Object空引用检查的一个方法</p><p>每一种检查都有检查到true和false的两种情况，并循环跑多次。</p><p>然后，上代码！</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TempCheckTest</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TempObjA</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> m_tempNum = <span class="number">56</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NullCheckTester</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// unity obj null check</span></span><br><span class="line">        <span class="keyword">private</span> Transform m_emptyTransform = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">private</span> Transform m_selfTransform = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// poco obj null check</span></span><br><span class="line">        <span class="keyword">private</span> TempObjA m_emptyObjA = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">private</span> TempObjA m_objA = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// bool check</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_boolTrue = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> m_boolFalse = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"test"</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> m_checkTimes = <span class="number">100000</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="meta-string">"UI side"</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> UnityEngine.UI.Text m_outPutText = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> UnityEngine.UI.Button m_doUnityObjTestButton = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> UnityEngine.UI.Button m_doPocoObjTestButton = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> UnityEngine.UI.Button m_doBoolTestButton = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> UnityEngine.UI.InputField m_inputField = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Button(<span class="meta-string">"init awake"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InitTester</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_emptyTransform = <span class="literal">null</span>;</span><br><span class="line">            m_selfTransform = <span class="keyword">this</span>.transform;</span><br><span class="line"></span><br><span class="line">            m_emptyObjA = <span class="literal">null</span>;</span><br><span class="line">            m_objA = <span class="keyword">new</span> TempObjA();</span><br><span class="line"></span><br><span class="line">            m_boolTrue = <span class="literal">true</span>;</span><br><span class="line">            m_boolFalse = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            m_outPutText.text = <span class="keyword">string</span>.Empty;</span><br><span class="line"></span><br><span class="line">            m_doUnityObjTestButton.onClick.RemoveAllListeners();</span><br><span class="line">            m_doPocoObjTestButton.onClick.RemoveAllListeners();</span><br><span class="line">            m_doBoolTestButton.onClick.RemoveAllListeners();</span><br><span class="line"></span><br><span class="line">            m_doUnityObjTestButton.onClick.AddListener(DoUnityObjNullCheckTest);</span><br><span class="line">            m_doPocoObjTestButton.onClick.AddListener(DoPOCOObjNullCheckTest);</span><br><span class="line">            m_doBoolTestButton.onClick.AddListener(DoBoolObjNullCheckTest);</span><br><span class="line"></span><br><span class="line">            m_inputField.onValueChanged.RemoveAllListeners();</span><br><span class="line">            m_inputField.onValueChanged.AddListener(OnInputNumberChanged);</span><br><span class="line">            m_checkTimes = <span class="number">100000</span>;</span><br><span class="line">            m_inputField.text = m_checkTimes.ToString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Button(<span class="meta-string">"do unity.object null check test"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoUnityObjNullCheckTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            System.Diagnostics.Stopwatch watcher = <span class="keyword">new</span> System.Diagnostics.Stopwatch();</span><br><span class="line">            watcher.Start();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_checkTimes; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == m_emptyTransform) &#123;&#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == m_selfTransform) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            watcher.Stop();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> outPut = <span class="string">$"do unity.object null check test 2*<span class="subst">&#123;m_checkTimes&#125;</span> cost <span class="subst">&#123;watcher.ElapsedMilliseconds&#125;</span>ms"</span>;</span><br><span class="line">            m_outPutText.text = outPut;</span><br><span class="line">            Debug.Log(outPut);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Button(<span class="meta-string">"do poco object null check test"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoPOCOObjNullCheckTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            System.Diagnostics.Stopwatch watcher = <span class="keyword">new</span> System.Diagnostics.Stopwatch();</span><br><span class="line">            watcher.Start();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_checkTimes; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == m_emptyObjA) &#123;&#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == m_objA) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            watcher.Stop();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> outPut = <span class="string">$"do poco object null check test 2*<span class="subst">&#123;m_checkTimes&#125;</span> cost <span class="subst">&#123;watcher.ElapsedMilliseconds&#125;</span>ms"</span>;</span><br><span class="line">            m_outPutText.text = outPut;</span><br><span class="line">            Debug.Log(outPut);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Button(<span class="meta-string">"do bool check test"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoBoolObjNullCheckTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            System.Diagnostics.Stopwatch watcher = <span class="keyword">new</span> System.Diagnostics.Stopwatch();</span><br><span class="line">            watcher.Start();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_checkTimes; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_boolFalse) &#123;&#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (m_boolTrue) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            watcher.Stop();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> outPut = <span class="string">$"do bool check test 2*<span class="subst">&#123;m_checkTimes&#125;</span> cost <span class="subst">&#123;watcher.ElapsedMilliseconds&#125;</span>ms"</span>;</span><br><span class="line">            m_outPutText.text = outPut;</span><br><span class="line">            Debug.Log(outPut);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnInputNumberChanged</span>(<span class="params"><span class="keyword">string</span> arg0</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (!Int32.TryParse(arg0, <span class="keyword">out</span> result))</span><br><span class="line">                result = Int32.MaxValue;</span><br><span class="line"></span><br><span class="line">            m_checkTimes = result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> mono method</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            InitTester();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            InitTester();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.enabled = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Test-Result"><a href="#Test-Result" class="headerlink" title="Test Result"></a>Test Result</h1><img src="/2020/06/20/20200620-unity-obj-null-check/20200620-pic001.png" class="" title="split"><p>分别进行10w次和100w次测试看看结果。</p><p>10w次:<br>Unity Object null check 4~7ms<br>POCO Object null check 0ms<br>bool check 0ms</p><p>100w次:<br>Unity Object null check 45~60ms<br>POCO Object null check 3~4ms<br>bool check 2ms</p><p>当检测数量非常多的时候，Unity Object 空引用检查的性能消耗比其他两个大了很多很多。现在的项目里大部分东西其实都是POCO的。<br>似乎把UnityObject Destroy之后再手动把变量置空是个好习惯（</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;Classes deriving from Unity. Object inherit equality operators that change the behaviour of the == and != operators.&lt;br&gt;Whil
      
    
    </summary>
    
    
      <category term="Unity" scheme="http://yoursite.com/categories/Unity/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UnityOptimization" scheme="http://yoursite.com/tags/UnityOptimization/"/>
    
  </entry>
  
  <entry>
    <title>简易检测，目标是否在扇形区域(2D)</title>
    <link href="http://yoursite.com/2020/06/14/20200614-check-target-fan-shape/"/>
    <id>http://yoursite.com/2020/06/14/20200614-check-target-fan-shape/</id>
    <published>2020-06-14T03:30:45.000Z</published>
    <updated>2020-06-14T05:25:53.113Z</updated>
    
    <content type="html"><![CDATA[<p>最近在项目组里做一些小游戏原型，深感自己菜得如虫豸。为了慢慢提升还是决定做一些记录，虽然只是很垃圾的功能。<br>因为做的是手游，所以对性能蛮看重的，说是原型，为了快也只是项目里开了个单独的新场景做的，3C都有，做好了可以直接打包APK试玩。<br>废话不多说，这次做的事很简单，在扇形区域内检测一些目标。因为听说Vector3. Angle()里会跑开方的计算，故尝试避免使用这个方法。</p><img src="/2020/06/14/20200614-check-target-fan-shape/20200614-pic001.png" class="" title="split"><h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>需要解决的需求是在检测者 前方 的一个扇形内检测目标物体，其实可以化简为2D平面的检测。<br>我决定多次使用点乘和叉乘来解决这个问题。</p><p>已知数据：<br>检测者的位置，朝向，检测角度大小，半径大小<br>检测目标的位置</p><p>步骤：</p><ol><li>用检测者的前方向量和检测者到目标的方向向量点乘来判断目标物体是否在检测者前方。</li><li>用检测者前方方向向量和检测区域的两个边界方向分别叉乘得到两个法向向量A,B。</li><li>用检测者到目标的方向向量和检测区域的两个边界方向分别叉乘得到两个法向向量C,D。</li><li>用点乘检测C,D是否同向，是，则在检测区外</li><li>是否同时满足向量A,C同向，向量B,D同向，是，则在检测区内</li></ol><p>其实我自己都感觉这中文，写得很乱，还不如直接看代码23333<br>全部代码：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TargetCheckTester</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Transform m_transform = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> m_checkAngle = <span class="number">60.0f</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> m_checkRadius = <span class="number">6.0f</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">private</span> Transform m_targetTransform = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckTarget1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_targetTransform)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        Vector3 myPos = m_transform.position;</span><br><span class="line">        Vector3 myForward = m_transform.forward;</span><br><span class="line">        <span class="keyword">float</span> halfAngle = m_checkAngle * <span class="number">0.5f</span>;</span><br><span class="line">        Vector3 dirUp = Quaternion.Euler(<span class="number">0.0f</span>, -halfAngle, <span class="number">0.0f</span>) * myForward;</span><br><span class="line">        Vector3 dirDown = Quaternion.Euler(<span class="number">0.0f</span>, halfAngle, <span class="number">0.0f</span>) * myForward;</span><br><span class="line"></span><br><span class="line">        Vector3 upCheck = Vector3.Cross(myForward, dirUp);</span><br><span class="line">        Vector3 downCheck = Vector3.Cross(myForward, dirDown);</span><br><span class="line"></span><br><span class="line">        Vector3 targetPos = m_targetTransform.position;</span><br><span class="line">        <span class="comment">// hack, to make them on a 2d plane :)</span></span><br><span class="line">        targetPos.y = myPos.y;</span><br><span class="line">        Vector3 toTargetDir = targetPos - myPos;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// draw line</span></span><br><span class="line">        Vector3 point1 = myPos + dirUp * m_checkRadius;</span><br><span class="line">        Vector3 point2 = myPos + dirDown * m_checkRadius;</span><br><span class="line">        Vector3 point0 = myPos + myForward * m_checkRadius;</span><br><span class="line"></span><br><span class="line">        Debug.DrawLine(myPos, point1, Color.yellow, Time.deltaTime);</span><br><span class="line">        Debug.DrawLine(myPos, point2, Color.yellow, Time.deltaTime);</span><br><span class="line">        Debug.DrawLine(myPos, point0, Color.yellow, Time.deltaTime);</span><br><span class="line">        Debug.DrawLine(point1, point0, Color.yellow, Time.deltaTime);</span><br><span class="line">        Debug.DrawLine(point2, point0, Color.yellow, Time.deltaTime);</span><br><span class="line">        Debug.DrawLine(myPos, targetPos, Color.red, Time.deltaTime);</span><br><span class="line">        <span class="comment">// draw line</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Vector3.Dot(toTargetDir, myForward) &lt; <span class="number">0.0f</span> || toTargetDir.sqrMagnitude &gt; m_checkRadius * m_checkRadius)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        Vector3 targetUpCheck = Vector3.Cross(toTargetDir, dirUp);</span><br><span class="line">        Vector3 targetDownCheck = Vector3.Cross(toTargetDir, dirDown);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> selfCheck = Vector3.Dot(targetUpCheck, targetDownCheck);</span><br><span class="line">        <span class="keyword">float</span> dotCheckUp = Vector3.Dot(upCheck, targetUpCheck);</span><br><span class="line">        <span class="keyword">float</span> dotCheckDown = Vector3.Dot(targetDownCheck, downCheck);</span><br><span class="line">        <span class="keyword">if</span> (selfCheck &lt;= <span class="number">0.0f</span> &amp;&amp; dotCheckUp * dotCheckDown &gt;= <span class="number">0.0f</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">"target in sight"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> mono method</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_transform = <span class="keyword">this</span>.transform;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        CheckTarget1();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2020/06/14/20200614-check-target-fan-shape/20200614-pic002.png" class="" title="split">]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近在项目组里做一些小游戏原型，深感自己菜得如虫豸。为了慢慢提升还是决定做一些记录，虽然只是很垃圾的功能。&lt;br&gt;因为做的是手游，所以对性能蛮看重的，说是原型，为了快也只是项目里开了个单独的新场景做的，3C都有，做好了可以直接打包APK试玩。&lt;br&gt;废话不多说，这次做的事很
      
    
    </summary>
    
    
      <category term="Unity" scheme="http://yoursite.com/categories/Unity/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="Gameplay" scheme="http://yoursite.com/tags/Gameplay/"/>
    
  </entry>
  
  <entry>
    <title>UnityEditor EasyButton 简易编辑器按钮</title>
    <link href="http://yoursite.com/2020/06/05/20200605-Unity-EasyButton/"/>
    <id>http://yoursite.com/2020/06/05/20200605-Unity-EasyButton/</id>
    <published>2020-06-05T15:04:09.000Z</published>
    <updated>2020-06-05T15:51:04.068Z</updated>
    
    <content type="html"><![CDATA[<p>一个比较简单但是方便的东西</p><h1 id="这是啥"><a href="#这是啥" class="headerlink" title="这是啥"></a>这是啥</h1><p>我们平时些写了一些函数在MonoBehavior里想测试，这边可以整一个特性放在需要快速调用的方法上(限于无参数的函数)。<br>这边可以做一个编辑器的按钮，直接放在MonoBehavior的组件面板上。</p><h1 id="上代码"><a href="#上代码" class="headerlink" title="上代码"></a>上代码</h1><p>先定义我们需要的这个特性，既然是做个按钮，那就叫Button好了。那么这个特性就应该叫做ButtonAttribute。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Method)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ButtonAttribute</span> : <span class="title">Attribute</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> m_methodName = <span class="keyword">string</span>.Empty;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ButtonAttribute</span>(<span class="params"><span class="keyword">string</span> methodName</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_methodName = methodName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>既然我们要在Inspector面板上加东西，那我们也要操作一下Inspector面板。<br>我们做一个CustomEditor面板给我们的MonoBehavior，这个面板会作用于所有的MonoBehavior。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">CustomEditor(typeof(MonoBehaviour), true), CanEditMultipleObjects</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseEditor</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Type m_targetType = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInspectorGUI</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// draw default stuff</span></span><br><span class="line">        <span class="keyword">base</span>.OnInspectorGUI();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == m_targetType)</span><br><span class="line">            m_targetType = target.GetType();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (m_targetType != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// try find member function and static function :)</span></span><br><span class="line">            MethodInfo[] methods = m_targetType.GetMethods(BindingFlags.Instance | BindingFlags.Static | BindingFlags.NonPublic | BindingFlags.Public);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> method <span class="keyword">in</span> methods)</span><br><span class="line">            &#123;</span><br><span class="line">                ButtonAttribute button = method.GetCustomAttribute&lt;ButtonAttribute&gt;();</span><br><span class="line">                <span class="keyword">if</span> (button != <span class="literal">null</span> &amp;&amp; method.GetParameters().Length &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    EditorGUILayout.HelpBox(<span class="string">"ButtonAttribute: method cant have parameterz."</span>, MessageType.Warning);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (button != <span class="literal">null</span> &amp;&amp; GUILayout.Button(button.m_methodName))</span><br><span class="line">                &#123;</span><br><span class="line">                    method.Invoke(target, <span class="keyword">new</span> <span class="keyword">object</span>[] &#123; &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            m_targetType = m_targetType.BaseType;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后新建一个MonoBehavior脚本，试试</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ToxicTester</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Button(<span class="meta-string">"try exec public method"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ExecPublicMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Debug.Log(<span class="string">"try exec public method wa"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Button(<span class="meta-string">"try exec protected method"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">ExecProtectedMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Debug.Log(<span class="string">"try exec protected method wa"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    [<span class="meta">Button(<span class="meta-string">"try exec private method"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ExecPrivateMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Debug.Log(<span class="string">"try exec private method wa"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Button(<span class="meta-string">"try exec public static method"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ExecPublicStaticMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Debug.Log(<span class="string">"try exec public static method wa"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2020/06/05/20200605-Unity-EasyButton/20200605-pic001.png" class="" title="split"><p>效果如图</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;一个比较简单但是方便的东西&lt;/p&gt;
&lt;h1 id=&quot;这是啥&quot;&gt;&lt;a href=&quot;#这是啥&quot; class=&quot;headerlink&quot; title=&quot;这是啥&quot;&gt;&lt;/a&gt;这是啥&lt;/h1&gt;&lt;p&gt;我们平时些写了一些函数在MonoBehavior里想测试，这边可以整一个特性放在需要快速调
      
    
    </summary>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/categories/UnityEditor/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UnityEditor" scheme="http://yoursite.com/tags/UnityEditor/"/>
    
  </entry>
  
  <entry>
    <title>摸一个简单的 Unity Log Console (2)</title>
    <link href="http://yoursite.com/2020/05/31/20200531-CloneUnityConsole2/"/>
    <id>http://yoursite.com/2020/05/31/20200531-CloneUnityConsole2/</id>
    <published>2020-05-31T10:50:56.000Z</published>
    <updated>2020-05-31T11:02:34.900Z</updated>
    
    <content type="html"><![CDATA[<p>上一期我们做完了基本的面板绘制，现在我们可以往里面添加简单的内容了。</p><h1 id="定义显示单位"><a href="#定义显示单位" class="headerlink" title="定义显示单位"></a>定义显示单位</h1><p>既然我们要显示Log，那就定义一些数据结构用于存储这些Log。因为这些东西在我们的console中只需要显示就行了，我们只需要定义只读的数据就可以，或许还能提高性能。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LogItem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsSelected &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">string</span> LogInfo = <span class="keyword">string</span>.Empty; <span class="comment">// Log简要信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="keyword">string</span> LogMessage = <span class="keyword">string</span>.Empty; <span class="comment">// Log 调用栈！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> LogType GetLogType = LogType.Log;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LogItem</span>(<span class="params"><span class="keyword">bool</span> isSelected, <span class="keyword">string</span> info, <span class="keyword">string</span> message, LogType type</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IsSelected = isSelected;</span><br><span class="line">        <span class="comment">// 记得加上时间！！！</span></span><br><span class="line">        LogInfo = <span class="keyword">string</span>.Format(<span class="string">"[&#123;0&#125;] &#123;1&#125;"</span>, System.DateTime.Now.ToLongTimeString(), info);</span><br><span class="line">        LogMessage = message;</span><br><span class="line">        GetLogType = type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TempConsoleWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LogMessageReceived</span>(<span class="params"><span class="keyword">string</span> condition, <span class="keyword">string</span> stackTrace, LogType type</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">            LogItem log = <span class="keyword">new</span> LogItem(<span class="literal">false</span>, condition, stackTrace, type);</span><br><span class="line">            m_logItems.Add(log);</span><br><span class="line">            <span class="keyword">switch</span> (type)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> LogType.Error:</span><br><span class="line">                    m_errorLogCount++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> LogType.Assert:</span><br><span class="line">                    m_errorLogCount++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> LogType.Warning:</span><br><span class="line">                    m_warningLogCount++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> LogType.Log:</span><br><span class="line">                    m_normalLogCount++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> LogType.Exception:</span><br><span class="line">                    m_errorLogCount++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    m_errorLogCount++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 主动刷新，因为当此窗口没有焦点时似乎无法走 OnGUI() 刷新。</span></span><br><span class="line">            Repaint();</span><br><span class="line">            <span class="comment">//GUI.changed = true;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line"><span class="comment">// 监听此事件，当Debug.Log("")被调用的时候就会响应</span></span><br><span class="line">Application.logMessageReceived += LogMessageReceived;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDestroy</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line">Application.logMessageReceived -= LogMessageReceived;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="在上部面板显示Log"><a href="#在上部面板显示Log" class="headerlink" title="在上部面板显示Log"></a>在上部面板显示Log</h1><p>像原本Unity Console一样，每一条Log以一个方条item的形式显示在上半部分面板。<br>我们先把这个item画出来。<br>m_selectedLogItem 是我们选中的 LogItem。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">bool</span> <span class="title">DrawLogBox</span>(<span class="params"><span class="keyword">in</span> <span class="keyword">string</span> content, LogType logType, <span class="keyword">bool</span> isOdd, <span class="keyword">bool</span> isSelected</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isSelected)</span><br><span class="line">    &#123;</span><br><span class="line">        m_boxItemStyle.normal.background = m_boxBgSelected;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (isOdd)</span><br><span class="line">        &#123;</span><br><span class="line">            m_boxItemStyle.normal.background = m_boxBgOdd;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_boxItemStyle.normal.background = m_boxBgEven;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (logType)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> LogType.Error:</span><br><span class="line">            m_boxIcon = m_errorIcon;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LogType.Assert:</span><br><span class="line">            m_boxIcon = m_errorIcon;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LogType.Warning:</span><br><span class="line">            m_boxIcon = m_warningIcon;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LogType.Log:</span><br><span class="line">            m_boxIcon = m_infoIcon;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LogType.Exception:</span><br><span class="line">            m_boxIcon = m_errorIcon;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这个按钮是因为这条box item是可以被点击选择的！！！</span></span><br><span class="line">    <span class="keyword">return</span> GUILayout.Button(<span class="keyword">new</span> GUIContent(content, m_boxIcon), m_boxItemStyle, GUILayout.ExpandWidth(<span class="literal">true</span>), GUILayout.Height(<span class="number">30.0f</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawUpperPanel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_upperPanel = <span class="keyword">new</span> Rect(<span class="number">0</span>, MENU_BAR_HEIGHT, <span class="keyword">this</span>.position.width, (<span class="keyword">this</span>.position.height - MENU_BAR_HEIGHT) * m_upperSizeRatio);</span><br><span class="line">    GUILayout.BeginArea(m_upperPanel, m_panelStyle);</span><br><span class="line">    GUILayout.Label(<span class="string">"Log"</span>, m_panelLabelStyle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在scrollview里填充log，unity</span></span><br><span class="line">    m_upperPanelScroll = GUILayout.BeginScrollView(m_upperPanelScroll);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_logItems.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_logTypeForUnshow.Contains(m_logItems[i].GetLogType))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 画的时候，顺便接受item的点击的结果</span></span><br><span class="line">        <span class="keyword">if</span> (DrawLogBox(m_logItems[i].LogInfo, m_logItems[i].GetLogType, i % <span class="number">2</span> == <span class="number">0</span>, m_logItems[i].IsSelected))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != m_selectedLogItem)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_logItems[i] == m_selectedLogItem)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// click a some one, open code</span></span><br><span class="line">                    <span class="comment">// JumpToCurrentLogPos(); // 跳转到你点击的Log的顶部的代码文件（如果可以</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    m_selectedLogItem.IsSelected = <span class="literal">false</span>;</span><br><span class="line">                    m_selectedLogItem = m_logItems[i];</span><br><span class="line">                    m_selectedLogItem.IsSelected = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                m_selectedLogItem = m_logItems[i];</span><br><span class="line">                m_selectedLogItem.IsSelected = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 准备刷新</span></span><br><span class="line">            GUI.changed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    GUILayout.EndScrollView();</span><br><span class="line">    GUILayout.EndArea();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// .....</span></span><br><span class="line">    <span class="keyword">if</span> (GUI.changed)</span><br><span class="line">    &#123;</span><br><span class="line">        Repaint();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="显示Log详情以及调用栈"><a href="#显示Log详情以及调用栈" class="headerlink" title="显示Log详情以及调用栈"></a>显示Log详情以及调用栈</h1><p>由于我脑子不好使，我不知道如何完美复刻Unity Console的详情，Unity自带Console中显示的代码链接既可以复制也可以点击跳转，我只做了简单的跳转。如果有比较熟悉编辑器开发的朋友，可以提供修改的方法。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawLowerPanel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">float</span> yPos = PanelGroupHeight * m_upperSizeRatio + MENU_BAR_HEIGHT + RESIZER_HEIGHT;</span><br><span class="line">    m_lowerPanel = <span class="keyword">new</span> Rect(<span class="number">0</span>, yPos, <span class="keyword">this</span>.position.width, PanelGroupHeight * (<span class="number">1.0f</span> - m_upperSizeRatio));</span><br><span class="line">    GUILayout.BeginArea(m_lowerPanel, m_panelStyle);</span><br><span class="line">    GUILayout.Label(<span class="string">"Log Detail"</span>, m_panelLabelStyle);</span><br><span class="line"></span><br><span class="line">    m_lowerPanelScroll = GUILayout.BeginScrollView(m_lowerPanelScroll);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">string</span> logDetail = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">string</span>[] logDetailMutiLine = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO : code clean here</span></span><br><span class="line">    <span class="keyword">string</span> pathline = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">string</span> tempCase = <span class="string">".cs:"</span>;</span><br><span class="line">    <span class="keyword">string</span> path = <span class="keyword">string</span>.Empty;</span><br><span class="line">    <span class="keyword">int</span> line = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> splitwa = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != m_selectedLogItem)</span><br><span class="line">    &#123;</span><br><span class="line">        logDetail = m_selectedLogItem.LogMessage;</span><br><span class="line">        GUILayout.TextArea(<span class="keyword">string</span>.Format(<span class="string">"&#123;0&#125;\n"</span>, m_selectedLogItem.LogInfo), m_textAreaStyle);</span><br><span class="line"></span><br><span class="line">        logDetailMutiLine = logDetail.Split(<span class="string">'\n'</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; logDetailMutiLine.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Regex match 'at xxx'</span></span><br><span class="line">            Match matches = Regex.Match(logDetailMutiLine[i], <span class="string">@"\(at (.+)\)"</span>, RegexOptions.Multiline);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (matches.Success)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span> (matches.Success)</span><br><span class="line">                &#123;</span><br><span class="line">                    pathline = matches.Groups[<span class="number">1</span>].Value;</span><br><span class="line">                    <span class="keyword">if</span> (pathline.Contains(tempCase))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">int</span> splitIndex = pathline.LastIndexOf(<span class="string">":"</span>);</span><br><span class="line">                        path = pathline.Substring(<span class="number">0</span>, splitIndex);</span><br><span class="line">                        line = Convert.ToInt32(pathline.Substring(splitIndex + <span class="number">1</span>));</span><br><span class="line">                        <span class="keyword">string</span> fullpath = Application.dataPath.Substring(<span class="number">0</span>, Application.dataPath.LastIndexOf(<span class="string">"Assets"</span>));</span><br><span class="line">                        fullpath = fullpath + path;</span><br><span class="line">                        splitwa = logDetailMutiLine[i].LastIndexOf(<span class="string">"("</span>);</span><br><span class="line">                        logDetailMutiLine[i] = logDetailMutiLine[i].Substring(<span class="number">0</span>, splitwa);</span><br><span class="line"></span><br><span class="line">                        GUILayout.BeginHorizontal();</span><br><span class="line">                        GUILayout.TextArea(<span class="keyword">string</span>.Format(<span class="string">" (at : &#123;0&#125;)\n"</span>, logDetailMutiLine[i]), m_textAreaStyle);</span><br><span class="line">                        <span class="keyword">if</span> (GUILayout.Button(<span class="keyword">string</span>.Format(<span class="string">" ( &#123;0&#125; )\n"</span>, pathline), m_labelButtonStyle))</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// 打开文件的魔法</span></span><br><span class="line">                            UnityEditorInternal.InternalEditorUtility.OpenFileAtLineExternal(fullpath.Replace(<span class="string">'/'</span>, <span class="string">'\\'</span>), line);</span><br><span class="line">                        &#125;</span><br><span class="line">                        GUILayout.FlexibleSpace();</span><br><span class="line">                        GUILayout.EndHorizontal();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                GUILayout.TextArea(logDetailMutiLine[i], m_textAreaStyle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    GUILayout.EndScrollView();</span><br><span class="line">    GUILayout.EndArea();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这边用了正则表达式去匹配去寻找代码文件，是从网上查到的，我用着还不太熟练。所以写得很乱，后续会在工程中更新干净些的版本。</p><h1 id="完善菜单栏功能"><a href="#完善菜单栏功能" class="headerlink" title="完善菜单栏功能"></a>完善菜单栏功能</h1><p>既然我们能显示Log了，那就别忘了补上清除Log的功能。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearLogs</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != m_selectedLogItem)</span><br><span class="line">    &#123;</span><br><span class="line">        m_selectedLogItem.IsSelected = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_selectedLogItem = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    m_normalLogCount = <span class="number">0</span>;</span><br><span class="line">    m_warningLogCount = <span class="number">0</span>;</span><br><span class="line">    m_errorLogCount = <span class="number">0</span>;</span><br><span class="line">    m_logItems.Clear();</span><br><span class="line">    GUI.changed = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawMenuUpperBar</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// .....</span></span><br><span class="line">    <span class="keyword">if</span> (GUILayout.Button(<span class="keyword">new</span> GUIContent(<span class="string">"Clear"</span>), EditorStyles.toolbarButton, GUILayout.Width(<span class="number">40.0f</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 用于清空所有的 log</span></span><br><span class="line">        ClearLogs();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// .....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这一期就到这里。感觉工具开发也有点搬砖，但是会用到各种各样的搬砖工具去搬运契合不同的砖，能接触到很多东西，还蛮有趣的。<br>下一期我会尝试把当前这个乞丐Log Console的功能都补齐。<br>代码有缺漏可以先参考工程。</p><hr><p>完整工程链接</p><p><a href="https://github.com/2C2C2C/TempUnityLogConsoleClone" target="_blank" rel="noopener">https://github.com/2C2C2C/TempUnityLogConsoleClone</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;上一期我们做完了基本的面板绘制，现在我们可以往里面添加简单的内容了。&lt;/p&gt;
&lt;h1 id=&quot;定义显示单位&quot;&gt;&lt;a href=&quot;#定义显示单位&quot; class=&quot;headerlink&quot; title=&quot;定义显示单位&quot;&gt;&lt;/a&gt;定义显示单位&lt;/h1&gt;&lt;p&gt;既然我们要显示Log，那
      
    
    </summary>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/categories/UnityEditor/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UnityEditor" scheme="http://yoursite.com/tags/UnityEditor/"/>
    
  </entry>
  
  <entry>
    <title>摸一个简单的 Unity Log Console (1)</title>
    <link href="http://yoursite.com/2020/05/31/20200531-CloneUnityConsole1/"/>
    <id>http://yoursite.com/2020/05/31/20200531-CloneUnityConsole1/</id>
    <published>2020-05-31T02:47:16.000Z</published>
    <updated>2020-06-05T15:08:44.394Z</updated>
    
    <content type="html"><![CDATA[<p>本菜狗在上周领了一个做LogManager的任务。很高兴也很慌，毕竟从来没做过编辑器开发，于是面向搜索引擎编程开始辣，找了一些教程学着做，顺便分享一下。</p><h1 id="需求分析（？"><a href="#需求分析（？" class="headerlink" title="需求分析（？"></a>需求分析（？</h1><p>组里对这个LogManager的要求是在Unity原来的Log功能上再加上根据标签和危险度(?)来筛选。<br>仔细想想还挺麻烦。需要筛选的话，那自然需要一个Console面板，似乎Unity原本的Console不方便扩展，索性跟着网上的教程重新做一个。</p><h1 id="弹出窗口"><a href="#弹出窗口" class="headerlink" title="弹出窗口"></a>弹出窗口</h1><p>首先我们先把窗口弹出来。代码很简单。</p><p>我们可以从Unity头顶的菜单栏中的Window中找到这个面板并打开。打开了是空白的，当然啦，因为还什么都没画上去。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TempConsoleWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">[<span class="meta">MenuItem(<span class="meta-string">"Window/Temp Console"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenWindow</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">TempConsoleWindow window = GetWindow&lt;TempConsoleWindow&gt;();</span><br><span class="line">GUIContent titleContent = <span class="keyword">new</span> GUIContent(<span class="string">"TempConsole"</span>, EditorGUIUtility.Load(<span class="string">"icons/UnityEditor.ConsoleWindow.png"</span>) <span class="keyword">as</span> Texture2D, <span class="string">"a clone sonsole"</span>);</span><br><span class="line">window.titleContent = titleContent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="分割区块"><a href="#分割区块" class="headerlink" title="分割区块"></a>分割区块</h1><img src="/2020/05/31/20200531-CloneUnityConsole1/20200531-Unity01.png" class="" title="split"><p>我们把原本的面板分成4块：1.菜单栏；2. Log区；3. 调整棒(上下移动调整区域大小)；4. 详情区。于是乎我们给这个4个区创建响应的变量为了方便绘制。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Rect m_menuUpperBar = <span class="keyword">default</span>;</span><br><span class="line"><span class="keyword">private</span> Rect m_upperPanel = <span class="keyword">default</span>;</span><br><span class="line"><span class="keyword">private</span> Rect m_lowerPanel = <span class="keyword">default</span>;</span><br><span class="line"><span class="keyword">private</span> Rect m_resizer = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">float</span> MENU_BAR_HEIGHT = <span class="number">20.0f</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">float</span> m_upperSizeRatio = <span class="number">0.5f</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">float</span> RESIZER_HEIGHT = <span class="number">4.0f</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">float</span> PanelGroupHeight =&gt; position.height - MENU_BAR_HEIGHT;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">bool</span> m_isResizing = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure><h1 id="偷皮"><a href="#偷皮" class="headerlink" title="偷皮"></a>偷皮</h1><p>Unity的绘制GUI方法中可以填写风格参数，我们绘制四个区块的时候自然也需要为区块准备皮和文字颜色。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// log区风格以及log区的标题风格</span></span><br><span class="line"><span class="keyword">private</span> GUIStyle m_panelLabelStyle = <span class="keyword">default</span>;</span><br><span class="line"><span class="keyword">private</span> GUIStyle m_panelStyle = <span class="keyword">default</span>;</span><br><span class="line"><span class="comment">// 调整棒儿的风格</span></span><br><span class="line"><span class="keyword">private</span> GUIStyle m_resizerStyle = <span class="keyword">default</span>;</span><br><span class="line"><span class="comment">// box item 其实是在log区显示的每一个log item</span></span><br><span class="line"><span class="keyword">private</span> GUIStyle m_boxItemStyle = <span class="keyword">default</span>;</span><br><span class="line"><span class="comment">// 这是 log详情的文字风格</span></span><br><span class="line"><span class="keyword">private</span> GUIStyle m_textAreaStyle = <span class="keyword">default</span>;</span><br><span class="line"><span class="comment">// 这是一个无边框的按钮风格，为代码跳转准备</span></span><br><span class="line"><span class="keyword">private</span> GUIStyle m_labelButtonStyle = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 各种图标</span></span><br><span class="line"><span class="keyword">private</span> Texture2D m_infoIcon = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">private</span> Texture2D m_infoIconSmall = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">private</span> Texture2D m_warningIcon = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">private</span> Texture2D m_warningIconSmall = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">private</span> Texture2D m_errorIcon = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">private</span> Texture2D m_errorIconSmall = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Texture2D m_boxBgOdd = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">private</span> Texture2D m_boxBgEven = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">private</span> Texture2D m_boxBgSelected = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">private</span> Texture2D m_boxIcon = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取各种皮</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">GetAssets</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_panelLabelStyle = <span class="keyword">new</span> GUIStyle();</span><br><span class="line">    m_panelLabelStyle.fixedHeight = <span class="number">30.0f</span>;</span><br><span class="line">    m_panelLabelStyle.richText = <span class="literal">true</span>;</span><br><span class="line">    m_panelLabelStyle.normal.textColor = Color.white;</span><br><span class="line">    m_panelLabelStyle.fontSize = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    m_infoIcon = EditorGUIUtility.Load(<span class="string">"icons/console.infoicon.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line">    m_infoIconSmall = EditorGUIUtility.Load(<span class="string">"icons/console.infoicon.sml.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line">    m_warningIcon = EditorGUIUtility.Load(<span class="string">"icons/console.warnicon.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line">    m_warningIconSmall = EditorGUIUtility.Load(<span class="string">"icons/console.warnicon.sml.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line">    m_errorIcon = EditorGUIUtility.Load(<span class="string">"icons/console.erroricon.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line">    m_errorIconSmall = EditorGUIUtility.Load(<span class="string">"icons/console.erroricon.sml.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line"></span><br><span class="line">    m_resizerStyle = <span class="keyword">new</span> GUIStyle();</span><br><span class="line"></span><br><span class="line">    m_panelStyle = <span class="keyword">new</span> GUIStyle();</span><br><span class="line">    m_panelStyle.normal.background = EditorGUIUtility.Load(<span class="string">"builtin skins/darkskin/images/projectbrowsericonareabg.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line">    <span class="comment">// 这行是同事告诉我的，但是不知道为什么不管用，直接用会有空引用报错，要在GUI里用</span></span><br><span class="line">    <span class="comment">// m_panelStyle.normal.background = GUI.skin.window.normal.background; </span></span><br><span class="line"></span><br><span class="line">    m_boxItemStyle = <span class="keyword">new</span> GUIStyle();</span><br><span class="line">    m_boxItemStyle.normal.textColor = <span class="keyword">new</span> Color(<span class="number">0.7f</span>, <span class="number">0.7f</span>, <span class="number">0.7f</span>);</span><br><span class="line"></span><br><span class="line">    m_boxBgOdd = EditorGUIUtility.Load(<span class="string">"builtin skins/darkskin/images/cn entrybackodd.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line">    m_boxBgEven = EditorGUIUtility.Load(<span class="string">"builtin skins/darkskin/images/cnentrybackeven.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line">    m_boxBgSelected = EditorGUIUtility.Load(<span class="string">"builtin skins/darkskin/images/menuitemhover.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line"></span><br><span class="line">    m_textAreaStyle = <span class="keyword">new</span> GUIStyle();</span><br><span class="line">    m_textAreaStyle.normal.textColor = <span class="keyword">new</span> Color(<span class="number">0.9f</span>, <span class="number">0.9f</span>, <span class="number">0.9f</span>);</span><br><span class="line">    m_textAreaStyle.normal.background = EditorGUIUtility.Load(<span class="string">"builtin skins/darkskin/images/projectbrowsericonareabg.png"</span>) <span class="keyword">as</span> Texture2D;</span><br><span class="line"></span><br><span class="line">    m_labelButtonStyle = <span class="keyword">new</span> GUIStyle();</span><br><span class="line">    m_labelButtonStyle.normal.textColor = Color.green;</span><br><span class="line">    m_labelButtonStyle.normal.background = m_textAreaStyle.normal.background;</span><br><span class="line">    m_labelButtonStyle.alignment = TextAnchor.MiddleLeft;</span><br><span class="line">    m_labelButtonStyle.stretchWidth = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> b = m_labelButtonStyle.border;</span><br><span class="line">    b.left = <span class="number">0</span>;</span><br><span class="line">    b.right = <span class="number">0</span>;</span><br><span class="line">    b.top = <span class="number">0</span>;</span><br><span class="line">    b.bottom = <span class="number">0</span>;</span><br><span class="line">    m_labelButtonStyle.border = b;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GetAssets();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取图像的参数都是magic number，这里不多提。图标浏览和获取参数可以参考下面两个页面。当然你也可以准备自己的素材。</p><p><a href="https://unitylist.com/p/5c3/Unity-editor-icons" target="_blank" rel="noopener">https://unitylist.com/p/5c3/Unity-editor-icons</a><br><a href="https://gist.github.com/rus89/375e107ed8c6db79d0c41b8612e5dbf3" target="_blank" rel="noopener">https://gist.github.com/rus89/375e107ed8c6db79d0c41b8612e5dbf3</a></p><h1 id="绘制菜单栏"><a href="#绘制菜单栏" class="headerlink" title="绘制菜单栏"></a>绘制菜单栏</h1><p>菜单栏上有几个按钮，我们把最常用的如清理，Play开始清除以及右边三个Filter选项。除了’Clear’是Button，其它的都是Toggle。所以得准备一些布尔变量。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">bool</span> m_isClearOnPlay = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">bool</span> m_isClearOnBuild = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">bool</span> IsClearOnBuild =&gt; m_isClearOnBuild;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">bool</span> m_isErrorPause = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">bool</span> m_isShowLog = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">bool</span> m_isShowWarning = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">bool</span> m_isShowError = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> m_normalLogCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> m_warningLogCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> m_errorLogCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> HashSet&lt;LogType&gt; m_logTypeForUnshow = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>准备好了，那么就可以开始绘制菜单栏了。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawMenuUpperBar</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_menuUpperBar = <span class="keyword">new</span> Rect(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="keyword">this</span>.position.width, MENU_BAR_HEIGHT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始绘制</span></span><br><span class="line">    GUILayout.BeginArea(m_menuUpperBar, EditorStyles.toolbar);</span><br><span class="line">    <span class="comment">// 横向绘制！！！</span></span><br><span class="line">    GUILayout.BeginHorizontal();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (GUILayout.Button(<span class="keyword">new</span> GUIContent(<span class="string">"Clear"</span>), EditorStyles.toolbarButton, GUILayout.Width(<span class="number">40.0f</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 用于清空所有的 log</span></span><br><span class="line">        ClearLogs();</span><br><span class="line">    &#125;</span><br><span class="line">    GUILayout.Space(<span class="number">5.0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// m_isCollapse = GUILayout.Toggle(m_isCollapse, new GUIContent("Collapse"), EditorStyles.toolbarButton, GUILayout.Width(55.0f));</span></span><br><span class="line">    m_isClearOnPlay = GUILayout.Toggle(m_isClearOnPlay, <span class="keyword">new</span> GUIContent(<span class="string">"Clear On Play"</span>), EditorStyles.toolbarButton, GUILayout.Width(<span class="number">80.0f</span>));</span><br><span class="line">    m_isClearOnBuild = GUILayout.Toggle(m_isClearOnBuild, <span class="keyword">new</span> GUIContent(<span class="string">"Clear On Build"</span>), EditorStyles.toolbarButton, GUILayout.Width(<span class="number">85.0f</span>));</span><br><span class="line">    m_isErrorPause = GUILayout.Toggle(m_isErrorPause, <span class="keyword">new</span> GUIContent(<span class="string">"Error Pause"</span>), EditorStyles.toolbarButton, GUILayout.Width(<span class="number">70.0f</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 弹性空白，我不太清楚应该怎么描述，但是它可以把后面的几个Toggle都尽可能往后面推</span></span><br><span class="line">    GUILayout.FlexibleSpace();</span><br><span class="line"></span><br><span class="line">    m_normalLogCount = Mathf.Clamp(m_normalLogCount, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    m_warningLogCount = Mathf.Clamp(m_warningLogCount, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    m_errorLogCount = Mathf.Clamp(m_errorLogCount, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    m_isShowLog = GUILayout.Toggle(m_isShowLog, <span class="keyword">new</span> GUIContent(m_numStrs[m_normalLogCount], m_infoIconSmall), EditorStyles.toolbarButton, GUILayout.Width(<span class="number">30.0f</span>));</span><br><span class="line">    m_isShowWarning = GUILayout.Toggle(m_isShowWarning, <span class="keyword">new</span> GUIContent(m_numStrs[m_warningLogCount], m_warningIconSmall), EditorStyles.toolbarButton, GUILayout.Width(<span class="number">30.0f</span>));</span><br><span class="line">    m_isShowError = GUILayout.Toggle(m_isShowError, <span class="keyword">new</span> GUIContent(m_numStrs[m_errorLogCount], m_errorIconSmall), EditorStyles.toolbarButton, GUILayout.Width(<span class="number">30.0f</span>));</span><br><span class="line"></span><br><span class="line">    m_logTypeForUnshow.Clear();</span><br><span class="line">    <span class="keyword">if</span> (!m_isShowLog)</span><br><span class="line">    &#123;</span><br><span class="line">        m_logTypeForUnshow.Add(LogType.Log);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!m_isShowWarning)</span><br><span class="line">    &#123;</span><br><span class="line">        m_logTypeForUnshow.Add(LogType.Warning);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!m_isShowError)</span><br><span class="line">    &#123;</span><br><span class="line">        m_logTypeForUnshow.Add(LogType.Error);</span><br><span class="line">        m_logTypeForUnshow.Add(LogType.Assert);</span><br><span class="line">        m_logTypeForUnshow.Add(LogType.Exception);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 横向绘制结束</span></span><br><span class="line">    GUILayout.EndHorizontal();</span><br><span class="line">    <span class="comment">// 区域绘制结束</span></span><br><span class="line">    GUILayout.EndArea();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实际调用绘制</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DrawMenuUpperBar();</span><br><span class="line">    <span class="comment">//DrawUpperPanel();</span></span><br><span class="line">    <span class="comment">//DrawLowerPanel();</span></span><br><span class="line">    <span class="comment">//DrawResizer();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就把菜单栏绘制好了。</p><h1 id="简单绘制上下区栏"><a href="#简单绘制上下区栏" class="headerlink" title="简单绘制上下区栏"></a>简单绘制上下区栏</h1><p>接下来再绘制调整棒之前先简单绘制上下区，待会儿做好调整棒之后就能直接测试效果。要注意给菜单栏以及调整版预留的高度，不然会得到错误的区域大小，添加调整棒后会更会出现奇怪现象。<br>现在只需要给上下区绘制空白就可以了。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawUpperPanel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_upperPanel = <span class="keyword">new</span> Rect(<span class="number">0</span>, MENU_BAR_HEIGHT, <span class="keyword">this</span>.position.width, (<span class="keyword">this</span>.position.height - MENU_BAR_HEIGHT) * m_upperSizeRatio);</span><br><span class="line">    GUILayout.BeginArea(m_upperPanel, m_panelStyle);</span><br><span class="line">    GUILayout.Label(<span class="string">"Log"</span>, m_panelLabelStyle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为了画log item而准备的 ScrollView</span></span><br><span class="line">    m_upperPanelScroll = GUILayout.BeginScrollView(m_upperPanelScroll);</span><br><span class="line">    GUILayout.EndScrollView();</span><br><span class="line"></span><br><span class="line">    GUILayout.EndArea();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawLowerPanel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">float</span> yPos = PanelGroupHeight * m_upperSizeRatio + MENU_BAR_HEIGHT + RESIZER_HEIGHT;</span><br><span class="line">    m_lowerPanel = <span class="keyword">new</span> Rect(<span class="number">0</span>, yPos, <span class="keyword">this</span>.position.width, PanelGroupHeight * (<span class="number">1.0f</span> - m_upperSizeRatio));</span><br><span class="line">    GUILayout.BeginArea(m_lowerPanel, m_panelStyle);</span><br><span class="line">    GUILayout.Label(<span class="string">"Log Detail"</span>, m_panelLabelStyle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为 log详情准备的 ScrollView</span></span><br><span class="line">    m_lowerPanelScroll = GUILayout.BeginScrollView(m_lowerPanelScroll);</span><br><span class="line">    GUILayout.EndScrollView();</span><br><span class="line"></span><br><span class="line">    GUILayout.EndArea();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实际调用绘制</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DrawMenuUpperBar();</span><br><span class="line">    DrawUpperPanel();</span><br><span class="line">    DrawLowerPanel();</span><br><span class="line">    <span class="comment">//DrawResizer();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="绘制调整棒-添加区域调整"><a href="#绘制调整棒-添加区域调整" class="headerlink" title="绘制调整棒 添加区域调整"></a>绘制调整棒 添加区域调整</h1><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawResizer</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">float</span> yPos = (<span class="keyword">this</span>.position.height - MENU_BAR_HEIGHT) * m_upperSizeRatio + MENU_BAR_HEIGHT;</span><br><span class="line">    m_resizer = <span class="keyword">new</span> Rect(<span class="number">0</span>, yPos, <span class="keyword">this</span>.position.width, RESIZER_HEIGHT);</span><br><span class="line"></span><br><span class="line">    GUILayout.BeginArea(<span class="keyword">new</span> Rect(m_resizer.position + (Vector2.up * RESIZER_HEIGHT), <span class="keyword">new</span> Vector2(<span class="keyword">this</span>.position.width, <span class="number">2.0f</span>)), m_resizerStyle);</span><br><span class="line">    GUILayout.EndArea();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把 m_resizer 区域内的光标换成拉伸指示光标</span></span><br><span class="line">    EditorGUIUtility.AddCursorRect(m_resizer, MouseCursor.ResizeVertical);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Resize</span>(<span class="params">Event currentEvent</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_isResizing)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 通过鼠标位置改变调整棒位置</span></span><br><span class="line">        <span class="keyword">float</span> pos = currentEvent.mousePosition.y - MENU_BAR_HEIGHT;</span><br><span class="line"></span><br><span class="line">        m_upperSizeRatio = pos / PanelGroupHeight;</span><br><span class="line">        m_upperSizeRatio = Mathf.Clamp(m_upperSizeRatio, <span class="number">0.5f</span>, <span class="number">0.8f</span>);</span><br><span class="line">        <span class="comment">//Debug.Log($"next upper ratio &#123;m_upperSizeRatio&#125;");</span></span><br><span class="line">        Repaint();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ProcessEvents</span>(<span class="params">Event currentEvent</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (EventType.MouseDown == currentEvent.type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// if press mouse left in resizer</span></span><br><span class="line">        m_isResizing = (<span class="number">0</span> == currentEvent.button &amp;&amp; m_resizer.Contains(currentEvent.mousePosition));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (EventType.MouseUp == currentEvent.type)</span><br><span class="line">    &#123;</span><br><span class="line">        m_isResizing = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Resize(currentEvent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>其实感觉编辑器开发挺麻烦的，除了区域绘制要注意，还有一堆API不好查不会用。下一期将会将Log信息捕获并显示在我们自己的这个Console上。</p><hr><p>完整工程链接(持续更新中) :<br><a href="https://github.com/2C2C2C/TempUnityLogConsoleClone" target="_blank" rel="noopener">https://github.com/2C2C2C/TempUnityLogConsoleClone</a></p><p>P.S : 我在做的时候是参考了某个游戏工作室发布的教程，我也顺便把这个教程分享出来。<br><a href="https://gram.gs/gramlog/creating-editor-windows-in-unity/" target="_blank" rel="noopener">https://gram.gs/gramlog/creating-editor-windows-in-unity/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;本菜狗在上周领了一个做LogManager的任务。很高兴也很慌，毕竟从来没做过编辑器开发，于是面向搜索引擎编程开始辣，找了一些教程学着做，顺便分享一下。&lt;/p&gt;
&lt;h1 id=&quot;需求分析（？&quot;&gt;&lt;a href=&quot;#需求分析（？&quot; class=&quot;headerlink&quot; tit
      
    
    </summary>
    
    
      <category term="UnityEditor" scheme="http://yoursite.com/categories/UnityEditor/"/>
    
    
      <category term="Unity" scheme="http://yoursite.com/tags/Unity/"/>
    
      <category term="UnityEditor" scheme="http://yoursite.com/tags/UnityEditor/"/>
    
  </entry>
  
  <entry>
    <title>给Unity上代理</title>
    <link href="http://yoursite.com/2020/05/18/20200518-unity-hub-w-proxy/"/>
    <id>http://yoursite.com/2020/05/18/20200518-unity-hub-w-proxy/</id>
    <published>2020-05-18T14:41:32.000Z</published>
    <updated>2020-05-31T02:17:28.274Z</updated>
    
    <content type="html"><![CDATA[<h1 id="给Unity用上代理"><a href="#给Unity用上代理" class="headerlink" title="给Unity用上代理"></a>给Unity用上代理</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前有段时间公司的网络不是很稳定，从UnityHub上拖东西99%失败。自己又太菜不想安装Android Studio手动设置安卓打包的东西，于是乎只能想办法给下载加速。</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>首先你要有那个，就是那个你为了看PH才弄的小工具：）</p><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>首先默认我们的小✈代理端口是1080。<br>似乎V2可以同时有SOCK5和HTTP代理的样子，那也把HTTP代理的端口设置成1080.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 设置代理</span></span><br><span class="line"><span class="built_in">set</span> HTTP_PROXY=http://127.0.0.1:1080</span><br><span class="line"><span class="built_in">set</span> HTTPS_PROXY=http://127.0.0.1:1080</span><br><span class="line"></span><br><span class="line">start <span class="string">""</span> <span class="string">"your unity hub path"</span></span><br><span class="line"><span class="comment"># like path is like -&gt; D:\Unity\Unity Hub\Unity Hub.exe</span></span><br></pre></td></tr></table></figure><h2 id="爆炸"><a href="#爆炸" class="headerlink" title="爆炸"></a>爆炸</h2><p>非常简单就是这样。</p><p>其实东西都是从有木桑博客看来的<br><a href="https://www.yomunchan.moe/archives/320" target="_blank" rel="noopener">https://www.yomunchan.moe/archives/320</a></p><p>这边有蛮多游戏开发相关的文章，帮了我不少，十分感谢了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;给Unity用上代理&quot;&gt;&lt;a href=&quot;#给Unity用上代理&quot; class=&quot;headerlink&quot; title=&quot;给Unity用上代理&quot;&gt;&lt;/a&gt;给Unity用上代理&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerli
      
    
    </summary>
    
    
    
      <category term="常用" scheme="http://yoursite.com/tags/%E5%B8%B8%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>给Git上个代理试试提速</title>
    <link href="http://yoursite.com/2020/05/03/20200503-git-add-proxy/"/>
    <id>http://yoursite.com/2020/05/03/20200503-git-add-proxy/</id>
    <published>2020-05-03T09:34:08.000Z</published>
    <updated>2020-05-31T03:14:50.308Z</updated>
    
    <content type="html"><![CDATA[<h1 id="给GIT用上代理"><a href="#给GIT用上代理" class="headerlink" title="给GIT用上代理"></a>给GIT用上代理</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在看着教程搭建这个博客的时候，我在GIT上也拖了不少的包。直连有时候真的速度慢到吐血，原因很复杂也莫得办法。<br>不过还好，我们其实可以给GIT上个代理，这样能给速度一些改善。</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>我是在本机器安装有代理客户端，小🛩和V2都彳亍。<br>我这边的情况是这样的，小飞机走SOCK5代理，V2走的HTTP代理。<br>因为平时我只可能开着一个，所以端口都是1080。</p><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>废话不多说了，直接上命令。</p><p>首先我们看看已有的设置.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 查看全局配置中的代理</span></span><br><span class="line">git config --global --get http.proxy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前生效配置中的代理</span></span><br><span class="line">git config --get http.proxy</span><br></pre></td></tr></table></figure><p>然后我们加上自己的代理。<br>当前我们假设的状态是本机开着小✈或者V2，且代理端口为1080的情况。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 括号中的都是可选项</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 若用的小飞机, --global 意味着应用到全局设置</span></span><br><span class="line">git config (--global) http.proxy sock5://127.0.0.1:1080</span><br><span class="line">git config (--global) https.proxy sock5://127.0.0.1:1080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这样应用后，没开代理GIT就会抽风了，所以如果平时速度还不错的话记得用完取消代理</span></span><br><span class="line">git config (--global) --<span class="built_in">unset</span> http.proxy (sock5://127.0.0.1:1080)</span><br><span class="line">git config (--global) --<span class="built_in">unset</span> https.proxy (sock5://127.0.0.1:1080)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 若用的V2, --global 意味着应用到全局设置</span></span><br><span class="line">git config (--global) http.proxy  http://127.0.0.1:1080</span><br><span class="line">git config (--global) https.proxy https://127.0.0.1:1080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取消</span></span><br><span class="line">git config (--global) --<span class="built_in">unset</span> http.proxy  （http://127.0.0.1:1080）</span><br><span class="line">git config (--global) --<span class="built_in">unset</span> https.proxy （https://127.0.0.1:1080）</span><br></pre></td></tr></table></figure><p>挂了代理真的飞速，爽到。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;给GIT用上代理&quot;&gt;&lt;a href=&quot;#给GIT用上代理&quot; class=&quot;headerlink&quot; title=&quot;给GIT用上代理&quot;&gt;&lt;/a&gt;给GIT用上代理&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; titl
      
    
    </summary>
    
    
      <category term="Git" scheme="http://yoursite.com/categories/Git/"/>
    
    
      <category term="Git" scheme="http://yoursite.com/tags/Git/"/>
    
      <category term="常用" scheme="http://yoursite.com/tags/%E5%B8%B8%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2020/05/03/hello-world/"/>
    <id>http://yoursite.com/2020/05/03/hello-world/</id>
    <published>2020-05-03T04:47:50.757Z</published>
    <updated>2020-05-03T04:47:50.757Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
    
  </entry>
  
</feed>
